<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JCHAT - Profile</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://*.firebaseio.com" crossorigin>
    <link rel="preconnect" href="https://res.cloudinary.com" crossorigin>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <style>
        /* Universal box-sizing for consistent layout */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        /* Global CSS Variables for easy theme switching */
        :root {
            --pink: #ff2e92;
            --blue: #00d5ff;
            --glass-black: rgba(10, 10, 10, .75);
            --glass-blue: rgba(0, 213, 255, .15);
            --radius: 20px;
            --transition: .3s ease;

            /* These variables will be overridden by theme classes */
            --white: #fff;
            --text-light: rgba(255, 255, 255, .7);
            --background-main: rgba(10, 10, 10, .75);
            --background-gradient-1: #00d5ff;
            --background-gradient-2: #ff2e92;
            --card-background: linear-gradient(145deg, rgba(255, 255, 255, .03), rgba(255, 255, 255, .01));
            --header-background: linear-gradient(135deg, rgba(10, 10, 10, .85), rgba(10, 10, 10, .75));
            --border-light: rgba(255, 255, 255, .05);
            --input-background: rgba(255, 255, 255, 0.05);
            --button-background: linear-gradient(90deg, var(--blue), var(--pink));
            --button-shadow: 0 4px 15px var(--blue), 0 44px 15px var(--pink);

            /* New variables for consistent theming */
            --background-color-primary: #1a1a2e;
            --background-color-secondary: #0f0f1f;
            --header-background-color: #2a2a4a;
            --footer-background-color: #2a2a4a;
            --content-background-color: #20203a;
            --card-background-color: #2a2a4a;
            --text-color-primary: #e0e0e0;
            --text-color-secondary: #b0b0d0;
            --notification-badge-color: #ff2e92;
            --status-online: #4CAF50;
            --status-offline: #6c757d;
            --status-away: #FFC107;
            --delete-button-color: #dc3545;
            --warning-color: #ffc107;
            --accent-color: #00d5ff; /* A bright cyan */
            --accent-color-dark: #00aaff;
            --border-color: #3a3a5a;
        }

        /* --- Theme Definitions (Light and Dark Mode) --- */
        /* Light Mode */
        body.theme-light-mode {
            --background-main: #f0f2f5; /* Light gray background */
            --background-gradient-1: #e0e2e5; /* Subtle lighter gradient */
            --background-gradient-2: #d0d2d5; /* Subtle darker gradient */
            --white: #333; /* Dark text for readability */
            --text-light: #666; /* Lighter dark text */
            --card-background: rgba(255, 255, 255, 0.95); /* Near white cards */
            --header-background: rgba(255, 255, 255, 0.98); /* Near white header */
            --border-light: rgba(0, 0, 0, 0.1); /* Light borders */
            --input-background: rgba(0, 0, 0, 0.05); /* Light input background */
            --button-background: linear-gradient(90deg, #6dd5ed, #2193b0); /* Blue gradient */
            --button-shadow: 0 4px 15px rgba(109, 213, 237, 0.4), 0 4px 15px rgba(33, 147, 176, 0.4);

            /* New variables override for light mode */
            --background-color-primary: #f0f2f5;
            --background-color-secondary: #e0e2e5;
            --header-background-color: #ffffff;
            --footer-background-color: #ffffff;
            --content-background-color: #f7f9fb;
            --card-background-color: #ffffff;
            --text-color-primary: #333333;
            --text-color-secondary: #666666;
            --text-color-light: #999999;
            --accent-color: #007bff;
            --accent-color-dark: #0056b3;
            --border-color: #e0e0e0;
            --input-background-color: #f0f0f0;
            --button-background: #e9ecef;
            --button-hover-background: #dee2e6;
            --active-item-background: rgba(0, 123, 255, 0.1);
            --notification-badge-color: #dc3545;
            --status-online: #28a745;
            --status-offline: #6c757d;
            --status-away: #ffc107;
            --delete-button-color: #dc3545;
            --warning-color: #ffc107;
        }

        /* Dark Mode */
        body.theme-dark-mode {
            --background-main: #1a1a2e; /* Deep purple-dark blue */
            --background-gradient-1: #16213e; /* Slightly lighter deep blue */
            --background-gradient-2: #0f3460; /* Darker blue */
            --white: #e0e0e0; /* Off-white text */
            --text-light: #a0a0a0; /* Grayish text */
            --card-background: rgba(25, 25, 40, 0.7); /* Darker, less transparent cards */
            --header-background: linear-gradient(135deg, rgba(10, 10, 20, .85), rgba(10, 10, 20, .75)); /* Original dark header */
            --border-light: rgba(255, 255, 255, 0.08); /* Subtle white borders */
            --input-background: rgba(255, 255, 255, 0.08);
            --button-background: linear-gradient(90deg, #e94560, #ba2f49); /* Reddish gradient */
            --button-shadow: 0 4px 15px rgba(233, 69, 96, 0.4), 0 4px 15px rgba(186, 47, 73, 0.4);

            /* New variables override for dark mode */
            --background-color-primary: #121212;
            --background-color-secondary: #1e1e1e;
            --header-background-color: #2c2c2c;
            --footer-background-color: #2c2c2c;
            --content-background-color: #242424;
            --card-background-color: #2c2c2c;
            --text-color-primary: #ffffff;
            --text-color-secondary: #bbbbbb;
            --accent-color: #bb86fc;
            --accent-color-dark: #9a67ea;
            --border-color: #444444;
            --input-background-color: #383838;
            --button-background: #383838;
            --button-hover-background: #505050;
            --active-item-background: rgba(187, 134, 252, 0.2);
            --notification-badge-color: #cf6679;
            --delete-button-color: #f44336;
            --warning-color: #ffeb3b;
        }

        /* Glass Mode specific variables (from original Profile.html snippet, adapted) */
        body.theme-glass-mode {
            --background-main: rgba(10, 10, 10, 0.75);
            background-image: url('https://source.unsplash.com/random/1920x1080?abstract,blur') !important;
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
            backdrop-filter: blur(10px);
            --card-background: rgba(25, 25, 40, 0.7);
            --white: #e0e0e0; /* text-color */
            --text-light: rgba(255, 255, 255, 0.7);
            --input-background: rgba(255, 255, 255, 0.05);
            --border-light: rgba(255, 255, 255, 0.1); /* glass-border-color */
            --button-background: linear-gradient(90deg, var(--pink), var(--blue));
            --button-shadow: 0 4px 15px var(--blue), 0 4px 15px var(--pink);
            box-shadow: inset 0 0 100px rgba(0, 0, 0, 0.5); /* Inner shadow for glass effect */

            /* New variables override for glass mode */
            --background-color-primary: rgba(10, 10, 10, 0.75);
            --background-color-secondary: rgba(10, 10, 10, 0.6);
            --header-background-color: rgba(10, 10, 10, 0.85);
            --footer-background-color: rgba(10, 10, 10, 0.85);
            --content-background-color: rgba(10, 10, 10, 0.75);
            --card-background-color: rgba(25, 25, 40, 0.7);
            --text-color-primary: #e0e0e0;
            --text-color-secondary: #b0b0d0;
            --accent-color: #00d5ff;
            --accent-color-dark: #00aaff;
            --border-color: rgba(255, 255, 255, 0.1);
            --input-background-color: rgba(255, 255, 255, 0.05);
            --button-background: rgba(0, 213, 255, 0.15); /* Glassy button */
            --button-hover-background: rgba(0, 213, 255, 0.25);
            --active-item-background: rgba(0, 213, 255, 0.1);
        }

        /* NEW: Sunset Theme (from original Profile.html snippet, adapted) */
        body.theme-sunset-mode {
            background: linear-gradient(to top, #ff7e5f, #feb47b) !important;
            --background-main: linear-gradient(to top, #ff7e5f, #feb47b);
            --card-background: rgba(255, 255, 255, 0.15); /* Slightly transparent white for contrast */
            --white: #fff; /* White text for readability */
            --text-light: rgba(255, 255, 255, 0.8);
            --input-background: rgba(255, 255, 255, 0.1);
            --border-light: rgba(255, 255, 255, 0.3);
            --button-background: linear-gradient(90deg, #fd746c, #ff9068); /* Sunset gradient */
            --button-shadow: 0 4px 15px rgba(253, 116, 108, 0.4), 0 4px 15px rgba(255, 144, 104, 0.4);

            /* New variables override for sunset mode */
            --background-color-primary: #ff7e5f;
            --background-color-secondary: #feb47b;
            --header-background-color: rgba(255, 126, 95, 0.9);
            --footer-background-color: rgba(255, 126, 95, 0.9);
            --content-background-color: rgba(255, 126, 95, 0.85);
            --card-background-color: rgba(255, 255, 255, 0.15);
            --text-color-primary: #fff;
            --text-color-secondary: rgba(255, 255, 255, 0.8);
            --accent-color: #ffd700;
            --accent-color-dark: #ccaa00;
            --border-color: rgba(255, 255, 255, 0.3);
            --input-background-color: rgba(255, 255, 255, 0.2);
            --button-background: rgba(255, 255, 255, 0.2);
            --button-hover-background: rgba(255, 255, 255, 0.3);
            --active-item-background: rgba(255, 215, 0, 0.1);
        }


        /* Always show scrollbar to prevent layout shifts */
        html {
            overflow-y: scroll;
        }

        body {
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden; /* Prevent horizontal scroll */
            padding-bottom: 0px; /* Adjusted: Removed nav bar and toggle button */
            background-color: var(--background-main);
            background-image: radial-gradient(circle at top left, var(--background-gradient-1), transparent 100px),
                              radial-gradient(circle at bottom right, var(--background-gradient-2), transparent 150px);
            color: var(--white);
            transition: background-color 0.5s ease, color 0.5s ease; /* Smooth theme transition */
        }

        /* Header Styling (from Home.html) */
        header {
            background: var(--header-background);
            border-bottom: 1px solid var(--border-light);
            padding: 10px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 55px;
            z-index: 10;
            display: flex;
            justify-content: center;
        }

        header .header-content-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 1200px;
            padding: 0 30px;
        }

        .logo {
            font-family: 'Poppins', sans-serif;
            font-size: 1.8rem;
            font-weight: 800;
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            letter-spacing: -0.03em;
            text-decoration: none;
        }

        /* Header Navigation (from Home.html) */
        header nav ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            gap: 25px;
        }

        header nav ul li a {
            color: var(--white);
            text-decoration: none;
            font-weight: 600;
            font-size: 1.1rem;
            padding: 5px 0;
            position: relative;
            transition: color var(--transition);
        }

        header nav ul li a::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: 0;
            width: 0;
            height: 3px;
            background: var(--blue);
            border-radius: 2px;
            transition: width var(--transition);
        }

        header nav ul li a:hover {
            color: var(--blue);
        }

        header nav ul li a:hover::after {
            width: 100%;
        }

        /* User Profile Header Styling (from Home.html) */
        .user-profile-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Notification Icon Styling (from Home.html) */
        .notification-icon-wrapper {
            position: relative;
            margin-right: 15px; /* Space between notification and profile */
        }

        .notification-icon-wrapper a {
            text-decoration: none; /* Remove underline from link */
            color: inherit; /* Inherit color from parent */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-icon-wrapper i {
            font-size: 1.5rem; /* Adjust size as needed */
            /* Apply gradient to icons */
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent; /* Fallback for browsers that don't support background-clip: text on icons */
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .notification-icon-wrapper i:hover {
            transform: scale(1.1);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--notification-badge-color); /* Use pink for notifications */
            color: var(--white);
            border-radius: 50%;
            padding: 3px 7px;
            font-size: 0.7rem;
            font-weight: 700;
            min-width: 20px;
            text-align: center;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            /* Hide if no notifications */
            display: none;
        }

        .user-profile-header #profileLink {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: var(--white);
            transition: opacity 0.3s ease, background-color 0.3s ease;
            padding: 5px 10px;
            border-radius: var(--radius);
        }

        .user-profile-header #profileLink:hover {
            opacity: 0.8;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .user-profile-header img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--accent-color); /* Used accent-color for consistency */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: opacity 0.3s ease;
        }

        .user-profile-header i {
            font-size: 30px;
            /* Apply gradient to icons */
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent; /* Fallback */
        }

        .user-profile-header span {
            font-weight: 600;
            font-size: 1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
            /* Apply gradient to names */
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent; /* Fallback */
        }

        /* NEW: Admin Icon Styling */
        #adminIconLink {
            display: none; /* Hidden by default */
            margin-right: 15px; /* Space it out from other icons */
            /* Apply gradient to icons */
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent; /* Fallback */
            font-size: 1.5rem;
            transition: transform 0.2s ease;
        }

        #adminIconLink:hover {
            transform: scale(1.1);
        }


        /* Logout Button Styling (from Home.html) */
        #logoutButton {
            background: linear-gradient(90deg, var(--pink), var(--blue));
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.3s ease;
            opacity: 0.8;
            margin-left: 10px;
        }

        #logoutButton:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px var(--pink), 0 44px 15px var(--blue);
            opacity: 1;
        }

        #logoutButton i {
            color: var(--white);
            font-size: 0.9rem;
        }

        /* Main Content Area (from Home.html) */
        main {
            flex-grow: 1;
            padding: 40px 0;
            padding-top: 55px; /* Adjust for fixed header */
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* Align content to top */
            text-align: center;
        }

        .content-wrapper {
            width: 100%;
            max-width: 800px; /* Adjust as needed */
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
        }

        /* Profile Section (adapted from original Profile.html and settings-section) */
        .profile-section {
            background: var(--card-background);
            border: 1px solid var(--glass-blue); /* Consistent border */
            backdrop-filter: blur(10px) saturate(180%);
            border-radius: var(--radius);
            box-shadow: 0 8px 25px rgba(0, 0, 0, .3);
            padding: 2rem;
            width: 90%;
            max-width: 600px; /* Max width for consistency */
            margin: 20px auto;
            display: flex;
            flex-direction: column;
            align-items: center; /* Center content */
            gap: 1.5rem;
            text-align: center;
            position: relative;
        }

        .profile-header-area { /* New wrapper for top part of profile */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            width: 100%;
        }

        .profile-pic-wrapper {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            overflow: hidden;
            border: 4px solid var(--blue);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            position: relative;
            flex-shrink: 0;
        }

        .profile-pic {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .profile-pic-placeholder {
            font-size: 100px;
            /* Apply gradient to icons */
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent; /* Fallback */
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .edit-profile-pic-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 40%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s ease;
            /* Ensure it's not clickable when not owner */
            pointer-events: none;
        }

        .profile-pic-wrapper:hover .edit-profile-pic-overlay {
            opacity: 1;
        }
        /* Make overlay clickable only for owner */
        .profile-pic-wrapper.owner .edit-profile-pic-overlay {
            pointer-events: auto;
        }

        /* NEW: Profile picture loading spinner */
        .profile-pic-wrapper .profile-pic-loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--blue);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            display: none; /* Hidden by default */
        }
        .profile-pic-wrapper.loading .profile-pic-loader {
            display: block;
        }
        .profile-pic-wrapper.loading .profile-pic,
        .profile-pic-wrapper.loading .profile-pic-placeholder,
        .profile-pic-wrapper.loading .edit-profile-pic-overlay {
            opacity: 0.3; /* Dim content while loading */
            pointer-events: none; /* Disable interaction */
        }


        .profile-name {
            font-family: 'Poppins', sans-serif;
            font-size: 2.2rem;
            font-weight: 800;
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            margin: 0;
            text-align: center;
        }

        .profile-bio, .profile-location, .profile-email, .profile-info-item {
            font-size: 1rem;
            color: var(--text-light);
            margin: 0;
            line-height: 1.5;
        }

        .profile-location i, .profile-email i, .profile-info-item i {
            /* Apply gradient to icons */
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent; /* Fallback */
            margin-right: 5px;
        }


        .profile-stats {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-top: 1rem;
            flex-wrap: wrap;
            gap: 15px;
            background: rgba(0, 0, 0, 0.2); /* Consistent with old profile, but blended */
            border-radius: 10px;
            padding: 10px 0;
            border: 1px solid var(--border-light); /* Consistent border */
        }

        .stat-item {
            text-align: center;
            color: var(--white); /* Use --white for main text */
            flex: 1 1 30%; /* Allow items to grow/shrink, 3 items per row on wider screens */
            min-width: 100px; /* Minimum width to prevent squishing */
        }

        .stat-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--white);
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-light); /* Lighter text for labels */
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* NEW: Level Display and Progress Bar Styles */
        .level-link-wrapper {
            text-decoration: none; /* Remove underline from the link */
            color: inherit; /* Inherit text color */
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%; /* Ensure it takes full width for centering */
            padding: 5px 0; /* Add some padding */
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .level-link-wrapper:hover {
            transform: translateY(-2px);
        }

        .level-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            width: 100%; /* Ensure it takes full width */
        }

        .profile-level-info { /* Adjusted to target the new div */
            display: flex;
            flex-direction: column; /* Stack icon and name */
            align-items: center;
            gap: 8px;
            margin-top: 10px; /* Space from bio/location */
        }

        .profile-level-name {
            font-family: 'Poppins', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            /* Apply gradient to level name */
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0; /* Remove default margin */
        }

        .profile-level-icon {
            font-size: 2.5rem; /* Larger icon for the main level display */
            /* Apply gradient to level icon */
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .progress-bar-container {
            width: 80%; /* Adjust width as needed */
            height: 10px;
            background-color: rgba(255, 255, 255, 0.1); /* Lighter background for the bar */
            border-radius: 5px;
            overflow: hidden;
            margin-top: 5px; /* Space between level name and bar */
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .progress-bar-fill {
            height: 100%;
            width: 100%; /* Always 100% width, the gradient moves */
            background-image: linear-gradient(90deg, var(--pink), var(--blue)); /* Pink to blue gradient */
            background-size: 200% 100%; /* Make gradient twice as wide */
            background-position: right; /* Start with blue showing */
            border-radius: 5px; /* Match container border-radius */
            transition: background-position 0.5s ease-out; /* Smooth transition for position */
        }

        /* Hide the "XP Level" label as requested */
        .level-link-wrapper .stat-label {
            display: none;
        }

        /* JCoin Exchange Rate Display */
        .jcoin-exchange-rate {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 5px;
            text-align: center;
            display: flex; /* Make it a flex container to align icon and text */
            align-items: center;
            justify-content: center;
            gap: 5px; /* Space between icon and text */
        }

        /* Padlock icon styling */
        .padlock-icon {
            font-size: 0.9rem; /* Smaller for inline text */
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--pink), var(--blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Wallet link specific styling */
        #walletLink.disabled-link {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none; /* Disables click events */
            background: rgba(255, 255, 255, 0.05); /* Greyed out background */
            box-shadow: none;
        }
        #walletLink.disabled-link:hover {
            transform: none; /* No hover effect when disabled */
            box-shadow: none;
        }
        .wallet-locked-message {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 5px;
            text-align: center;
        }


        .profile-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .profile-action-button {
            background: var(--button-background);
            color: var(--white);
            border: none;
            border-radius: 15px;
            padding: 0.8rem 1.5rem;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: var(--button-shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .profile-action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--blue), 0 6px 20px var(--pink);
        }

        .profile-action-button.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--white);
            border: 1px solid var(--border-light);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
        }

        .profile-action-button.secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }
        .profile-action-button.danger {
            background-color: var(--delete-button-color); /* Red for danger actions */
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
        }

        .profile-action-button.danger:hover {
            background-color: #c82333;
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.6);
        }

        /* Specific button styles for dynamic states */
        .profile-action-button.sent { background: #6c757d; cursor: default; box-shadow: none; }
        .profile-action-button.sent:hover { transform: none; box-shadow: none; }
        .profile-action-button.friends { background: #28a745; cursor: default; box-shadow: none; }
        .profile-action-button.friends:hover { transform: none; box-shadow: none; }
        .profile-action-button.accept { background: linear-gradient(90deg, #28a745, #218838); }
        .profile-action-button.accept:hover { background: linear-gradient(90deg, #218838, #28a745); }
        .profile-action-button.unfriend { background: #dc3545; }
        .profile-action-button.unfriend:hover { background: #c82333; }


        /* Icons within action buttons */
        .profile-action-button i {
            /* Apply gradient to icons */
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .profile-action-button.secondary i,
        .profile-action-button.danger i {
            -webkit-text-fill-color: var(--white); /* Ensure icons are white for secondary/danger */
        }


        /* Inline Profile Details (from original Profile.html snippet) */
        .profile-details-section { /* Renamed from .profile-details to avoid conflict */
            width: 100%;
            text-align: left;
            margin-top: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .profile-details-section label {
            display: block;
            text-align: left;
            margin-bottom: 5px;
            color: var(--text-light); /* Consistent text color */
            font-weight: 600;
            font-size: 0.95rem;
        }

        .profile-details-section input[type="text"],
        .profile-details-section input[type="url"], /* Added for website */
        .profile-details-section textarea,
        .profile-details-section select { /* NEW: for customization options */
            width: 100%;
            padding: 0.8rem 1rem;
            margin-bottom: 15px; /* Keep original margin for spacing between fields */
            border: 1px solid var(--border-light); /* Consistent border */
            border-radius: 15px; /* Consistent radius */
            background: var(--input-background); /* Consistent background */
            color: var(--white); /* Consistent text color */
            font-size: 1rem; /* Consistent font size */
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            outline: none;
        }

        .profile-details-section input[type="text"]:focus,
        .profile-details-section input[type="url"]:focus,
        .profile-details-section textarea:focus,
        .profile-details-section select:focus {
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(0, 213, 255, 0.2);
        }

        .profile-details-section textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* NEW: Toggle switch for privacy settings */
        .privacy-toggle-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px dashed rgba(255,255,255,0.1);
            margin-bottom: 10px;
        }

        .privacy-toggle-group:last-child {
            border-bottom: none;
        }

        .privacy-toggle-group label {
            margin-bottom: 0;
        }

        /* Toggle button styles (reused from Admin.html) */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-switch .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--input-background);
            transition: .4s;
            border-radius: 34px;
            border: 1px solid var(--border-light);
        }

        .toggle-switch .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: var(--text-light);
            transition: .4s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .slider {
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            border-color: var(--blue);
        }

        .toggle-switch input:checked + .slider:before {
            transform: translateX(26px);
            background-color: var(--white);
        }

        /* NEW: Unlocked Rewards Section */
        .unlocked-rewards-section, .friends-snippet-section, .recent-activity-section, .customization-section, .wallet-guide-section {
            background: var(--card-background);
            border: 1px solid var(--glass-blue);
            backdrop-filter: blur(10px) saturate(180%);
            border-radius: var(--radius);
            box-shadow: 0 8px 25px rgba(0, 0, 0, .3);
            padding: 1.5rem;
            width: 100%;
            margin-top: 20px;
            text-align: left;
        }

        .unlocked-rewards-section h3, .friends-snippet-section h3, .recent-activity-section h3, .customization-section h3, .wallet-guide-section h3 {
            font-family: 'Poppins', sans-serif;
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--white);
            margin-top: 0;
            margin-bottom: 1rem;
            text-align: center;
        }

        .rewards-grid, .friends-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
            justify-content: center;
        }

        .reward-item, .friend-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-light);
            cursor: default;
        }

        .reward-icon {
            font-size: 2.5rem;
            margin-bottom: 5px;
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .friend-pic-wrapper {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid var(--accent-color);
            margin-bottom: 5px;
        }

        .friend-pic {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .friend-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            font-weight: 600;
            color: var(--white);
        }

        /* Recent Activity Section */
        .activity-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px dashed rgba(255,255,255,0.1);
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-item i {
            font-size: 1.2rem;
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .activity-item span {
            flex-grow: 1;
        }

        .activity-timestamp {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            white-space: nowrap;
        }

        .no-activity-message {
            text-align: center;
            color: var(--text-light);
            padding: 20px;
        }

        /* Customization Section */
        .customization-option {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }

        .customization-option label {
            margin-bottom: 5px;
            color: var(--text-light);
            font-weight: 600;
        }

        .customization-option select {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid var(--border-light);
            border-radius: 15px;
            background: var(--input-background);
            color: var(--white);
            font-size: 1rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            outline: none;
            appearance: none; /* Remove default select arrow */
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23ffffff%22%20d%3D%22M287%2C197.399L146.2%2C56.6C145.4%2C55.8%2C144.6%2C55.4%2C143.8%2C55.4s-1.6%2C0.4-2.4%2C1.2L5.4%2C197.399c-1.6%2C1.6-1.6%2C4.1%2C0%2C5.7c1.6%2C1.6%2C4.1%2C1.6%2C5.7%2C0L143.8%2C64.9l132.7%2C132.7c1.6%2C1.6%2C4.1%2C1.6%2C5.7%2C0C288.5%2C201.5%2C288.5%2C198.9%2C287%2C197.399z%22%2F%3E%3C%2Fsvg%3E'); /* Custom arrow */
            background-repeat: no-repeat;
            background-position: right 1rem top 50%;
            background-size: 0.65em auto;
        }

        .customization-option select:focus {
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(0, 213, 255, 0.2);
        }


        /* Global Modal Styling (reused from Home.html) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--card-background);
            border: 1px solid var(--border-light);
            backdrop-filter: blur(15px) saturate(180%);
            border-radius: var(--radius);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            padding: 30px;
            width: 90%;
            max-width: 500px;
            text-align: center;
            position: relative;
            transform: translateY(20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
            opacity: 1;
        }

        .modal-content h3 {
            font-family: 'Poppins', sans-serif;
            font-size: 1.8rem;
            font-weight: 700;
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            margin-top: 0;
            margin-bottom: 20px;
        }

        .modal-content h3 i {
            margin-right: 10px;
        }

        .modal-content .input-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .modal-content label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-light);
            font-weight: 600;
            font-size: 0.95rem;
        }

        .modal-content input[type="text"],
        .modal-content input[type="email"],
        .modal-content input[type="password"],
        .modal-content input[type="number"],
        .modal-content textarea,
        .modal-content select {
            width: calc(100% - 20px);
            padding: 12px;
            border: 1px solid var(--border-light);
            border-radius: 10px;
            background: var(--input-background);
            color: var(--white);
            font-size: 1rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            outline: none;
            box-sizing: border-box; /* Include padding in width */
        }

        .modal-content input[type="text"]:focus,
        .modal-content input[type="email"]:focus,
        .modal-content input[type="password"]:focus,
        .modal-content input[type="number"]:focus,
        .modal-content textarea:focus,
        .modal-content select:focus {
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(0, 213, 255, 0.2);
        }

        .modal-content textarea {
            resize: vertical;
            min-height: 80px;
        }

        .modal-content .button-group {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 25px;
        }

        .modal-button {
            background: var(--button-background);
            color: var(--white);
            border: none;
            border-radius: 15px;
            padding: 10px 20px;
            font-size: 0.95rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: var(--button-shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative; /* For loader */
            overflow: hidden; /* For loader */
        }

        .modal-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--blue), 0 6px 20px var(--pink);
        }

        .modal-button.cancel-button {
            background: rgba(255, 255, 255, 0.1);
            color: var(--white);
            border: 1px solid var(--border-light);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
        }

        .modal-button.cancel-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .modal-button .button-loader {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid var(--white);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: none;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        .modal-button.loading .button-text {
            visibility: hidden;
        }

        .modal-button.loading .button-loader {
            display: block;
        }

        /* Message Box Styling (reused from Home.html) */
        #messageBox {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(90deg, var(--blue), var(--pink));
            color: var(--white);
            padding: 15px 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            font-size: 1rem;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease, transform 0.5s ease, visibility 0.5s ease;
            min-width: 280px;
            max-width: 90%;
            text-align: center;
        }

        #messageBox.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-10px);
        }

        #messageBox.success {
            background: linear-gradient(90deg, #28a745, #218838); /* Green */
        }

        #messageBox.error {
            background: linear-gradient(90deg, #dc3545, #c82333); /* Red */
        }

        #messageBox.warning {
            background: linear-gradient(90deg, #ffc107, #e0a800); /* Orange */
        }

        #messageBox.info {
            background: linear-gradient(90deg, #17a2b8, #138496); /* Blue */
        }

        #messageBox.loading {
            background: linear-gradient(90deg, #6f42c1, #563d7c); /* Purple */
        }


        /* NEW: file input styling for receipt upload */
        .file-input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--input-background);
            border: 1px solid var(--border-light);
            border-radius: 10px;
            padding: 12px;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        .file-input-wrapper:hover {
            border-color: var(--blue);
        }

        .file-input-wrapper .fa-upload {
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 1.2rem;
        }

        .file-input-wrapper .file-name {
            color: var(--text-light);
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .receipt-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 10px;
            margin-top: 15px;
            border: 1px solid var(--border-light);
        }
        .calculated-jcoins {
            text-align: center;
            color: var(--text-light);
            font-size: 0.9rem;
            margin-top: 10px;
        }
        .calculated-jcoins .gradient-text {
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
        }


        /* Animations */
        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* Utility classes */
        .gradient-text {
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .hidden {
            display: none !important;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            header .header-content-wrapper {
                padding: 0 15px;
            }
            header nav ul {
                gap: 15px;
            }
            .logo {
                font-size: 1.5rem;
            }
            header nav ul li a {
                font-size: 1rem;
            }
            .profile-section {
                padding: 1.5rem;
            }
            .profile-name {
                font-size: 1.8rem;
            }
            .profile-bio, .profile-location, .profile-email, .profile-info-item {
                font-size: 0.9rem;
            }
            .profile-actions {
                flex-direction: column;
                gap: 0.8rem;
            }
            .profile-action-button {
                width: 100%;
                padding: 0.7rem 1.2rem;
                font-size: 0.85rem;
            }
            .stat-value {
                font-size: 1.2rem;
            }
            .stat-label {
                font-size: 0.75rem;
            }
            .modal-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content-wrapper">
            <a href="/home.html" class="logo">JCHAT</a>
            <nav>
                <ul>
                    <li><a href="/home.html">Home</a></li>
                    <li><a href="/chat.html">Chat</a></li>
                    <li><a href="/friends.html">Friends</a></li>
                </ul>
            </nav>
            <div class="user-profile-header">
                <div class="notification-icon-wrapper">
                    <a href="/notifications.html">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notificationBadge"></span>
                    </a>
                </div>
                <i class="fas fa-user-shield" id="adminIconLink"></i> <a href="#" id="profileLink">
                    <img id="headerProfilePic" src="#" alt="Profile Picture" style="display: none;">
                    <i id="headerAvatarIcon" class="fas fa-user-circle"></i>
                    <span id="headerDisplayName"></span>
                </a>
                <button id="logoutButton" title="Logout">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </header>

    <main>
        <div class="content-wrapper">
            <section class="profile-section">
                <div class="profile-header-area">
                    <div class="profile-pic-wrapper owner">
                        <img id="profilePic" class="profile-pic" src="" alt="Profile Picture">
                        <i id="profilePicPlaceholder" class="fas fa-user-circle profile-pic-placeholder"></i>
                        <div class="profile-pic-loader"></div> <label for="profilePicUpload" class="edit-profile-pic-overlay" title="Change Profile Picture">
                            <i class="fas fa-camera"></i>
                        </label>
                        <input type="file" id="profilePicUpload" accept="image/*" style="display: none;">
                    </div>
                    <h1 class="profile-name" id="profileUsername"></h1>
                    <p class="profile-bio" id="profileBio"></p>
                    <p class="profile-location" id="profileLocation"><i class="fas fa-map-marker-alt"></i> <span></span></p>
                    <p class="profile-email" id="profileEmail"><i class="fas fa-envelope"></i> <span></span></p>
                    <div class="profile-level-info">
                        <i id="xpLevelIcon" class="profile-level-icon"></i>
                        <h2 id="xpLevelName" class="profile-level-name"></h2>
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill" id="xpProgressBarFill"></div>
                        </div>
                        <span id="xpProgressText" class="jcoin-exchange-rate"></span>
                    </div>
                </div>

                <div class="profile-stats">
                    <div class="stat-item">
                        <span class="stat-value" id="friendsCount">0</span>
                        <span class="stat-label">Friends</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="postsCount">0</span>
                        <span class="stat-label">Posts</span>
                    </div>
                    <a href="/wallet.html" class="stat-item" id="walletLink">
                        <span class="stat-value" id="jCoinsBalance">0</span>
                        <span class="stat-label"><i class="fas fa-coins gradient-text"></i> JCoins</span>
                        <span class="wallet-locked-message" style="display:none;">
                            <i class="fas fa-lock padlock-icon"></i> Wallet Locked
                        </span>
                    </a>
                </div>

                <div class="jcoin-exchange-rate">
                    1 JCoin is now 0.003
                </div>

                <div class="profile-actions" id="profileActions">
                    <button id="requestJCoinsButton" class="profile-action-button" style="display: none;">
                        <i class="fas fa-hand-holding-usd"></i> Request JCoins
                    </button>
                    </div>

                <button id="toggleAccountSettingsButton" class="profile-action-button secondary" style="margin-top: 20px;">
                    <i class="fas fa-cog"></i> Account Settings
                </button>

                <div class="profile-details-section" id="accountSettingsSection" style="display: none;">
                    <h3><i class="fas fa-user-edit"></i> Edit Profile Information</h3>

                    <div class="input-group">
                        <label for="displayNameInput">Display Name:</label>
                        <input type="text" id="displayNameInput" placeholder="Your Display Name">
                    </div>

                    <div class="input-group">
                        <label for="bioTextarea">Bio:</label>
                        <textarea id="bioTextarea" placeholder="Tell us about yourself..."></textarea>
                    </div>

                    <div class="input-group">
                        <label for="locationInput">Location:</label>
                        <input type="text" id="locationInput" placeholder="e.g., Lagos, Nigeria">
                    </div>

                    <div class="input-group">
                        <label for="schoolInput">School:</label>
                        <input type="text" id="schoolInput" placeholder="Your school/university">
                    </div>

                    <div class="input-group">
                        <label for="workInput">Work/Occupation:</label>
                        <input type="text" id="workInput" placeholder="Your job or profession">
                    </div>

                    <div class="input-group">
                        <label for="interestsInput">Interests:</label>
                        <textarea id="interestsInput" placeholder="Comma-separated interests (e.g., coding, gaming, art)"></textarea>
                    </div>

                    <div class="input-group">
                        <label for="websiteInput">Website/Portfolio URL:</label>
                        <input type="url" id="websiteInput" placeholder="e.g., https://yourwebsite.com">
                    </div>

                    <div class="input-group">
                        <label for="socialLinksInput">Social Media Links:</label>
                        <textarea id="socialLinksInput" rows="2" placeholder="Links to your social media profiles (one per line)"></textarea>
                    </div>

                    <button id="saveProfileButton" class="profile-action-button">
                        <span class="button-text">Save Profile</span>
                        <div class="button-loader"></div>
                    </button>

                    <h3 style="margin-top: 2rem;"><i class="fas fa-lock"></i> Privacy Settings</h3>
                    <p style="color: var(--text-light); font-size: 0.9rem; text-align: center; margin-bottom: 20px;">Control what information is visible to other users on your profile.</p>

                    <div class="privacy-toggle-group">
                        <label for="toggleEmailVisibility">Show Email Address</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggleEmailVisibility">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="privacy-toggle-group">
                        <label for="toggleLocationVisibility">Show Location</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggleLocationVisibility">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="privacy-toggle-group">
                        <label for="toggleOnlineStatusVisibility">Show Online Status</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggleOnlineStatusVisibility">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="privacy-toggle-group">
                        <label for="toggleFriendRequests">Allow Friend Requests</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggleFriendRequests">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="privacy-toggle-group">
                        <label for="toggleMessages">Allow Direct Messages</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggleMessages">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="privacy-toggle-group">
                        <label for="toggleSchoolVisibility">Show School</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggleSchoolVisibility">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="privacy-toggle-group">
                        <label for="toggleWorkVisibility">Show Work/Occupation</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggleWorkVisibility">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="privacy-toggle-group">
                        <label for="toggleInterestsVisibility">Show Interests</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggleInterestsVisibility">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="privacy-toggle-group">
                        <label for="toggleWebsiteVisibility">Show Website/Portfolio</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggleWebsiteVisibility">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="privacy-toggle-group">
                        <label for="toggleSocialLinksVisibility">Show Social Media Links</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggleSocialLinksVisibility">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <button id="savePrivacySettingsButton" class="profile-action-button secondary" style="margin-top: 15px;">
                        <span class="button-text">Save Privacy Settings</span>
                        <div class="button-loader"></div>
                    </button>

                    <h3 style="margin-top: 2rem;"><i class="fas fa-palette"></i> Customization</h3>
                    <p style="color: var(--text-light); font-size: 0.9rem; text-align: center; margin-bottom: 20px;">Customize your profile's look and feel. Unlocked customizations will appear here.</p>

                    <div class="customization-option">
                        <label for="profileFrameSelect">Profile Frame:</label>
                        <select id="profileFrameSelect">
                            <option value="default">Default</option>
                            </select>
                    </div>

                    <div class="customization-option">
                        <label for="chatBubbleStyleSelect">Chat Bubble Style:</label>
                        <select id="chatBubbleStyleSelect">
                            <option value="default">Default</option>
                            </select>
                    </div>

                    <div class="customization-option">
                        <label for="profileThemeSelect">Profile Theme:</label>
                        <select id="profileThemeSelect">
                            <option value="default">Default</option>
                            <option value="theme-light-mode">Light Mode</option>
                            <option value="theme-dark-mode">Dark Mode</option>
                            <option value="theme-glass-mode">Glass Mode</option>
                            <option value="theme-sunset-mode">Sunset Mode</option>
                            </select>
                    </div>

                    <button id="saveCustomizationButton" class="profile-action-button">
                        <span class="button-text">Save Customization</span>
                        <div class="button-loader"></div>
                    </button>

                    <h3 style="margin-top: 2rem;"><i class="fas fa-key"></i> Change Password</h3>
                    <div class="input-group">
                        <label for="currentPasswordInput">Current Password:</label>
                        <input type="password" id="currentPasswordInput" placeholder="Enter your current password">
                    </div>
                    <div class="input-group">
                        <label for="newPasswordInput">New Password:</label>
                        <input type="password" id="newPasswordInput" placeholder="Enter your new password">
                    </div>
                    <div class="input-group">
                        <label for="confirmNewPasswordInput">Confirm New Password:</label>
                        <input type="password" id="confirmNewPasswordInput" placeholder="Confirm your new password">
                    </div>
                    <button id="changePasswordButton" class="profile-action-button danger">
                        <span class="button-text">Change Password</span>
                        <div class="button-loader"></div>
                    </button>
                    <button id="deleteAccountButton" class="profile-action-button danger" style="margin-top: 20px;">
                        <i class="fas fa-trash-alt"></i> Delete Account
                    </button>
                </div>
            </section>

            <div class="unlocked-rewards-section" id="unlockedRewardsSection" style="display: none;">
                <h3><i class="fas fa-trophy"></i> Unlocked Rewards</h3>
                <p class="no-activity-message" id="noRewardsMessage">No rewards unlocked yet.</p>
                <div class="rewards-grid" id="rewardsGrid">
                    </div>
            </div>

            <div class="friends-snippet-section" id="friendsSnippetSection" style="display: none;">
                <h3><i class="fas fa-user-friends"></i> Friends (<span id="friendsSnippetCount">0</span>)</h3>
                <p class="no-activity-message" id="noFriendsMessage">No friends to display.</p>
                <div class="friends-grid" id="friendsGrid">
                    </div>
                <button class="profile-action-button secondary" style="margin-top: 20px;" onclick="window.location.href='/friends.html';">
                    <i class="fas fa-users"></i> View All Friends
                </button>
            </div>

            <div class="recent-activity-section" id="recentActivitySection" style="display: none;">
                <h3><i class="fas fa-history"></i> Recent Activity</h3>
                <p class="no-activity-message" id="noActivityMessage">No recent activity to display.</p>
                <ul class="activity-list" id="recentActivityList">
                    </ul>
            </div>

            <div class="wallet-guide-section" id="walletGuideSection" style="display: none;">
                <h3><i class="fas fa-wallet"></i> Wallet Guide</h3>
                <p style="color: var(--text-light); text-align: center;">Learn how to use your JCHAT Wallet:</p>
                <ul class="activity-list">
                    <li><i class="fas fa-arrow-right"></i> Your JCoins balance is shown above. You can earn JCoins through various activities and daily bonuses.</li>
                    <li><i class="fas fa-exchange-alt"></i> The current exchange rate for JCoins to Naira is displayed.</li>
                    <li><i class="fas fa-dollar-sign"></i> You can convert JCoins to Naira and withdraw them to your bank account once you reach the minimum withdrawal amount.</li>
                    <li><i class="fas fa-shopping-cart"></i> Use JCoins to purchase premium features, profile customizations, and virtual gifts in the JCHAT Store (coming soon!).</li>
                    <li><i class="fas fa-history"></i> The Wallet History section (in your full wallet page) shows all your JCoin transactions.</li>
                    <li><i class="fas fa-search"></i> Use the search bar to find specific transactions by description.</li>
                    <li><i class="fas fa-info-circle"></i> Click on any transaction to see more detailed information, including receipt images for purchases.</li>
                </ul>
            </div>
            <div class="posts-feed-section" id="userPostsFeed" style="display: none;">
                <h3>Posts by <span id="postsFeedUsername"></span></h3>
                <p style="text-align: center; color: var(--text-light);" id="loadingUserPostsMessage">Loading posts...</p>
                </div>
        </div>
    </main>

    <div id="messageBox"></div>

    <div id="jcoinRequestModal" class="modal-overlay">
        <div class="modal-content">
            <h3><i class="fas fa-coins"></i> Request JCoins</h3>
            <p style="color: var(--text-light); font-size: 0.9rem; text-align: center;">
                Enter the Naira amount you wish to purchase. You will be credited with JCoins based on the current exchange rate. <br>
                Amounts of <span class="gradient-text">#1000</span> and above receive a <span class="gradient-text">10% bonus</span>.
            </p>
            <div class="input-group">
                <label for="nairaAmountInput">Naira Amount (NGN):</label>
                <input type="number" id="nairaAmountInput" placeholder="e.g., 500, 1000, 5000" min="100">
                <p class="calculated-jcoins">You will get: <span id="calculatedJCoins">0 JCoins</span></p>
            </div>
            <div class="input-group">
                <label class="file-input-label" for="receiptUploadInput">Upload Payment Receipt:</label>
                <div class="file-input-wrapper">
                    <input type="file" id="receiptUploadInput" accept="image/*" style="display: none;">
                    <i class="fas fa-upload"></i>
                    <span class="file-name" id="receiptFileName">No file chosen</span>
                </div>
                <img id="receiptPreview" class="receipt-preview" style="display: none;">
            </div>
            <div class="button-group">
                <button id="cancelJCoinRequest" class="modal-button cancel-button">Cancel</button>
                <button id="submitJCoinRequestButton" class="modal-button save-button">
                    <span class="button-text">Submit Request</span>
                    <div class="button-loader"></div>
                </button>
            </div>
        </div>
    </div>

    <div id="reportUserModal" class="modal-overlay">
        <div class="modal-content">
            <h3><i class="fas fa-flag"></i> Report User</h3>
            <p style="color: var(--text-light); font-size: 0.9rem; text-align: center;">
                You are reporting <strong id="reportedUsernameDisplay" class="gradient-text"></strong>. Please select a reason and provide details.
            </p>
            <div class="input-group">
                <label for="reportReasonSelect">Reason:</label>
                <select id="reportReasonSelect">
                    <option value="">Select a reason</option>
                    <option value="harassment">Harassment / Bullying</option>
                    <option value="spam">Spam / Advertising</option>
                    <option value="inappropriate_content">Inappropriate Content</option>
                    <option value="impersonation">Impersonation</option>
                    <option value="scam">Scam / Fraud</option>
                    <option value="other">Other (please specify)</option>
                </select>
            </div>
            <div class="input-group">
                <label for="reportDetailsTextarea">Details (optional):</label>
                <textarea id="reportDetailsTextarea" rows="4" placeholder="Provide more details about the report..."></textarea>
            </div>
            <div class="button-group">
                <button id="cancelReportButton" class="modal-button cancel-button">Cancel</button>
                <button id="submitReportButton" class="modal-button save-button">
                    <span class="button-text">Submit Report</span>
                    <div class="button-loader"></div>
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, updateProfile, updateEmail, reauthenticateWithCredential, EmailAuthProvider, updatePassword, signOut, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, setDoc, collection, query, where, getDocs, runTransaction, writeBatch, serverTimestamp, orderBy, addDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
        // Import Timestamp for scheduled announcements
        import { Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Firebase & Canvas Environment Configuration ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "AIzaSyBsBinyrD9WZZXRaCvA4gxfX7BIimydDvo", authDomain: "jchat-1.firebaseapp.com", projectId: "jchat-1", storageBucket: "jchat-1.firebasestorage.app", appId: "1:328479683167:web:276c0b7e8ea44dd2d6a1ea", measurementId: "G-S6Z9GG0R9P" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; // Corrected: Use initialAuthToken variable

        // Cloudinary Configuration
        const cloudinaryConfig = {
            cloudName: "dxld01rcp", // Your Cloudinary Cloud Name
            uploadPreset: "Storage_preset" // Your Cloudinary Upload Preset
        };

        // Initialize Firebase services
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- DOM Elements ---
        const headerDisplayName = document.getElementById('headerDisplayName');
        const headerProfilePic = document.getElementById('headerProfilePic');
        const headerAvatarIcon = document.getElementById('headerAvatarIcon');
        const headerNavLinkProfile = document.getElementById('profileLink'); // Null check if not always present
        const logoutButton = document.getElementById('logoutButton');
        const notificationBadge = document.getElementById('notificationBadge');
        const adminIconLink = document.getElementById('adminIconLink'); // NEW Admin icon

        // Profile section elements
        const profilePic = document.getElementById('profilePic');
        const profilePicPlaceholder = document.getElementById('profilePicPlaceholder');
        const profilePicUpload = document.getElementById('profilePicUpload');
        const profileUsername = document.getElementById('profileUsername');
        const profileBio = document.getElementById('profileBio');
        const profileLocation = document.getElementById('profileLocation');
        const profileEmail = document.getElementById('profileEmail');
        const friendsCountSpan = document.getElementById('friendsCount');
        const postsCountSpan = document.getElementById('postsCount');
        const jCoinsBalanceSpan = document.getElementById('jCoinsBalance');
        const walletLink = document.getElementById('walletLink'); // NEW Wallet link
        const walletLockedMessage = document.querySelector('.wallet-locked-message'); // NEW Wallet locked message

        // XP Level elements
        const xpLevelIcon = document.getElementById('xpLevelIcon');
        const xpLevelName = document.getElementById('xpLevelName');
        const xpProgressBarFill = document.getElementById('xpProgressBarFill');
        const xpProgressText = document.getElementById('xpProgressText');

        // Action buttons
        const profileActionsDiv = document.getElementById('profileActions');
        const messageButton = document.getElementById('messageButton'); // Potentially null
        const addFriendButton = document.getElementById('addFriendButton'); // Potentially null
        const cancelFriendRequestButton = document.getElementById('cancelFriendRequestButton'); // Potentially null
        const acceptFriendRequestButton = document.getElementById('acceptFriendRequestButton'); // Potentially null
        const declineFriendRequestButton = document.getElementById('declineFriendRequestButton'); // Potentially null
        const unfriendButton = document.getElementById('unfriendButton'); // Potentially null
        const reportUserButton = document.getElementById('reportUserButton'); // Potentially null
        const requestJCoinsButton = document.getElementById('requestJCoinsButton'); // NEW Request JCoins button
        // const claimDailyBonusButton = document.getElementById('claimDailyBonusButton'); // Removed Daily Bonus button

        // Account settings elements
        const toggleAccountSettingsButton = document.getElementById('toggleAccountSettingsButton');
        const accountSettingsSection = document.getElementById('accountSettingsSection');
        const displayNameInput = document.getElementById('displayNameInput');
        const bioTextarea = document.getElementById('bioTextarea');
        const locationInput = document.getElementById('locationInput');
        const schoolInput = document.getElementById('schoolInput'); // NEW
        const workInput = document.getElementById('workInput'); // NEW
        const interestsInput = document.getElementById('interestsInput'); // NEW
        const websiteInput = document.getElementById('websiteInput'); // NEW
        const socialLinksInput = document.getElementById('socialLinksInput'); // NEW
        const saveProfileButton = document.getElementById('saveProfileButton');

        // Privacy toggles
        const toggleEmailVisibility = document.getElementById('toggleEmailVisibility');
        const toggleLocationVisibility = document.getElementById('toggleLocationVisibility');
        const toggleOnlineStatusVisibility = document.getElementById('toggleOnlineStatusVisibility');
        const toggleFriendRequests = document.getElementById('toggleFriendRequests');
        const toggleMessages = document.getElementById('toggleMessages');
        const toggleSchoolVisibility = document.getElementById('toggleSchoolVisibility'); // NEW
        const toggleWorkVisibility = document.getElementById('toggleWorkVisibility'); // NEW
        const toggleInterestsVisibility = document.getElementById('toggleInterestsVisibility'); // NEW
        const toggleWebsiteVisibility = document.getElementById('toggleWebsiteVisibility'); // NEW
        const toggleSocialLinksVisibility = document.getElementById('toggleSocialLinksVisibility'); // NEW
        const savePrivacySettingsButton = document.getElementById('savePrivacySettingsButton');

        // Customization selects
        const profileFrameSelect = document.getElementById('profileFrameSelect');
        const chatBubbleStyleSelect = document.getElementById('chatBubbleStyleSelect');
        const profileThemeSelect = document.getElementById('profileThemeSelect');
        const saveCustomizationButton = document.getElementById('saveCustomizationButton');

        // Change Password elements
        const currentPasswordInput = document.getElementById('currentPasswordInput');
        const newPasswordInput = document.getElementById('newPasswordInput');
        const confirmNewPasswordInput = document.getElementById('confirmNewPasswordInput');
        const changePasswordButton = document.getElementById('changePasswordButton');
        const deleteAccountButton = document.getElementById('deleteAccountButton');

        // New sections
        const unlockedRewardsSection = document.getElementById('unlockedRewardsSection');
        const noRewardsMessage = document.getElementById('noRewardsMessage');
        const rewardsGrid = document.getElementById('rewardsGrid');
        const friendsSnippetSection = document.getElementById('friendsSnippetSection');
        const friendsSnippetCount = document.getElementById('friendsSnippetCount');
        const noFriendsMessage = document.getElementById('noFriendsMessage');
        const friendsGrid = document.getElementById('friendsGrid');
        const recentActivitySection = document.getElementById('recentActivitySection');
        const noActivityMessage = document.getElementById('noActivityMessage');
        const recentActivityList = document.getElementById('recentActivityList');
        const walletGuideSection = document.getElementById('walletGuideSection'); // NEW

        // User posts feed
        const userPostsFeed = document.getElementById('userPostsFeed');
        const postsFeedUsername = document.getElementById('postsFeedUsername');
        const loadingUserPostsMessage = document.getElementById('loadingUserPostsMessage');

        // Modals and message box
        const messageBox = document.getElementById('messageBox');
        const jcoinRequestModal = document.getElementById('jcoinRequestModal');
        const nairaAmountInput = document.getElementById('nairaAmountInput');
        const calculatedJCoinsSpan = document.getElementById('calculatedJCoins');
        const receiptUploadInput = document.getElementById('receiptUploadInput');
        const receiptFileNameSpan = document.getElementById('receiptFileName');
        const receiptPreview = document.getElementById('receiptPreview');
        const cancelJCoinRequestButton = document.getElementById('cancelJCoinRequest');
        const submitJCoinRequestButton = document.getElementById('submitJCoinRequestButton');
        const reportUserModal = document.getElementById('reportUserModal');
        const reportedUsernameDisplay = document.getElementById('reportedUsernameDisplay');
        const reportReasonSelect = document.getElementById('reportReasonSelect');
        const reportDetailsTextarea = document.getElementById('reportDetailsTextarea');
        const cancelReportButton = document.getElementById('cancelReportButton');
        const submitReportButton = document.getElementById('submitReportButton');


        // --- Global Variables ---
        let currentUser = null;
        let isAuthReady = false;
        let displayedUserId = null; // The userId whose profile is currently displayed
        let currentUserProfileData = null; // Full profile data of the currently logged-in user (private)
        let displayedUserProfileData = null; // Profile data of the user currently being displayed (public/private based on context)

        const ADMIN_UID = "ADMIN_USER_ID_PLACEHOLDER"; // Replace with your actual admin UID

        // --- Firebase Auth Listener ---
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            isAuthReady = true;
            console.log("JCHAT_DEBUG: Auth state changed. User:", user);
            await updateHeaderUI(user);
            await handleProfileLoad();
        });

        // --- Event Listeners ---
        logoutButton?.addEventListener('click', handleLogout);
        profilePicUpload?.addEventListener('change', handleProfilePicUpload);
        saveProfileButton?.addEventListener('click', handleSaveProfile);
        savePrivacySettingsButton?.addEventListener('click', handleSavePrivacySettings);
        saveCustomizationButton?.addEventListener('click', handleSaveCustomization);
        changePasswordButton?.addEventListener('click', handleChangePassword);
        deleteAccountButton?.addEventListener('click', handleDeleteAccount);
        toggleAccountSettingsButton?.addEventListener('click', () => {
            if (accountSettingsSection) {
                accountSettingsSection.style.display = accountSettingsSection.style.display === 'none' ? 'flex' : 'none';
                toggleAccountSettingsButton.textContent = accountSettingsSection.style.display === 'none' ? 'Account Settings' : 'Hide Settings';
                if (accountSettingsSection.style.display === 'flex') {
                    // Scroll to the settings section when opened
                    accountSettingsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        });
        requestJCoinsButton?.addEventListener('click', () => {
            jcoinRequestModal?.classList.add('active');
            nairaAmountInput.value = '';
            calculatedJCoinsSpan.textContent = '0 JCoins';
            receiptUploadInput.value = '';
            receiptFileNameSpan.textContent = 'No file chosen';
            receiptPreview.style.display = 'none';
            receiptPreview.src = '';
        });
        cancelJCoinRequestButton?.addEventListener('click', () => {
            jcoinRequestModal?.classList.remove('active');
        });
        submitJCoinRequestButton?.addEventListener('click', handleSubmitJCoinRequest);

        nairaAmountInput?.addEventListener('input', updateCalculatedJCoins);
        receiptUploadInput?.addEventListener('change', displayReceiptPreview);

        // Report User Modal Listeners (dynamic buttons will need separate listeners)
        reportUserButton?.addEventListener('click', () => {
            if (displayedUserProfileData) {
                reportedUsernameDisplay.textContent = displayedUserProfileData.username;
                reportUserModal?.classList.add('active');
            }
        });
        cancelReportButton?.addEventListener('click', () => {
            reportUserModal?.classList.remove('active');
        });
        submitReportButton?.addEventListener('click', handleSubmitReport);

        // Listen for changes on customization selects to update profile immediately
        profileFrameSelect?.addEventListener('change', applyProfileCustomizations);
        chatBubbleStyleSelect?.addEventListener('change', applyProfileCustomizations);
        profileThemeSelect?.addEventListener('change', (event) => {
            applyProfileCustomizations();
            // Also update body class for theme
            const selectedTheme = event.target.value;
            document.body.classList.remove('theme-light-mode', 'theme-dark-mode', 'theme-glass-mode', 'theme-sunset-mode');
            if (selectedTheme !== 'default') {
                document.body.classList.add(selectedTheme);
            }
        });

        // --- Functions ---

        /**
         * Toggles loading state for buttons.
         * @param {HTMLElement} button - The button element.
         * @param {boolean} isLoading - Whether the button should be in loading state.
         */
        function toggleButtonLoading(button, isLoading) {
            if (button) {
                if (isLoading) {
                    button.classList.add('loading');
                    button.disabled = true;
                } else {
                    button.classList.remove('loading');
                    button.disabled = false;
                }
            }
        }

        /**
         * Displays a temporary message box.
         * @param {string} message - The message to display.
         * @param {string} type - 'success', 'error', 'warning', 'info', 'loading'.
         * @param {boolean} persistent - If true, message won't disappear automatically.
         */
        function showMessageBox(message, type = 'info', persistent = false) {
            if (!messageBox) return;

            // Clear previous states
            messageBox.classList.remove('show', 'success', 'error', 'warning', 'info', 'loading');
            messageBox.textContent = message;

            // Apply new state
            messageBox.classList.add('show', type);

            if (!persistent) {
                setTimeout(() => {
                    messageBox.classList.remove('show');
                }, 3000); // Message disappears after 3 seconds
            }
        }

        /**
         * Handles user logout.
         */
        async function handleLogout() {
            try {
                await signOut(auth);
                console.log("JCHAT_DEBUG: User signed out.");
                window.location.href = '/login.html'; // Redirect to login page
            } catch (error) {
                console.error("JCHAT_ERROR: Error signing out:", error);
                showMessageBox(`Logout failed: ${error.message}`, 'error');
            }
        }

        /**
         * Displays user profile picture or placeholder.
         * @param {HTMLImageElement} imgElement - The img element for the profile picture.
         * @param {HTMLElement} iconElement - The icon element for the placeholder.
         * @param {string|null} photoURL - The URL of the profile picture.
         * @param {string} initial - User's display name initial for placeholder.
         * @param {string} cloudinaryTransformations - Cloudinary transformations string.
         */
        function displayProfilePicture(imgElement, iconElement, photoURL, initial, cloudinaryTransformations = "") {
            if (!imgElement || !iconElement) return;

            if (photoURL) {
                let transformedURL = photoURL;
                if (photoURL.includes("res.cloudinary.com") && cloudinaryTransformations) {
                    // Insert transformations after /upload/ in Cloudinary URL
                    const parts = photoURL.split('/upload/');
                    if (parts.length > 1) {
                        transformedURL = `${parts[0]}/upload/${cloudinaryTransformations}/${parts[1]}`;
                    }
                }
                imgElement.src = transformedURL;
                imgElement.style.display = 'block';
                iconElement.style.display = 'none';
            } else {
                imgElement.src = ''; // Clear image source
                imgElement.style.display = 'none';
                iconElement.style.display = 'block';
                // For a more dynamic placeholder, you could set text content here if it were a div
                // For Font Awesome icon, simply ensuring it's visible is enough
            }
        }

        /**
         * Updates the header UI based on the current user.
         * @param {Object} user - The Firebase user object.
         */
        async function updateHeaderUI(user) {
            if (!headerDisplayName || !headerProfilePic || !headerAvatarIcon) return; // Ensure elements exist

            try {
                if (user) {
                    const publicProfileDocRef = doc(db, "public_user_profiles", user.uid);
                    const privateProfileDocRef = doc(db, "user_profiles", user.uid); // Fetch private for full data
                    let profileData = null;

                    const publicSnap = await getDoc(publicProfileDocRef);
                    const privateSnap = await getDoc(privateProfileDocRef);

                    if (privateSnap.exists()) {
                        profileData = privateSnap.data();
                        // Ensure createdAt is a Timestamp (not a Timestamp)
                        if (!profileData.createdAt || typeof profileData.createdAt.toDate !== 'function') {
                            console.warn("JCHAT_WARN: Private user_profile createdAt is missing or malformed. Attempting to fix.");
                            await updateDoc(privateProfileDocRef, { createdAt: serverTimestamp() });
                            // Re-fetch to get the correct Timestamp object
                            const updatedSnap = await getDoc(privateProfileDocRef);
                            profileData.createdAt = updatedSnap.data().createdAt;
                        }

                        // Ensure 'gas' field exists, initialize if not
                        if (profileData.gas === undefined) {
                            console.log("JCHAT_DEBUG: 'gas' field missing in profile, initializing to 0.");
                            await updateDoc(privateProfileDocRef, { gas: 0 });
                            profileData.gas = 0;
                        }
                        // Ensure 'totalGasEarned' field exists, initialize if not
                        if (profileData.totalGasEarned === undefined) {
                            console.log("JCHAT_DEBUG: 'totalGasEarned' field missing in profile, initializing to 0.");
                            await updateDoc(privateProfileDocRef, { totalGasEarned: 0 });
                            profileData.totalGasEarned = 0;
                        }
                        // Ensure 'level' field exists, initialize if not
                        if (profileData.level === undefined) {
                            console.log("JCHAT_DEBUG: 'level' field missing in profile, initializing to 1.");
                            await updateDoc(privateProfileDocRef, { level: 1 });
                            profileData.level = 1;
                        }
                        if (profileData.walletUnlocked === undefined) { // NEW: Initialize walletUnlocked
                            console.log("JCHAT_DEBUG: 'walletUnlocked' field missing in profile, initializing to false.");
                            await updateDoc(privateProfileDocRef, { walletUnlocked: false });
                            profileData.walletUnlocked = false;
                        }
                        if (profileData.unlockedBenefits === undefined) { // NEW: Initialize unlockedBenefits
                            console.log("JCHAT_DEBUG: 'unlockedBenefits' field missing in profile, initializing to [].");
                            await updateDoc(privateProfileDocRef, { unlockedBenefits: [] });
                            profileData.unlockedBenefits = [];
                        }
                        if (profileData.lastDailyBonusClaimDate === undefined) { // Removed: Initialize lastDailyBonusClaimDate
                            // console.log("JCHAT_DEBUG: 'lastDailyBonusClaimDate' missing, initializing to null.");
                            // await updateDoc(privateProfileDocRef, { lastDailyBonusClaimDate: null });
                            // profileData.lastDailyBonusClaimDate = null;
                        }

                        // NEW: Initialize additional profile fields
                        if (profileData.school === undefined) {
                            await updateDoc(privateProfileDocRef, { school: "" });
                            profileData.school = "";
                        }
                        if (profileData.work === undefined) {
                            await updateDoc(privateProfileDocRef, { work: "" });
                            profileData.work = "";
                        }
                        if (profileData.interests === undefined) {
                            await updateDoc(privateProfileDocRef, { interests: "" });
                            profileData.interests = "";
                        }
                        if (profileData.website === undefined) {
                            await updateDoc(privateProfileDocRef, { website: "" });
                            profileData.website = "";
                        }
                        if (profileData.socialLinks === undefined) {
                            await updateDoc(privateProfileDocRef, { socialLinks: "" });
                            profileData.socialLinks = "";
                        }
                        if (profileData.profileFrame === undefined) {
                            await updateDoc(privateProfileDocRef, { profileFrame: "default" });
                            profileData.profileFrame = "default";
                        } // NEW
                        if (profileData.chatBubbleStyle === undefined) {
                            await updateDoc(privateProfileDocRef, { chatBubbleStyle: "default" });
                            profileData.chatBubbleStyle = "default";
                        } // NEW
                        if (profileData.profileTheme === undefined) {
                            await updateDoc(privateProfileDocRef, { profileTheme: "default" });
                            profileData.profileTheme = "default";
                        } // NEW


                        console.log("JCHAT_DEBUG: Fetched existing profile data for header:", profileData);
                    } else {
                        // If private profile doesn't exist, create a basic one
                        profileData = {
                            username: user.displayName || `User_${user.uid.substring(0, 8)}`,
                            email: user.email || "",
                            profilePicId: user.photoURL || null,
                            bio: "",
                            location: "",
                            school: "", // NEW
                            work: "", // NEW
                            interests: "", // NEW
                            website: "", // NEW
                            socialLinks: "", // NEW
                            friendsCount: 0,
                            followersCount: 0,
                            followingCount: 0,
                            createdAt: serverTimestamp(),
                            updatedAt: serverTimestamp(),
                            inspirationType: "motivational",
                            visibility: {
                                displayName: true,
                                profilePic: true,
                                bio: false,
                                location: false,
                                emailPublic: false,
                                lastOnline: false,
                                allowFriendRequests: true,
                                allowMessages: true,
                                school: false,
                                work: false,
                                interests: false,
                                website: false,
                                socialLinks: false // NEW visibility defaults
                            },
                            totalPosts: 0,
                            jCoins: 0, // Initialize jCoins
                            gas: 0, // Initialize GAS
                            totalGasEarned: 0, // Initialize totalGasEarned
                            level: 1, // Initialize level
                            walletUnlocked: false, // NEW: Default to locked wallet
                            unlockedBenefits: [], // NEW: Initialize unlockedBenefits
                            lastDailyBonusClaimDate: null, // Removed: Initialize daily bonus claim date
                            profileFrame: "default", // NEW
                            chatBubbleStyle: "default", // NEW
                            profileTheme: "default", // NEW
                        };
                        await setDoc(privateProfileDocRef, profileData);
                        console.log("JCHAT_DEBUG: Created new profile data for header:", profileData);

                        // Also create/update public profile
                        await setDoc(publicProfileDocRef, {
                            username: profileData.username,
                            profilePicId: profileData.profilePicId,
                            bio: profileData.bio,
                            location: profileData.location,
                            school: profileData.school, // NEW
                            work: profileData.work, // NEW
                            interests: profileData.interests, // NEW
                            website: profileData.website, // NEW
                            socialLinks: profileData.socialLinks, // NEW
                            createdAt: profileData.createdAt,
                            updatedAt: profileData.updatedAt,
                            visibility: profileData.visibility,
                            totalPosts: profileData.totalPosts,
                            level: profileData.level, // Include level in public profile
                            totalGasEarned: profileData.totalGasEarned, // Include totalGasEarned in public profile
                            profileFrame: profileData.profileFrame, // NEW: Public profile also needs customization info
                            chatBubbleStyle: profileData.chatBubbleStyle, // NEW
                            profileTheme: profileData.profileTheme, // NEW
                        }, { merge: true });
                    }

                    // Store current user's profile data globally
                    currentUserProfileData = profileData;

                    // Update header UI
                    const usernameInitial = (profileData.username || "J").charAt(0).toUpperCase();
                    displayProfilePicture(headerProfilePic, headerAvatarIcon, profileData?.profilePicId, usernameInitial, "w_70,h_70,c_fill,g_face,r_max");
                    headerDisplayName.textContent = profileData.username || "JCHAT User";
                    if (headerNavLinkProfile) headerNavLinkProfile.href = `/profile.html?userId=${user.uid}`; // Ensure header nav link is correct, null check

                    // Show Admin Icon if current user is admin
                    if (adminIconLink) { // Null check
                        if (user.uid === ADMIN_UID) {
                            adminIconLink.style.display = 'block';
                        } else {
                            adminIconLink.style.display = 'none';
                        }
                    }
                } else {
                    // Not logged in
                    if (headerDisplayName) headerDisplayName.textContent = "Guest"; // Null check
                    if (headerProfilePic) headerProfilePic.style.display = 'none'; // Null check
                    if (headerAvatarIcon) headerAvatarIcon.style.display = 'block'; // Null check
                    if (adminIconLink) adminIconLink.style.display = 'none'; // Ensure admin icon is hidden, null check
                }
            } catch (error) {
                console.error("JCHAT_ERROR: Error fetching or creating profile for header:", error);
                const usernameInitial = (user.displayName || "J").charAt(0).toUpperCase();
                displayProfilePicture(headerProfilePic, headerAvatarIcon, user.photoURL, usernameInitial, "w_70,h_70,c_fill,g_face,r_max");
                if (headerDisplayName) headerDisplayName.textContent = user.displayName || "JCHAT User"; // Null check
                showMessageBox(`Error loading header profile: ${error.message}`, 'error');
            }
        }

        /**
         * Fetches and displays the notification count for the current user.
         * @param {string} userId - The UID of the current user.
         */
        async function fetchNotificationCount(userId) {
            if (!notificationBadge) return;
            try {
                const notificationsRef = collection(db, `users/${userId}/notifications`);
                const q = query(notificationsRef, where("read", "==", false));
                const querySnapshot = await getDocs(q);
                const unreadCount = querySnapshot.size;

                if (unreadCount > 0) {
                    notificationBadge.textContent = unreadCount.toString();
                    notificationBadge.style.display = 'flex';
                } else {
                    notificationBadge.style.display = 'none';
                }
            } catch (error) {
                console.error("JCHAT_ERROR: Error fetching notification count:", error);
                // Optionally hide badge on error
                if (notificationBadge) notificationBadge.style.display = 'none';
            }
        }


        /**
         * Handles the profile page load, determining which profile to display.
         */
        async function handleProfileLoad() {
            const urlParams = new URLSearchParams(window.location.search);
            const userIdFromUrl = urlParams.get('userId');

            if (currentUser) {
                if (userIdFromUrl && userIdFromUrl !== currentUser.uid) {
                    // Displaying another user's profile
                    displayedUserId = userIdFromUrl;
                    await fetchAndDisplayUserProfile(userIdFromUrl, false); // Fetch public profile
                } else {
                    // Displaying current user's own profile
                    displayedUserId = currentUser.uid;
                    await fetchAndDisplayUserProfile(currentUser.uid, true); // Fetch full profile for owner
                }
            } else {
                // Not logged in, and no specific user ID requested, or invalid user ID
                displayedUserId = null;
                if (profileUsername) profileUsername.textContent = "Please Log In"; // Null check
                if (profileBio) profileBio.textContent = "Log in to view your profile or search for other users."; // Null check
                if (profileActionsDiv) profileActionsDiv.innerHTML = ''; // Clear actions, null check

                // Hide inline edit fields and account settings
                const profileDetailsSection = displayNameInput ? displayNameInput.closest('.profile-details-section') : null; // Null check
                if (profileDetailsSection) {
                    profileDetailsSection.style.display = 'none';
                }
                if (userPostsFeed) userPostsFeed.style.display = 'none'; // Hide user posts, null check
                if (toggleAccountSettingsButton) toggleAccountSettingsButton.style.display = 'none'; // NEW: Hide toggle button
                if (accountSettingsSection) accountSettingsSection.style.display = 'none'; // NEW: Hide account settings

                // Hide all new sections as well
                if (unlockedRewardsSection) unlockedRewardsSection.style.display = 'none';
                if (friendsSnippetSection) friendsSnippetSection.style.display = 'none';
                if (recentActivitySection) recentActivitySection.style.display = 'none';
                if (profileFrameSelect) profileFrameSelect.closest('.customization-option').style.display = 'none';
                if (chatBubbleStyleSelect) chatBubbleStyleSelect.closest('.customization-option').style.display = 'none';
                if (profileThemeSelect) profileThemeSelect.closest('.customization-option').style.display = 'none';
                if (saveCustomizationButton) saveCustomizationButton.style.display = 'none';
                if (savePrivacySettingsButton) savePrivacySettingsButton.style.display = 'none';
                if (toggleEmailVisibility) toggleEmailVisibility.closest('.privacy-toggle-group').style.display = 'none';
                if (toggleLocationVisibility) toggleLocationVisibility.closest('.privacy-toggle-group').style.display = 'none';
                if (toggleOnlineStatusVisibility) toggleOnlineStatusVisibility.closest('.privacy-toggle-group').style.display = 'none';
                if (toggleFriendRequests) toggleFriendRequests.closest('.privacy-toggle-group').style.display = 'none';
                if (toggleMessages) toggleMessages.closest('.privacy-toggle-group').style.display = 'none';
                if (toggleSchoolVisibility) toggleSchoolVisibility.closest('.privacy-toggle-group').style.display = 'none';
                if (toggleWorkVisibility) toggleWorkVisibility.closest('.privacy-toggle-group').style.display = 'none';
                if (toggleInterestsVisibility) toggleInterestsVisibility.closest('.privacy-toggle-group').style.display = 'none';
                if (toggleWebsiteVisibility) toggleWebsiteVisibility.closest('.privacy-toggle-group').style.display = 'none';
                if (toggleSocialLinksVisibility) toggleSocialLinksVisibility.closest('.privacy-toggle-group').style.display = 'none';


                showMessageBox("Please log in to view profiles.", 'info', true);
            }
            if (currentUser) {
                fetchNotificationCount(currentUser.uid); // Fetch notifications for logged-in user
            }
        }

        /**
         * Fetches and displays a user's profile data.
         * Determines if it's the current user's profile or another user's.
         * @param {string} userIdToDisplay - The UID of the user whose profile should be displayed.
         * @param {boolean} isCurrentUserProfile - True if displaying the current user's profile.
         */
        async function fetchAndDisplayUserProfile(userIdToDisplay, isCurrentUserProfile = false) {
            let profileDocRef;
            if (isCurrentUserProfile) {
                profileDocRef = doc(db, "user_profiles", userIdToDisplay); // Private profile for owner
            } else {
                profileDocRef = doc(db, "public_user_profiles", userIdToDisplay); // Public profile for others
            }

            try {
                const profileSnap = await getDoc(profileDocRef);

                if (!profileSnap.exists()) {
                    showMessageBox("User profile not found.", 'error');
                    if (profileUsername) profileUsername.textContent = "User Not Found";
                    if (profileBio) profileBio.textContent = "";
                    if (profileActionsDiv) profileActionsDiv.innerHTML = '';
                    if (toggleAccountSettingsButton) toggleAccountSettingsButton.style.display = 'none'; // Hide if no profile
                    if (accountSettingsSection) accountSettingsSection.style.display = 'none'; // Hide if no profile
                    if (unlockedRewardsSection) unlockedRewardsSection.style.display = 'none';
                    if (friendsSnippetSection) friendsSnippetSection.style.display = 'none';
                    if (recentActivitySection) recentActivitySection.style.display = 'none';
                    if (walletGuideSection) walletGuideSection.style.display = 'none';
                    if (userPostsFeed) userPostsFeed.style.display = 'none';
                    return;
                }

                displayedUserProfileData = profileSnap.data();
                console.log("JCHAT_DEBUG: Displaying profile data:", displayedUserProfileData);

                const visibility = displayedUserProfileData.visibility || {}; // Ensure visibility object exists

                // Set profile picture or placeholder
                const usernameInitial = (displayedUserProfileData.username || "J").charAt(0).toUpperCase();
                if (profilePic) {
                    if (visibility.profilePic) {
                        profilePic.closest('.profile-pic-wrapper')?.classList.toggle('owner', isCurrentUserProfile);
                        displayProfilePicture(profilePic, profilePicPlaceholder, displayedUserProfileData.profilePicId, usernameInitial, "w_240,h_240,c_fill,g_face,r_max");
                    } else {
                        profilePic.style.display = 'none';
                        if (profilePicPlaceholder) profilePicPlaceholder.style.display = 'block';
                    }
                }

                // Populate basic profile info
                if (profileUsername) profileUsername.textContent = visibility.displayName ? (displayedUserProfileData.username || "N/A") : "Private User";
                if (profileBio) profileBio.textContent = visibility.bio ? (displayedUserProfileData.bio || "No bio yet.") : "Bio is private.";
                if (profileLocation) profileLocation.querySelector('span').textContent = visibility.location ? (displayedUserProfileData.location || "N/A") : "Private";
                if (profileEmail) profileEmail.querySelector('span').textContent = visibility.emailPublic ? (displayedUserProfileData.email || "N/A") : "Private";

                // Update friends and posts count from profileData
                if (friendsCountSpan) friendsCountSpan.textContent = (displayedUserProfileData.friendsCount || 0).toLocaleString();
                if (postsCountSpan) postsCountSpan.textContent = (displayedUserProfileData.totalPosts || 0).toLocaleString();
                if (jCoinsBalanceSpan) jCoinsBalanceSpan.textContent = (displayedUserProfileData.jCoins || 0).toLocaleString(); // Update JCoins


                // XP Level Display
                const level = displayedUserProfileData.level || 1;
                const totalGasEarned = displayedUserProfileData.totalGasEarned || 0;
                const { name, icon, xpNeededForNextLevel, progressPercentage, otherRewards } = calculateLevelInfo(level, totalGasEarned);

                if (xpLevelIcon) xpLevelIcon.className = `profile-level-icon ${icon}`;
                if (xpLevelName) xpLevelName.textContent = name;
                if (xpProgressText) xpProgressText.textContent = `XP for next level: ${xpNeededForNextLevel.toLocaleString()}`;

                // Set background-position for the gradient fill
                // When progressPercentage is 0, background-position is right (0% of the gradient shown)
                // When progressPercentage is 100, background-position is left (100% of the gradient shown)
                const backgroundPosition = 100 - progressPercentage; // Invert for background-position: left to right fill
                if (xpProgressBarFill) { // Null check for xpProgressBarFill
                    xpProgressBarFill.style.backgroundPosition = `${backgroundPosition}% 0`; // Set background-position
                    xpProgressBarFill.style.width = `100%`; // Ensure width is always 100%
                }

                // Action Buttons and Inline Edit Fields
                if (isCurrentUserProfile) {
                    if (walletLink) walletLink.style.display = 'inline-flex'; // Null check
                    if (requestJCoinsButton) requestJCoinsButton.style.display = 'inline-flex'; // Show Request JCoins button for owner, null check
                    // if (claimDailyBonusButton) claimDailyBonusButton.style.display = 'inline-flex'; // Removed: Show daily bonus button
                    // updateDailyBonusUI(); // Removed: Update daily bonus UI

                    // Wallet Link Logic (only for owner)
                    if (walletLink && walletLockedMessage) { // Null check
                        walletLink.style.display = 'inline-flex';
                        if (displayedUserProfileData.walletUnlocked) {
                            walletLink.classList.remove('disabled-link');
                            walletLockedMessage.style.display = 'none';
                            if (walletLink.querySelector('.padlock-icon')) { // Null check for inner icon
                                walletLink.querySelector('.padlock-icon').classList.remove('fa-lock');
                                walletLink.querySelector('.padlock-icon').classList.add('fa-unlock-alt');
                            }
                        } else {
                            walletLink.classList.add('disabled-link');
                            walletLockedMessage.style.display = 'block';
                            if (walletLink.querySelector('.padlock-icon')) { // Null check for inner icon
                                walletLink.querySelector('.padlock-icon').classList.add('fa-lock');
                                walletLink.querySelector('.padlock-icon').classList.remove('fa-unlock-alt');
                            }
                        }
                    }

                    // Show inline edit fields and account settings for owner
                    const profileDetailsSection = displayNameInput ? displayNameInput.closest('.profile-details-section') : null; // Null check
                    if (profileDetailsSection) {
                        profileDetailsSection.style.display = 'flex';
                    }

                    // Populate inline edit fields
                    if (displayNameInput) displayNameInput.value = displayedUserProfileData.username || ""; // Null check
                    if (bioTextarea) bioTextarea.value = displayedUserProfileData.bio || ""; // Null check
                    if (locationInput) locationInput.value = displayedUserProfileData.location || ""; // Null check
                    if (schoolInput) schoolInput.value = displayedUserProfileData.school || ""; // NEW
                    if (workInput) workInput.value = displayedUserProfileData.work || ""; // NEW
                    if (interestsInput) interestsInput.value = displayedUserProfileData.interests || ""; // NEW
                    if (websiteInput) websiteInput.value = displayedUserProfileData.website || ""; // NEW
                    if (socialLinksInput) socialLinksInput.value = displayedUserProfileData.socialLinks || ""; // NEW

                    // Populate privacy toggles
                    if (toggleEmailVisibility) toggleEmailVisibility.checked = visibility.emailPublic ?? false;
                    if (toggleLocationVisibility) toggleLocationVisibility.checked = visibility.location ?? false;
                    if (toggleOnlineStatusVisibility) toggleOnlineStatusVisibility.checked = visibility.lastOnline ?? false;
                    if (toggleFriendRequests) toggleFriendRequests.checked = visibility.allowFriendRequests ?? true;
                    if (toggleMessages) toggleMessages.checked = visibility.allowMessages ?? true;
                    if (toggleSchoolVisibility) toggleSchoolVisibility.checked = visibility.school ?? false; // NEW
                    if (toggleWorkVisibility) toggleWorkVisibility.checked = visibility.work ?? false; // NEW
                    if (toggleInterestsVisibility) toggleInterestsVisibility.checked = visibility.interests ?? false; // NEW
                    if (toggleWebsiteVisibility) toggleWebsiteVisibility.checked = visibility.website ?? false; // NEW
                    if (toggleSocialLinksVisibility) toggleSocialLinksVisibility.checked = visibility.socialLinks ?? false; // NEW

                    // Show privacy toggles and save button
                    if (toggleEmailVisibility) toggleEmailVisibility.closest('.privacy-toggle-group').style.display = 'flex';
                    if (toggleLocationVisibility) toggleLocationVisibility.closest('.privacy-toggle-group').style.display = 'flex';
                    if (toggleOnlineStatusVisibility) toggleOnlineStatusVisibility.closest('.privacy-toggle-group').style.display = 'flex';
                    if (toggleFriendRequests) toggleFriendRequests.closest('.privacy-toggle-group').style.display = 'flex';
                    if (toggleMessages) toggleMessages.closest('.privacy-toggle-group').style.display = 'flex';
                    if (toggleSchoolVisibility) toggleSchoolVisibility.closest('.privacy-toggle-group').style.display = 'flex';
                    if (toggleWorkVisibility) toggleWorkVisibility.closest('.privacy-toggle-group').style.display = 'flex';
                    if (toggleInterestsVisibility) toggleInterestsVisibility.closest('.privacy-toggle-group').style.display = 'flex';
                    if (toggleWebsiteVisibility) toggleWebsiteVisibility.closest('.privacy-toggle-group').style.display = 'flex';
                    if (toggleSocialLinksVisibility) toggleSocialLinksVisibility.closest('.privacy-toggle-group').style.display = 'flex';
                    if (savePrivacySettingsButton) savePrivacySettingsButton.style.display = 'inline-flex'; //

                    // Populate customization selects
                    if (profileFrameSelect) profileFrameSelect.value = displayedUserProfileData.profileFrame || 'default';
                    if (chatBubbleStyleSelect) chatBubbleStyleSelect.value = displayedUserProfileData.chatBubbleStyle || 'default';
                    if (profileThemeSelect) profileThemeSelect.value = displayedUserProfileData.profileTheme || 'default';

                    // Show customization options and save button
                    if (profileFrameSelect) profileFrameSelect.closest('.customization-option').style.display = 'flex';
                    if (chatBubbleStyleSelect) chatBubbleStyleSelect.closest('.customization-option').style.display = 'flex';
                    if (profileThemeSelect) profileThemeSelect.closest('.customization-option').style.display = 'flex';
                    if (saveCustomizationButton) saveCustomizationButton.style.display = 'inline-flex';

                    // Apply current theme to body
                    const currentTheme = displayedUserProfileData.profileTheme;
                    document.body.classList.remove('theme-light-mode', 'theme-dark-mode', 'theme-glass-mode', 'theme-sunset-mode');
                    if (currentTheme && currentTheme !== 'default') {
                        document.body.classList.add(currentTheme);
                    }


                    // Fetch and display unlocked benefits
                    await fetchUnlockedBenefits(userIdToDisplay, displayedUserProfileData.unlockedBenefits);
                    if (unlockedRewardsSection) unlockedRewardsSection.style.display = 'block';

                    // Fetch and display friends snippet
                    await fetchFriendsSnippet(userIdToDisplay);
                    if (friendsSnippetSection) friendsSnippetSection.style.display = 'block';

                    // Fetch and display recent activity
                    await fetchRecentActivity(userIdToDisplay);
                    if (recentActivitySection) recentActivitySection.style.display = 'block';

                    // Show wallet guide if wallet is unlocked
                    if (displayedUserProfileData.walletUnlocked && walletGuideSection) {
                        walletGuideSection.style.display = 'block';
                    } else if (walletGuideSection) {
                        walletGuideSection.style.display = 'none';
                    }

                    // Show user's own posts feed
                    await fetchAndDisplayUserPosts(userIdToDisplay, displayedUserProfileData.username);
                    if (userPostsFeed) userPostsFeed.style.display = 'block';

                } else {
                    // Not current user's profile - hide editing options and show relevant action buttons
                    if (profilePic) profilePic.closest('.profile-pic-wrapper')?.classList.remove('owner');
                    if (requestJCoinsButton) requestJCoinsButton.style.display = 'none'; // Hide request JCoins for others
                    // if (claimDailyBonusButton) claimDailyBonusButton.style.display = 'none'; // Removed: Hide daily bonus for others
                    if (walletLink) walletLink.style.display = 'none'; // Hide wallet for others

                    const profileDetailsSection = displayNameInput ? displayNameInput.closest('.profile-details-section') : null;
                    if (profileDetailsSection) {
                        profileDetailsSection.style.display = 'none';
                    }
                    if (toggleAccountSettingsButton) toggleAccountSettingsButton.style.display = 'none';
                    if (accountSettingsSection) accountSettingsSection.style.display = 'none';

                    // Hide new sections for other users
                    if (unlockedRewardsSection) unlockedRewardsSection.style.display = 'none';
                    if (friendsSnippetSection) friendsSnippetSection.style.display = 'none';
                    if (recentActivitySection) recentActivitySection.style.display = 'none';
                    if (walletGuideSection) walletGuideSection.style.display = 'none';

                    // Show user's posts feed if not private
                    if (userPostsFeed) userPostsFeed.style.display = 'block';
                    await fetchAndDisplayUserPosts(userIdToDisplay, displayedUserProfileData.username);

                    // Render action buttons (Add Friend, Message, Report, etc.)
                    await renderProfileActions(userIdToDisplay, displayedUserProfileData);
                }
                applyProfileCustomizations(displayedUserProfileData);

            } catch (error) {
                console.error("JCHAT_ERROR: Error fetching and displaying user profile:", error);
                showMessageBox(`Failed to load profile: ${error.message}`, 'error');
                if (profileUsername) profileUsername.textContent = "Error Loading Profile";
                if (profileBio) profileBio.textContent = "Please try again later.";
            }
        }

        /**
         * Calculates level information based on total GAS earned.
         * @param {number} level - Current level.
         * @param {number} totalGasEarned - Total GAS (XP) earned.
         * @returns {Object} Level name, icon, XP needed for next level, and progress percentage.
         */
        function calculateLevelInfo(level, totalGasEarned) {
            const baseXP = 100; // XP needed for Level 2
            const growthFactor = 1.15; // How much XP requirement increases per level

            let xpForCurrentLevel = 0;
            if (level > 1) {
                xpForCurrentLevel = baseXP * ((Math.pow(growthFactor, level - 1) - 1) / (growthFactor - 1));
            }
            xpForCurrentLevel = Math.round(xpForCurrentLevel);

            let xpForNextLevel = baseXP * Math.pow(growthFactor, level - 1);
            xpForNextLevel = Math.round(xpForNextLevel);

            const xpEarnedInCurrentLevel = totalGasEarned - xpForCurrentLevel;
            const progressPercentage = (xpEarnedInCurrentLevel / xpForNextLevel) * 100;

            const levelNames = [ //
                "Newbie", "Apprentice", "Journeyman", "Adept", "Veteran", "Expert", "Master", "Grandmaster",
                "Legend", "Mythic", "Champion", "Hero", "Elite", "Savvy", "Pioneer", "Communicator", "Socialite",
                "Networker", "Influencer", "Trendsetter", "Innovator", "Creator", "Visionary", "Architect",
                "Maestro", "Strategist", "Guardian", "Champion", "Hero", "Legend", "Mythic", "Celestial", "Divine", "Transcendent", "Cosmic Being"
            ];

            const levelIcons = [ //
                "fas fa-leaf", "fas fa-seedling", "fas fa-user-graduate", "fas fa-map-marker-alt", "fas fa-compass",
                "fas fa-comments", "fas fa-users", "fas fa-share-alt", "fas fa-star", "fas fa-fire",
                "fas fa-lightbulb", "fas fa-paint-brush", "fas fa-eye", "fas fa-building", "fas fa-music",
                "fas fa-chess", "fas fa-shield-alt", "fas fa-trophy", "fas fa-mask", "fas fa-dragon",
                "fas fa-meteor", "fas fa-galaxy", "fas fa-hand-sparkles", "fas fa-infinity", "fas fa-atom"
            ];

            const name = levelNames[level - 1] || `Level ${level}`; //
            const icon = levelIcons[level - 1] || "fas fa-question-circle"; //

            // Determine other rewards based on level
            const otherRewards = [];
            if (level === 1) otherRewards.push("Badge: 'Newbie'");
            if (level === 3) otherRewards.push("Unlock: 1-Hour XP Boost");
            if (level === 5) otherRewards.push("Badge: 'Chat Starter'", "Unlock: Basic Profile Picture Frame");
            if (level === 8) otherRewards.push("Unlock: Common Emote Pack (Set 1)");
            if (level === 10) otherRewards.push("Title: 'Friendly Face'", "Increased Message Character Limit (+10)");
            if (level === 13) otherRewards.push("Unlock: Rare Chat Bubble Style (Set 1)");
            if (level === 15) otherRewards.push("Badge: 'Community Contributor'", "Unlock: Advanced Profile Picture Frame");
            if (level === 18) otherRewards.push("Unlock: Epic Emote Pack (Set 1)");
            if (level === 20) otherRewards.push("Title: 'Digital Diplomat'", "Unlock: Exclusive Chat Bubble Style (Set 1)");
            if (level === 25) otherRewards.push("Unlock: Profile Theme (Light Mode)", "Unlock: Profile Theme (Dark Mode)");
            if (level === 30) otherRewards.push("Badge: 'JCHAT Veteran'", "Increased Daily JCoin Bonus");
            if (level === 35) otherRewards.push("Unlock: Legendary Profile Picture Frame", "Unlock: Legendary Emote Pack (Set 1)");
            if (level === 40) otherRewards.push("Title: 'Master Creator'", "Unlock: Custom Profile Frame Slot");
            if (level === 50) otherRewards.push("Badge: 'JCHAT Legend'", "Unlock: Animated Profile Picture Frame");
            if (level === 75) otherRewards.push("Title: 'Cosmic Converser'", "Unlock: Custom Chat Bubble Style Slot");
            if (level === 100) otherRewards.push("Grand Badge: 'Transcendent User'", "Unlock: Custom Profile Theme Slot");


            return { name, icon, xpNeededForNextLevel: xpForNextLevel - xpEarnedInCurrentLevel, progressPercentage, otherRewards };
        }

        /**
         * Handles the profile picture upload.
         */
        async function handleProfilePicUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                showMessageBox("No file selected.", 'warning');
                return;
            }
            if (!currentUser) {
                showMessageBox("You must be logged in to upload a profile picture.", 'error');
                return;
            }

            // Show loading spinner
            profilePic.closest('.profile-pic-wrapper')?.classList.add('loading');

            const filePath = `profile_pictures/${currentUser.uid}/${file.name}`;
            const storageRef = ref(storage, filePath);

            try {
                // Upload file to Firebase Storage
                const snapshot = await uploadBytes(storageRef, file);
                console.log('JCHAT_DEBUG: Uploaded a blob or file!', snapshot);

                // Get download URL
                const downloadURL = await getDownloadURL(snapshot.ref);
                console.log('JCHAT_DEBUG: File available at', downloadURL);

                // Upload to Cloudinary using your function (assuming `uploadImageToCloudinary` exists)
                const cloudinaryResponse = await uploadImageToCloudinary(downloadURL); // Assuming it takes a URL or Blob

                if (cloudinaryResponse && cloudinaryResponse.secure_url) {
                    const newProfilePicId = cloudinaryResponse.public_id;
                    const newProfilePicUrl = cloudinaryResponse.secure_url;

                    // Update profile in Firestore with Cloudinary URL
                    const userProfileRef = doc(db, "user_profiles", currentUser.uid);
                    await updateDoc(userProfileRef, { profilePicId: newProfilePicUrl, updatedAt: serverTimestamp() });

                    // Update public profile
                    const publicProfileRef = doc(db, "public_user_profiles", currentUser.uid);
                    await updateDoc(publicProfileRef, { profilePicId: newProfilePicUrl, updatedAt: serverTimestamp() });


                    // Update UI immediately
                    displayProfilePicture(profilePic, profilePicPlaceholder, newProfilePicUrl, currentUser.displayName?.charAt(0) || 'J', "w_240,h_240,c_fill,g_face,r_max");
                    displayProfilePicture(headerProfilePic, headerAvatarIcon, newProfilePicUrl, currentUser.displayName?.charAt(0) || 'J', "w_70,h_70,c_fill,g_face,r_max");

                    showMessageBox("Profile picture updated successfully!", 'success');
                    // Re-fetch and display profile to ensure all data is consistent
                    await fetchAndDisplayUserProfile(currentUser.uid, true);
                } else {
                    showMessageBox("Failed to upload image to Cloudinary.", 'error');
                }

            } catch (error) {
                console.error("JCHAT_ERROR: Error uploading profile picture:", error);
                showMessageBox(`Failed to update profile picture: ${error.message}`, 'error');
            } finally {
                // Hide loading spinner
                profilePic.closest('.profile-pic-wrapper')?.classList.remove('loading');
            }
        }

        /**
         * Helper function to upload an image to Cloudinary.
         * You would typically have a backend endpoint for this to secure your API key.
         * For client-side, you'd use unsigned uploads with an upload preset.
         */
        async function uploadImageToCloudinary(imageFileOrUrl) {
            const formData = new FormData();
            formData.append('file', imageFileOrUrl);
            formData.append('upload_preset', cloudinaryConfig.uploadPreset); // Your unsigned upload preset
            formData.append('cloud_name', cloudinaryConfig.cloudName); // Your Cloudinary cloud name

            try {
                const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/image/upload`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (response.ok) {
                    console.log("Cloudinary Upload Success:", data);
                    return data;
                } else {
                    console.error("Cloudinary Upload Error:", data);
                    throw new Error(data.error?.message || "Cloudinary upload failed.");
                }
            } catch (error) {
                console.error("Error sending to Cloudinary API:", error);
                showMessageBox(`Cloudinary upload error: ${error.message}`, 'error');
                return null;
            }
        }


        /**
         * Handles saving profile details.
         */
        async function handleSaveProfile() {
            if (!currentUser || !isAuthReady || displayedUserId !== currentUser.uid) {
                showMessageBox("You can only edit your own profile.", 'warning');
                return;
            }

            toggleButtonLoading(saveProfileButton, true);
            showMessageBox("Saving profile...", 'loading', true);

            const newDisplayName = displayNameInput.value.trim();
            const newBio = bioTextarea.value.trim();
            const newLocation = locationInput.value.trim();
            const newSchool = schoolInput.value.trim(); // NEW
            const newWork = workInput.value.trim(); // NEW
            const newInterests = interestsInput.value.trim(); // NEW
            const newWebsite = websiteInput.value.trim(); // NEW
            const newSocialLinks = socialLinksInput.value.trim(); // NEW

            try {
                const userProfileRef = doc(db, "user_profiles", currentUser.uid);
                const publicProfileRef = doc(db, "public_user_profiles", currentUser.uid);

                const batch = writeBatch(db);

                // Update private profile
                batch.update(userProfileRef, {
                    username: newDisplayName,
                    bio: newBio,
                    location: newLocation,
                    school: newSchool, // NEW
                    work: newWork, // NEW
                    interests: newInterests, // NEW
                    website: newWebsite, // NEW
                    socialLinks: newSocialLinks, // NEW
                    updatedAt: serverTimestamp()
                });

                // Update public profile (only fields that are public)
                // Note: visibility is handled by handleSavePrivacySettings
                batch.update(publicProfileRef, {
                    username: newDisplayName,
                    bio: newBio,
                    location: newLocation,
                    school: newSchool, // NEW
                    work: newWork, // NEW
                    interests: newInterests, // NEW
                    website: newWebsite, // NEW
                    socialLinks: newSocialLinks, // NEW
                    updatedAt: serverTimestamp()
                });

                await batch.commit();

                // Update current user's Firebase Auth profile display name
                if (currentUser.displayName !== newDisplayName) {
                    await updateProfile(currentUser, { displayName: newDisplayName });
                    console.log("JCHAT_DEBUG: Firebase Auth display name updated.");
                }

                showMessageBox("Profile updated successfully!", 'success');
                // Refresh currentUserProfileData and re-render profile for immediate effect
                const updatedProfileSnap = await getDoc(userProfileRef);
                if (updatedProfileSnap.exists()) {
                    currentUserProfileData = updatedProfileSnap.data();
                    displayedUserProfileData = currentUserProfileData; // Ensure consistency
                    await fetchAndDisplayUserProfile(currentUser.uid, true); // Re-fetch to apply changes
                }
            } catch (error) {
                console.error("JCHAT_ERROR: Error saving profile:", error);
                showMessageBox(`Failed to save profile: ${error.message}`, 'error');
            } finally {
                toggleButtonLoading(saveProfileButton, false);
            }
        }

        /**
         * Handles saving privacy settings.
         */
        async function handleSavePrivacySettings() {
            if (!currentUser || !isAuthReady || displayedUserId !== currentUser.uid) {
                showMessageBox("You can only change privacy settings for your own profile.", 'warning');
                return;
            }

            toggleButtonLoading(savePrivacySettingsButton, true);
            showMessageBox("Saving privacy settings...", 'loading', true);

            try {
                const userProfileRef = doc(db, "user_profiles", currentUser.uid);
                const publicProfileRef = doc(db, "public_user_profiles", currentUser.uid);

                const newVisibility = {
                    displayName: true, // Display name is always public by design
                    profilePic: true, // Profile pic is always public by design
                    emailPublic: toggleEmailVisibility.checked,
                    location: toggleLocationVisibility.checked,
                    lastOnline: toggleOnlineStatusVisibility.checked,
                    allowFriendRequests: toggleFriendRequests.checked,
                    allowMessages: toggleMessages.checked,
                    school: toggleSchoolVisibility.checked, // NEW
                    work: toggleWorkVisibility.checked, // NEW
                    interests: toggleInterestsVisibility.checked, // NEW
                    website: toggleWebsiteVisibility.checked, // NEW
                    socialLinks: toggleSocialLinksVisibility.checked // NEW
                };

                const batch = writeBatch(db);

                // Update private profile
                batch.update(userProfileRef, {
                    visibility: newVisibility,
                    updatedAt: serverTimestamp()
                });

                // Update public profile with new visibility settings
                batch.update(publicProfileRef, {
                    visibility: newVisibility,
                    updatedAt: serverTimestamp()
                });

                await batch.commit();
                showMessageBox("Privacy settings saved successfully!", 'success');

                // Refresh currentUserProfileData and re-render profile for immediate effect
                const updatedProfileSnap = await getDoc(userProfileRef);
                if (updatedProfileSnap.exists()) {
                    currentUserProfileData = updatedProfileSnap.data();
                    displayedUserProfileData = currentUserProfileData; // Ensure consistency
                    // Re-call fetchAndDisplayUserProfile to apply new visibility locally
                    await fetchAndDisplayUserProfile(currentUser.uid);
                }

            } catch (error) {
                console.error("JCHAT_ERROR: Error saving privacy settings:", error);
                showMessageBox(`Failed to save privacy settings: ${error.message}`, 'error');
            } finally {
                toggleButtonLoading(savePrivacySettingsButton, false);
            }
        }

        /**
         * Handles saving customization settings.
         */
        async function handleSaveCustomization() { //
            if (!currentUser || !isAuthReady || displayedUserId !== currentUser.uid) { //
                showMessageBox("You can only customize your own profile.", 'warning'); //
                return; //
            } //

            toggleButtonLoading(saveCustomizationButton, true); //
            showMessageBox("Saving customization...", 'loading', true); //

            try { //
                const newProfileFrame = profileFrameSelect.value; //
                const newChatBubbleStyle = chatBubbleStyleSelect.value; //
                const newProfileTheme = profileThemeSelect.value; //

                // Basic validation: Check if user has unlocked these
                const hasFrame = currentUserProfileData.unlockedBenefits.includes(`Unlock: Profile Frame (${newProfileFrame})`) || newProfileFrame === 'default';
                const hasBubble = currentUserProfileData.unlockedBenefits.includes(`Unlock: Chat Bubble Style (${newChatBubbleStyle})`) || newChatBubbleStyle === 'default';
                const hasTheme = currentUserProfileData.unlockedBenefits.includes(`Unlock: Profile Theme (${newProfileTheme})`) || newProfileTheme === 'default' ||
                                 newProfileTheme === 'theme-light-mode' && currentUserProfileData.unlockedBenefits.includes('Unlock: Profile Theme (Light Mode)') ||
                                 newProfileTheme === 'theme-dark-mode' && currentUserProfileData.unlockedBenefits.includes('Unlock: Profile Theme (Dark Mode)') ||
                                 newProfileTheme === 'theme-glass-mode' && currentUserProfileData.unlockedBenefits.includes('Unlock: Profile Theme (Glass Mode)') ||
                                 newProfileTheme === 'theme-sunset-mode' && currentUserProfileData.unlockedBenefits.includes('Unlock: Profile Theme (Sunset Mode)');


                if (!hasFrame) {
                    showMessageBox(`You have not unlocked the '${newProfileFrame}' profile frame.`, 'warning');
                    return;
                }
                if (!hasBubble) {
                    showMessageBox(`You have not unlocked the '${newChatBubbleStyle}' chat bubble style.`, 'warning');
                    return;
                }
                if (!hasTheme) {
                    showMessageBox(`You have not unlocked the '${newProfileTheme}' profile theme.`, 'warning');
                    return;
                }


                const userProfileRef = doc(db, "user_profiles", currentUser.uid); //
                const publicProfileRef = doc(db, "public_user_profiles", currentUser.uid); //

                const batch = writeBatch(db); //

                batch.update(userProfileRef, { //
                    profileFrame: newProfileFrame, //
                    chatBubbleStyle: newChatBubbleStyle, //
                    profileTheme: newProfileTheme, //
                    updatedAt: serverTimestamp() //
                }); //

                batch.update(publicProfileRef, { //
                    profileFrame: newProfileFrame, //
                    chatBubbleStyle: newChatBubbleStyle, //
                    profileTheme: newProfileTheme, //
                    updatedAt: serverTimestamp() //
                }); //

                await batch.commit(); //
                showMessageBox("Customization saved successfully!", 'success'); //

                // Refresh currentUserProfileData and re-render profile for immediate effect //
                const updatedProfileSnap = await getDoc(userProfileRef); //
                if (updatedProfileSnap.exists()) { //
                    currentUserProfileData = updatedProfileSnap.data(); //
                    displayedUserProfileData = currentUserProfileData; // Ensure consistency //
                    await fetchAndDisplayUserProfile(currentUser.uid, true); // Re-fetch to apply changes //
                } //
            } catch (error) { //
                console.error("JCHAT_ERROR: Error saving customization:", error); //
                showMessageBox(`Failed to save customization: ${error.message}`, 'error'); //
            } finally { //
                toggleButtonLoading(saveCustomizationButton, false); //
            } //
        }

        /**
         * Applies the selected profile customizations (frame, chat bubble, theme).
         * @param {Object} profileData - The profile data containing customization settings.
         */
        function applyProfileCustomizations(profileData = displayedUserProfileData) {
            if (!profileData) return;

            // Apply profile frame
            const profilePicWrapper = profilePic.closest('.profile-pic-wrapper');
            if (profilePicWrapper) {
                // Remove existing frame classes
                profilePicWrapper.classList.forEach(className => {
                    if (className.startsWith('frame-')) {
                        profilePicWrapper.classList.remove(className);
                    }
                });
                if (profileData.profileFrame && profileData.profileFrame !== 'default') {
                    profilePicWrapper.classList.add(`frame-${profileData.profileFrame}`);
                }
            }

            // Apply chat bubble style (placeholder for future implementation)
            // This would typically involve dynamically loading a CSS file or modifying styles for chat messages
            console.log(`Applying chat bubble style: ${profileData.chatBubbleStyle}`);

            // Apply profile theme to body
            const body = document.body;
            body.classList.remove('theme-light-mode', 'theme-dark-mode', 'theme-glass-mode', 'theme-sunset-mode');
            if (profileData.profileTheme && profileData.profileTheme !== 'default') {
                body.classList.add(profileData.profileTheme);
            }
        }


        /**
         * Handles changing the user's password.
         */
        async function handleChangePassword() {
            if (!currentUser) {
                showMessageBox("You must be logged in to change your password.", 'warning');
                return;
            }

            const currentPassword = currentPasswordInput.value;
            const newPassword = newPasswordInput.value;
            const confirmNewPassword = confirmNewPasswordInput.value;

            if (!currentPassword || !newPassword || !confirmNewPassword) {
                showMessageBox("All password fields are required.", 'warning');
                return;
            }
            if (newPassword !== confirmNewPassword) {
                showMessageBox("New password and confirm password do not match.", 'error');
                return;
            }
            if (newPassword.length < 6) {
                showMessageBox("New password must be at least 6 characters long.", 'warning');
                return;
            }

            toggleButtonLoading(changePasswordButton, true);
            showMessageBox("Changing password...", 'loading', true);

            try {
                const credential = EmailAuthProvider.credential(currentUser.email, currentPassword);
                await reauthenticateWithCredential(currentUser, credential);
                await updatePassword(currentUser, newPassword);
                showMessageBox("Password changed successfully!", 'success');
                currentPasswordInput.value = '';
                newPasswordInput.value = '';
                confirmNewPasswordInput.value = '';
            } catch (error) {
                console.error("JCHAT_ERROR: Error changing password:", error);
                if (error.code === 'auth/wrong-password') {
                    showMessageBox("Incorrect current password.", 'error');
                } else if (error.code === 'auth/requires-recent-login') {
                    showMessageBox("Please log out and log in again to change your password.", 'warning');
                } else {
                    showMessageBox(`Failed to change password: ${error.message}`, 'error');
                }
            } finally {
                toggleButtonLoading(changePasswordButton, false);
            }
        }

        /**
         * Handles deleting the user's account.
         */
        async function handleDeleteAccount() {
            if (!currentUser) {
                showMessageBox("You must be logged in to delete your account.", 'warning');
                return;
            }

            if (!confirm("Are you sure you want to delete your account? This action is irreversible.")) {
                return;
            }

            toggleButtonLoading(deleteAccountButton, true);
            showMessageBox("Deleting account...", 'loading', true);

            try {
                // Optional: Re-authenticate user before deletion for security
                // const password = prompt("Please enter your password to confirm account deletion:");
                // if (!password) { showMessageBox("Deletion cancelled.", 'info'); return; }
                // const credential = EmailAuthProvider.credential(currentUser.email, password);
                // await reauthenticateWithCredential(currentUser, credential);

                // Delete user's Firestore profile data (public and private)
                const publicProfileDocRef = doc(db, "public_user_profiles", currentUser.uid);
                const privateProfileDocRef = doc(db, "user_profiles", currentUser.uid);
                const notificationsCollectionRef = collection(db, `users/${currentUser.uid}/notifications`);
                const friendsCollectionRef = collection(db, `users/${currentUser.uid}/friends`);
                const messagesCollectionRef = collection(db, `users/${currentUser.uid}/messages`); // Assuming messages subcollection
                const postsCollectionRef = collection(db, `users/${currentUser.uid}/posts`); // Assuming user's own posts

                const batch = writeBatch(db);

                batch.delete(publicProfileDocRef);
                batch.delete(privateProfileDocRef);

                // Delete subcollections (Firebase doesn't delete subcollections automatically)
                // This is a simplified approach; for large data, a Cloud Function is better.
                const deleteCollection = async (collectionRef) => {
                    const snapshot = await getDocs(collectionRef);
                    snapshot.docs.forEach(d => batch.delete(d.ref));
                };

                await deleteCollection(notificationsCollectionRef);
                await deleteCollection(friendsCollectionRef);
                await deleteCollection(messagesCollectionRef);
                await deleteCollection(postsCollectionRef);


                await batch.commit();

                // Delete user's profile picture from Storage (if exists)
                if (currentUser.photoURL) {
                    try {
                        const fileRef = ref(storage, `profile_pictures/${currentUser.uid}/`); // Assuming folder per user
                        // This might require listing files if not a single file per user
                        // For simplicity, attempting to delete the main photo URL
                        const photoToDeleteRef = ref(storage, currentUser.photoURL);
                        await deleteObject(photoToDeleteRef);
                        console.log("JCHAT_DEBUG: Profile picture deleted from storage.");
                    } catch (storageError) {
                        console.warn("JCHAT_WARN: Could not delete profile picture from storage (might not exist or permission issue):", storageError);
                    }
                }

                // Finally, delete the Firebase Auth user
                await currentUser.delete();

                showMessageBox("Account deleted successfully! Redirecting...", 'success');
                setTimeout(() => {
                    window.location.href = '/register.html'; // Redirect to registration or login
                }, 2000);
            } catch (error) {
                console.error("JCHAT_ERROR: Error deleting account:", error);
                if (error.code === 'auth/requires-recent-login') {
                    showMessageBox("Please log out and log in again, then try deleting your account.", 'warning');
                } else {
                    showMessageBox(`Failed to delete account: ${error.message}`, 'error');
                }
            } finally {
                toggleButtonLoading(deleteAccountButton, false);
            }
        }

        /**
         * Renders dynamic action buttons based on the relationship with the displayed user.
         * @param {string} targetUserId - The UID of the user whose profile is being displayed.
         * @param {Object} targetUserProfileData - The profile data of the user being displayed.
         */
        async function renderProfileActions(targetUserId, targetUserProfileData) {
            if (!profileActionsDiv || !currentUser || !isAuthReady || !targetUserProfileData) return;

            profileActionsDiv.innerHTML = ''; // Clear existing buttons

            if (targetUserId === currentUser.uid) {
                // This is the current user's own profile, only show "Request JCoins"
                if (requestJCoinsButton) {
                    requestJCoinsButton.style.display = 'inline-flex';
                    profileActionsDiv.appendChild(requestJCoinsButton);
                }
                // Daily Bonus button is removed
                // if (claimDailyBonusButton) {
                //     claimDailyBonusButton.style.display = 'inline-flex';
                //     profileActionsDiv.appendChild(claimDailyBonusButton);
                //     updateDailyBonusUI();
                // }
                return;
            }

            // Determine friendship status
            const currentUserFriendsRef = doc(db, `users/${currentUser.uid}/friends`, targetUserId);
            const targetUserFriendRequestsRef = doc(db, `users/${targetUserId}/friend_requests`, currentUser.uid);
            const currentUserSentRequestsRef = doc(db, `users/${currentUser.uid}/sent_friend_requests`, targetUserId);
            const targetUserSentRequestsRef = doc(db, `users/${targetUserId}/sent_friend_requests`, currentUser.uid);

            const [
                currentUserFriendsSnap,
                targetUserFriendRequestsSnap,
                currentUserSentRequestsSnap,
                targetUserSentRequestsSnap
            ] = await Promise.all([
                getDoc(currentUserFriendsRef),
                getDoc(targetUserFriendRequestsRef),
                getDoc(currentUserSentRequestsRef),
                getDoc(targetUserSentRequestsRef)
            ]);


            let relationshipStatus = "stranger";

            if (currentUserFriendsSnap.exists()) {
                relationshipStatus = "friends";
            } else if (targetUserFriendRequestsSnap.exists()) {
                relationshipStatus = "received_request"; // Target user sent request to current user
            } else if (currentUserSentRequestsSnap.exists()) {
                relationshipStatus = "sent_request"; // Current user sent request to target user
            }

            console.log("JCHAT_DEBUG: Relationship status:", relationshipStatus);

            // Message Button
            if (targetUserProfileData.visibility.allowMessages ?? true) { // Default to true if not set
                const msgBtn = document.createElement('button');
                msgBtn.id = 'messageButton';
                msgBtn.classList.add('profile-action-button');
                msgBtn.innerHTML = '<i class="fas fa-comment"></i> Message';
                msgBtn.addEventListener('click', () => {
                    window.location.href = `/chat.html?userId=${targetUserId}`;
                });
                profileActionsDiv.appendChild(msgBtn);
            }

            // Friend Request Buttons
            if (targetUserProfileData.visibility.allowFriendRequests ?? true) { // Default to true if not set
                if (relationshipStatus === "stranger") {
                    const addFriendBtn = document.createElement('button');
                    addFriendBtn.id = 'addFriendButton';
                    addFriendBtn.classList.add('profile-action-button', 'secondary');
                    addFriendBtn.innerHTML = '<i class="fas fa-user-plus"></i> Add Friend';
                    addFriendBtn.addEventListener('click', () => handleAddFriend(targetUserId, targetUserProfileData.username));
                    profileActionsDiv.appendChild(addFriendBtn);
                } else if (relationshipStatus === "sent_request") {
                    const cancelRequestBtn = document.createElement('button');
                    cancelRequestBtn.id = 'cancelFriendRequestButton';
                    cancelRequestBtn.classList.add('profile-action-button', 'secondary', 'sent'); // Add 'sent' class for styling
                    cancelRequestBtn.innerHTML = '<i class="fas fa-hourglass-half"></i> Request Sent';
                    cancelRequestBtn.disabled = true; // Disable button once sent
                    // cancelRequestBtn.addEventListener('click', () => handleCancelFriendRequest(targetUserId, targetUserProfileData.username));
                    profileActionsDiv.appendChild(cancelRequestBtn);
                } else if (relationshipStatus === "received_request") {
                    const acceptBtn = document.createElement('button');
                    acceptBtn.id = 'acceptFriendRequestButton';
                    acceptBtn.classList.add('profile-action-button', 'accept');
                    acceptBtn.innerHTML = '<i class="fas fa-check"></i> Accept Request';
                    acceptBtn.addEventListener('click', () => handleAcceptFriendRequest(targetUserId, targetUserProfileData.username));
                    profileActionsDiv.appendChild(acceptBtn);

                    const declineBtn = document.createElement('button');
                    declineBtn.id = 'declineFriendRequestButton';
                    declineBtn.classList.add('profile-action-button', 'danger', 'secondary'); // Red for decline
                    declineBtn.innerHTML = '<i class="fas fa-times"></i> Decline';
                    declineBtn.addEventListener('click', () => handleDeclineFriendRequest(targetUserId, targetUserProfileData.username));
                    profileActionsDiv.appendChild(declineBtn);
                } else if (relationshipStatus === "friends") {
                    const unfriendBtn = document.createElement('button');
                    unfriendBtn.id = 'unfriendButton';
                    unfriendBtn.classList.add('profile-action-button', 'danger', 'unfriend');
                    unfriendBtn.innerHTML = '<i class="fas fa-user-times"></i> Unfriend';
                    unfriendBtn.addEventListener('click', () => handleUnfriend(targetUserId, targetUserProfileData.username));
                    profileActionsDiv.appendChild(unfriendBtn);
                }
            }


            // Report Button (always available for other users)
            const reportBtn = document.createElement('button');
            reportBtn.id = 'reportUserButton';
            reportBtn.classList.add('profile-action-button', 'secondary');
            reportBtn.innerHTML = '<i class="fas fa-flag"></i> Report User';
            reportBtn.addEventListener('click', () => {
                reportedUsernameDisplay.textContent = targetUserProfileData.username;
                reportUserModal?.classList.add('active');
            });
            profileActionsDiv.appendChild(reportBtn);
        }

        /**
         * Handles adding a friend.
         * @param {string} targetUserId
         * @param {string} targetUsername
         */
        async function handleAddFriend(targetUserId, targetUsername) {
            if (!currentUser) {
                showMessageBox("You must be logged in to send friend requests.", 'warning');
                return;
            }
            if (targetUserId === currentUser.uid) {
                showMessageBox("You cannot send a friend request to yourself.", 'warning');
                return;
            }

            const confirmAdd = confirm(`Send friend request to ${targetUsername}?`);
            if (!confirmAdd) return;

            showMessageBox(`Sending request to ${targetUsername}...`, 'loading', true);
            const batch = writeBatch(db);

            const friendRequestRef = doc(db, `users/${targetUserId}/friend_requests`, currentUser.uid);
            const sentRequestRef = doc(db, `users/${currentUser.uid}/sent_friend_requests`, targetUserId);

            batch.set(friendRequestRef, {
                senderId: currentUser.uid,
                senderUsername: currentUserProfileData?.username || currentUser.displayName,
                senderProfilePic: currentUserProfileData?.profilePicId || currentUser.photoURL,
                timestamp: serverTimestamp()
            });

            batch.set(sentRequestRef, {
                receiverId: targetUserId,
                receiverUsername: targetUsername,
                receiverProfilePic: targetUserProfileData?.profilePicId || null,
                timestamp: serverTimestamp()
            });

            // Add a notification for the receiver
            const notificationRef = collection(db, `users/${targetUserId}/notifications`);
            batch.add(notificationRef, {
                type: 'friend_request',
                senderId: currentUser.uid,
                senderUsername: currentUserProfileData?.username || currentUser.displayName,
                message: `${currentUserProfileData?.username || currentUser.displayName} sent you a friend request.`,
                read: false,
                timestamp: serverTimestamp()
            });

            try {
                await batch.commit();
                showMessageBox(`Friend request sent to ${targetUsername}!`, 'success');
                await fetchAndDisplayUserProfile(displayedUserId, false); // Re-render buttons
            } catch (error) {
                console.error("JCHAT_ERROR: Error sending friend request:", error);
                showMessageBox(`Failed to send friend request: ${error.message}`, 'error');
            }
        }

        /**
         * Handles accepting a friend request.
         * @param {string} senderId - The UID of the user who sent the request.
         * @param {string} senderUsername - The username of the user who sent the request.
         */
        async function handleAcceptFriendRequest(senderId, senderUsername) {
            if (!currentUser) return;

            const confirmAccept = confirm(`Accept friend request from ${senderUsername}?`);
            if (!confirmAccept) return;

            showMessageBox(`Accepting request from ${senderUsername}...`, 'loading', true);
            const batch = writeBatch(db);

            const currentUserFriendRef = doc(db, `users/${currentUser.uid}/friends`, senderId);
            const senderFriendRef = doc(db, `users/${senderId}/friends`, currentUser.uid);
            const friendRequestRef = doc(db, `users/${currentUser.uid}/friend_requests`, senderId);
            const senderSentRequestRef = doc(db, `users/${senderId}/sent_friend_requests`, currentUser.uid);

            // Add to current user's friends list
            batch.set(currentUserFriendRef, {
                friendId: senderId,
                username: senderUsername,
                profilePic: targetUserProfileData?.profilePicId || null,
                timestamp: serverTimestamp()
            });

            // Add to sender's friends list
            batch.set(senderFriendRef, {
                friendId: currentUser.uid,
                username: currentUserProfileData?.username || currentUser.displayName,
                profilePic: currentUserProfileData?.profilePicId || currentUser.photoURL,
                timestamp: serverTimestamp()
            });

            // Delete the friend request
            batch.delete(friendRequestRef);
            batch.delete(senderSentRequestRef);

            // Update friendsCount for both users
            const currentUserProfileRef = doc(db, "user_profiles", currentUser.uid);
            const senderProfileRef = doc(db, "user_profiles", senderId);

            batch.update(currentUserProfileRef, {
                friendsCount: (currentUserProfileData.friendsCount || 0) + 1
            });
            batch.update(senderProfileRef, {
                friendsCount: (targetUserProfileData.friendsCount || 0) + 1
            });

            // Add notification for the sender
            const notificationRef = collection(db, `users/${senderId}/notifications`);
            batch.add(notificationRef, {
                type: 'friend_accepted',
                senderId: currentUser.uid,
                senderUsername: currentUserProfileData?.username || currentUser.displayName,
                message: `${currentUserProfileData?.username || currentUser.displayName} accepted your friend request.`,
                read: false,
                timestamp: serverTimestamp()
            });

            try {
                await batch.commit();
                showMessageBox(`You are now friends with ${senderUsername}!`, 'success');
                await fetchAndDisplayUserProfile(displayedUserId, false); // Re-render buttons
            } catch (error) {
                console.error("JCHAT_ERROR: Error accepting friend request:", error);
                showMessageBox(`Failed to accept friend request: ${error.message}`, 'error');
            }
        }

        /**
         * Handles declining a friend request.
         * @param {string} senderId
         * @param {string} senderUsername
         */
        async function handleDeclineFriendRequest(senderId, senderUsername) {
            if (!currentUser) return;

            const confirmDecline = confirm(`Decline friend request from ${senderUsername}?`);
            if (!confirmDecline) return;

            showMessageBox(`Declining request from ${senderUsername}...`, 'loading', true);
            const batch = writeBatch(db);

            const friendRequestRef = doc(db, `users/${currentUser.uid}/friend_requests`, senderId);
            const senderSentRequestRef = doc(db, `users/${senderId}/sent_friend_requests`, currentUser.uid);

            batch.delete(friendRequestRef);
            batch.delete(senderSentRequestRef);

            // Optional: Add a notification for the sender that their request was declined
            const notificationRef = collection(db, `users/${senderId}/notifications`);
            batch.add(notificationRef, {
                type: 'friend_declined',
                senderId: currentUser.uid,
                senderUsername: currentUserProfileData?.username || currentUser.displayName,
                message: `${currentUserProfileData?.username || currentUser.displayName} declined your friend request.`,
                read: false,
                timestamp: serverTimestamp()
            });

            try {
                await batch.commit();
                showMessageBox(`Friend request from ${senderUsername} declined.`, 'info');
                await fetchAndDisplayUserProfile(displayedUserId, false); // Re-render buttons
            } catch (error) {
                console.error("JCHAT_ERROR: Error declining friend request:", error);
                showMessageBox(`Failed to decline friend request: ${error.message}`, 'error');
            }
        }

        /**
         * Handles unfriending a user.
         * @param {string} friendId
         * @param {string} friendUsername
         */
        async function handleUnfriend(friendId, friendUsername) {
            if (!currentUser) return;

            const confirmUnfriend = confirm(`Are you sure you want to unfriend ${friendUsername}?`);
            if (!confirmUnfriend) return;

            showMessageBox(`Unfriending ${friendUsername}...`, 'loading', true);
            const batch = writeBatch(db);

            const currentUserFriendRef = doc(db, `users/${currentUser.uid}/friends`, friendId);
            const targetUserFriendRef = doc(db, `users/${friendId}/friends`, currentUser.uid);

            batch.delete(currentUserFriendRef);
            batch.delete(targetUserFriendRef);

            // Update friendsCount for both users
            const currentUserProfileRef = doc(db, "user_profiles", currentUser.uid);
            const targetUserProfileRef = doc(db, "user_profiles", friendId); // Assuming target user also has a private profile

            batch.update(currentUserProfileRef, {
                friendsCount: (currentUserProfileData.friendsCount || 1) - 1
            });
            batch.update(targetUserProfileRef, {
                friendsCount: (targetUserProfileData.friendsCount || 1) - 1
            });


            // Optional: Add notification for the unfriended user
            const notificationRef = collection(db, `users/${friendId}/notifications`);
            batch.add(notificationRef, {
                type: 'unfriended',
                senderId: currentUser.uid,
                senderUsername: currentUserProfileData?.username || currentUser.displayName,
                message: `${currentUserProfileData?.username || currentUser.displayName} unfriended you.`,
                read: false,
                timestamp: serverTimestamp()
            });

            try {
                await batch.commit();
                showMessageBox(`You have unfriended ${friendUsername}.`, 'info');
                await fetchAndDisplayUserProfile(displayedUserId, false); // Re-render buttons
            } catch (error) {
                console.error("JCHAT_ERROR: Error unfriending:", error);
                showMessageBox(`Failed to unfriend: ${error.message}`, 'error');
            }
        }

        /**
         * Updates the calculated JCoins when Naira amount changes.
         */
        function updateCalculatedJCoins() {
            const nairaAmount = parseFloat(nairaAmountInput.value);
            if (isNaN(nairaAmount) || nairaAmount < 0) {
                calculatedJCoinsSpan.textContent = '0 JCoins';
                return;
            }

            const exchangeRate = 0.003; // 1 JCoin is 0.003 Naira
            let jCoins = nairaAmount / exchangeRate;
            if (nairaAmount >= 1000) {
                jCoins *= 1.10; // 10% bonus for 1000 NGN and above
            }
            calculatedJCoinsSpan.textContent = `${Math.round(jCoins).toLocaleString()} JCoins`;
        }

        /**
         * Displays a preview of the selected receipt image.
         */
        function displayReceiptPreview(event) {
            const file = event.target.files[0];
            if (file) {
                receiptFileNameSpan.textContent = file.name;
                const reader = new FileReader();
                reader.onload = (e) => {
                    receiptPreview.src = e.target.result;
                    receiptPreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                receiptFileNameSpan.textContent = 'No file chosen';
                receiptPreview.style.display = 'none';
                receiptPreview.src = '';
            }
        }

        /**
         * Handles submitting a JCoin request.
         */
        async function handleSubmitJCoinRequest() {
            if (!currentUser) {
                showMessageBox("You must be logged in to request JCoins.", 'warning');
                return;
            }

            const nairaAmount = parseFloat(nairaAmountInput.value);
            const receiptFile = receiptUploadInput.files[0];

            if (isNaN(nairaAmount) || nairaAmount <= 0) {
                showMessageBox("Please enter a valid Naira amount.", 'warning');
                return;
            }
            if (!receiptFile) {
                showMessageBox("Please upload a payment receipt.", 'warning');
                return;
            }

            toggleButtonLoading(submitJCoinRequestButton, true);
            showMessageBox("Submitting JCoin request...", 'loading', true);

            try {
                let receiptUrl = null;
                // Upload receipt image to Cloudinary
                const cloudinaryResponse = await uploadImageToCloudinary(receiptFile);
                if (cloudinaryResponse && cloudinaryResponse.secure_url) {
                    receiptUrl = cloudinaryResponse.secure_url;
                } else {
                    throw new Error("Failed to upload receipt image.");
                }

                const jCoinsToReceive = parseInt(calculatedJCoinsSpan.textContent.replace(' JCoins', '').replace(/,/g, ''));

                const requestsRef = collection(db, "jcoin_requests");
                await addDoc(requestsRef, {
                    userId: currentUser.uid,
                    username: currentUserProfileData?.username || currentUser.displayName,
                    nairaAmount: nairaAmount,
                    jCoinsToReceive: jCoinsToReceive,
                    receiptUrl: receiptUrl,
                    status: "pending", // pending, approved, rejected
                    requestedAt: serverTimestamp(),
                    processedBy: null,
                    processedAt: null
                });

                showMessageBox("JCoin request submitted successfully! Please wait for approval.", 'success');
                jcoinRequestModal?.classList.remove('active');
            } catch (error) {
                console.error("JCHAT_ERROR: Error submitting JCoin request:", error);
                showMessageBox(`Failed to submit request: ${error.message}`, 'error');
            } finally {
                toggleButtonLoading(submitJCoinRequestButton, false);
            }
        }

        /**
         * Removed: Handles claiming the daily bonus.
         * Daily bonus button and associated logic have been removed.
         */
        // async function handleClaimDailyBonus() { //
        //     if (!currentUser) { //
        //         showMessageBox("You must be logged in to claim the daily bonus.", 'warning'); //
        //         return; //
        //     } //

        //     toggleButtonLoading(claimDailyBonusButton, true); //
        //     showMessageBox("Claiming daily bonus...", 'loading', true); //

        //     try { //
        //         const userProfileRef = doc(db, "user_profiles", currentUser.uid); //
        //         const publicProfileRef = doc(db, "public_user_profiles", currentUser.uid); //

        //         await runTransaction(db, async (transaction) => { //
        //             const profileSnap = await transaction.get(userProfileRef); //
        //             if (!profileSnap.exists()) { //
        //                 throw new Error("Profile not found."); //
        //             } //
        //             const profileData = profileSnap.data(); //

        //             const lastClaimDate = profileData.lastDailyBonusClaimDate; //
        //             const now = new Date(); //
        //             const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()); //

        //             if (lastClaimDate) { //
        //                 const lastClaimDay = new Date(lastClaimDate.toDate().getFullYear(), lastClaimDate.toDate().getMonth(), lastClaimDate.toDate().getDate()); //
        //                 if (lastClaimDay.getTime() === today.getTime()) { //
        //                     showMessageBox("You have already claimed your daily bonus today. Come back tomorrow!", 'info'); //
        //                     return; //
        //                 } //
        //             } //

        //             const bonusJCoins = 50; // Example daily bonus amount //
        //             const newJCoinsBalance = (profileData.jCoins || 0) + bonusJCoins; //

        //             transaction.update(userProfileRef, { //
        //                 jCoins: newJCoinsBalance, //
        //                 lastDailyBonusClaimDate: serverTimestamp(), //
        //                 updatedAt: serverTimestamp() //
        //             }); //
        //             transaction.update(publicProfileRef, { //
        //                 jCoins: newJCoinsBalance, // Update public profile //
        //                 updatedAt: serverTimestamp() //
        //             }); //

        //             // Add activity log
        //             const activityRef = collection(db, `users/${currentUser.uid}/activity`); //
        //             transaction.add(activityRef, { //
        //                 type: 'daily_bonus_claimed', //
        //                 jCoinsEarned: bonusJCoins, //
        //                 timestamp: serverTimestamp() //
        //             }); //

        //             showMessageBox(`Claimed ${bonusJCoins} JCoins daily bonus!`, 'success'); //
        //             // Update UI immediately //
        //             if (jCoinsBalanceSpan) jCoinsBalanceSpan.textContent = newJCoinsBalance.toLocaleString(); //
        //             currentUserProfileData.jCoins = newJCoinsBalance; //
        //             currentUserProfileData.lastDailyBonusClaimDate = { toDate: () => now }; // Simulate Timestamp for immediate UI update //
        //             updateDailyBonusUI(); //
        //         }); //
        //     } catch (error) { //
        //         console.error("JCHAT_ERROR: Error claiming daily bonus:", error); //
        //         showMessageBox(`Failed to claim daily bonus: ${error.message}`, 'error'); //
        //     } finally { //
        //         toggleButtonLoading(claimDailyBonusButton, false); //
        //     } //
        // } //

        /**
         * Removed: Updates the daily bonus UI state (disabled/enabled).
         * Daily bonus button and associated logic have been removed.
         */
        // function updateDailyBonusUI() { //
        //     if (!claimDailyBonusButton || !currentUserProfileData) return; //

        //     const lastClaimDate = currentUserProfileData.lastDailyBonusClaimDate; //
        //     const now = new Date(); //
        //     const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()); //

        //     if (lastClaimDate) { //
        //         const lastClaimDay = new Date(lastClaimDate.toDate().getFullYear(), lastClaimDate.toDate().getMonth(), lastClaimDate.toDate().getDate()); //
        //         if (lastClaimDay.getTime() === today.getTime()) { //
        //             claimDailyBonusButton.disabled = true; //
        //             claimDailyBonusButton.textContent = "Claimed Today"; //
        //             claimDailyBonusButton.classList.add('sent'); // Use 'sent' for a disabled/greyed look //
        //             return; //
        //         } //
        //     } //

        //     claimDailyBonusButton.disabled = false; //
        //     claimDailyBonusButton.textContent = "Claim Daily Bonus"; //
        //     claimDailyBonusButton.classList.remove('sent'); //
        // } //


        /**
         * Handles submitting a user report.
         */
        async function handleSubmitReport() {
            if (!currentUser) {
                showMessageBox("You must be logged in to report a user.", 'warning');
                return;
            }

            const reason = reportReasonSelect.value;
            const details = reportDetailsTextarea.value.trim();

            if (!reason) {
                showMessageBox("Please select a reason for the report.", 'warning');
                return;
            }

            toggleButtonLoading(submitReportButton, true);
            showMessageBox("Submitting report...", 'loading', true);

            try {
                const reportsRef = collection(db, "reports");
                await addDoc(reportsRef, {
                    reportedUserId: displayedUserId,
                    reportedUsername: reportedUsernameDisplay.textContent,
                    reporterId: currentUser.uid,
                    reporterUsername: currentUserProfileData?.username || currentUser.displayName,
                    reason: reason,
                    details: details,
                    status: "pending", // pending, reviewed, resolved
                    submittedAt: serverTimestamp()
                });

                showMessageBox("User reported successfully. Thank you for helping keep the community safe!", 'success');
                reportUserModal?.classList.remove('active');
                reportReasonSelect.value = '';
                reportDetailsTextarea.value = '';
            } catch (error) {
                console.error("JCHAT_ERROR: Error submitting report:", error);
                showMessageBox(`Failed to submit report: ${error.message}`, 'error');
            } finally {
                toggleButtonLoading(submitReportButton, false);
            }
        }

        /**
         * Fetches and displays unlocked benefits.
         * @param {string} userId - The UID of the user.
         * @param {Array<string>} unlockedBenefitsArray - Array of unlocked benefits from profile data.
         */
        async function fetchUnlockedBenefits(userId, unlockedBenefitsArray) {
            if (!unlockedRewardsSection || !rewardsGrid || !noRewardsMessage) return;

            rewardsGrid.innerHTML = ''; // Clear previous rewards
            if (!unlockedBenefitsArray || unlockedBenefitsArray.length === 0) {
                noRewardsMessage.style.display = 'block';
                return;
            }
            noRewardsMessage.style.display = 'none';

            // Define icons for different benefit types (extend as needed)
            const benefitIcons = {
                "Badge": "fas fa-medal",
                "Unlock: 1-Hour XP Boost": "fas fa-hourglass-half",
                "Unlock: Basic Profile Picture Frame": "fas fa-portrait",
                "Unlock: Common Emote Pack": "fas fa-smile",
                "Title": "fas fa-heading",
                "Increased Message Character Limit": "fas fa-text-width",
                "Unlock: Rare Chat Bubble Style": "fas fa-comment-alt",
                "Unlock: Advanced Profile Picture Frame": "fas fa-image",
                "Unlock: Epic Emote Pack": "fas fa-grin-squint",
                "Unlock: Exclusive Chat Bubble Style": "fas fa-comments",
                "Unlock: Profile Theme (Light Mode)": "fas fa-sun",
                "Unlock: Profile Theme (Dark Mode)": "fas fa-moon",
                "Unlock: Profile Theme (Glass Mode)": "fas fa-glass-whiskey",
                "Unlock: Profile Theme (Sunset Mode)": "fas fa-cloud-sun",
                "Increased Daily JCoin Bonus": "fas fa-gifts",
                "Unlock: Legendary Profile Picture Frame": "fas fa-crown",
                "Unlock: Legendary Emote Pack": "fas fa-laugh-squint",
                "Unlock: Custom Profile Frame Slot": "fas fa-shapes",
                "Unlock: Animated Profile Picture Frame": "fas fa-film",
                "Unlock: Custom Chat Bubble Style Slot": "fas fa-comment-medical",
                "Grand Badge": "fas fa-award",
                "Unlock: Custom Profile Theme Slot": "fas fa-palette",
            };

            unlockedBenefitsArray.forEach(benefit => {
                const item = document.createElement('div');
                item.classList.add('reward-item');

                let iconClass = "fas fa-question-circle"; // Default icon
                let benefitText = benefit;

                // Try to find a matching icon and format text
                for (const key in benefitIcons) {
                    if (benefit.startsWith(key)) {
                        iconClass = benefitIcons[key];
                        benefitText = benefit.replace(key + ": ", ""); // Remove prefix for cleaner text
                        break;
                    }
                }

                item.innerHTML = `
                    <i class="${iconClass} reward-icon"></i>
                    <span>${benefitText}</span>
                `;
                rewardsGrid.appendChild(item);
            });

            // Populate customization selects based on unlocked benefits
            populateCustomizationSelects(unlockedBenefitsArray);
        }

        /**
         * Populates the customization select dropdowns based on unlocked benefits.
         * @param {Array<string>} unlockedBenefitsArray - Array of unlocked benefits.
         */
        function populateCustomizationSelects(unlockedBenefitsArray) {
            // Profile Frame Select
            if (profileFrameSelect) {
                profileFrameSelect.innerHTML = '<option value="default">Default</option>';
                const frames = unlockedBenefitsArray.filter(b => b.startsWith('Unlock: Profile Picture Frame (')).map(b => b.replace('Unlock: Profile Picture Frame (', '').replace(')', ''));
                frames.forEach(frame => {
                    const option = document.createElement('option');
                    option.value = frame.toLowerCase().replace(/ /g, '-'); // e.g., 'Basic' -> 'basic'
                    option.textContent = frame;
                    profileFrameSelect.appendChild(option);
                });
            }

            // Chat Bubble Style Select
            if (chatBubbleStyleSelect) {
                chatBubbleStyleSelect.innerHTML = '<option value="default">Default</option>';
                const bubbles = unlockedBenefitsArray.filter(b => b.startsWith('Unlock: Chat Bubble Style (')).map(b => b.replace('Unlock: Chat Bubble Style (', '').replace(')', ''));
                bubbles.forEach(bubble => {
                    const option = document.createElement('option');
                    option.value = bubble.toLowerCase().replace(/ /g, '-');
                    option.textContent = bubble;
                    chatBubbleStyleSelect.appendChild(option);
                });
            }

            // Profile Theme Select (already has hardcoded options, add dynamic ones if any)
            if (profileThemeSelect) {
                // Ensure default options are present, then add dynamic ones
                // For now, hardcoded themes like Light/Dark/Glass/Sunset are treated as fixed unlocks at certain levels
                // If more dynamic themes are introduced, this logic would expand.
                // Example for a dynamically unlocked theme:
                // const dynamicThemes = unlockedBenefitsArray.filter(b => b.startsWith('Unlock: Profile Theme (Custom '));
                // dynamicThemes.forEach(theme => {
                //     const option = document.createElement('option');
                //     option.value = theme.toLowerCase().replace(/ /g, '-').replace('unlock: profile theme (', '').replace(')', '');
                //     option.textContent = theme.replace('Unlock: ', '');
                //     profileThemeSelect.appendChild(option);
                // });
            }
        }


        /**
         * Fetches and displays a snippet of friends for the given user.
         * @param {string} userId - The UID of the user.
         */
        async function fetchFriendsSnippet(userId) {
            if (!friendsSnippetSection || !friendsGrid || !friendsSnippetCount || !noFriendsMessage) return;

            friendsGrid.innerHTML = '';
            friendsSnippetCount.textContent = '0';
            noFriendsMessage.style.display = 'none';

            try {
                const friendsCollectionRef = collection(db, `users/${userId}/friends`);
                const q = query(friendsCollectionRef, orderBy("timestamp", "desc"), limit(6)); // Show latest 6 friends
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    noFriendsMessage.style.display = 'block';
                    return;
                }

                friendsSnippetCount.textContent = querySnapshot.size.toLocaleString(); // Show actual count of friends fetched
                querySnapshot.forEach(docSnap => {
                    const friendData = docSnap.data();
                    const friendItem = document.createElement('div');
                    friendItem.classList.add('friend-item');
                    friendItem.title = friendData.username;
                    friendItem.dataset.userId = friendData.friendId; // Store friend's UID

                    let profilePicUrl = friendData.profilePic || '';
                    if (profilePicUrl.includes("res.cloudinary.com")) {
                        // Apply Cloudinary transformations for small friend pic
                        const parts = profilePicUrl.split('/upload/');
                        if (parts.length > 1) {
                            profilePicUrl = `${parts[0]}/upload/w_120,h_120,c_fill,g_face,r_max/${parts[1]}`;
                        }
                    }

                    friendItem.innerHTML = `
                        <div class="friend-pic-wrapper">
                            ${profilePicUrl ? `<img src="${profilePicUrl}" alt="${friendData.username}" class="friend-pic">` : `<i class="fas fa-user-circle friend-pic-placeholder" style="font-size: 50px; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; background-clip: text; color: transparent; background-image: linear-gradient(90deg, var(--blue), var(--pink)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;"></i>`}
                        </div>
                        <span class="friend-name">${friendData.username}</span>
                    `;
                    friendItem.addEventListener('click', () => {
                        window.location.href = `/profile.html?userId=${friendData.friendId}`;
                    });
                    friendsGrid.appendChild(friendItem);
                });
            } catch (error) {
                console.error("JCHAT_ERROR: Error fetching friends snippet:", error);
                noFriendsMessage.textContent = "Failed to load friends.";
                noFriendsMessage.style.display = 'block';
            }
        }

        /**
         * Fetches and displays a snippet of recent activity for the given user.
         * @param {string} userId - The UID of the user.
         */
        async function fetchRecentActivity(userId) {
            if (!recentActivitySection || !recentActivityList || !noActivityMessage) return;

            recentActivityList.innerHTML = '';
            noActivityMessage.style.display = 'none';

            try {
                const activityCollectionRef = collection(db, `users/${userId}/activity`);
                const q = query(activityCollectionRef, orderBy("timestamp", "desc"), limit(5)); // Latest 5 activities
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    noActivityMessage.style.display = 'block';
                    return;
                }
                noActivityMessage.style.display = 'none';

                let activities = [];
                querySnapshot.forEach(docSnap => {
                    activities.push(docSnap.data());
                });

                // Limit to latest 5 activities
                activities = activities.slice(0, 5); //

                activities.forEach(activity => { //
                    const activityItem = document.createElement('li'); //
                    activityItem.classList.add('activity-item'); //

                    let icon = 'fas fa-info-circle'; //
                    let text = 'Performed an action.'; //

                    if (activity.type === 'post_created') { //
                        icon = 'fas fa-pencil-alt'; //
                        text = `Posted a new message: "${activity.contentSnippet || 'No content snippet'}"`; //
                    } else if (activity.type === 'level_up') { //
                        icon = 'fas fa-star'; //
                        text = `Reached Level ${activity.newLevel || '?'}: ${activity.levelName || 'New Level'}!`; //
                    } else if (activity.type === 'jcoins_earned') { //
                        icon = 'fas fa-coins'; //
                        text = `Earned ${activity.amount} JCoins for ${activity.reason || 'activity'}.`; //
                    } else if (activity.type === 'daily_bonus_claimed') { //
                        icon = 'fas fa-gift'; //
                        text = `Claimed daily bonus of ${activity.jCoinsEarned} JCoins.`; //
                    } else if (activity.type === 'profile_updated') { //
                        icon = 'fas fa-user-edit'; //
                        text = `Updated profile information.`; //
                    } else if (activity.type === 'friend_added') { //
                        icon = 'fas fa-user-plus'; //
                        text = `Became friends with ${activity.friendUsername || 'someone'}.`; //
                    } else if (activity.type === 'chat_message_sent') { //
                        icon = 'fas fa-comment-dots'; //
                        text = `Sent a chat message.`; //
                    }

                    const timestamp = activity.timestamp ? new Date(activity.timestamp.toDate()).toLocaleString() : 'N/A'; //

                    activityItem.innerHTML = `
                        <i class="${icon}"></i>
                        <span>${text}</span>
                        <span class="activity-timestamp">${timestamp}</span>
                    `; //
                    recentActivityList.appendChild(activityItem); //
                }); //

            } catch (error) {
                console.error("JCHAT_ERROR: Error fetching recent activity:", error);
                noActivityMessage.textContent = "Failed to load recent activity.";
            }
        }

        /**
         * Fetches and displays a user's posts.
         * @param {string} userId - The UID of the user whose posts to fetch.
         * @param {string} username - The username of the user.
         */
        async function fetchAndDisplayUserPosts(userId, username) {
            if (!userPostsFeed || !postsFeedUsername || !loadingUserPostsMessage) return;

            postsFeedUsername.textContent = username || "User";
            loadingUserPostsMessage.style.display = 'block';
            userPostsFeed.style.display = 'block';
            const postsContainer = userPostsFeed; // Using the feed div directly for posts

            // Clear previous posts (if any)
            Array.from(postsContainer.children).forEach(child => {
                if (child.classList.contains('post-card')) { // Assuming posts have a 'post-card' class
                    postsContainer.removeChild(child);
                }
            });

            try {
                const postsCollectionRef = collection(db, "posts");
                const q = query(
                    postsCollectionRef,
                    where("userId", "==", userId),
                    orderBy("timestamp", "desc")
                );
                const querySnapshot = await getDocs(q);

                loadingUserPostsMessage.style.display = 'none';

                if (querySnapshot.empty) {
                    const noPostsMessage = document.createElement('p');
                    noPostsMessage.style.textAlign = 'center';
                    noPostsMessage.style.color = 'var(--text-light)';
                    noPostsMessage.textContent = "No posts yet.";
                    noPostsMessage.classList.add('post-card'); // Use a similar class to remove it later
                    postsContainer.appendChild(noPostsMessage);
                    return;
                }

                querySnapshot.forEach(postDoc => {
                    const post = postDoc.data();
                    const postId = postDoc.id;
                    const postElement = createPostElement(post, postId);
                    postsContainer.appendChild(postElement);
                });

            } catch (error) {
                console.error("JCHAT_ERROR: Error fetching user posts:", error);
                loadingUserPostsMessage.textContent = `Failed to load posts: ${error.message}`;
                loadingUserPostsMessage.style.display = 'block';
            }
        }

        /**
         * Creates an HTML element for a single post.
         * (Simplified for profile page, may not include all interactive features of home feed)
         * @param {Object} post - The post data.
         * @param {string} postId - The ID of the post document.
         * @returns {HTMLElement} The created post element.
         */
        function createPostElement(post, postId) {
            const postCard = document.createElement('div');
            postCard.classList.add('post-card'); // Assuming this style exists in main CSS

            const timestampDate = post.timestamp ? new Date(post.timestamp.toDate()) : new Date();
            const timeAgo = formatTimeAgo(timestampDate);

            // Basic structure, expand as needed
            postCard.innerHTML = `
                <div class="post-header">
                    <div class="post-author-info">
                        <img src="${post.authorProfilePic || '/path/to/default-avatar.png'}" alt="${post.authorUsername}" class="post-author-pic">
                        <span class="post-author-username">${post.authorUsername}</span>
                    </div>
                    <span class="post-timestamp">${timeAgo}</span>
                </div>
                <div class="post-content">
                    <p>${post.content}</p>
                    ${post.imageUrl ? `<img src="${post.imageUrl}" alt="Post image" class="post-image">` : ''}
                </div>
                <div class="post-actions">
                    <span><i class="fas fa-heart"></i> ${post.likesCount || 0}</span>
                    <span><i class="fas fa-comment"></i> ${post.commentsCount || 0}</span>
                </div>
            `;
            return postCard;
        }

        /**
         * Formats a date into a "time ago" string.
         * @param {Date} date - The date to format.
         * @returns {string} Formatted string.
         */
        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " years ago";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " months ago";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " days ago";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " hours ago";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " minutes ago";
            return Math.floor(seconds) + " seconds ago";
        }

    </script>
</body>
</html>