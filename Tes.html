<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JCHAT - Market</title>

    <!-- Google Fonts: Poppins for headings, Inter for body text -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Preconnect to Firebase and Cloudinary domains for faster loading -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://*.firebaseio.com" crossorigin>
    <link rel="preconnect" href="https://res.cloudinary.com" crossorigin>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* Universal box-sizing for consistent layout */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        /* Global CSS Variables (reused from Admin.html for consistency) */
        :root {
            --pink: #ff2e92;
            --blue: #00d5ff;
            --radius: 20px;
            --transition: .3s ease;

            /* Default Dark Mode variables */
            --white: #fff;
            --text-light: rgba(255, 255, 255, .7);
            --background-main: rgba(10, 10, 10, .75);
            --background-gradient-1: #00d5ff;
            --background-gradient-2: #ff2e92;
            --card-background: linear-gradient(145deg, rgba(255, 255, 255, .03), rgba(255, 255, 255, .01));
            --header-background: linear-gradient(135deg, rgba(10, 10, 10, .85), rgba(10, 10, 10, .75));
            --border-light: rgba(255, 255, 255, .05);
            --input-background: rgba(255, 255, 255, 0.05);
            --button-background-gradient: linear-gradient(90deg, var(--blue), var(--pink));
            --button-shadow: 0 4px 15px var(--blue), 0 44px 15px var(--pink);

            /* Semantic Colors */
            --background-color-primary: #1a1a2e;
            --background-color-secondary: #0f0f1f;
            --header-background-color: #2a2a4a;
            --footer-background-color: #2a2a4a;
            --content-background-color: #20203a;
            --card-background-color: #2a2a4a;
            --text-color-primary: #e0e0e0;
            --text-color-secondary: #b0b0d0;
            --notification-badge-color: #ff2e92;
            --status-online: #4CAF50;
            --status-offline: #6c757d;
            --status-away: #FFC107;
            --delete-button-color: #dc3545;
            --warning-color: #ffc107;
            --accent-color: #00d5ff;
            --accent-color-dark: #00aaff;
            --border-color: #3a3a5a;
        }

        /* Theme Definitions (Light, Dark, Glass, Sunset) */
        body.theme-light-mode {
            --background-main: #f0f2f5;
            background-image: none !important;
            --white: #333;
            --text-light: #666;
            --card-background: rgba(255, 255, 255, 0.95);
            --header-background: rgba(255, 255, 255, 0.98);
            --border-light: rgba(0, 0, 0, 0.1);
            --input-background: rgba(0, 0, 0, 0.05);
            --button-background-gradient: linear-gradient(90deg, #6dd5ed, #2193b0);
            --button-shadow: 0 4px 15px rgba(109, 213, 237, 0.4), 0 4px 15px rgba(33, 147, 176, 0.4);

            --background-color-primary: #f0f2f5;
            --background-color-secondary: #e0e2e5;
            --header-background-color: #ffffff;
            --footer-background-color: #ffffff;
            --content-background-color: #f7f9fb;
            --card-background-color: #ffffff;
            --text-color-primary: #333333;
            --text-color-secondary: #666666;
            --accent-color: #007bff;
            --accent-color-dark: #0056b3;
            --border-color: #e0e0e0;
            --input-background-color: #f0f0f0;
            --button-background: #e9ecef;
            --button-hover-background: #dee2e6;
            --active-item-background: rgba(0, 123, 255, 0.1);
            --notification-badge-color: #dc3545;
            --status-online: #28a745;
            --status-offline: #6c757d;
            --status-away: #ffc107;
            --delete-button-color: #dc3545;
            --warning-color: #ffc107;
        }

        body.theme-dark-mode {
            --background-main: #1a1a2e;
            background-image: radial-gradient(circle at top left, #16213e, transparent 100px),
                              radial-gradient(circle at bottom right, #0f3460, transparent 150px) !important;
            --white: #e0e0e0;
            --text-light: #a0a0a0;
            --card-background: rgba(25, 25, 40, 0.7);
            --header-background: linear-gradient(135deg, rgba(10, 10, 20, .85), rgba(10, 10, 20, .75));
            --border-light: rgba(255, 255, 255, 0.08);
            --input-background: rgba(255, 255, 255, 0.08);
            --button-background-gradient: linear-gradient(90deg, #e94560, #ba2f49);
            --button-shadow: 0 4px 15px rgba(233, 69, 96, 0.4), 0 4px 15px rgba(186, 47, 73, 0.4);

            --background-color-primary: #121212;
            --background-color-secondary: #1e1e1e;
            --header-background-color: #2c2c2c;
            --footer-background-color: #2c2c2c;
            --content-background-color: #242424;
            --card-background-color: #2c2c2c;
            --text-color-primary: #ffffff;
            --text-color-secondary: #bbbbbb;
            --accent-color: #bb86fc;
            --accent-color-dark: #9a67ea;
            --border-color: #444444;
            --input-background-color: #383838;
            --button-background: #383838;
            --button-hover-background: #505050;
            --active-item-background: rgba(187, 134, 252, 0.2);
            --notification-badge-color: #cf6679;
            --delete-button-color: #f44336;
            --warning-color: #ffeb3b;
        }

        body.theme-glass-mode {
            --background-main: rgba(10, 10, 10, 0.75);
            background-image: url('https://source.unsplash.com/random/1920x1080?abstract,blur') !important;
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
            backdrop-filter: blur(10px);
            --card-background: rgba(25, 25, 40, 0.7);
            --white: #e0e0e0;
            --text-light: rgba(255, 255, 255, 0.7);
            --input-background: rgba(255, 255, 255, 0.05);
            --border-light: rgba(255, 255, 255, 0.1);
            --button-background-gradient: linear-gradient(90deg, var(--pink), var(--blue));
            --button-shadow: 0 4px 15px var(--blue), 0 4px 15px var(--pink);
            box-shadow: inset 0 0 100px rgba(0, 0, 0, 0.5);

            --background-color-primary: rgba(10, 10, 10, 0.75);
            --background-color-secondary: rgba(10, 10, 10, 0.6);
            --header-background-color: rgba(10, 10, 10, 0.85);
            --footer-background-color: rgba(10, 10, 10, 0.85);
            --content-background-color: rgba(10, 10, 10, 0.75);
            --card-background-color: rgba(25, 25, 40, 0.7);
            --text-color-primary: #e0e0e0;
            --text-color-secondary: #b0b0d0;
            --accent-color: #00d5ff;
            --accent-color-dark: #00aaff;
            --border-color: rgba(255, 255, 255, 0.1);
            --input-background-color: rgba(255, 255, 255, 0.05);
            --button-background: rgba(0, 213, 255, 0.15);
            --button-hover-background: rgba(0, 213, 255, 0.25);
            --active-item-background: rgba(0, 213, 255, 0.1);
        }

        body.theme-sunset-mode {
            background: linear-gradient(to top, #ff7e5f, #feb47b) !important;
            --background-main: linear-gradient(to top, #ff7e5f, #feb47b);
            --card-background: rgba(255, 255, 255, 0.15);
            --white: #fff;
            --text-light: rgba(255, 255, 255, 0.8);
            --input-background: rgba(255, 255, 255, 0.1);
            --border-light: rgba(255, 255, 255, 0.3);
            --button-background-gradient: linear-gradient(90deg, #fd746c, #ff9068);
            --button-shadow: 0 4px 15px rgba(253, 116, 108, 0.4), 0 4px 15px rgba(255, 144, 104, 0.4);

            --background-color-primary: #ff7e5f;
            --background-color-secondary: #feb47b;
            --header-background-color: rgba(255, 126, 95, 0.9);
            --footer-background-color: rgba(255, 126, 95, 0.9);
            --content-background-color: rgba(255, 126, 95, 0.85);
            --card-background-color: rgba(255, 255, 255, 0.15);
            --text-color-primary: #fff;
            --text-color-secondary: rgba(255, 255, 255, 0.8);
            --accent-color: #ffd700;
            --accent-color-dark: #ccaa00;
            --border-color: rgba(255, 255, 255, 0.3);
            --input-background-color: rgba(255, 255, 255, 0.2);
            --button-background: rgba(255, 255, 255, 0.2);
            --button-hover-background: rgba(255, 255, 255, 0.3);
            --active-item-background: rgba(255, 215, 0, 0.1);
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* Align to top for scrollable content */
            background-color: var(--background-main);
            background-image: radial-gradient(circle at top left, var(--background-gradient-1), transparent 100px),
                              radial-gradient(circle at bottom right, var(--background-gradient-2), transparent 150px);
            color: var(--white);
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        /* Header Styling (reused from Groups.html) */
        header {
            background: var(--header-background);
            border-bottom: 1px solid var(--border-light);
            padding: 10px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 55px;
            z-index: 10;
            display: flex;
            justify-content: center;
        }

        header .header-content-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 1200px;
            padding: 0 30px;
        }

        .header-main-title {
            font-family: 'Poppins', sans-serif;
            font-size: 1.8rem;
            font-weight: 800;
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            letter-spacing: -0.03em;
            text-decoration: none;
            margin-right: auto; /* Push other elements to the right */
        }

        .user-profile-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification-icon-wrapper {
            position: relative;
            margin-right: 15px;
        }

        .notification-icon-wrapper a {
            text-decoration: none;
            color: inherit;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-icon-wrapper i {
            font-size: 1.5rem;
            color: var(--text-light);
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .notification-icon-wrapper i:hover {
            color: var(--white);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--notification-badge-color);
            color: var(--white);
            border-radius: 50%;
            padding: 3px 7px;
            font-size: 0.7rem;
            font-weight: 700;
            min-width: 20px;
            text-align: center;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            display: none;
        }

        .user-profile-header #profileLink {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: var(--white);
            transition: opacity 0.3s ease, background-color 0.3s ease;
            padding: 5px 10px;
            border-radius: var(--radius);
        }

        .user-profile-header #profileLink:hover {
            opacity: 0.8;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .user-profile-header img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--accent-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: opacity 0.3s ease;
        }

        .user-profile-header .user-avatar-icon { /* Specific for the user profile icon in header */
            font-size: 30px;
            color: var(--text-light);
        }

        .user-profile-header span {
            font-weight: 600;
            font-size: 1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
        }

        .jcoin-gas-display {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: 15px;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-color-primary);
        }
        .jcoin-gas-display .jcoin-icon, .jcoin-gas-display .gas-icon {
            color: var(--pink); /* JCoin color */
            font-size: 1.1rem;
        }
        .jcoin-gas-display .gas-icon {
            color: var(--blue); /* Gas color */
        }

        /* Main Content Area */
        main {
            flex-grow: 1;
            padding: 40px 0;
            padding-top: 80px; /* Adjust for fixed header and some top margin */
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            text-align: center;
            overflow-y: auto; /* Allow main content to scroll */
            min-height: calc(100vh - 55px); /* Make main content take full height minus header */
        }

        .market-layout-container {
            display: flex;
            width: 100%;
            max-width: 1200px;
            padding: 20px;
            gap: 20px;
            align-items: flex-start; /* Align sidebar and main content to top */
        }

        /* Sidebar Styles */
        .market-sidebar {
            flex-shrink: 0;
            width: 250px;
            background: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            box-shadow: 0 8px 25px rgba(0, 0, 0, .3);
            padding: 20px;
            text-align: left;
            position: sticky; /* Make sidebar sticky */
            top: 80px; /* Stick below header */
            align-self: flex-start; /* Align to top of parent */
        }

        .sidebar-section {
            margin-bottom: 25px;
        }

        .sidebar-section h3 {
            font-family: 'Poppins', sans-serif;
            font-size: 1.4rem;
            font-weight: 700;
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-light);
            padding-bottom: 10px;
        }

        .category-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .category-list li {
            margin-bottom: 10px;
        }

        .category-list li a {
            color: var(--text-color-secondary);
            text-decoration: none;
            font-size: 1rem;
            transition: color 0.2s ease;
            display: block;
            padding: 5px 0;
        }

        .category-list li a:hover, .category-list li a.active {
            color: var(--accent-color);
            font-weight: 600;
        }

        .location-select, .currency-select {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background: var(--input-background);
            color: var(--text-color-primary);
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            -webkit-appearance: none; /* Remove default arrow */
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23e0e0e0' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 20px;
        }
        .location-select:focus, .currency-select:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 213, 255, 0.2);
        }

        .price-range-inputs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .price-range-inputs input {
            width: 50%;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background: var(--input-background);
            color: var(--text-color-primary);
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .price-range-inputs input:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 213, 255, 0.2);
        }

        /* Main Content Area */
        .market-main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .main-search-bar {
            width: 100%;
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: var(--card-background); /* Match section card styling */
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            box-shadow: 0 8px 25px rgba(0, 0, 0, .3);
            padding: 15px;
        }
        .main-search-bar input {
            flex-grow: 1;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background: var(--input-background);
            color: var(--text-color-primary);
            font-size: 1.1rem;
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .main-search-bar input:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 213, 255, 0.2);
        }
        .main-search-bar button {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            background: linear-gradient(90deg, var(--blue), var(--pink));
            color: var(--white);
            box-shadow: 0 4px 10px rgba(0, 213, 255, 0.3);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .main-search-bar button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
        }


        .section-card {
            background: var(--card-background);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px) saturate(180%);
            border-radius: var(--radius);
            box-shadow: 0 8px 25px rgba(0, 0, 0, .3);
            padding: 2.5rem;
            width: 100%; /* Take full width of its parent */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
            text-align: center;
        }

        .section-card h1, .section-card h2 {
            font-family: 'Poppins', sans-serif;
            font-weight: 800;
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            margin-bottom: 1.5rem;
        }
        .section-card h1 { font-size: 2.8rem; }
        .section-card h2 { font-size: 2rem; margin-bottom: 1.2rem; }

        .section-description {
            color: var(--text-color-secondary);
            font-size: 1rem;
            margin-top: -1rem;
            margin-bottom: 1.5rem;
        }

        /* Listing Specific Styles */
        .listing-grid-container {
            width: 100%;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); /* Adjusted for more items in a row */
            gap: 20px;
            max-height: 600px; /* Make listing lists scrollable */
            overflow-y: auto;
            padding-right: 10px; /* For scrollbar */
        }

        .listing-grid-container::-webkit-scrollbar {
            width: 8px;
        }

        .listing-grid-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .listing-grid-container::-webkit-scrollbar-thumb {
            background: linear-gradient(to bottom, var(--blue), var(--pink));
            border-radius: 10px;
        }

        .listing-grid-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(to bottom, var(--pink), var(--blue));
        }

        .listing-card {
            background: var(--input-background);
            border: 1px solid var(--border-light);
            border-radius: 15px;
            padding: 15px; /* Slightly less padding to fit more */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px; /* Slightly less gap */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            text-decoration: none;
            color: inherit;
            position: relative;
        }

        .listing-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .listing-card .listing-image {
            width: 100%;
            height: 160px; /* Slightly smaller image */
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 8px;
            border: 2px solid var(--accent-color);
            transition: border-color 0.3s ease;
        }

        .listing-card h3 {
            font-family: 'Poppins', sans-serif;
            font-size: 1.2rem; /* Slightly smaller title */
            font-weight: 700;
            color: var(--text-color-primary);
            margin: 0;
            text-align: center;
            word-break: break-word;
            min-height: 1.4em; /* Ensure consistent height for single/double line titles */
        }

        .listing-card .listing-description {
            margin: 0;
            font-size: 0.85rem; /* Slightly smaller description */
            color: var(--text-color-secondary);
            text-align: center;
            flex-grow: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2; /* Limit to 2 lines */
            -webkit-box-orient: vertical;
            line-height: 1.3em; /* Adjusted line height */
            max-height: 2.6em; /* max-height for 2 lines */
        }

        .listing-card .listing-price {
            font-size: 1.1rem; /* Slightly smaller price */
            font-weight: 700;
            color: var(--pink); /* Default to JCoins color */
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 8px;
        }
        .listing-card .listing-price.gas {
            color: var(--blue); /* Gas color */
        }
        .listing-card .listing-price i {
            font-size: 1.3rem; /* Adjusted icon size */
        }

        .listing-card .seller-info {
            font-size: 0.8rem; /* Slightly smaller seller info */
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 5px;
        }
        .listing-card .seller-info img {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid var(--border-color);
        }
        .listing-card .seller-info i {
            color: var(--text-light);
        }

        .listing-card .action-button-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px; /* Slightly less gap */
            margin-top: 10px;
            width: 100%;
        }

        .listing-card .action-button {
            padding: 8px 15px; /* Slightly smaller padding */
            border: none;
            border-radius: 8px; /* Slightly smaller radius */
            font-weight: 600;
            cursor: pointer;
            background: linear-gradient(90deg, var(--blue), var(--pink));
            color: var(--white);
            box-shadow: 0 4px 10px rgba(0, 213, 255, 0.3);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex-grow: 1;
            min-width: 100px; /* Adjusted min width */
            font-size: 0.9rem;
        }

        .listing-card .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
        }
        .listing-card .action-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
        }

        .listing-card .action-button.delete-button {
            background: var(--delete-button-color);
            box-shadow: 0 4px 10px rgba(220, 53, 69, 0.3);
        }
        .listing-card .action-button.delete-button:hover {
            box-shadow: 0 6px 15px rgba(220, 53, 69, 0.4);
        }
        .listing-card .action-button.edit-button {
            background: var(--warning-color); /* Yellowish */
            box-shadow: 0 4px 10px rgba(255, 193, 7, 0.3);
        }
        .listing-card .action-button.edit-button:hover {
            box-shadow: 0 6px 15px rgba(255, 193, 7, 0.4);
        }

        .no-listings-message {
            text-align: center;
            color: var(--text-light);
            padding: 20px;
            font-size: 1rem;
            width: 100%;
        }

        /* Post Listing FAB */
        #postListingFab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--button-background-gradient);
            color: var(--white);
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            z-index: 70;
        }
        #postListingFab:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }

        /* Modals (reused from Groups.html) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: var(--card-background);
            padding: 30px;
            border-radius: var(--radius);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            text-align: center;
            max-width: 500px;
            width: 90%;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-height: 90vh; /* Ensure modal is scrollable on small screens */
            overflow-y: auto;
        }
        .modal-overlay.active .modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        .modal-content h3 {
            color: var(--white);
            margin-top: 0;
            margin-bottom: 10px;
            font-family: 'Poppins', sans-serif;
            font-size: 1.8rem;
        }
        .modal-content .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            text-align: left;
        }
        .modal-content label {
            font-weight: 600;
            font-size: 0.95rem;
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
        }
        .modal-content input[type="text"],
        .modal-content input[type="number"],
        .modal-content select,
        .modal-content textarea {
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background: var(--input-background);
            color: var(--text-color-primary);
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            width: 100%;
        }
        .modal-content input:focus,
        .modal-content textarea:focus,
        .modal-content select:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 213, 255, 0.2);
        }
        .modal-content textarea {
            min-height: 80px;
            resize: vertical;
        }
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 10px;
        }
        .modal-buttons button {
            padding: 10px 25px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .modal-buttons button.primary-btn {
            background: linear-gradient(90deg, var(--blue), var(--pink));
            color: var(--white);
            box-shadow: 0 4px 10px rgba(0, 213, 255, 0.3);
        }
        .modal-buttons button.primary-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 213, 255, 0.4);
        }
        .modal-buttons button.cancel-btn {
            background: var(--input-background);
            color: var(--text-light);
            border: 1px solid var(--border-light);
        }
        .modal-buttons button.cancel-btn:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.1);
        }

        /* Loader styles for buttons (reused from previous) */
        .button-loader {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid var(--white);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: none;
        }
        .button-loader.active { display: block; }
        .button-text { display: block; }
        .loading .button-text { display: none; }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Custom Message Box Styles (reused from previous) */
        #messageBox {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--card-background-color);
            color: var(--text-color-primary);
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            min-width: 280px;
            max-width: 90%;
            text-align: center;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        #messageBox.show {
            opacity: 1;
            display: flex;
        }
        #messageBox.success {
            background-image: linear-gradient(45deg, var(--pink), var(--blue));
            color: var(--white);
            border: none;
            box-shadow: 0 8px 30px rgba(0, 213, 255, 0.5), 0 8px 30px rgba(255, 46, 146, 0.5);
        }
        #messageBox.error { border-left: 5px solid var(--delete-button-color); background-color: var(--card-background-color); color: var(--text-color-primary); }
        #messageBox.info { border-left: 5px solid var(--accent-color); background-color: var(--card-background-color); color: var(--text-color-primary); }
        #messageBox.warning { border-left: 5px solid var(--warning-color); background-color: var(--card-background-color); color: var(--text-color-primary); }

        #messageBox i {
            font-size: 2.5rem;
            margin-bottom: 5px;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent;
        }
        #messageBox.success i { color: var(--white); }
        #messageBox.error i { color: var(--delete-button-color); }
        #messageBox.info i { color: var(--accent-color); }
        #messageBox.warning i { color: var(--warning-color); }

        #messageBox span {
            font-size: 1.1rem;
            font-weight: 600;
        }

        @keyframes pulse-bg {
            0% { background-color: var(--accent-color); }
            50% { background-color: rgba(0, 213, 255, 0.7); }
            100% { background-color: var(--accent-color); }
        }
        #messageBox.loading-pulse { animation: pulse-bg 1.5s infinite ease-in-out; }

        /* Custom Confirmation Modal */
        .confirm-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }
        .confirm-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .confirm-modal-content {
            background: var(--card-background);
            padding: 30px;
            border-radius: var(--radius);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            text-align: center;
            max-width: 400px;
            width: 90%;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .confirm-modal-overlay.active .confirm-modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        .confirm-modal-content h3 {
            color: var(--white);
            margin-top: 0;
            margin-bottom: 20px;
            font-family: 'Poppins', sans-serif;
        }
        .confirm-modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
        }
        .confirm-modal-buttons button {
            padding: 10px 25px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .confirm-modal-buttons button.confirm-btn {
            background: linear-gradient(90deg, var(--pink), var(--blue));
            color: var(--white);
            box-shadow: 0 4px 10px rgba(0, 213, 255, 0.3);
        }
        .confirm-modal-buttons button.confirm-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 213, 255, 0.4);
        }
        .confirm-modal-buttons button.cancel-btn {
            background: var(--input-background);
            color: var(--text-light);
            border: 1px solid var(--border-light);
        }
        .confirm-modal-buttons button.cancel-btn:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.1);
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .market-layout-container {
                flex-direction: column;
                align-items: center;
            }
            .market-sidebar {
                position: static; /* Remove sticky behavior on small screens */
                width: 100%;
                margin-bottom: 20px;
            }
            .main-search-bar {
                flex-direction: column;
                padding: 10px;
            }
            .main-search-bar button {
                width: 100%;
            }
            .section-card {
                padding: 1.5rem;
            }
            .section-card h1 {
                font-size: 2.2rem;
            }
            .section-card h2 {
                font-size: 1.7rem;
            }
            .listing-grid-container {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); /* Adjust for smaller cards on mobile */
                padding-right: 0; /* No right padding if no scrollbar is expected */
            }
            .listing-card .listing-image {
                height: 120px;
            }
            .listing-card h3 {
                font-size: 1.1rem;
            }
            .listing-card .listing-description {
                font-size: 0.75rem;
                -webkit-line-clamp: 2; /* Keep max lines */
                max-height: 2.5em;
            }
            .listing-card .listing-price {
                font-size: 1rem;
            }
            .listing-card .action-button {
                font-size: 0.8rem;
                padding: 6px 10px;
                min-width: 80px;
            }
            .modal-content {
                width: 95%;
                padding: 20px;
            }
            .modal-content h3 {
                font-size: 1.5rem;
            }
            .modal-content label, .modal-content input, .modal-content textarea, .modal-content select {
                font-size: 0.9rem;
            }
            .modal-buttons button {
                padding: 8px 15px;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            .listing-grid-container {
                grid-template-columns: 1fr; /* Single column on very small screens */
            }
            .header-content-wrapper {
                padding: 0 15px;
            }
            .user-profile-header {
                gap: 5px;
            }
            .jcoin-gas-display {
                margin-left: 5px;
            }
            .notification-icon-wrapper {
                margin-right: 10px;
            }
        }
    </style>
</head>
<body class="theme-dark-mode">

    <header>
        <div class="header-content-wrapper">
            <!-- The main title link, consistent with Groups.html -->
            <a href="/groups.html" class="header-main-title">JCHAT</a>
            <!-- The <nav> element and its contents are entirely removed -->
            <div class="user-profile-header">
                <!-- Notification Icon with Badge -->
                <div class="notification-icon-wrapper">
                    <a href="/notifications.html" aria-label="Notifications">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notificationCount" style="display: none;">0</span>
                    </a>
                </div>
                <!-- JCoin and Gas Display -->
                <div class="jcoin-gas-display">
                    <span id="jCoinsDisplay"><i class="fas fa-coins jcoin-icon"></i> 0</span>
                    <span id="gasDisplay"><i class="fas fa-gas-pump gas-icon"></i> 0</span>
                </div>
                <!-- Profile Link - this still goes to profile.html -->
                <a href="/profile.html" id="profileLink">
                    <img id="headerProfilePic" src="" alt="Profile Picture" style="display: none;">
                    <i id="headerAvatarIcon" class="fas fa-user-circle user-avatar-icon"></i>
                    <span id="headerDisplayName">Loading...</span>
                </a>
            </div>
        </div>
    </header>

    <main>
        <div class="market-layout-container">
            <aside class="market-sidebar">
                <div class="sidebar-section">
                    <h3>Categories</h3>
                    <ul id="categoryFilterList" class="category-list">
                        <!-- Categories will be dynamically generated here -->
                    </ul>
                </div>
                <div class="sidebar-section">
                    <h3>Location</h3>
                    <select id="locationFilterSelect" class="location-select">
                        <option value="all">All Nigeria</option>
                        <option value="Lagos">Lagos</option>
                        <option value="Abuja">Abuja</option>
                        <option value="Port Harcourt">Port Harcourt</option>
                        <option value="Kano">Kano</option>
                        <option value="Ibadan">Ibadan</option>
                        <option value="Enugu">Enugu</option>
                    </select>
                </div>
                <div class="sidebar-section">
                    <h3>Price Range</h3>
                    <div class="price-range-inputs">
                        <input type="number" id="minPriceInput" placeholder="Min Price">
                        <input type="number" id="maxPriceInput" placeholder="Max Price">
                    </div>
                    <select id="currencyFilter" class="currency-select">
                        <option value="all">All Currencies</option>
                        <option value="JCoins">JCoins</option>
                        <option value="Gas">Gas</option>
                    </select>
                </div>
            </aside>

            <section class="market-main-content">
                <div class="main-search-bar">
                    <input type="text" id="mainSearchInput" placeholder="Search for anything...">
                    <button id="mainSearchBtn">Search</button>
                </div>

                <div class="section-card">
                    <h2>Featured Listings</h2>
                    <p class="no-listings-message" id="loadingFeaturedListingsMessage">Loading featured listings...</p>
                    <div id="featuredListingsGrid" class="listing-grid-container">
                        <!-- Featured listings will be loaded here -->
                    </div>
                </div>

                <div class="section-card" style="margin-top: 25px;">
                    <h2>All Listings</h2>
                    <p class="no-listings-message" id="loadingAllListingsMessage">Loading all listings...</p>
                    <div id="allListingsGrid" class="listing-grid-container">
                        <!-- All listings will be loaded here -->
                    </div>
                </div>

                <div class="section-card" style="margin-top: 25px;">
                    <h2>My Listings</h2>
                    <p class="no-listings-message" id="loadingMyListingsMessage">Loading your listings...</p>
                    <div id="myListingsGrid" class="listing-grid-container">
                        <!-- My listings will be loaded here -->
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Post Listing Floating Action Button -->
    <button id="postListingFab" aria-label="Post New Listing">
        <i class="fas fa-plus"></i>
    </button>

    <!-- Post Listing Modal -->
    <div id="postListingModal" class="modal-overlay">
        <div class="modal-content">
            <h3>Post New Item for Sale</h3>
            <div class="form-group">
                <label for="itemNameInput">Item Name:</label>
                <input type="text" id="itemNameInput" placeholder="Enter item name" maxlength="100" required>
            </div>
            <div class="form-group">
                <label for="itemDescriptionInput">Description:</label>
                <textarea id="itemDescriptionInput" placeholder="Describe your item" maxlength="500"></textarea>
            </div>
            <div class="form-group">
                <label for="itemPriceInput">Price:</label>
                <input type="number" id="itemPriceInput" min="1" placeholder="Enter price" required>
            </div>
            <div class="form-group">
                <label for="itemPriceCurrencySelect">Currency:</label>
                <select id="itemPriceCurrencySelect">
                    <option value="JCoins">JCoins</option>
                    <option value="Gas">Gas</option>
                </select>
            </div>
            <div class="form-group">
                <label for="itemImageUrlInput">Item Image URL (Optional):</label>
                <input type="text" id="itemImageUrlInput" placeholder="Enter image URL or leave blank">
            </div>
            <div class="form-group">
                <label for="itemCategorySelect">Category:</label>
                <select id="itemCategorySelect">
                    <!-- Categories will be dynamically generated here from predefined list -->
                </select>
            </div>
            <div class="form-group">
                <label for="itemLocationSelect">Location:</label>
                <select id="itemLocationSelect">
                    <!-- Locations will be dynamically generated here from predefined list -->
                </select>
            </div>
            <div class="modal-buttons">
                <button id="submitPostListingBtn" class="primary-btn">
                    <span class="button-text"><i class="fas fa-plus-circle"></i> Post Listing</span>
                    <div class="button-loader"></div>
                </button>
                <button id="cancelPostListingBtn" class="cancel-btn">
                    <span class="button-text"><i class="fas fa-times"></i> Cancel</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Listing Details Modal (Optional, for future enhancement) -->
    <div id="listingDetailsModal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="detailItemName"></h3>
            <img id="detailItemImage" src="" alt="Item Image" class="listing-image">
            <p id="detailItemDescription" class="listing-description"></p>
            <p id="detailItemPrice" class="listing-price"></p>
            <p id="detailSellerInfo" class="seller-info"></p>
            <div class="modal-buttons">
                <button id="buyItemBtn" class="primary-btn">
                    <span class="button-text"><i class="fas fa-shopping-cart"></i> Buy Now</span>
                    <div class="button-loader"></div>
                </button>
                <button id="closeDetailsModalBtn" class="cancel-btn">
                    <span class="button-text"><i class="fas fa-times"></i> Close</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Custom Message Box -->
    <div id="messageBox"></div>

    <!-- Custom Confirmation Modal -->
    <div id="customConfirmModal" class="confirm-modal-overlay">
        <div class="confirm-modal-content">
            <h3 id="confirmModalMessage"></h3>
            <div class="confirm-modal-buttons">
                <button id="confirmYesBtn" class="confirm-btn">Yes</button>
                <button id="confirmNoBtn" class="cancel-btn">No</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, onSnapshot, addDoc, updateDoc, arrayUnion, arrayRemove, serverTimestamp, runTransaction, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Firebase & Canvas Environment Configuration ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyBsBinyrD9WZZXRaCvA4gxfX7BIimydDvo",
            authDomain: "jchat-1.firebaseapp.com",
            projectId: "jchat-1",
            storageBucket: "jchat-1.firebasestorage.app",
            messagingSenderId: "328479683167",
            appId: "1:328479683167:web:276c0b7e8ea44dd2d6a1ea",
            measurementId: "G-S6Z9GG0R9P"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Cloudinary Configuration (needed for profile pictures)
        const cloudinaryConfig = {
            cloudName: "dxld01rcp", // Your Cloudinary Cloud Name
            uploadPreset: "Storage_preset" // Your Cloudinary Upload Preset
        };

        // Initialize Firebase services
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const headerProfilePic = document.getElementById('headerProfilePic');
        const headerAvatarIcon = document.getElementById('headerAvatarIcon');
        const headerDisplayName = document.getElementById('headerDisplayName');
        const notificationCountElement = document.getElementById('notificationCount');
        const jCoinsDisplay = document.getElementById('jCoinsDisplay');
        const gasDisplay = document.getElementById('gasDisplay');
        const profileLink = document.getElementById('profileLink');

        // Sidebar elements
        const categoryFilterList = document.getElementById('categoryFilterList');
        const locationFilterSelect = document.getElementById('locationFilterSelect');
        const minPriceInput = document.getElementById('minPriceInput');
        const maxPriceInput = document.getElementById('maxPriceInput');
        const currencyFilter = document.getElementById('currencyFilter');

        // Main content elements
        const mainSearchInput = document.getElementById('mainSearchInput');
        const mainSearchBtn = document.getElementById('mainSearchBtn');
        const featuredListingsGrid = document.getElementById('featuredListingsGrid');
        const loadingFeaturedListingsMessage = document.getElementById('loadingFeaturedListingsMessage');
        const allListingsGrid = document.getElementById('allListingsGrid');
        const loadingAllListingsMessage = document.getElementById('loadingAllListingsMessage');
        const myListingsGrid = document.getElementById('myListingsGrid');
        const loadingMyListingsMessage = document.getElementById('loadingMyListingsMessage');
        const postListingFab = document.getElementById('postListingFab');

        // Post Listing Modal elements
        const postListingModal = document.getElementById('postListingModal');
        const itemNameInput = document.getElementById('itemNameInput');
        const itemDescriptionInput = document.getElementById('itemDescriptionInput');
        const itemPriceInput = document.getElementById('itemPriceInput');
        const itemPriceCurrencySelect = document.getElementById('itemPriceCurrencySelect');
        const itemImageUrlInput = document.getElementById('itemImageUrlInput');
        const itemCategorySelect = document.getElementById('itemCategorySelect');
        const itemLocationSelect = document.getElementById('itemLocationSelect');
        const submitPostListingBtn = document.getElementById('submitPostListingBtn');
        const cancelPostListingBtn = document.getElementById('cancelPostListingBtn');

        // Listing Details Modal elements (for future enhancement)
        const listingDetailsModal = document.getElementById('listingDetailsModal');
        const detailItemName = document.getElementById('detailItemName');
        const detailItemImage = document.getElementById('detailItemImage');
        const detailItemDescription = document.getElementById('detailItemDescription');
        const detailItemPrice = document.getElementById('detailItemPrice');
        const detailSellerInfo = document.getElementById('detailSellerInfo');
        const buyItemBtn = document.getElementById('buyItemBtn');
        const closeDetailsModalBtn = document.getElementById('closeDetailsModalBtn');

        // Custom Message Box
        const customMessageBox = document.getElementById('messageBox');

        // Custom Confirmation Modal elements
        const customConfirmModal = document.getElementById('customConfirmModal');
        const confirmModalMessage = document.getElementById('confirmModalMessage');
        const confirmYesBtn = document.getElementById('confirmYesBtn');
        const confirmNoBtn = document.getElementById('confirmNoBtn');

        // --- Global State ---
        let isAuthReady = false;
        let currentUser = null;
        let currentUserProfileData = null;
        let allMarketListingsData = []; // Stores all publicly available listings

        // --- Predefined Categories and Locations for Jiji-like functionality ---
        const categories = [
            "Electronics", "Vehicles", "Property", "Fashion", "Home & Garden",
            "Sports & Hobbies", "Jobs", "Services", "Baby & Kids", "Animals", "Other"
        ];
        const locations = [
            "Lagos", "Abuja", "Port Harcourt", "Kano", "Ibadan", "Enugu", "Kaduna",
            "Benin City", "Maiduguri", "Onitsha", "Abeokuta", "Jos", "Zaria", "Ilorin"
        ];


        // --- Utility Functions (reused from other pages) ---

        /**
         * Plays a short notification sound.
         */
        function playNotificationSound() {
            // Placeholder: In a real app, ensure this path is correct
            // const audio = new Audio('/assets/sounds/success_notification.mp3');
            // audio.play().catch(e => console.error("Error playing sound:", e));
            console.log("Notification sound placeholder triggered.");
        }

        /**
         * Displays a temporary message box with a given message and type.
         * @param {string} message - The message to display.
         * @param {string} type - The type of message ('success', 'error', 'info', 'loading', 'warning').
         * @param {number} [durationMs=3000] - Duration in milliseconds for the message to display.
         * @param {boolean} [isPersistent=false] - If true, message stays until explicitly cleared or replaced.
         */
        function showMessageBox(message, type, durationMs = 3000, isPersistent = false) {
            if (customMessageBox.timeoutId) {
                clearTimeout(customMessageBox.timeoutId);
                customMessageBox.timeoutId = null;
            }

            customMessageBox.innerHTML = `<i id="messageBoxIcon"></i><span id="messageBoxText"></span>`;
            const messageBoxIcon = customMessageBox.querySelector('#messageBoxIcon');
            const messageBoxText = customMessageBox.querySelector('#messageBoxText');

            messageBoxText.textContent = message;
            customMessageBox.className = 'message-box show ' + type;

            if (messageBoxIcon) {
                if (type === 'success') {
                    messageBoxIcon.classList.add('fas', 'fa-check-circle');
                    playNotificationSound();
                } else if (type === 'error') {
                    messageBoxIcon.classList.add('fas', 'fa-times-circle');
                } else if (type === 'info') {
                    messageBoxIcon.classList.add('fas', 'fa-info-circle');
                } else if (type === 'warning') {
                    messageBoxIcon.classList.add('fas', 'fa-exclamation-triangle');
                } else if (type === 'loading') {
                    messageBoxIcon.classList.add('fas', 'fa-spinner', 'fa-spin');
                }
            }

            if (type === 'loading') {
                customMessageBox.classList.add('loading-pulse');
            } else {
                customMessageBox.classList.remove('loading-pulse');
            }

            customMessageBox.style.display = 'flex';
            customMessageBox.style.opacity = '1';

            if (!isPersistent) {
                customMessageBox.timeoutId = setTimeout(() => {
                    customMessageBox.style.opacity = '0';
                    customMessageBox.addEventListener('transitionend', function handler() {
                        customMessageBox.style.display = 'none';
                        customMessageBox.removeEventListener('transitionend', handler);
                        customMessageBox.classList.remove('loading-pulse');
                    }, { once: true });
                }, durationMs);
            }
        }

        /**
         * Displays a custom confirmation modal.
         * @param {string} message - The message to display in the modal.
         * @returns {Promise<boolean>} Resolves with true if 'Yes' is clicked, false if 'No'.
         */
        function showCustomConfirm(message) {
            return new Promise((resolve) => {
                confirmModalMessage.textContent = message;
                customConfirmModal.classList.add('active');

                const handleYes = () => {
                    customConfirmModal.classList.remove('active');
                    confirmYesBtn.removeEventListener('click', handleYes);
                    confirmNoBtn.removeEventListener('click', handleNo);
                    resolve(true);
                };

                const handleNo = () => {
                    customConfirmModal.classList.remove('active');
                    confirmYesBtn.removeEventListener('click', handleYes);
                    confirmNoBtn.removeEventListener('click', handleNo);
                    resolve(false);
                };

                confirmYesBtn.addEventListener('click', handleYes);
                confirmNoBtn.addEventListener('click', handleNo);
            });
        }

        /**
         * Toggles loading state for a button.
         * @param {HTMLElement} buttonElement - The button to toggle.
         * @param {boolean} isLoading - True to show loading, false to hide.
         */
        function toggleButtonLoading(buttonElement, isLoading) {
            if (!buttonElement) return;
            const loader = buttonElement.querySelector('.button-loader');
            const text = buttonElement.querySelector('.button-text');

            if (isLoading) {
                buttonElement.disabled = true;
                buttonElement.classList.add('loading');
                if (loader) loader.classList.add('active');
                if (text) text.style.display = 'none';
            } else {
                buttonElement.disabled = false;
                buttonElement.classList.remove('loading');
                if (loader) loader.classList.remove('active');
                if (text) text.style.display = 'block';
            }
        }

        /**
         * Constructs a Cloudinary URL for an image/video.
         * @param {string} urlOrPublicId - The full Cloudinary URL or the public ID of the image on Cloudinary.
         * @param {string} transformations - Optional Cloudinary transformations.
         * @returns {string|null} The full Cloudinary URL or null if urlOrPublicId is not provided.
         */
        function getCloudinaryImageUrl(urlOrPublicId, transformations = "w_auto,f_auto,q_auto") {
            if (!urlOrPublicId) return null;
            if (urlOrPublicId.startsWith('http://') || urlOrPublicId.startsWith('https://')) {
                return urlOrPublicId;
            }
            return `https://res.cloudinary.com/${cloudinaryConfig.cloudName}/image/upload/${transformations}/${urlOrPublicId}`;
        }

        /**
         * Displays the profile picture or a default icon for a user/group.
         * @param {HTMLElement} imgElement - The <img> element to update.
         * @param {HTMLElement} iconElement - The <i> element to display if no image.
         * @param {string|null} picId - The Cloudinary public ID or URL, or null.
         * @param {string} initial - Initial for placeholder (e.g., username initial or group name initial).
         * @param {string} transformations - Cloudinary transformations.
         */
        function displayPicture(imgElement, iconElement, picId, initial, transformations) {
            if (imgElement) {
                if (picId) {
                    const imageUrl = getCloudinaryImageUrl(picId, transformations);
                    imgElement.src = imageUrl;
                    imgElement.style.display = 'block';
                    if (iconElement) iconElement.style.display = 'none';
                    imgElement.onerror = () => {
                        console.error(`Failed to load picture: ${picId}. Using placeholder.`);
                        imgElement.src = `https://placehold.co/80x80/CCCCCC/000000?text=${initial}`;
                        imgElement.style.display = 'block';
                        if (iconElement) iconElement.style.display = 'none';
                    };
                } else {
                    imgElement.src = '';
                    imgElement.style.display = 'none';
                    if (iconElement) iconElement.style.display = 'block';
                }
            }
        }

        /**
         * Fetches and displays the current user's profile data for the header.
         * @param {firebase.User} user - The authenticated Firebase user object.
         */
        async function fetchAndDisplayHeaderProfile(user) {
            try {
                const privateProfileDocRef = doc(db, "artifacts", appId, "users", user.uid, "profiles", "user_profile");
                const publicProfileDocRef = doc(db, "artifacts", appId, "public", "data", "users", user.uid);

                const privateDocSnap = await getDoc(privateProfileDocRef);
                let profileData = null;

                if (privateDocSnap.exists()) {
                    profileData = privateDocSnap.data();
                } else {
                    // Create a default profile if it doesn't exist
                    profileData = {
                        username: user.displayName || `User_${user.uid.substring(0, 8)}`,
                        email: user.email || "",
                        profilePicId: user.photoURL || null,
                        bio: "", location: "", friendsCount: 0, followersCount: 0, followingCount: 0,
                        createdAt: Date.now(), updatedAt: Date.now(),
                        totalPosts: 0, jCoins: 0, level: 1, currentXp: 0, xpToNextLevel: 100,
                        gas: 0,
                        messagesSentCount: 0,
                        lastGroupCheckIn: null,
                        completedQuests: [],
                        questProgress: {},
                        referralCode: generateReferralCode(),
                        successfulReferrals: 0
                    };
                    await setDoc(privateProfileDocRef, profileData);
                }
                currentUserProfileData = profileData; // Store profile data globally

                // Ensure referral code exists (copied from Groups.html, even if not displayed here)
                if (!currentUserProfileData.referralCode) {
                    currentUserProfileData.referralCode = generateReferralCode();
                    await updateDoc(privateProfileDocRef, { referralCode: currentUserProfileData.referralCode });
                }

                const publicProfileSummary = {
                    username: profileData.username,
                    profilePicId: profileData.profilePicId,
                    jCoins: profileData.jCoins,
                    level: profileData.level,
                    userId: user.uid,
                    email: profileData.email,
                    messagesSentCount: profileData.messagesSentCount || 0
                };
                await setDoc(publicProfileDocRef, publicProfileSummary, { merge: true });

                const usernameInitial = (profileData.username || "J").charAt(0).toUpperCase();
                displayPicture(headerProfilePic, headerAvatarIcon, profileData?.profilePicId, usernameInitial, "w_70,h_70,c_fill,g_face,r_max");
                headerDisplayName.textContent = profileData.username || "JCHAT User";
                profileLink.href = `/profile.html?userId=${user.uid}`;

                // Update JCoin and Gas display in header
                jCoinsDisplay.innerHTML = `<i class="fas fa-coins jcoin-icon"></i> ${currentUserProfileData.jCoins || 0}`;
                gasDisplay.innerHTML = `<i class="fas fa-gas-pump gas-icon"></i> ${currentUserProfileData.gas || 0}`;

            } catch (error) {
                console.error("Error fetching or creating profile for header:", error);
                const usernameInitial = (user.displayName || "J").charAt(0).toUpperCase();
                displayPicture(headerProfilePic, headerAvatarIcon, user.photoURL, usernameInitial, "w_70,h_70,c_fill,g_face,r_max");
                headerDisplayName.textContent = user.displayName || "JCHAT User";
                showMessageBox(`Error loading header profile: ${error.message}`, 'error');
            }
        }

        // Helper function for generating referral codes (used by fetchAndDisplayHeaderProfile)
        function generateReferralCode(length = 8) {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return result;
        }

        /**
         * Fetches and displays the notification count for the current user.
         * (Placeholder for future functionality, kept for header display)
         * @param {string} userId - The UID of the current user.
         */
        async function fetchNotificationCount(userId) {
            notificationCountElement.style.display = 'none';
        }

        /**
         * Creates a pending activity reward for admin review.
         * @param {string} userId - The ID of the user whose JCoins/XP/Gas are affected.
         * @param {string} username - The username of the user.
         * @param {string} activityType - Type of activity (e.g., 'item_purchase', 'item_sale').
         * @param {number} suggestedJCoinAmount - The suggested JCoin amount (positive for add, negative for deduct).
         * @param {number} suggestedXpAmount - The suggested XP amount (positive for add, negative for deduct).
         * @param {number} suggestedGasAmount - The suggested Gas amount (positive for add, negative for deduct).
         * @param {string|null} relatedEntityId - ID of related entity (e.g., listing ID).
         */
        async function createPendingActivityReward(userId, username, activityType, suggestedJCoinAmount, suggestedXpAmount, suggestedGasAmount, relatedEntityId = null) {
            try {
                const pendingRewardsCollectionRef = collection(db, "artifacts", appId, "public", "data", "pending_activity_rewards");
                await addDoc(pendingRewardsCollectionRef, {
                    userId: userId,
                    username: username,
                    activityType: activityType,
                    suggestedJCoinAmount: suggestedJCoinAmount,
                    suggestedXpAmount: suggestedXpAmount,
                    suggestedGasAmount: suggestedGasAmount,
                    status: 'pending', // Always pending for admin review
                    timestamp: serverTimestamp(),
                    relatedEntityId: relatedEntityId,
                    reviewerId: null, // Admin who reviews it
                    reviewTimestamp: null,
                    notes: ''
                });
                console.log(`JCHAT_DEBUG: Pending activity reward created for ${activityType}.`);
            } catch (error) {
                console.error("JCHAT_ERROR: Error creating pending activity reward:", error);
            }
        }


        /**
         * Renders a single market listing card.
         * @param {object} listingData - The listing data.
         * @param {boolean} isMyListing - True if the current user owns this listing.
         */
        function renderListingCard(listingData, isMyListing) {
            const listingCard = document.createElement('div');
            listingCard.classList.add('listing-card');
            listingCard.dataset.listingId = listingData.id;

            const priceIconClass = listingData.priceCurrency === 'JCoins' ? 'fas fa-coins jcoin-icon' : 'fas fa-gas-pump gas-icon';
            const priceClass = listingData.priceCurrency === 'JCoins' ? '' : 'gas';
            const imageUrl = listingData.imageUrl || `https://placehold.co/400x300/CCCCCC/000000?text=No+Image`; // Placeholder if no image

            const sellerAvatar = listingData.sellerProfilePicId ?
                getCloudinaryImageUrl(listingData.sellerProfilePicId, 'w_50,h_50,c_fill,g_face,r_max') :
                `https://placehold.co/50x50/CCCCCC/000000?text=${(listingData.sellerUsername || 'U').charAt(0).toUpperCase()}`; // Fallback if no username

            listingCard.innerHTML = `
                <img src="${imageUrl}" alt="${listingData.itemName}" class="listing-image">
                <h3>${listingData.itemName}</h3>
                <p class="listing-description">${listingData.description}</p>
                <div class="listing-price ${priceClass}">
                    <i class="${priceIconClass}"></i> ${listingData.price}
                </div>
                <div class="seller-info">
                    <img src="${sellerAvatar}" alt="${listingData.sellerUsername}'s avatar">
                    <span>${listingData.sellerUsername}</span>
                </div>
                <div class="action-button-container">
                    ${isMyListing ? `
                        <button class="action-button edit-button" data-listing-id="${listingData.id}">
                            <span class="button-text"><i class="fas fa-edit"></i> Edit</span>
                            <div class="button-loader"></div>
                        </button>
                        <button class="action-button delete-button" data-listing-id="${listingData.id}">
                            <span class="button-text"><i class="fas fa-trash-alt"></i> Delete</span>
                            <div class="button-loader"></div>
                        </button>
                    ` : `
                        <button class="action-button buy-button" data-listing-id="${listingData.id}" ${listingData.isSold ? 'disabled' : ''}>
                            <span class="button-text"><i class="fas fa-shopping-cart"></i> ${listingData.isSold ? 'Sold!' : 'Buy'}</span>
                            <div class="button-loader"></div>
                        </button>
                    `}
                </div>
            `;
            // Add error handling for image
            listingCard.querySelector('.listing-image').onerror = (e) => {
                e.target.src = `https://placehold.co/400x300/CCCCCC/000000?text=No+Image`;
            };


            if (isMyListing) {
                const deleteButton = listingCard.querySelector('.delete-button');
                if (deleteButton) {
                    deleteButton.addEventListener('click', () => handleDeleteListing(listingData.id, listingData.itemName, deleteButton));
                }
                const editButton = listingCard.querySelector('.edit-button');
                if (editButton) {
                    editButton.addEventListener('click', () => showMessageBox("Edit feature coming soon!", "info"));
                }
            } else {
                const buyButton = listingCard.querySelector('.buy-button');
                if (buyButton && !listingData.isSold) {
                    buyButton.addEventListener('click', () => handleBuyItem(listingData.id, listingData.sellerId, listingData.sellerUsername, listingData.itemName, listingData.price, listingData.priceCurrency, buyButton));
                }
            }

            return listingCard;
        }

        /**
         * Populates the category filter list and item category select.
         */
        function populateCategories() {
            categoryFilterList.innerHTML = `<li><a href="#" data-category="all" class="active">All Categories</a></li>`;
            itemCategorySelect.innerHTML = `<option value="">Select Category</option>`;
            categories.forEach(category => {
                const li = document.createElement('li');
                li.innerHTML = `<a href="#" data-category="${category}">${category}</a>`;
                categoryFilterList.appendChild(li);

                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                itemCategorySelect.appendChild(option);
            });
        }

        /**
         * Populates the location filter select and item location select.
         */
        function populateLocations() {
            locationFilterSelect.innerHTML = `<option value="all">All Nigeria</option>`;
            itemLocationSelect.innerHTML = `<option value="">Select Location</option>`;
            locations.forEach(location => {
                const optionFilter = document.createElement('option');
                optionFilter.value = location;
                optionFilter.textContent = location;
                locationFilterSelect.appendChild(optionFilter);

                const optionItem = document.createElement('option');
                optionItem.value = location;
                optionItem.textContent = location;
                itemLocationSelect.appendChild(optionItem);
            });
        }


        /**
         * Fetches and displays listings owned by the current user.
         */
        function fetchMyListings() {
            if (!currentUser) {
                loadingMyListingsMessage.textContent = "Please log in to see your listings.";
                myListingsGrid.innerHTML = ''; // Clear previous list
                return;
            }

            loadingMyListingsMessage.style.display = 'block';
            myListingsGrid.innerHTML = ''; // Clear previous list

            const q = query(collection(db, "artifacts", appId, "public", "data", "market_listings"), where("sellerId", "==", currentUser.uid));

            onSnapshot(q, (querySnapshot) => {
                if (querySnapshot.empty) {
                    loadingMyListingsMessage.textContent = "You have no items listed for sale yet.";
                    myListingsGrid.innerHTML = '';
                    return;
                }

                loadingMyListingsMessage.style.display = 'none';
                myListingsGrid.innerHTML = '';

                querySnapshot.docs.forEach(docSnapshot => {
                    const listing = { id: docSnapshot.id, ...docSnapshot.data() };
                    myListingsGrid.appendChild(renderListingCard(listing, true)); // True for isMyListing
                });
                showMessageBox("Your listings updated.", "info", 1500);
            }, (error) => {
                console.error("JCHAT_ERROR: Error fetching my listings:", error);
                loadingMyListingsMessage.textContent = `Error loading your listings: ${error.message}`;
                showMessageBox(`Error fetching your listings: ${error.message}`, 'error');
            });
        }

        /**
         * Fetches and displays all available market listings.
         */
        function fetchAllMarketListings() {
            loadingAllListingsMessage.style.display = 'block';
            loadingFeaturedListingsMessage.style.display = 'block';
            allListingsGrid.innerHTML = ''; // Clear previous list
            featuredListingsGrid.innerHTML = '';

            // Only fetch active (not sold) listings
            const q = query(collection(db, "artifacts", appId, "public", "data", "market_listings"), where("isSold", "==", false));

            onSnapshot(q, async (querySnapshot) => {
                if (querySnapshot.empty) {
                    loadingAllListingsMessage.textContent = "No items available in the marketplace.";
                    loadingFeaturedListingsMessage.textContent = "No featured items available.";
                    allMarketListingsData = [];
                    return;
                }

                loadingAllListingsMessage.style.display = 'none';
                loadingFeaturedListingsMessage.style.display = 'none';
                allMarketListingsData = [];

                // Fetch seller details for each item to display username and profile pic
                const listingsPromises = querySnapshot.docs.map(async docSnapshot => {
                    const listingData = docSnapshot.data();
                    const sellerProfileRef = doc(db, "artifacts", appId, "public", "data", "users", listingData.sellerId);
                    const sellerDoc = await getDoc(sellerProfileRef);
                    const sellerData = sellerDoc.exists() ? sellerDoc.data() : { username: "Unknown Seller", profilePicId: null };
                    return {
                        id: docSnapshot.id,
                        ...listingData,
                        sellerUsername: sellerData.username,
                        sellerProfilePicId: sellerData.profilePicId
                    };
                });

                allMarketListingsData = await Promise.all(listingsPromises);
                filterAndDisplayAllListings(); // Apply all filters
                showMessageBox("Marketplace listings updated.", "info", 1500);
            }, (error) => {
                console.error("JCHAT_ERROR: Error fetching browse listings:", error);
                loadingAllListingsMessage.textContent = `Error loading marketplace: ${error.message}`;
                loadingFeaturedListingsMessage.textContent = `Error loading featured listings: ${error.message}`;
                showMessageBox(`Error fetching marketplace: ${error.message}`, 'error');
            });
        }

        /**
         * Filters and displays all listings based on search input, category, location, price range, and currency.
         */
        function filterAndDisplayAllListings() {
            const searchTerm = mainSearchInput.value.toLowerCase().trim();
            const selectedCategory = categoryFilterList.querySelector('.active')?.dataset.category || 'all';
            const selectedLocation = locationFilterSelect.value;
            const minPrice = parseFloat(minPriceInput.value) || 0;
            const maxPrice = parseFloat(maxPriceInput.value) || Infinity;
            const selectedCurrency = currencyFilter.value;

            allListingsGrid.innerHTML = '';
            featuredListingsGrid.innerHTML = ''; // Clear grids before re-rendering

            const filteredListings = allMarketListingsData.filter(listing => {
                const matchesSearch = listing.itemName.toLowerCase().includes(searchTerm) ||
                                      listing.description.toLowerCase().includes(searchTerm) ||
                                      listing.sellerUsername.toLowerCase().includes(searchTerm);

                const matchesCategory = selectedCategory === 'all' || listing.category === selectedCategory;
                const matchesLocation = selectedLocation === 'all' || listing.location === selectedLocation;
                const matchesCurrency = selectedCurrency === 'all' || listing.priceCurrency === selectedCurrency;
                const matchesPrice = listing.price >= minPrice && listing.price <= maxPrice;

                // Ensure current user is not the seller and item is not sold
                const isMyListing = currentUser && listing.sellerId === currentUser.uid;

                return matchesSearch && matchesCategory && matchesLocation && matchesCurrency && matchesPrice && !isMyListing && !listing.isSold;
            });

            if (filteredListings.length === 0) {
                allListingsGrid.innerHTML = '<p class="no-listings-message">No items found matching your criteria.</p>';
                featuredListingsGrid.innerHTML = '<p class="no-listings-message">No featured items found.</p>';
                return;
            }

            // Simple logic for featured listings: Take the first few matching items
            const featuredItems = filteredListings.slice(0, Math.min(filteredListings.length, 4)); // Up to 4 featured items
            if (featuredItems.length > 0) {
                loadingFeaturedListingsMessage.style.display = 'none';
                featuredItems.forEach(listing => {
                    featuredListingsGrid.appendChild(renderListingCard(listing, false));
                });
            } else {
                loadingFeaturedListingsMessage.textContent = "No featured items found matching your criteria.";
                featuredListingsGrid.innerHTML = '';
            }

            // Display all other listings
            loadingAllListingsMessage.style.display = 'none';
            filteredListings.forEach(listing => {
                allListingsGrid.appendChild(renderListingCard(listing, false));
            });
        }


        /**
         * Handles posting a new item for sale.
         */
        async function handlePostListing() {
            if (!currentUser || !currentUserProfileData) {
                showMessageBox("You must be logged in to post an item.", "error");
                return;
            }

            const itemName = itemNameInput.value.trim();
            const itemDescription = itemDescriptionInput.value.trim();
            const itemPrice = parseFloat(itemPriceInput.value);
            const itemCurrency = itemPriceCurrencySelect.value;
            const itemImageUrl = itemImageUrlInput.value.trim();
            const itemCategory = itemCategorySelect.value;
            const itemLocation = itemLocationSelect.value;

            if (!itemName || !itemPrice || itemPrice <= 0 || !itemCategory || !itemLocation) {
                showMessageBox("Please fill all required fields (Name, Price, Category, Location).", "warning");
                return;
            }

            toggleButtonLoading(submitPostListingBtn, true);
            showMessageBox("Posting your listing...", "loading", true);

            try {
                const listingsCollectionRef = collection(db, "artifacts", appId, "public", "data", "market_listings");
                await addDoc(listingsCollectionRef, {
                    itemName: itemName,
                    description: itemDescription,
                    price: itemPrice,
                    priceCurrency: itemCurrency,
                    imageUrl: itemImageUrl || null,
                    category: itemCategory, // New field
                    location: itemLocation, // New field
                    sellerId: currentUser.uid,
                    sellerUsername: currentUserProfileData.username,
                    sellerProfilePicId: currentUserProfileData.profilePicId || null,
                    isSold: false,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                });

                showMessageBox(`Item "${itemName}" posted successfully!`, "success");
                postListingModal.classList.remove('active'); // Close modal
                // Clear form fields
                itemNameInput.value = '';
                itemDescriptionInput.value = '';
                itemPriceInput.value = '';
                itemPriceCurrencySelect.value = 'JCoins';
                itemImageUrlInput.value = '';
                itemCategorySelect.value = '';
                itemLocationSelect.value = '';

                // onSnapshot listeners will handle UI updates for listings
            } catch (error) {
                console.error("JCHAT_ERROR: Error posting listing:", error);
                showMessageBox(`Failed to post listing: ${error.message}`, "error");
            } finally {
                toggleButtonLoading(submitPostListingBtn, false);
            }
        }

        /**
         * Handles buying an item from the marketplace.
         * @param {string} listingId - The ID of the item being bought.
         * @param {string} sellerId - The ID of the seller.
         * @param {string} sellerUsername - The username of the seller.
         * @param {string} itemName - The name of the item.
         * @param {number} price - The price of the item.
         * @param {string} currency - The currency (JCoins or Gas).
         * @param {HTMLElement} buttonElement - The buy button.
         */
        async function handleBuyItem(listingId, sellerId, sellerUsername, itemName, price, currency, buttonElement) {
            if (!currentUser || !currentUserProfileData) {
                showMessageBox("You must be logged in to buy an item.", "error");
                return;
            }
            if (currentUser.uid === sellerId) {
                showMessageBox("You cannot buy your own item.", "warning");
                return;
            }

            const userCurrentBalance = currency === 'JCoins' ? currentUserProfileData.jCoins : currentUserProfileData.gas;
            if (userCurrentBalance < price) {
                showMessageBox(`Insufficient ${currency} to buy this item. You have ${userCurrentBalance} ${currency}.`, "error");
                return;
            }

            const confirmed = await showCustomConfirm(`Buy "${itemName}" for ${price} ${currency}?`);
            if (!confirmed) return;

            toggleButtonLoading(buttonElement, true);
            showMessageBox(`Buying "${itemName}" for ${price} ${currency}...`, "loading", true);

            try {
                const buyerProfileRef = doc(db, "artifacts", appId, "users", currentUser.uid, "profiles", "user_profile");
                const sellerProfileRef = doc(db, "artifacts", appId, "users", sellerId, "profiles", "user_profile");
                const listingRef = doc(db, "artifacts", appId, "public", "data", "market_listings", listingId);

                await runTransaction(db, async (transaction) => {
                    const buyerDoc = await transaction.get(buyerProfileRef);
                    const sellerDoc = await transaction.get(sellerProfileRef);
                    const listingDoc = await transaction.get(listingRef);

                    if (!buyerDoc.exists()) throw new Error("Buyer profile not found!");
                    if (!sellerDoc.exists()) throw new Error("Seller profile not found!");
                    if (!listingDoc.exists()) throw new Error("Listing not found!");
                    if (listingDoc.data().isSold) throw new Error("Item already sold!");

                    const currentBuyerJCoins = buyerDoc.data().jCoins || 0;
                    const currentBuyerGas = buyerDoc.data().gas || 0;
                    const currentSellerJCoins = sellerDoc.data().jCoins || 0;
                    const currentSellerGas = sellerDoc.data().gas || 0;

                    let newBuyerJCoins = currentBuyerJCoins;
                    let newBuyerGas = currentBuyerGas;
                    let newSellerJCoins = currentSellerJCoins;
                    let newSellerGas = currentSellerGas;

                    if (currency === 'JCoins') {
                        if (currentBuyerJCoins < price) throw new Error("Insufficient JCoins.");
                        newBuyerJCoins -= price;
                        newSellerJCoins += price;
                    } else if (currency === 'Gas') {
                        if (currentBuyerGas < price) throw new Error("Insufficient Gas.");
                        newBuyerGas -= price;
                        newSellerGas += price;
                    }

                    // 1. Deduct from buyer
                    transaction.update(buyerProfileRef, {
                        jCoins: newBuyerJCoins,
                        gas: newBuyerGas,
                        updatedAt: serverTimestamp()
                    });

                    // 2. Add to seller
                    transaction.update(sellerProfileRef, {
                        jCoins: newSellerJCoins,
                        gas: newSellerGas,
                        updatedAt: serverTimestamp()
                    });

                    // 3. Mark listing as sold
                    transaction.update(listingRef, {
                        isSold: true,
                        buyerId: currentUser.uid,
                        purchasedAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    });
                });

                // After successful transaction, update local profile data and UI for buyer
                await fetchAndDisplayHeaderProfile(currentUser);

                // Create pending activity rewards for admin review
                await createPendingActivityReward(
                    currentUser.uid,
                    currentUserProfileData.username,
                    'item_purchase',
                    currency === 'JCoins' ? -price : 0,
                    0,
                    currency === 'Gas' ? -price : 0,
                    listingId
                );
                await createPendingActivityReward(
                    sellerId,
                    sellerUsername,
                    'item_sale',
                    currency === 'JCoins' ? price : 0,
                    0,
                    currency === 'Gas' ? price : 0,
                    listingId
                );

                showMessageBox(`You successfully bought "${itemName}"!`, "success");
                // The onSnapshot listeners will automatically update the UI (item will disappear from browse)
            } catch (error) {
                console.error("JCHAT_ERROR: Error buying item:", error);
                showMessageBox(`Failed to buy item: ${error.message}`, "error");
            } finally {
                toggleButtonLoading(buttonElement, false);
            }
        }

        /**
         * Handles deleting a listing.
         * @param {string} listingId - The ID of the listing to delete.
         * @param {string} itemName - The name of the item.
         * @param {HTMLElement} buttonElement - The delete button.
         */
        async function handleDeleteListing(listingId, itemName, buttonElement) {
            if (!currentUser) {
                showMessageBox("You must be logged in to delete a listing.", "error");
                return;
            }

            const confirmed = await showCustomConfirm(`Are you sure you want to delete "${itemName}"? This cannot be undone.`);
            if (!confirmed) return;

            toggleButtonLoading(buttonElement, true);
            showMessageBox(`Deleting "${itemName}"...`, "loading", true);

            try {
                const listingRef = doc(db, "artifacts", appId, "public", "data", "market_listings", listingId);
                const listingDoc = await getDoc(listingRef);

                if (!listingDoc.exists()) {
                    throw new Error("Listing not found.");
                }

                if (listingDoc.data().sellerId !== currentUser.uid) {
                    throw new Error("You are not authorized to delete this listing.");
                }

                await deleteDoc(listingRef);

                showMessageBox(`Listing "${itemName}" deleted successfully!`, "success");
                // onSnapshot listeners will handle UI updates
            } catch (error) {
                console.error("JCHAT_ERROR: Error deleting listing:", error);
                showMessageBox(`Failed to delete listing: ${error.message}`, "error");
            } finally {
                toggleButtonLoading(buttonElement, false);
            }
        }


        // --- Authentication State Listener ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                isAuthReady = true;
                await fetchAndDisplayHeaderProfile(user);
                fetchNotificationCount(user.uid);
                fetchMyListings(); // Start fetching user's listings
                fetchAllMarketListings(); // Start fetching all listings
            } else {
                isAuthReady = false;
                currentUser = null;
                headerDisplayName.textContent = "Guest";
                headerProfilePic.style.display = 'none';
                headerAvatarIcon.style.display = 'block';
                jCoinsDisplay.innerHTML = `<i class="fas fa-coins jcoin-icon"></i> 0`;
                gasDisplay.innerHTML = `<i class="fas fa-gas-pump gas-icon"></i> 0`;
                loadingMyListingsMessage.textContent = 'Please log in to see your listings.';
                loadingFeaturedListingsMessage.textContent = 'Please log in to browse the marketplace.';
                loadingAllListingsMessage.textContent = 'Please log in to browse the marketplace.';

                showMessageBox("You must be logged in to access the marketplace.", 'error', 2000, true);
                setTimeout(() => {
                    window.location.href = '/login.html';
                }, 2000);
            }
        });

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            // Apply saved theme
            const savedTheme = localStorage.getItem('jchat-theme');
            const themes = ['theme-light-mode', 'theme-dark-mode', 'theme-glass-mode', 'theme-sunset-mode'];
            if (savedTheme && themes.includes(savedTheme)) {
                document.body.classList.remove(...themes);
                document.body.classList.add(savedTheme);
            } else {
                document.body.classList.add('theme-dark-mode'); // Default to dark mode
            }

            populateCategories();
            populateLocations();

            // Filters and Search
            mainSearchInput.addEventListener('input', filterAndDisplayAllListings);
            mainSearchBtn.addEventListener('click', filterAndDisplayAllListings); // Trigger filter on button click
            locationFilterSelect.addEventListener('change', filterAndDisplayAllListings);
            minPriceInput.addEventListener('input', filterAndDisplayAllListings);
            maxPriceInput.addEventListener('input', filterAndDisplayAllListings);
            currencyFilter.addEventListener('change', filterAndDisplayAllListings);

            categoryFilterList.addEventListener('click', (e) => {
                e.preventDefault();
                const target = e.target.closest('a');
                if (target && target.dataset.category) {
                    // Remove active class from all category links
                    categoryFilterList.querySelectorAll('a').forEach(link => link.classList.remove('active'));
                    // Add active class to the clicked link
                    target.classList.add('active');
                    filterAndDisplayAllListings(); // Re-filter listings
                }
            });


            postListingFab.addEventListener('click', () => {
                if (!currentUser || !currentUserProfileData) {
                    showMessageBox("Please log in to post an item.", "error");
                    return;
                }
                // Clear previous form data
                itemNameInput.value = '';
                itemDescriptionInput.value = '';
                itemPriceInput.value = '';
                itemPriceCurrencySelect.value = 'JCoins';
                itemImageUrlInput.value = '';
                itemCategorySelect.value = ''; // Reset category
                itemLocationSelect.value = ''; // Reset location
                postListingModal.classList.add('active');
            });
            cancelPostListingBtn.addEventListener('click', () => {
                postListingModal.classList.remove('active');
            });
            submitPostListingBtn.addEventListener('click', handlePostListing);

            // Close modal if clicking outside content
            postListingModal.addEventListener('click', (e) => {
                if (e.target === postListingModal) {
                    postListingModal.classList.remove('active');
                }
            });

            // Listing Details Modal (placeholder for future interaction)
            closeDetailsModalBtn.addEventListener('click', () => listingDetailsModal.classList.remove('active'));
            listingDetailsModal.addEventListener('click', (e) => {
                if (e.target === listingDetailsModal) {
                    listingDetailsModal.classList.remove('active');
                }
            });
        });

        window.addEventListener('storage', (event) => {
            if (event.key === 'jchat-theme') {
                const newTheme = event.newValue || 'theme-dark-mode';
                const themes = ['theme-light-mode', 'theme-dark-mode', 'theme-glass-mode', 'theme-sunset-mode'];
                if (themes.includes(newTheme)) {
                    document.body.classList.remove(...themes);
                    document.body.classList.add(newTheme);
                }
            }
        });
    </script>
</body>
</html>
