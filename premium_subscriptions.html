<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JCHAT - Premium Subscriptions</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        *, *::before, *::after {
            box-sizing: border-box;
        }

        :root {
            --pink: #ff2e92;
            --blue: #00d5ff;
            --glass-black: rgba(10, 10, 10, .75);
            --glass-blue: rgba(0, 213, 255, .15);
            --radius: 20px;
            --transition: .3s ease;
            --white: #fff;
            --text-light: rgba(255, 255, 255, .7);
            --background-main: rgba(10, 10, 10, .75);
            --background-gradient-1: #00d5ff;
            --background-gradient-2: #ff2e92;
            --card-background: linear-gradient(145deg, rgba(255, 255, 255, .03), rgba(255, 255, 255, .01));
            --header-background: linear-gradient(135deg, rgba(10, 10, 20, .85), rgba(10, 10, 20, .75));
            --border-light: rgba(255, 255, 255, .05);
            --input-background: rgba(255, 255, 255, 0.05);
            --button-background: linear-gradient(90deg, var(--blue), var(--pink));
            --button-shadow: 0 4px 15px var(--blue), 0 4px 15px var(--pink);
            
            /* Premium specific colors */
            --premium-gold: #ffd700;
            --premium-silver: #c0c0c0;
            --premium-bronze: #cd7f32;
            --premium-platinum: #e5e4e2;
            --success-green: #4CAF50;
            --warning-orange: #ff9800;
        }

        body {
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
            padding-bottom: 20px;
            background-color: var(--background-main);
            background-image: radial-gradient(circle at top left, var(--background-gradient-1), transparent 100px),
                              radial-gradient(circle at bottom right, var(--background-gradient-2), transparent 150px);
            color: var(--white);
        }

        .header {
            width: 100%;
            background: var(--header-background);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-light);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 800;
            background: linear-gradient(45deg, var(--blue), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-decoration: none;
        }

        .nav ul {
            list-style: none;
            display: flex;
            gap: 2rem;
            margin: 0;
            padding: 0;
        }

        .nav a {
            color: var(--white);
            text-decoration: none;
            transition: var(--transition);
            font-weight: 500;
        }

        .nav a:hover {
            color: var(--blue);
        }

        .main-content {
            max-width: 1200px;
            width: 100%;
            padding: 2rem;
        }

        .hero-section {
            text-align: center;
            margin-bottom: 3rem;
        }

        .hero-section h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
            background: linear-gradient(45deg, var(--blue), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .hero-section p {
            font-size: 1.2rem;
            color: var(--text-light);
            max-width: 600px;
            margin: 0 auto;
        }

        .subscription-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .subscription-card {
            background: var(--card-background);
            border: 1px solid var(--border-light);
            border-radius: var(--radius);
            padding: 2rem;
            text-align: center;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .subscription-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .subscription-card.featured {
            border: 2px solid var(--premium-gold);
            transform: scale(1.05);
        }

        .subscription-card.featured::before {
            content: "MOST POPULAR";
            position: absolute;
            top: 1rem;
            right: -2rem;
            background: var(--premium-gold);
            color: #000;
            padding: 0.5rem 2rem;
            transform: rotate(45deg);
            font-size: 0.8rem;
            font-weight: bold;
        }

        .plan-name {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .plan-price {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .plan-price .currency {
            font-size: 1.5rem;
            vertical-align: top;
        }

        .plan-price .period {
            font-size: 1rem;
            color: var(--text-light);
        }

        .plan-description {
            color: var(--text-light);
            margin-bottom: 2rem;
        }

        .features-list {
            list-style: none;
            padding: 0;
            margin: 0 0 2rem 0;
            text-align: left;
        }

        .features-list li {
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-light);
        }

        .features-list li:last-child {
            border-bottom: none;
        }

        .features-list li i {
            color: var(--success-green);
            margin-right: 0.5rem;
            width: 20px;
        }

        .subscribe-btn {
            width: 100%;
            padding: 1rem 2rem;
            background: var(--button-background);
            border: none;
            border-radius: var(--radius);
            color: var(--white);
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--button-shadow);
        }

        .subscribe-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }

        .subscribe-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .current-plan-badge {
            background: var(--success-green);
            color: var(--white);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .jcoin-integration {
            background: var(--card-background);
            border: 1px solid var(--border-light);
            border-radius: var(--radius);
            padding: 2rem;
            margin-top: 2rem;
        }

        .jcoin-integration h3 {
            color: var(--premium-gold);
            margin-bottom: 1rem;
        }

        .jcoin-packages {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .jcoin-package {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-light);
            border-radius: var(--radius);
            padding: 1rem;
            text-align: center;
        }

        .jcoin-amount {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--premium-gold);
        }

        .jcoin-price {
            color: var(--text-light);
            margin-top: 0.5rem;
        }

        .message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: var(--radius);
            color: var(--white);
            font-weight: 500;
            z-index: 10000;
            display: none;
            max-width: 300px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .message-box.show {
            display: block;
        }

        .message-box.success {
            background: var(--success-green);
        }

        .message-box.error {
            background: #f44336;
        }

        .message-box.info {
            background: var(--blue);
        }

        .message-box.warning {
            background: var(--warning-orange);
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--white);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .subscription-grid {
                grid-template-columns: 1fr;
            }
            
            .hero-section h1 {
                font-size: 2rem;
            }
            
            .main-content {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="/Home.html" class="logo">JCHAT</a>
            <nav class="nav">
                <ul>
                    <li><a href="/Home.html">Home</a></li>
                    <li><a href="/profile.html">Profile</a></li>
                    <li><a href="/wallet.html">Wallet</a></li>
                    <li><a href="/jcoin_shop.html">Buy JCoins</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="main-content">
        <div class="hero-section">
            <h1>Unlock Premium Features</h1>
            <p>Enhance your JCHAT experience with exclusive features, premium themes, and advanced tools</p>
        </div>

        <div class="subscription-grid">
            <!-- Basic Premium -->
            <div class="subscription-card">
                <div class="plan-name">Basic Premium</div>
                <div class="plan-price">
                    <span class="currency">₦</span>499
                    <span class="period">/month</span>
                </div>
                <div class="plan-description">Perfect for casual users who want enhanced features</div>
                
                <ul class="features-list">
                    <li><i class="fas fa-check"></i> Premium themes (5+ exclusive themes)</li>
                    <li><i class="fas fa-check"></i> Custom profile frames</li>
                    <li><i class="fas fa-check"></i> Priority customer support</li>
                    <li><i class="fas fa-check"></i> Ad-free experience</li>
                    <li><i class="fas fa-check"></i> 100 JCoins monthly bonus</li>
                </ul>
                
                <button class="subscribe-btn" onclick="subscribeToPlan('basic')" id="basicBtn">
                    <span class="btn-text">Subscribe Now</span>
                    <span class="loading-spinner" style="display: none;"></span>
                </button>
            </div>

            <!-- Pro Premium -->
            <div class="subscription-card featured">
                <div class="plan-name">Pro Premium</div>
                <div class="plan-price">
                    <span class="currency">₦</span>999
                    <span class="period">/month</span>
                </div>
                <div class="plan-description">Best value for power users and content creators</div>
                
                <ul class="features-list">
                    <li><i class="fas fa-check"></i> All Basic features</li>
                    <li><i class="fas fa-check"></i> Unlimited premium themes</li>
                    <li><i class="fas fa-check"></i> Advanced analytics dashboard</li>
                    <li><i class="fas fa-check"></i> Unlimited groups creation</li>
                    <li><i class="fas fa-check"></i> Custom emoji packs</li>
                    <li><i class="fas fa-check"></i> 250 JCoins monthly bonus</li>
                    <li><i class="fas fa-check"></i> Priority chat features</li>
                </ul>
                
                <button class="subscribe-btn" onclick="subscribeToPlan('pro')" id="proBtn">
                    <span class="btn-text">Subscribe Now</span>
                    <span class="loading-spinner" style="display: none;"></span>
                </button>
            </div>

            <!-- Enterprise -->
            <div class="subscription-card">
                <div class="plan-name">Enterprise</div>
                <div class="plan-price">
                    <span class="currency">₦</span>1999
                    <span class="period">/month</span>
                </div>
                <div class="plan-description">Complete solution for businesses and teams</div>
                
                <ul class="features-list">
                    <li><i class="fas fa-check"></i> All Pro features</li>
                    <li><i class="fas fa-check"></i> Team management tools</li>
                    <li><i class="fas fa-check"></i> Advanced moderation tools</li>
                    <li><i class="fas fa-check"></i> Custom branding options</li>
                    <li><i class="fas fa-check"></i> API access</li>
                    <li><i class="fas fa-check"></i> 500 JCoins monthly bonus</li>
                    <li><i class="fas fa-check"></i> Dedicated support</li>
                </ul>
                
                <button class="subscribe-btn" onclick="subscribeToPlan('enterprise')" id="enterpriseBtn">
                    <span class="btn-text">Subscribe Now</span>
                    <span class="loading-spinner" style="display: none;"></span>
                </button>
            </div>
        </div>

        <div class="jcoin-integration">
            <h3><i class="fas fa-coins"></i> JCoin Integration</h3>
            <p>All premium subscriptions include monthly JCoin bonuses. You can also purchase additional JCoins separately.</p>
            
            <div class="jcoin-packages">
                <div class="jcoin-package">
                    <div class="jcoin-amount">1000 JCoins</div>
                    <div class="jcoin-price">₦400</div>
                </div>
                <div class="jcoin-package">
                    <div class="jcoin-amount">2500 JCoins</div>
                    <div class="jcoin-price">₦1000</div>
                </div>
                <div class="jcoin-package">
                    <div class="jcoin-amount">5000 JCoins</div>
                    <div class="jcoin-price">₦2000</div>
                </div>
                <div class="jcoin-package">
                    <div class="jcoin-amount">12500 JCoins</div>
                    <div class="jcoin-price">₦5000</div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 1rem;">
                <a href="/jcoin_shop.html" class="subscribe-btn" style="display: inline-block; text-decoration: none; margin-top: 1rem;">
                    <i class="fas fa-shopping-cart"></i> Buy JCoins
                </a>
            </div>
        </div>
    </main>

    <div id="messageBox" class="message-box"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, getDoc, serverTimestamp, addDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBvQhHhHhHhHhHhHhHhHhHhHhHhHhHhHh",
            authDomain: "jchat-12345.firebaseapp.com",
            projectId: "jchat-12345",
            storageBucket: "jchat-12345.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdefghijklmnop"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "jchat-12345";

        // Global variables
        let currentUser = null;
        let userPremiumStatus = null;
        let isProcessing = false;

        // Plan details
        const plans = {
            basic: { 
                name: 'Basic Premium', 
                price: 499, 
                jcoins: 100,
                features: ['Premium themes (5+ exclusive themes)', 'Custom profile frames', 'Priority customer support', 'Ad-free experience', '100 JCoins monthly bonus']
            },
            pro: { 
                name: 'Pro Premium', 
                price: 999, 
                jcoins: 250,
                features: ['All Basic features', 'Unlimited premium themes', 'Advanced analytics dashboard', 'Unlimited groups creation', 'Custom emoji packs', '250 JCoins monthly bonus', 'Priority chat features']
            },
            enterprise: { 
                name: 'Enterprise', 
                price: 1999, 
                jcoins: 500,
                features: ['All Pro features', 'Team management tools', 'Advanced moderation tools', 'Custom branding options', 'API access', '500 JCoins monthly bonus', 'Dedicated support']
            }
        };

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            checkUserAuth();
        });

        // Check user authentication
        function checkUserAuth() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    await loadUserPremiumStatus();
                    updateSubscriptionUI();
                } else {
                    // Redirect to login if not authenticated
                    window.location.href = '/Login.html';
                }
            });
        }

        // Load user's premium status from Firebase
        async function loadUserPremiumStatus() {
            try {
                const userRef = doc(db, "artifacts", appId, "public", "data", "users", currentUser.uid);
                const userDoc = await getDoc(userRef);
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    userPremiumStatus = userData.premium || {
                        plan: 'none',
                        expiresAt: null,
                        features: [],
                        startDate: null
                    };
                } else {
                    userPremiumStatus = {
                        plan: 'none',
                        expiresAt: null,
                        features: [],
                        startDate: null
                    };
                }
            } catch (error) {
                console.error('Error loading user premium status:', error);
                userPremiumStatus = {
                    plan: 'none',
                    expiresAt: null,
                    features: [],
                    startDate: null
                };
            }
        }

        // Update UI based on user's premium status
        function updateSubscriptionUI() {
            if (userPremiumStatus.plan !== 'none') {
                // Show current plan badge
                const cards = document.querySelectorAll('.subscription-card');
                cards.forEach(card => {
                    const planName = card.querySelector('.plan-name').textContent.toLowerCase();
                    if (planName.includes(userPremiumStatus.plan)) {
                        // Remove existing badge if any
                        const existingBadge = card.querySelector('.current-plan-badge');
                        if (existingBadge) existingBadge.remove();
                        
                        const badge = document.createElement('div');
                        badge.className = 'current-plan-badge';
                        badge.textContent = 'Current Plan';
                        card.insertBefore(badge, card.firstChild);
                        
                        const btn = card.querySelector('.subscribe-btn');
                        const btnText = btn.querySelector('.btn-text');
                        btnText.textContent = 'Manage Subscription';
                        btn.onclick = () => manageSubscription(userPremiumStatus.plan);
                    }
                });
            }
        }

        // Subscribe to a premium plan
        window.subscribeToPlan = async function(planType) {
            if (isProcessing) return;
            
            if (!currentUser) {
                showMessage('Please log in to subscribe', 'error');
                return;
            }

            const planDetails = plans[planType];
            if (!planDetails) {
                showMessage('Invalid plan selected', 'error');
                return;
            }

            // Check if user already has this plan
            if (userPremiumStatus.plan === planType) {
                showMessage('You already have this plan', 'info');
                return;
            }

            // Show confirmation dialog
            if (confirm(`Subscribe to ${planDetails.name} for ₦${planDetails.price}/month?\n\nThis will redirect you to complete your payment.`)) {
                await processSubscription(planType, planDetails);
            }
        };

        // Process subscription
        async function processSubscription(planType, planDetails) {
            try {
                isProcessing = true;
                setButtonLoading(planType, true);
                
                showMessage('Processing subscription...', 'info');
                
                // Create subscription record in Firebase
                const subscriptionData = {
                    userId: currentUser.uid,
                    username: currentUser.displayName || currentUser.email,
                    email: currentUser.email,
                    plan: planType,
                    planName: planDetails.name,
                    amount: planDetails.price,
                    jcoins: planDetails.jcoins,
                    status: 'pending',
                    startDate: serverTimestamp(),
                    endDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000), // 30 days from now
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                };

                // Save to premium_subscriptions collection
                const subscriptionRef = collection(db, "artifacts", appId, "public", "data", "premium_subscriptions");
                await addDoc(subscriptionRef, subscriptionData);

                // Add activity log
                const activityRef = collection(db, "artifacts", appId, "public", "data", "premium_activity");
                await addDoc(activityRef, {
                    type: 'subscription',
                    title: `New ${planDetails.name} subscription`,
                    description: `${currentUser.displayName || currentUser.email} subscribed to ${planDetails.name}`,
                    timestamp: serverTimestamp(),
                    userId: currentUser.uid,
                    planType: planType,
                    amount: planDetails.price
                });

                // Show payment instructions
                showPaymentInstructions(planType, planDetails, subscriptionData);
                
            } catch (error) {
                console.error('Error processing subscription:', error);
                showMessage('Failed to process subscription. Please try again.', 'error');
            } finally {
                isProcessing = false;
                setButtonLoading(planType, false);
            }
        }

        // Set button loading state
        function setButtonLoading(planType, isLoading) {
            const btn = document.getElementById(`${planType}Btn`);
            if (btn) {
                const btnText = btn.querySelector('.btn-text');
                const spinner = btn.querySelector('.loading-spinner');
                
                if (isLoading) {
                    btn.disabled = true;
                    btnText.style.display = 'none';
                    spinner.style.display = 'inline-block';
                } else {
                    btn.disabled = false;
                    btnText.style.display = 'inline';
                    spinner.style.display = 'none';
                }
            }
        }

        // Show payment instructions
        function showPaymentInstructions(planType, planDetails, subscriptionData) {
            const message = `
                To complete your ${planDetails.name} subscription:
                
                1. Transfer ₦${planDetails.price} to:
                   Bank: Opay
                   Account: 8111609765
                   Name: Elechi Joshua
                
                2. Send payment proof to WhatsApp: 08111609765
                
                3. Include your User ID: ${currentUser.uid}
                
                Your subscription will be activated after payment verification.
                
                Subscription ID: ${subscriptionData.id || 'Pending'}
            `;
            
            alert(message);
            showMessage('Payment instructions sent! Check your subscription status in your profile.', 'success');
        }

        // Manage existing subscription
        window.manageSubscription = function(planType) {
            showMessage('Subscription management coming soon! You can contact support for changes.', 'info');
        };

        // Show message
        function showMessage(message, type = 'info') {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.className = `message-box show ${type}`;
            
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 5000);
        }
    </script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, getDoc, serverTimestamp, addDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBvQhHhHhHhHhHhHhHhHhHhHhHhHhHhHhHh",
            authDomain: "jchat-12345.firebaseapp.com",
            projectId: "jchat-12345",
            storageBucket: "jchat-12345.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdefghijklmnop"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "jchat-12345";

        // Global variables
        let currentUser = null;
        let userPremiumStatus = null;
        let isProcessing = false;

        // Plan details
        const plans = {
            basic: { 
                name: 'Basic Premium', 
                price: 499, 
                jcoins: 100,
                features: ['Premium themes (5+ exclusive themes)', 'Custom profile frames', 'Priority customer support', 'Ad-free experience', '100 JCoins monthly bonus']
            },
            pro: { 
                name: 'Pro Premium', 
                price: 999, 
                jcoins: 250,
                features: ['All Basic features', 'Unlimited premium themes', 'Advanced analytics dashboard', 'Unlimited groups creation', 'Custom emoji packs', '250 JCoins monthly bonus', 'Priority chat features']
            },
            enterprise: { 
                name: 'Enterprise', 
                price: 1999, 
                jcoins: 500,
                features: ['All Pro features', 'Team management tools', 'Advanced moderation tools', 'Custom branding options', 'API access', '500 JCoins monthly bonus', 'Dedicated support']
            }
        };

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            checkUserAuth();
        });

        // Check user authentication
        function checkUserAuth() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    await loadUserPremiumStatus();
                    updateSubscriptionUI();
                } else {
                    // Redirect to login if not authenticated
                    window.location.href = '/Login.html';
                }
            });
        }

        // Load user premium status
        async function loadUserPremiumStatus() {
            try {
                const userDoc = await getDoc(doc(db, `artifacts/${appId}/public/data/users/${currentUser.uid}`));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    userPremiumStatus = userData.premiumStatus || null;
                } else {
                    // Create user document if it doesn't exist
                    await setDoc(doc(db, `artifacts/${appId}/public/data/users/${currentUser.uid}`), {
                        uid: currentUser.uid,
                        email: currentUser.email,
                        username: currentUser.displayName || currentUser.email,
                        premiumStatus: null,
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    });
                    userPremiumStatus = null;
                }
            } catch (error) {
                console.error('Error loading user premium status:', error);
                showMessage('Error loading user data', 'error');
            }
        }

        // Update subscription UI
        function updateSubscriptionUI() {
            // Remove any existing current plan badges
            document.querySelectorAll('.current-plan-badge').forEach(badge => badge.remove());
            
            if (userPremiumStatus) {
                const planCard = document.querySelector(`[data-plan="${userPremiumStatus.plan}"]`);
                if (planCard) {
                    const badge = document.createElement('div');
                    badge.className = 'current-plan-badge';
                    badge.textContent = 'Current Plan';
                    badge.style.cssText = 'background: var(--success-green); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; font-weight: 600; text-align: center; margin-top: 1rem;';
                    planCard.appendChild(badge);
                    
                    // Change button text
                    const button = planCard.querySelector('.subscribe-btn');
                    if (button) {
                        button.textContent = 'Manage Subscription';
                        button.onclick = () => manageSubscription(userPremiumStatus.plan);
                    }
                }
            }
        }

        // Subscribe to plan
        function subscribeToPlan(planType) {
            if (isProcessing) return;
            if (!currentUser) {
                showMessage('Please log in to subscribe', 'error');
                return;
            }
            if (!plans[planType]) {
                showMessage('Invalid plan selected', 'error');
                return;
            }
            if (userPremiumStatus && userPremiumStatus.plan === planType) {
                showMessage('You already own this plan', 'info');
                return;
            }
            
            processSubscription(planType, plans[planType]);
        }

        // Process subscription
        async function processSubscription(planType, planDetails) {
            isProcessing = true;
            setButtonLoading(planType, true);
            
            try {
                // Create subscription document
                const subscriptionData = {
                    userId: currentUser.uid,
                    username: currentUser.displayName || currentUser.email,
                    email: currentUser.email,
                    plan: planType,
                    planName: planDetails.name,
                    amount: planDetails.price,
                    jcoins: planDetails.jcoins,
                    status: 'pending',
                    startDate: serverTimestamp(),
                    endDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000), // 30 days from now
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                };

                const subscriptionRef = await addDoc(collection(db, `artifacts/${appId}/public/data/premium_subscriptions`), subscriptionData);

                // Add activity log
                await addDoc(collection(db, `artifacts/${appId}/public/data/premium_activity`), {
                    userId: currentUser.uid,
                    username: currentUser.displayName || currentUser.email,
                    activityType: 'subscription',
                    title: `Subscribed to ${planDetails.name}`,
                    description: `User subscribed to ${planDetails.name} plan`,
                    amount: planDetails.price,
                    plan: planType,
                    subscriptionId: subscriptionRef.id,
                    timestamp: serverTimestamp()
                });

                showPaymentInstructions(planType, planDetails, subscriptionRef.id);
                
            } catch (error) {
                console.error('Error processing subscription:', error);
                showMessage('Error processing subscription. Please try again.', 'error');
            } finally {
                isProcessing = false;
                setButtonLoading(planType, false);
            }
        }

        // Set button loading state
        function setButtonLoading(planType, isLoading) {
            const button = document.getElementById(`${planType}Btn`);
            if (button) {
                button.disabled = isLoading;
                const btnText = button.querySelector('.btn-text');
                const spinner = button.querySelector('.loading-spinner');
                
                if (isLoading) {
                    btnText.textContent = 'Processing...';
                    spinner.style.display = 'inline-block';
                } else {
                    btnText.textContent = 'Subscribe Now';
                    spinner.style.display = 'none';
                }
            }
        }

        // Show payment instructions
        function showPaymentInstructions(planType, planDetails, subscriptionId) {
            alert(`Payment Instructions for ${planDetails.name}:
            
Your User ID: ${currentUser.uid}
Subscription ID: ${subscriptionId}
Amount: ₦${planDetails.price}

Please contact support to complete your payment and activate your subscription.`);
            
            showMessage(`Subscription created successfully! Please contact support to complete payment.`, 'success');
        }

        // Manage subscription
        function manageSubscription(planType) {
            showMessage('Subscription management features coming soon. Please contact support for assistance.', 'info');
        }

        // Logout
        function handleLogout() {
            signOut(auth).then(() => {
                window.location.href = '/Login.html';
            }).catch((error) => {
                console.error('Error signing out:', error);
                showMessage('Error signing out', 'error');
            });
        }
    </script>
</body>
</html>