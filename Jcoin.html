<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JCHAT - JCoin Code Generator (Admin)</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://*.firebaseio.com" crossorigin>
    <link rel="preconnect" href="https://res.cloudinary.com" crossorigin>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* Universal box-sizing for consistent layout */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        /* Global CSS Variables - Keep consistent with other pages */
        :root {
            --pink: #ff2e92;
            --blue: #00d5ff;
            --glass-black: rgba(10, 10, 10, .75);
            --glass-blue: rgba(0, 213, 255, .15);
            --radius: 20px;
            --transition: .3s ease;

            /* These variables will be overridden by theme classes */
            --white: #fff;
            --text-light: rgba(255, 255, 255, .7);
            --background-main: rgba(10, 10, 10, .75);
            --background-gradient-1: #00d5ff;
            --background-gradient-2: #ff2e92;
            --card-background: linear-gradient(145deg, rgba(255, 255, 255, .03), rgba(255, 255, 255, .01));
            --header-background: linear-gradient(135deg, rgba(10, 10, 20, .85), rgba(10, 10, 20, .75));
            --border-light: rgba(255, 255, 255, .05);
            --input-background: rgba(255, 255, 255, 0.05);
            --button-background: linear-gradient(90deg, var(--blue), var(--pink));
            --button-shadow: 0 4px 15px var(--blue), 0 4px 15px var(--pink);
        }

        /* --- Theme Definitions (Simplified: Light and Dark Mode) --- */
        /* Light Mode */
        body.theme-light-mode {
            --background-main: #f0f2f5; /* Light gray background */
            --background-gradient-1: #e0e2e5; /* Subtle lighter gradient */
            --background-gradient-2: #d0d2d5; /* Subtle darker gradient */
            --white: #333; /* Dark text for readability */
            --text-light: #666; /* Lighter dark text */
            --card-background: rgba(255, 255, 255, 0.95); /* Near white cards */
            --header-background: rgba(255, 255, 255, 0.98); /* Near white header */
            --border-light: rgba(0, 0, 0, 0.1); /* Light borders */
            --input-background: rgba(0, 0, 0, 0.05); /* Light input background */
            --button-background: linear-gradient(90deg, #6dd5ed, #2193b0); /* Blue gradient */
            --button-shadow: 0 4px 15px rgba(109, 213, 237, 0.4), 0 4px 15px rgba(33, 147, 176, 0.4);
        }

        /* Dark Mode */
        body.theme-dark-mode {
            --background-main: #1a1a2e; /* Deep purple-dark blue */
            --background-gradient-1: #16213e; /* Slightly lighter deep blue */
            --background-gradient-2: #0f3460; /* Darker blue */
            --white: #e0e0e0; /* Off-white text */
            --text-light: #a0a0a0; /* Grayish text */
            --card-background: rgba(25, 25, 40, 0.7); /* Darker, less transparent cards */
            --header-background: linear-gradient(135deg, rgba(10, 10, 20, .85), rgba(10, 10, 20, .75)); /* Original dark header */
            --border-light: rgba(255, 255, 255, 0.08); /* Subtle white borders */
            --input-background: rgba(255, 255, 255, 0.08); /* Dark input background */
            --button-background: linear-gradient(90deg, #e94560, #ba2f49); /* Reddish gradient */
            --button-shadow: 0 4px 15px rgba(233, 69, 96, 0.4), 0 4px 15px rgba(186, 47, 73, 0.4);
        }

        /* Always show scrollbar to prevent layout shifts */
        html {
            overflow-y: scroll;
        }

        body {
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
            padding-bottom: 20px; /* Some padding at the bottom */
            background-color: var(--background-main);
            background-image: radial-gradient(circle at top left, var(--background-gradient-1), transparent 100px),
                              radial-gradient(circle at bottom right, var(--background-gradient-2), transparent 150px);
            color: var(--white);
            transition: background-color 0.5s ease, color 0.5s ease; /* Smooth theme transition */
        }

        /* Header Styling */
        header {
            background: var(--header-background);
            border-bottom: 1px solid var(--border-light);
            padding: 10px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 55px;
            z-index: 10;
            display: flex;
            justify-content: center;
        }

        header .header-content-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 1200px;
            padding: 0 30px;
        }

        .logo {
            font-family: 'Poppins', sans-serif;
            font-size: 1.8rem;
            font-weight: 800;
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            letter-spacing: -0.03em;
            text-decoration: none;
        }

        /* Header Navigation (simplified) */
        header nav ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            gap: 25px;
        }

        header nav ul li a {
            color: var(--white);
            text-decoration: none;
            font-weight: 600;
            font-size: 1.1rem;
            padding: 5px 0;
            position: relative;
            transition: color var(--transition);
        }

        header nav ul li a::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: 0;
            width: 0;
            height: 3px;
            background: var(--blue);
            border-radius: 2px;
            transition: width var(--transition);
        }

        header nav ul li a:hover {
            color: var(--blue);
        }

        header nav ul li a:hover::after {
            width: 100%;
        }

        /* Smart Back Button Styling */
        .smart-back-button {
            background: linear-gradient(90deg, var(--pink), var(--blue));
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.3s ease;
            opacity: 0.8;
            margin-right: 15px;
        }

        .smart-back-button:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px var(--pink), 0 4px 15px var(--blue);
            opacity: 1;
        }

        .smart-back-button i {
            color: var(--white);
            font-size: 0.9rem;
        }

        /* User Profile Header Styling */
        .user-profile-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-profile-header #profileLink {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: var(--white);
            transition: opacity 0.3s ease, background-color 0.3s ease;
            padding: 5px 10px;
            border-radius: var(--radius);
        }

        .user-profile-header #profileLink:hover {
            opacity: 0.8;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .user-profile-header img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--blue);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: opacity 0.3s ease;
        }

        .user-profile-header i {
            font-size: 30px;
            color: var(--text-light);
        }

        .user-profile-header span {
            font-weight: 600;
            font-size: 1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
        }

        /* Logout Button Styling */
        #logoutButton {
            background: linear-gradient(90deg, var(--pink), var(--blue));
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.3s ease;
            opacity: 0.8;
            margin-left: 10px;
        }

        #logoutButton:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px var(--pink), 0 4px 15px var(--blue);
            opacity: 1;
        }

        #logoutButton i {
            color: var(--white);
            font-size: 0.9rem;
        }

        /* Main Content */
        main {
            flex-grow: 1;
            padding: 20px 0;
            padding-top: 55px; /* Adjust for fixed header */
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* Align content to top */
            text-align: center;
        }

        .content-wrapper {
            width: 100%;
            max-width: 800px; /* Wider for more content */
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .generator-card {
            background: var(--card-background);
            border: 1px solid var(--glass-blue);
            backdrop-filter: blur(10px) saturate(180%);
            border-radius: var(--radius);
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, .3);
            text-align: center;
            margin-bottom: 20px;
        }

        .generator-card h2 {
            font-family: 'Poppins', sans-serif;
            font-size: 2rem;
            font-weight: 700;
            color: var(--white);
            margin-bottom: 25px;
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
        }

        .info-section {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-item {
            flex: 1 1 150px; /* Allows items to grow/shrink but maintain min-width */
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid var(--border-light);
            box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
        }

        .info-item .label {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-bottom: 5px;
        }

        .info-item .value {
            font-family: 'Poppins', sans-serif;
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--pink);
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--white);
        }

        .form-group input[type="text"],
        .form-group select { /* Added select to styling */
            width: 100%;
            padding: 12px 15px;
            border-radius: 10px;
            background: var(--input-background);
            border: 1px solid var(--border-light);
            color: var(--white);
            font-size: 1rem;
            outline: none;
            transition: border-color var(--transition), box-shadow var(--transition);
        }

        .form-group input[type="text"]:focus,
        .form-group select:focus { /* Added select to styling */
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(0, 213, 255, 0.2);
        }

        .action-button {
            background: var(--button-background);
            color: var(--white);
            border: none;
            border-radius: 25px;
            padding: 12px 25px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: var(--button-shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 15px;
        }

        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--blue), 0 6px 20px var(--pink);
        }

        .action-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .generated-code-display {
            background: rgba(255, 255, 255, 0.05);
            border: 1px dashed var(--blue);
            border-radius: 10px;
            padding: 15px;
            margin-top: 25px;
            word-break: break-all;
            font-family: 'Courier New', monospace;
            font-size: 1.1rem;
            color: var(--pink);
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .generated-code-display button {
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            font-size: 1.2rem;
            transition: color 0.2s ease;
        }

        .generated-code-display button:hover {
            color: var(--white);
        }

        /* Custom Message Box Styles */
        #messageBox {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            min-width: 250px;
            text-align: center;
        }
        #messageBox.success {
            background-color: rgba(46, 204, 113, 0.9);
        }
        #messageBox.error {
            background-color: rgba(231, 76, 60, 0.9);
        }
        #messageBox.info {
            background-color: rgba(52, 152, 219, 0.9);
        }
        @keyframes pulse-bg {
            0% { background-color: rgba(52, 152, 219, 0.9); }
            50% { background-color: rgba(52, 152, 219, 0.7); }
            100% { background-color: rgba(52, 152, 219, 0.9); }
        }
        #messageBox.loading-pulse {
            animation: pulse-bg 1.5s infinite ease-in-out;
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            header .header-content-wrapper {
                padding: 0 20px;
            }
            .logo {
                font-size: 1.6rem;
            }
            header nav ul {
                display: none; /* Hide desktop nav on mobile */
            }
            .user-profile-header #profileLink {
                padding: 5px;
            }
            .user-profile-header span {
                max-width: 90px;
            }
            .user-profile-header img {
                width: 30px;
                height: 30px;
            }
            .user-profile-header i {
                font-size: 25px;
            }
            #logoutButton {
                width: 25px;
                height: 25px;
                font-size: 0.8rem;
                margin-left: 8px;
            }
            #logoutButton i {
                font-size: 0.8rem;
            }
            .generator-card {
                padding: 20px;
            }
            .generator-card h2 {
                font-size: 1.8rem;
            }
            .info-item .value {
                font-size: 1.3rem;
            }
            .action-button {
                padding: 10px 20px;
                font-size: 0.9rem;
            }
            .generated-code-display {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body class="theme-dark-mode">

    <header>
        <div class="header-content-wrapper">
            <!-- Smart Back Button -->
            <button id="backButton" class="smart-back-button" aria-label="Go Back"><i class="fas fa-arrow-left"></i></button>
            <a href="/home.html" class="logo">JCHAT</a>
            <nav>
                <ul>
                    <li><a href="/home.html">Home</a></li>
                    <li><a href="/chat.html">Chat</a></li>
                    <li><a href="/friends.html">Friends</a></li>
                    <li><a href="/settings.html">Settings</a></li>
                </ul>
            </nav>
            <div class="user-profile-header">
                <!-- Logout Button -->
                <button id="logoutButton" aria-label="Logout">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
                <a href="/profile.html" id="profileLink">
                    <img id="headerProfilePic" src="" alt="Profile Picture" style="display: none;">
                    <i id="headerAvatarIcon" class="fas fa-user-circle"></i>
                    <span id="headerDisplayName">Loading...</span>
                </a>
            </div>
        </div>
    </header>

    <main>
        <div class="content-wrapper">
            <div class="generator-card">
                <h2>JCoin Code Generator (Admin)</h2>

                <!-- User ID Verification Section -->
                <div class="form-group">
                    <label for="targetUserId">Enter User ID (Recipient to Verify)</label>
                    <input type="text" id="targetUserId" placeholder="Paste user ID here (e.g., 123abcDEF456)">
                    <button type="button" class="action-button" id="verifyUserButton" style="margin-top: 10px;">
                        <i class="fas fa-search"></i> Verify User & Balance
                    </button>
                </div>

                <div class="info-section" id="targetUserInfo" style="display: none;">
                    <div class="info-item">
                        <div class="label">Recipient Username</div>
                        <div class="value" id="recipientUsername">N/A</div>
                    </div>
                    <div class="info-item">
                        <div class="label">Recipient JCoins</div>
                        <div class="value" id="recipientJCoins">0</div>
                    </div>
                </div>

                <!-- JCoin Code Generation Section -->
                <form id="generateCodeForm">
                    <div class="form-group">
                        <label for="jcoinAmount">Select JCoin Amount to Generate</label>
                        <select id="jcoinAmount" required>
                            <option value="">-- Select Amount --</option>
                            <option value="200">₦200 (200 JCoins)</option>
                            <option value="500">₦500 (500 JCoins)</option>
                            <option value="1000">₦1,000 (1,000 JCoins)</option>
                            <option value="2000">₦2,000 (2,000 JCoins)</option>
                            <option value="5000">₦5,000 (5,000 JCoins)</option>
                            <option value="10000">₦10,000 (10,000 JCoins)</option>
                            <option value="20000">₦20,000 (20,000 JCoins)</option>
                            <option value="50000">₦50,000 (50,000 JCoins)</option>
                            <option value="100000">₦100,000 (100,000 JCoins)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="senderId">Optional: Sender ID (e.g., your ID or another user's ID)</label>
                        <input type="text" id="senderId" placeholder="Leave empty for no sender, or enter an ID">
                    </div>
                    <button type="submit" class="action-button" id="generateCodeButton">
                        <i class="fas fa-plus-circle"></i> Generate JCoin Code
                    </button>
                </form>

                <div class="generated-code-display" id="generatedCodeDisplay">
                    <span>Generated Code: <strong id="generatedCodeValue"></strong></span>
                    <button id="copyCodeButton" title="Copy to Clipboard"><i class="fas fa-copy"></i></button>
                </div>
            </div>
        </div>
    </main>

    <!-- Custom Message Box -->
    <div id="messageBox"></div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Firebase & Canvas Environment Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBsBinyrD9WZZXRaCvA4gxfX7BIimydDvo",
            authDomain: "jchat-1.firebaseapp.com",
            projectId: "jchat-1",
            storageBucket: "jchat-1.firebasestorage.app",
            messagingSenderId: "328479683167",
            appId: "1:328479683167:web:276c0b7e8ea44dd2d6a1ea",
            measurementId: "G-S6Z9GG0R9P"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Cloudinary Configuration (needed for header profile pic)
        const cloudinaryConfig = {
            cloudName: "dxld01rcp", // Replace with your actual Cloudinary Cloud Name
            uploadPreset: "Storage_preset" // Replace with your actual unsigned upload preset
        };

        // Initialize Firebase services
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const headerProfilePic = document.getElementById('headerProfilePic');
        const headerAvatarIcon = document.getElementById('headerAvatarIcon');
        const headerDisplayName = document.getElementById('headerDisplayName');
        const logoutButton = document.getElementById('logoutButton');
        const messageBox = document.getElementById('messageBox');
        const backButton = document.getElementById('backButton');

        // Generator Panel Elements
        const targetUserIdInput = document.getElementById('targetUserId');
        const verifyUserButton = document.getElementById('verifyUserButton');
        const targetUserInfoDiv = document.getElementById('targetUserInfo');
        const recipientUsernameDisplay = document.getElementById('recipientUsername');
        const recipientJCoinsDisplay = document.getElementById('recipientJCoins');
        const generateCodeForm = document.getElementById('generateCodeForm');
        const jcoinAmountSelect = document.getElementById('jcoinAmount');
        const senderIdInput = document.getElementById('senderId'); // New sender ID input
        const generateCodeButton = document.getElementById('generateCodeButton');
        const generatedCodeDisplay = document.getElementById('generatedCodeDisplay');
        const generatedCodeValue = document.getElementById('generatedCodeValue');
        const copyCodeButton = document.getElementById('copyCodeButton');

        // --- Global State ---
        let currentUser = null; // The currently authenticated user (Firebase Auth object)
        let currentUserProfileData = null; // The private profile data of the currently authenticated user (Firestore)
        let recipientUserData = null; // Data for the verified recipient user (for display only)

        // --- Utility Functions ---

        /**
         * Displays a temporary message box with a given message and type.
         * @param {string} message - The message to display.
         * @param {string} type - The type of message ('success', 'error', 'info').
         * @param {boolean} [isPersistent=false] - If true, message stays until explicitly cleared or replaced.
         */
        function showMessageBox(message, type, isPersistent = false) {
            if (messageBox.timeoutId) {
                clearTimeout(messageBox.timeoutId);
                messageBox.timeoutId = null;
            }

            messageBox.textContent = message;
            messageBox.className = '';
            messageBox.classList.add(type);

            if (type === 'info' && isPersistent) {
                messageBox.classList.add('loading-pulse');
            } else {
                messageBox.classList.remove('loading-pulse');
            }

            messageBox.style.display = 'block';
            messageBox.style.opacity = '1';

            if (!isPersistent) {
                messageBox.timeoutId = setTimeout(() => {
                    messageBox.style.opacity = '0';
                    messageBox.addEventListener('transitionend', function handler() {
                        messageBox.style.display = 'none';
                        messageBox.removeEventListener('transitionend', handler);
                        messageBox.classList.remove('loading-pulse');
                    }, { once: true });
                }, 3000);
            }
        }

        /**
         * Constructs a Cloudinary URL for an image/video.
         * @param {string} urlOrPublicId - The full Cloudinary URL or the public ID of the image on Cloudinary.
         * @param {string} transformations - Optional Cloudinary transformations.
         * @returns {string|null} The full Cloudinary URL or null if urlOrPublicId is not provided.
         */
        function getCloudinaryImageUrl(urlOrPublicId, transformations = "w_auto,f_auto,q_auto") {
            if (!urlOrPublicId) return null;
            if (urlOrPublicId.startsWith('http://') || urlOrPublicId.startsWith('https://')) {
                return urlOrPublicId;
            }
            return `https://res.cloudinary.com/${cloudinaryConfig.cloudName}/image/upload/${transformations}/${urlOrPublicId}`;
        }

        /**
         * Displays the profile picture or a default icon.
         * @param {HTMLElement} imgElement - The <img> element to update.
         * @param {HTMLElement} iconElement - The <i> element to display if no image.
         * @param {string|null} profilePicId - The Cloudinary public ID or URL, or null.
         * @param {string} usernameInitial - Initial for placeholder.
         * @param {string} transformations - Cloudinary transformations.
         */
        function displayProfilePicture(imgElement, iconElement, profilePicId, usernameInitial, transformations) {
            if (profilePicId) {
                const imageUrl = getCloudinaryImageUrl(profilePicId, transformations);
                imgElement.src = imageUrl;
                imgElement.style.display = 'block';
                iconElement.style.display = 'none';
                imgElement.onerror = () => {
                    console.error(`Failed to load profile picture: ${profilePicId}. Using placeholder.`);
                    imgElement.src = `https://placehold.co/120x120/CCCCCC/000000?text=${usernameInitial}`;
                    imgElement.style.display = 'block';
                    iconElement.style.display = 'none';
                };
            } else {
                imgElement.src = '';
                imgElement.style.display = 'none';
                iconElement.style.display = 'block';
            }
        }

        /**
         * Handles user logout.
         */
        async function handleLogout() {
            try {
                await signOut(auth);
                showMessageBox("Logged out successfully!", 'success');
                setTimeout(() => {
                    window.location.href = '/login.html';
                }, 1000);
            } catch (error) {
                console.error("Error logging out:", error);
                showMessageBox("Failed to log out. Please try again.", 'error');
            }
        }

        /**
         * Fetches and displays the current user's profile data for the header.
         * This function also handles initial profile creation if it doesn't exist.
         * @param {firebase.User} user - The authenticated Firebase user object.
         */
        async function fetchAndDisplayHeaderProfile(user) {
            try {
                const privateProfileDocRef = doc(db, "artifacts", appId, "users", user.uid, "profiles", "user_profile");
                const privateDocSnap = await getDoc(privateProfileDocRef);

                let profileData = null;

                if (privateDocSnap.exists()) {
                    profileData = privateDocSnap.data();
                } else {
                    // If private profile doesn't exist, create a basic one
                    profileData = {
                        username: user.displayName || "JCHAT User",
                        email: user.email || "", // Ensure email is always stored
                        fullName: "",
                        profilePicId: user.photoURL || null,
                        bio: "",
                        location: "",
                        country: "",
                        state: "",
                        school: "",
                        work: "",
                        hobbies: "",
                        feelings: "",
                        bestSong: "",
                        bestMovie: "",
                        phoneNumber: "",
                        friendsCount: 0,
                        followersCount: 0,
                        followingCount: 0,
                        totalPosts: 0,
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp(),
                        inspirationType: "motivational",
                        // Initialize lastFieldUpdateTimestamps map
                        lastFieldUpdateTimestamps: {
                            profilePicId: null,
                            fullName: null,
                            username: null,
                            bio: null,
                            location: null,
                            country: null,
                            state: null,
                            school: null,
                            work: null,
                            hobbies: null,
                            feelings: null,
                            bestSong: null,
                            bestMovie: null,
                            phoneNumber: null,
                            inspirationType: null
                        },
                        lastEmailUpdateTimestamp: null, // Initial email update timestamp
                        visibility: { // Default visibility settings: core public, all additional fields private
                            displayName: true,
                            profilePic: true,
                            friendsCount: true,
                            followersCount: true,
                            followingCount: true,
                            totalPosts: true,
                            email: true, // Email is always public by default for new users
                            // All other additional fields default to false (private) for new users
                            fullName: false,
                            bio: false,
                            location: false,
                            country: false,
                            state: false,
                            school: false,
                            work: false,
                            hobbies: false,
                            feelings: false,
                            bestSong: false,
                            bestMovie: false,
                            phoneNumber: false,
                            inspirationType: false,
                            lastOnline: false,
                            allowFriendRequests: true, // These are operational settings, not display fields
                            allowMessages: true,     // These are operational settings, not display fields
                        },
                    };
                    await setDoc(privateProfileDocRef, profileData);

                    // Also create/update public profile
                    const publicProfileDocRef = doc(db, "artifacts", appId, "public", "data", "users", user.uid);
                    await setDoc(publicProfileDocRef, {
                        username: profileData.username,
                        fullName: profileData.fullName,
                        profilePicId: profileData.profilePicId,
                        email: profileData.email, // Always include email in public profile
                        bio: profileData.bio,
                        location: profileData.location,
                        country: profileData.country,
                        state: profileData.state,
                        school: profileData.school,
                        work: profileData.work,
                        hobbies: profileData.hobbies,
                        feelings: profileData.feelings,
                        bestSong: profileData.bestSong,
                        bestMovie: profileData.bestMovie,
                        phoneNumber: profileData.phoneNumber,
                        friendsCount: profileData.friendsCount,
                        followersCount: profileData.followersCount,
                        followingCount: profileData.followingCount,
                        totalPosts: profileData.totalPosts,
                        createdAt: profileData.createdAt,
                        updatedAt: profileData.updatedAt,
                        inspirationType: profileData.inspirationType,
                        visibility: profileData.visibility,
                    });
                }

                currentUserProfileData = profileData; // Store the full private profile data
                // Update header profile link (always show current user's header info)
                displayProfilePicture(headerProfilePic, headerAvatarIcon, profileData?.profilePicId, (profileData.username || "J").charAt(0).toUpperCase(), "w_70,h_70,c_fill,g_face,r_max");
                headerDisplayName.textContent = profileData.username || "JCHAT User";

                // Update profile link to include user ID
                document.getElementById('profileLink').href = `/profile.html?userId=${user.uid}`;

            } catch (error) {
                console.error("Error fetching or creating profile for header:", error);
                // Fallback to Firebase Auth data if Firestore fetch fails for header
                displayProfilePicture(headerProfilePic, headerAvatarIcon, user.photoURL, (user.displayName || "J").charAt(0).toUpperCase(), "w_70,h_70,c_fill,g_face,r_max");
                headerDisplayName.textContent = user.displayName || "JCHAT User";
                showMessageBox(`Error loading header profile: ${error.message}`, 'error');
            }
        }

        /**
         * Fetches user progress from Firestore. If it doesn't exist, initializes it.
         * @param {string} userId - The ID of the user whose progress to fetch.
         * @returns {Promise<object>} The user's progress data.
         */
        async function getUserProgressFromFirestore(userId) {
            const userProgressDocRef = doc(db, "artifacts", appId, "users", userId, "user_progress", "progress_document");
            const docSnap = await getDoc(userProgressDocRef);

            if (docSnap.exists()) {
                return docSnap.data();
            } else {
                const defaultProgress = {
                    jCoins: 0,
                    level: 1,
                    xp: 0,
                    lastLogin: serverTimestamp()
                };
                await setDoc(userProgressDocRef, defaultProgress);
                return defaultProgress;
            }
        }

        /**
         * Verifies a target user's ID and fetches their JCoin balance and username.
         * This is for admin to view recipient's balance before generating a code.
         */
        async function verifyUserAndBalance() {
            const targetUserId = targetUserIdInput.value.trim();
            if (!targetUserId) {
                showMessageBox("Please enter a User ID to verify.", "error");
                return;
            }

            showMessageBox("Verifying user...", "info", true);
            verifyUserButton.disabled = true;

            try {
                // Fetch public profile for username
                const publicProfileDocRef = doc(db, "artifacts", appId, "public", "data", "users", targetUserId);
                const publicDocSnap = await getDoc(publicProfileDocRef);

                if (!publicDocSnap.exists()) {
                    showMessageBox("User not found.", "error");
                    targetUserInfoDiv.style.display = 'none';
                    recipientUserData = null;
                    return;
                }

                const publicProfileData = publicDocSnap.data();
                const recipientUsername = publicProfileData.username || "Unknown User";

                // Fetch user progress for JCoins
                const recipientProgress = await getUserProgressFromFirestore(targetUserId);

                recipientUserData = {
                    userId: targetUserId,
                    username: recipientUsername,
                    jCoins: recipientProgress.jCoins
                };

                recipientUsernameDisplay.textContent = recipientUsername;
                recipientJCoinsDisplay.textContent = recipientProgress.jCoins;
                targetUserInfoDiv.style.display = 'flex'; // Show the info section

                showMessageBox(`User "${recipientUsername}" verified.`, "success");

            } catch (error) {
                console.error("Error verifying user:", error);
                showMessageBox(`Error verifying user: ${error.message}`, "error");
                targetUserInfoDiv.style.display = 'none';
                recipientUserData = null;
            } finally {
                verifyUserButton.disabled = false;
            }
        }

        /**
         * Generates a unique JCoin code and stores it in Firestore as unused.
         */
        async function handleGenerateCode(event) {
            event.preventDefault();

            if (!currentUser) {
                showMessageBox("Please log in to generate JCoins.", "error");
                return;
            }

            const jcoinAmount = parseInt(jcoinAmountSelect.value, 10);
            const senderId = senderIdInput.value.trim() || null; // Get optional sender ID

            if (isNaN(jcoinAmount) || jcoinAmount <= 0) {
                showMessageBox("Please select a valid JCoin amount.", "error");
                return;
            }

            generateCodeButton.disabled = true;
            showMessageBox("Generating JCoin code...", "info", true);
            generatedCodeDisplay.style.display = 'none'; // Hide previous code

            try {
                // Generate a unique code
                const generatedCode = `JCOIN-${crypto.randomUUID().substring(0, 8).toUpperCase()}`;
                const codeDocRef = doc(db, "artifacts", appId, "public", "data", "jcoin_codes", generatedCode);

                // Store the generated code as unused in Firestore
                await setDoc(codeDocRef, {
                    code: generatedCode,
                    value: jcoinAmount,
                    generatedBy: currentUser.uid,
                    senderId: senderId, // Store the optional sender ID
                    generatedAt: serverTimestamp(),
                    status: "unused",
                    usedBy: null,
                    usedAt: null
                });

                generatedCodeValue.textContent = generatedCode;
                generatedCodeDisplay.style.display = 'flex'; // Show the generated code

                showMessageBox(`JCoin code generated successfully! Share this code: ${generatedCode}`, "success", true);
                generateCodeForm.reset(); // Clear form
                targetUserInfoDiv.style.display = 'none'; // Hide recipient info after generation
                recipientUserData = null; // Clear recipient data

            } catch (error) {
                console.error("Error during JCoin code generation:", error);
                showMessageBox(`Code generation failed: ${error.message}`, "error");
            } finally {
                generateCodeButton.disabled = false;
            }
        }

        /**
         * Copies the generated code to the clipboard.
         */
        function copyGeneratedCode() {
            const codeToCopy = generatedCodeValue.textContent;
            if (codeToCopy) {
                // Use document.execCommand('copy') for better compatibility in iframes
                const textArea = document.createElement("textarea");
                textArea.value = codeToCopy;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showMessageBox("Code copied to clipboard!", "success");
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                    showMessageBox("Failed to copy code. Please copy manually.", "error");
                }
                document.body.removeChild(textArea);
            }
        }


        // --- Event Listeners ---

        // Authentication state listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                console.log("User authenticated:", user.uid);
                await fetchAndDisplayHeaderProfile(user); // Still needed for header

            } else {
                console.log("No user signed in. Redirecting to login page.");
                window.location.href = '/login.html';
            }
        });

        // Logout button
        logoutButton.addEventListener('click', handleLogout);

        // Verify User button
        verifyUserButton.addEventListener('click', verifyUserAndBalance);

        // Generate Code form submission
        generateCodeForm.addEventListener('submit', handleGenerateCode);

        // Copy Code button
        copyCodeButton.addEventListener('click', copyGeneratedCode);

        // Apply theme on load (consistent with other pages)
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('jchat-theme');
            if (savedTheme && ['theme-light-mode', 'theme-dark-mode'].includes(savedTheme)) {
                document.body.classList.remove('theme-light-mode', 'theme-dark-mode');
                document.body.classList.add(savedTheme);
            } else {
                document.body.classList.add('theme-dark-mode'); // Default
            }
        });

        // Listen for theme changes from other tabs/windows (consistent with other pages)
        window.addEventListener('storage', (event) => {
            if (event.key === 'jchat-theme') {
                const newTheme = event.newValue || 'theme-dark-mode';
                if (['theme-light-mode', 'theme-dark-mode'].includes(newTheme)) {
                    document.body.classList.remove('theme-light-mode', 'theme-dark-mode');
                    document.body.classList.add(newTheme);
                }
            }
        });

        // Smart Back Button Event Listener
        if (backButton) {
            backButton.addEventListener('click', () => {
                window.history.back(); // Go back to the previous page (likely profile.html)
            });
        }

    </script>
</body>
</html>
