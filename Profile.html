<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JCHAT - Profile</title>
    
    <!-- Security Meta Tags -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="JCHAT - User Profile with levels, achievements, and customization">
    <meta name="keywords" content="profile, user, levels, achievements, customization, JCHAT">
    <meta name="author" content="JCHAT Team">

    <!-- Google Fonts: Poppins for headings, Inter for body text -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Preconnect to Firebase and Cloudinary domains for faster loading -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://firebaseio.com" crossorigin>
    <link rel="preconnect" href="https://res.cloudinary.com" crossorigin>
    <link rel="preconnect" href="https://api.cloudinary.com" crossorigin>
    <link rel="dns-prefetch" href="//fonts.googleapis.com">
    <link rel="dns-prefetch" href="//fonts.gstatic.com">

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Tone.js for audio notifications (if used) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <style>
        /* Universal box-sizing for consistent layout */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        /* Global CSS Variables for easy theme switching */
        :root {
            --pink: #ff2e92;
            --blue: #00d5ff;
            --glass-black: rgba(10, 10, 10, .75);
            --glass-blue: rgba(0, 213, 255, .15);
            --radius: 20px;
            --transition: .3s ease;

            /* These variables will be overridden by theme classes */
            --white: #fff;
            --text-light: rgba(255, 255, 255, .7);
            --background-main: rgba(10, 10, 10, .75);
            --background-gradient-1: #00d5ff;
            --background-gradient-2: #ff2e92;
            --card-background: linear-gradient(145deg, rgba(255, 255, 255, .03), rgba(255, 255, 255, .01));
            --header-background: linear-gradient(135deg, rgba(10, 10, 10, .85), rgba(10, 10, 10, .75));
            --border-light: rgba(255, 255, 255, .05);
            --input-background: rgba(255, 255, 255, 0.05);
            --button-background: linear-gradient(90deg, var(--blue), var(--pink));
            --button-shadow: 0 4px 15px var(--blue), 0 4px 15px var(--pink);

            /* New variables for consistent theming */
            --background-color-primary: #1a1a2e;
            --background-color-secondary: #0f0f1f;
            --header-background-color: #2a2a4a;
            --footer-background-color: #2a2a4a;
            --content-background-color: #20203a;
            --card-background-color: #2a2a4a;
            --text-color-primary: #e0e0e0;
            --text-color-secondary: #b0b0d0;
            --notification-badge-color: #ff2e92;
            --status-online: #4CAF50;
            --status-offline: #6c757d;
            --status-away: #FFC107;
            --delete-button-color: #dc3545;
            --warning-color: #ffc107;
            --accent-color: #00d5ff; /* A bright cyan */
            --accent-color-dark: #00aaff;
            --border-color: #3a3a5a;
        }

        /* --- Theme Definitions (Light and Dark Mode) --- */
        /* Light Mode */
        body.theme-light-mode {
            --background-main: #f0f2f5; /* Light gray background */
            --background-gradient-1: #e0e2e5; /* Subtle lighter gradient */
            --background-gradient-2: #d0d2d5; /* Subtle darker gradient */
            --white: #333; /* Dark text for readability */
            --text-light: #666; /* Lighter dark text */
            --card-background: rgba(255, 255, 255, 0.95); /* Near white cards */
            --header-background: rgba(255, 255, 255, 0.98); /* Near white header */
            --border-light: rgba(0, 0, 0, 0.1); /* Light borders */
            --input-background: rgba(0, 0, 0, 0.05); /* Light input background */
            --button-background: linear-gradient(90deg, #6dd5ed, #2193b0); /* Blue gradient */
            --button-shadow: 0 4px 15px rgba(109, 213, 237, 0.4), 0 4px 15px rgba(33, 147, 176, 0.4);

            /* New variables override for light mode */
            --background-color-primary: #f0f2f5;
            --background-color-secondary: #e0e2e5;
            --header-background-color: #ffffff;
            --footer-background-color: #ffffff;
            --content-background-color: #f7f9fb;
            --card-background-color: #ffffff;
            --text-color-primary: #333333;
            --text-color-secondary: #666666;
            --text-color-light: #999999;
            --accent-color: #007bff;
            --accent-color-dark: #0056b3;
            --border-color: #e0e0e0;
            --input-background-color: #f0f0f0;
            --button-background: #e9ecef;
            --button-hover-background: #dee2e6;
            --active-item-background: rgba(0, 123, 255, 0.1);
            --notification-badge-color: #dc3545;
            --status-online: #28a745;
            --status-offline: #6c757d;
            --status-away: #ffc107;
            --delete-button-color: #dc3545;
            --warning-color: #ffc107;
        }

        /* Dark Mode */
        body.theme-dark-mode {
            --background-main: #1a1a2e; /* Deep purple-dark blue */
            --background-gradient-1: #16213e; /* Slightly lighter deep blue */
            --background-gradient-2: #0f3460; /* Darker blue */
            --white: #e0e0e0; /* Off-white text */
            --text-light: #a0a0a0; /* Grayish text */
            --card-background: rgba(25, 25, 40, 0.7); /* Darker, less transparent cards */
            --header-background: linear-gradient(135deg, rgba(10, 10, 20, .85), rgba(10, 10, 20, .75)); /* Original dark header */
            --border-light: rgba(255, 255, 255, 0.08); /* Subtle white borders */
            --input-background: rgba(255, 255, 255, 0.08);
            --button-background: linear-gradient(90deg, #e94560, #ba2f49); /* Reddish gradient */
            --button-shadow: 0 4px 15px rgba(233, 69, 96, 0.4), 0 4px 15px rgba(186, 47, 73, 0.4);

            /* New variables override for dark mode */
            --background-color-primary: #121212;
            --background-color-secondary: #1e1e1e;
            --header-background-color: #2c2c2c;
            --footer-background-color: #2c2c2c;
            --content-background-color: #242424;
            --card-background-color: #2c2c2c;
            --text-color-primary: #ffffff;
            --text-color-secondary: #bbbbbb;
            --accent-color: #bb86fc;
            --accent-color-dark: #9a67ea;
            --border-color: #444444;
            --input-background-color: #383838;
            --button-background: #383838;
            --button-hover-background: #505050;
            --active-item-background: rgba(187, 134, 252, 0.2);
            --notification-badge-color: #cf6679;
            --delete-button-color: #f44336;
            --warning-color: #ffeb3b;
        }

        /* Glass Mode specific variables (from original Profile.html snippet, adapted) */
        body.theme-glass-mode {
            --background-main: rgba(10, 10, 10, 0.75);
            background-image: url('https://source.unsplash.com/random/1920x1080?abstract,blur') !important;
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
            backdrop-filter: blur(10px);
            --card-background: rgba(25, 25, 40, 0.7);
            --white: #e0e0e0; /* text-color */
            --text-light: rgba(255, 255, 255, 0.7);
            --input-background: rgba(255, 255, 255, 0.05);
            --border-light: rgba(255, 255, 255, 0.1); /* glass-border-color */
            --button-background: linear-gradient(90deg, var(--pink), var(--blue));
            --button-shadow: 0 4px 15px var(--blue), 0 4px 15px var(--pink);
            box-shadow: inset 0 0 100px rgba(0, 0, 0, 0.5); /* Inner shadow for glass effect */

            /* New variables override for glass mode */
            --background-color-primary: rgba(10, 10, 10, 0.75);
            --background-color-secondary: rgba(10, 10, 10, 0.6);
            --header-background-color: rgba(10, 10, 10, 0.85);
            --footer-background-color: rgba(10, 10, 10, 0.85);
            --content-background-color: rgba(10, 10, 10, 0.75);
            --card-background-color: rgba(25, 25, 40, 0.7);
            --text-color-primary: #e0e0e0;
            --text-color-secondary: #b0b0d0;
            --accent-color: #00d5ff;
            --accent-color-dark: #00aaff;
            --border-color: rgba(255, 255, 255, 0.1);
            --input-background-color: rgba(255, 255, 255, 0.05);
            --button-background: rgba(0, 213, 255, 0.15); /* Glassy button */
            --button-hover-background: rgba(0, 213, 255, 0.25);
            --active-item-background: rgba(0, 213, 255, 0.1);
        }

        /* NEW: Sunset Theme (from original Profile.html snippet, adapted) */
        body.theme-sunset-mode {
            background: linear-gradient(to top, #ff7e5f, #feb47b) !important;
            --background-main: linear-gradient(to top, #ff7e5f, #feb47b);
            --card-background: rgba(255, 255, 255, 0.15); /* Slightly transparent white for contrast */
            --white: #fff; /* White text for readability */
            --text-light: rgba(255, 255, 255, 0.8);
            --input-background: rgba(255, 255, 255, 0.1);
            --border-light: rgba(255, 255, 255, 0.3);
            --button-background: linear-gradient(90deg, #fd746c, #ff9068); /* Sunset gradient */
            --button-shadow: 0 4px 15px rgba(253, 116, 108, 0.4), 0 4px 15px rgba(255, 144, 104, 0.4);

            /* New variables override for sunset mode */
            --background-color-primary: #ff7e5f;
            --background-color-secondary: #feb47b;
            --header-background-color: rgba(255, 126, 95, 0.9);
            --footer-background-color: rgba(255, 126, 95, 0.9);
            --content-background-color: rgba(255, 126, 95, 0.85);
            --card-background-color: rgba(255, 255, 255, 0.15);
            --text-color-primary: #fff;
            --text-color-secondary: rgba(255, 255, 255, 0.8);
            --accent-color: #ffd700;
            --accent-color-dark: #ccaa00;
            --border-color: rgba(255, 255, 255, 0.3);
            --input-background-color: rgba(255, 255, 255, 0.2);
            --button-background: rgba(255, 255, 255, 0.2);
            --button-hover-background: rgba(255, 255, 255, 0.3);
            --active-item-background: rgba(255, 215, 0, 0.1);
        }


        /* Always show scrollbar to prevent layout shifts */
        html {
            overflow-y: scroll;
        }

        body {
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden; /* Prevent horizontal scroll */
            padding-bottom: 0px; /* Adjusted: Removed nav bar and toggle button */
            background-color: var(--background-main);
            background-image: radial-gradient(circle at top left, var(--background-gradient-1), transparent 100px),
                              radial-gradient(circle at bottom right, var(--background-gradient-2), transparent 150px);
            color: var(--white);
            transition: background-color 0.5s ease, color 0.5s ease; /* Smooth theme transition */
        }

        /* Header Styling (from Home.html) */
        header {
            background: var(--header-background);
            border-bottom: 1px solid var(--border-light);
            padding: 10px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 55px;
            z-index: 10;
            display: flex;
            justify-content: center;
        }

        header .header-content-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 1200px;
            padding: 0 30px;
        }

        .logo {
            font-family: 'Poppins', sans-serif;
            font-size: 1.8rem;
            font-weight: 800;
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            letter-spacing: -0.03em;
            text-decoration: none;
        }

        /* Header Navigation (from Home.html) */
        header nav ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            gap: 25px;
        }

        header nav ul li a {
            color: var(--white);
            text-decoration: none;
            font-weight: 600;
            font-size: 1.1rem;
            padding: 5px 0;
            position: relative;
            transition: color var(--transition);
        }

        header nav ul li a::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: 0;
            width: 0;
            height: 3px;
            background: var(--blue);
            border-radius: 2px;
            transition: width var(--transition);
        }

        header nav ul li a:hover {
            color: var(--blue);
        }

        header nav ul li a:hover::after {
            width: 100%;
        }

        /* Cool Notification Icon Styling (from Home.html) */
        .notification-icon-wrapper {
            position: relative;
            margin-right: 15px;
        }

        .notification-icon-wrapper a {
            text-decoration: none;
            color: inherit;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .notification-icon-wrapper a::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .notification-icon-wrapper a:hover::before {
            left: 100%;
        }

        .notification-icon-wrapper a:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 213, 255, 0.3);
            border-color: var(--blue);
        }

        .notification-icon-wrapper i {
            font-size: 1.3rem;
            background: linear-gradient(45deg, var(--blue), var(--pink));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent;
            transition: all 0.3s ease;
            z-index: 1;
            position: relative;
        }

        .notification-icon-wrapper a:hover i {
            transform: rotate(15deg) scale(1.1);
            background: linear-gradient(45deg, var(--pink), var(--blue));
            background-clip: text;
            -webkit-background-clip: text;
        }

        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(45deg, #ff4757, #ff3742);
            color: var(--white);
            border-radius: 50%;
            padding: 4px 8px;
            font-size: 0.7rem;
            font-weight: 800;
            min-width: 22px;
            height: 22px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(255, 71, 87, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--background-main);
            animation: pulse-notification 2s infinite;
            z-index: 2;
        }

        @keyframes pulse-notification {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .notification-badge:empty {
            display: none;
        }

        /* Additional cool effects for notification icon */
        .notification-icon-wrapper a:active {
            transform: scale(0.95);
        }

        /* Glow effect when there are notifications */
        .notification-icon-wrapper.has-notifications a {
            box-shadow: 0 0 20px rgba(255, 71, 87, 0.3);
        }

        .notification-icon-wrapper.has-notifications a:hover {
            box-shadow: 0 0 30px rgba(255, 71, 87, 0.5);
        }

        /* Shaking animation for notification bell when there are unread notifications */
        .notification-icon-wrapper.has-notifications i {
            animation: bell-shake 2s ease-in-out infinite, subtle-shake 3s ease-in-out infinite 1s;
            transform-origin: top;
        }

        @keyframes bell-shake {
            0%, 100% { transform: rotate(0deg); }
            5%, 15%, 25%, 35% { transform: rotate(8deg); }
            10%, 20%, 30% { transform: rotate(-8deg); }
            40%, 100% { transform: rotate(0deg); }
        }

        @keyframes subtle-shake {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(2deg); }
        }

        /* Pause shaking on hover */
        .notification-icon-wrapper.has-notifications a:hover i {
            animation-play-state: paused;
        }

        /* Admin Icon Styling */
        #adminIconLink {
            display: none; /* Hidden by default */
            margin-right: 15px; /* Space it out from other icons */
            /* Apply gradient to icons */
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent; /* Fallback */
            font-size: 1.5rem;
            transition: transform 0.2s ease;
        }

        #adminIconLink:hover {
            transform: scale(1.1);
        }

        /* User Profile Header Styling (from Home.html) */
        .user-profile-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Notification Icon Styling (from Home.html) */
        .notification-icon-wrapper {
            position: relative;
            margin-right: 15px; /* Space between notification and profile */
        }

        .notification-icon-wrapper a {
            text-decoration: none; /* Remove underline from link */
            color: inherit; /* Inherit color from parent */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .notification-icon-wrapper i {
            font-size: 1.5rem; /* Adjust size as needed */
            /* Apply gradient to icons */
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent; /* Fallback for browsers that don't support background-clip: text on icons */
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .notification-icon-wrapper i:hover {
            transform: scale(1.1);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--notification-badge-color); /* Use pink for notifications */
            color: var(--white);
            border-radius: 50%;
            padding: 3px 7px;
            font-size: 0.7rem;
            font-weight: 700;
            min-width: 20px;
            text-align: center;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            /* Hide if no notifications */
            display: none;
        }

        .user-profile-header #profileLink {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: var(--white);
            transition: opacity 0.3s ease, background-color 0.3s ease;
            padding: 5px 10px;
            border-radius: var(--radius);
        }

        .user-profile-header #profileLink:hover {
            opacity: 0.8;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .user-profile-header img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--accent-color); /* Used accent-color for consistency */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: opacity 0.3s ease;
        }

        .user-profile-header i {
            font-size: 30px;
            /* Apply gradient to icons */
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent; /* Fallback */
        }

        .user-profile-header span {
            font-weight: 600;
            font-size: 1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
            /* Apply gradient to names */
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent; /* Fallback */
        }

        /* NEW: Admin Icon Styling */
        #adminIconLink {
            display: none; /* Hidden by default */
            margin-right: 15px; /* Space it out from other icons */
            /* Apply gradient to icons */
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent; /* Fallback */
            font-size: 1.5rem;
            transition: transform 0.2s ease;
        }

        #adminIconLink:hover {
            transform: scale(1.1);
        }


        /* Logout Button Styling (from Home.html) */
        #logoutButton {
            background: linear-gradient(90deg, var(--pink), var(--blue));
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.3s ease;
            opacity: 0.8;
            margin-left: 10px;
        }

        #logoutButton:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px var(--pink), 0 44px 15px var(--blue);
            opacity: 1;
        }

        #logoutButton i {
            color: var(--white);
            font-size: 0.9rem;
        }

        /* Main Content Area (from Home.html) */
        main {
            flex-grow: 1;
            padding: 40px 0;
            padding-top: 55px; /* Adjust for fixed header */
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* Align content to top */
            text-align: center;
        }

        .content-wrapper {
            width: 100%;
            max-width: 800px; /* Adjust as needed */
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
        }
        /* Enhanced Profile Section (adapted from original Profile.html and settings-section) */
        .profile-section {
            background: var(--card-background);
            border: 1px solid var(--glass-blue); /* Consistent border */
            backdrop-filter: blur(10px) saturate(180%);
            border-radius: var(--radius);
            box-shadow: 0 8px 25px rgba(0, 0, 0, .3);
            padding: 2rem;
            width: 90%;
            max-width: 600px; /* Max width for consistency */
            margin: 20px auto;
            display: flex;
            flex-direction: column;
            align-items: center; /* Center content */
            gap: 1.5rem;
            text-align: center;
            position: relative;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .profile-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--blue), var(--pink));
            border-radius: var(--radius) var(--radius) 0 0;
        }

        .profile-section:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, .4);
        }

        .profile-header-area { /* New wrapper for top part of profile */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            width: 100%;
        }

        .profile-pic-wrapper {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            overflow: hidden;
            border: 4px solid var(--blue);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            position: relative;
            flex-shrink: 0;
        }

        .profile-pic {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .profile-pic-placeholder {
            font-size: 100px;
            /* Apply gradient to icons */
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent; /* Fallback */
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .edit-profile-pic-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 40%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s ease;
            /* Ensure it's not clickable when not owner */
            pointer-events: none;
        }

        .profile-pic-wrapper:hover .edit-profile-pic-overlay {
            opacity: 1;
        }
        /* Make overlay clickable only for owner */
        .profile-pic-wrapper.owner .edit-profile-pic-overlay {
            pointer-events: auto;
        }

        /* NEW: Profile picture loading spinner */
        .profile-pic-wrapper .profile-pic-loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--blue);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            display: none; /* Hidden by default */
        }
        .profile-pic-wrapper.loading .profile-pic-loader {
            display: block;
        }
        .profile-pic-wrapper.loading .profile-pic,
        .profile-pic-wrapper.loading .profile-pic-placeholder,
        .profile-pic-wrapper.loading .edit-profile-pic-overlay {
            opacity: 0.3; /* Dim content while loading */
            pointer-events: none; /* Disable interaction */
        }


        .profile-name {
            font-family: 'Poppins', sans-serif;
            font-size: 2.2rem;
            font-weight: 800;
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            margin: 0;
            text-align: center;
            transition: all 0.3s ease;
        }

        .profile-name:hover {
            background-image: linear-gradient(90deg, var(--pink), var(--blue));
            transform: scale(1.02);
        }

        .profile-bio, .profile-location, .profile-email, .profile-info-item {
            font-size: 1rem;
            color: var(--text-light);
            margin: 0;
            line-height: 1.5;
        }
        .profile-location i, .profile-email i, .profile-info-item i {
            /* Apply gradient to icons */
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent; /* Fallback */
            margin-right: 5px;
        }


        .profile-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 20px;
            width: 100%;
            margin-top: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid var(--border-light);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .profile-stats:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .stat-item {
            text-align: center;
            color: var(--white);
            padding: 15px 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80px;
        }

        .stat-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .stat-value {
            font-size: 1.4rem;
            font-weight: 700;
            background: linear-gradient(45deg, var(--blue), var(--pink));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent;
            transition: all 0.3s ease;
        }

        .stat-item:hover .stat-value {
            background: linear-gradient(45deg, var(--pink), var(--blue));
            background-clip: text;
            -webkit-background-clip: text;
            transform: scale(1.1);
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-light); /* Lighter text for labels */
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* NEW: Level Display and Progress Bar Styles */
        .level-link-wrapper {
            text-decoration: none; /* Remove underline from the link */
            color: inherit; /* Inherit text color */
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%; /* Ensure it takes full width for centering */
            padding: 5px 0; /* Add some padding */
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .level-link-wrapper:hover {
            transform: translateY(-2px);
        }

        .level-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            width: 100%; /* Ensure it takes full width */
        }

        .profile-level-info { /* Adjusted to target the new div */
            display: flex;
            flex-direction: column; /* Stack icon and name */
            align-items: center;
            gap: 8px;
            margin-top: 10px; /* Space from bio/location */
        }

        .profile-level-name {
            font-family: 'Poppins', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            /* Apply gradient to level name */
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0; /* Remove default margin */
        }

        .profile-level-icon {
            font-size: 2.5rem; /* Larger icon for the main level display */
            /* Apply gradient to level icon */
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .progress-bar-container {
            width: 80%; /* Adjust width as needed */
            height: 12px;
            background-color: rgba(255, 255, 255, 0.1); /* Lighter background for the bar */
            border-radius: 6px;
            overflow: hidden;
            margin-top: 8px; /* Space between level name and bar */
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .progress-bar-fill {
            height: 100%;
            width: 100%; /* Always 100% width, the gradient moves */
            background-image: linear-gradient(90deg, 
                #ff4757 0%,    /* Red */
                #ff6b35 25%,   /* Orange-Red */
                #ffa726 50%,   /* Orange */
                #ffd700 75%,   /* Yellow */
                #4caf50 100%   /* Green */
            );
            background-size: 200% 100%; /* Make gradient twice as wide */
            background-position: right; /* Start with red showing */
            border-radius: 6px; /* Match container border-radius */
            transition: background-position 0.8s ease-out; /* Smooth transition for position */
            position: relative;
        }

        /* Progress percentage display */
        .progress-percentage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.7rem;
            font-weight: 700;
            color: #000;
            text-shadow: 0 0 2px rgba(255, 255, 255, 0.8);
            z-index: 2;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        /* Progress bar glow effect */
        .progress-bar-container::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                rgba(255, 71, 87, 0.3) 0%,    /* Red glow */
                rgba(255, 107, 53, 0.3) 25%,  /* Orange-Red glow */
                rgba(255, 167, 38, 0.3) 50%,  /* Orange glow */
                rgba(255, 215, 0, 0.3) 75%,   /* Yellow glow */
                rgba(76, 175, 80, 0.3) 100%   /* Green glow */
            );
            border-radius: 6px;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .progress-bar-container:hover::after {
            opacity: 1;
        }

        /* Hide the "XP Level" label as requested */
        .level-link-wrapper .stat-label {
            display: none;
        }

        /* JCoin Exchange Rate Display */
        .jcoin-exchange-rate {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 5px;
            text-align: center;
            display: flex; /* Make it a flex container to align icon and text */
            align-items: center;
            justify-content: center;
            gap: 5px; /* Space between icon and text */
        }

        /* Padlock icon styling */
        .padlock-icon {
            font-size: 0.9rem; /* Smaller for inline text */
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--pink), var(--blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Wallet link specific styling */
        #walletLink.disabled-link {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none; /* Disables click events */
            background: rgba(255, 255, 255, 0.05); /* Greyed out background */
            box-shadow: none;
        }
        #walletLink.disabled-link:hover {
            transform: none; /* No hover effect when disabled */
            box-shadow: none;
        }
        .wallet-locked-message {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 5px;
            text-align: center;
        }


        .profile-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .profile-action-button {
            background: var(--button-background);
            color: var(--white);
            border: none;
            border-radius: 15px;
            padding: 0.8rem 1.5rem;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: var(--button-shadow);
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .profile-action-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .profile-action-button:hover::before {
            left: 100%;
        }

        .profile-action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--blue), 0 6px 20px var(--pink);
        }

        .profile-action-button.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--white);
            border: 1px solid var(--border-light);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
        }

        .profile-action-button.secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }
        .profile-action-button.danger {
            background-color: var(--delete-button-color); /* Red for danger actions */
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
        }

        .profile-action-button.danger:hover {
            background-color: #c82333;
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.6);
        }

        /* Specific button styles for dynamic states */
        .profile-action-button.sent { background: #6c757d; cursor: default; box-shadow: none; }
        .profile-action-button.sent:hover { transform: none; box-shadow: none; }
        .profile-action-button.friends { background: #28a745; cursor: default; box-shadow: none; }
        .profile-action-button.friends:hover { transform: none; box-shadow: none; }
        .profile-action-button.accept { background: linear-gradient(90deg, #28a745, #218838); }
        .profile-action-button.accept:hover { background: linear-gradient(90deg, #218838, #28a745); }
        .profile-action-button.unfriend { background: #dc3545; }
        .profile-action-button.unfriend:hover { background: #c82333; }


        /* Icons within action buttons */
        .profile-action-button i {
            /* Apply gradient to icons */
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .profile-action-button.secondary i,
        .profile-action-button.danger i {
            -webkit-text-fill-color: var(--white); /* Ensure icons are white for secondary/danger */
        }


        /* Inline Profile Details (from original Profile.html snippet) */
        .profile-details-section { /* Renamed from .profile-details to avoid conflict */
            width: 100%;
            text-align: left;
            margin-top: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .profile-details-section label {
            display: block;
            text-align: left;
            margin-bottom: 5px;
            color: var(--text-light); /* Consistent text color */
            font-weight: 600;
            font-size: 0.95rem;
        }

        .profile-details-section input[type="text"],
        .profile-details-section input[type="url"], /* Added for website */
        .profile-details-section textarea,
        .profile-details-section select { /* NEW: for customization options */
            width: 100%;
            padding: 0.8rem 1rem;
            margin-bottom: 15px; /* Keep original margin for spacing between fields */
            border: 1px solid var(--border-light); /* Consistent border */
            border-radius: 15px; /* Consistent radius */
            background: var(--input-background); /* Consistent background */
            color: var(--white); /* Consistent text color */
            font-size: 1rem; /* Consistent font size */
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            outline: none;
        }

        .profile-details-section input[type="text"]:focus,
        .profile-details-section input[type="url"]:focus,
        .profile-details-section textarea:focus,
        .profile-details-section select:focus {
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(0, 213, 255, 0.2);
        }

        .profile-details-section textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* NEW: Toggle switch for privacy settings */
        .privacy-toggle-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px dashed rgba(255,255,255,0.1);
            margin-bottom: 10px;
        }
        .privacy-toggle-group:last-child {
            border-bottom: none;
        }
        .privacy-toggle-group label {
            margin-bottom: 0;
        }
        /* Toggle button styles (reused from Admin.html) */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-switch .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--input-background);
            transition: .4s;
            border-radius: 34px;
            border: 1px solid var(--border-light);
        }

        .toggle-switch .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: var(--text-light);
            transition: .4s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .slider {
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            border-color: var(--blue);
        }

        .toggle-switch input:checked + .slider:before {
            transform: translateX(26px);
            background-color: var(--white);
        }

        /* NEW: Unlocked Rewards Section */
        .unlocked-rewards-section, .friends-snippet-section, .recent-activity-section, .customization-section, .wallet-guide-section {
            background: var(--card-background);
            border: 1px solid var(--glass-blue);
            backdrop-filter: blur(10px) saturate(180%);
            border-radius: var(--radius);
            box-shadow: 0 8px 25px rgba(0, 0, 0, .3);
            padding: 1.5rem;
            width: 100%;
            margin-top: 20px;
            text-align: left;
        }
        .unlocked-rewards-section h3, .friends-snippet-section h3, .recent-activity-section h3, .customization-section h3, .wallet-guide-section h3 {
            font-family: 'Poppins', sans-serif;
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--white);
            margin-top: 0;
            margin-bottom: 1rem;
            text-align: center;
        }
        .rewards-grid, .friends-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
            justify-content: center;
        }
        .reward-item, .friend-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-light);
            cursor: default;
        }
        .reward-icon {
            font-size: 2.5rem;
            margin-bottom: 5px;
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .friend-pic-wrapper {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid var(--accent-color);
            margin-bottom: 5px;
        }
        .friend-pic {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .friend-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            font-weight: 600;
            color: var(--white);
        }

        /* Recent Activity Section */
        .activity-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .activity-item {
            background-color: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            padding: 12px 15px;
            margin-bottom: 10px;
            font-size: 0.95rem;
            color: var(--text-color-secondary);
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid var(--border-light);
        }
        .activity-item i {
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        .activity-timestamp {
            font-size: 0.8em;
            color: var(--text-light);
            margin-left: auto;
        }
        .no-activity-message, .no-friends-message, .no-rewards-message {
            text-align: center;
            color: var(--text-light);
            margin-top: 10px;
            font-size: 1rem;
        }

        /* Customization Section */
        .customization-option {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        .customization-option label {
            margin-bottom: 0;
        }

        /* Account Settings Sub-section (from original Profile.html snippet) */
        .sub-section {
            margin-top: 30px;
            padding-top: 22px; /* Increased padding-top to give more space from previous section */
            border-top: 1px solid var(--border-light); /* Consistent border */
            text-align: left;
        }

        .sub-section h2 {
            font-family: 'Poppins', sans-serif;
            font-weight: 700; /* Consistent with h3 in settings */
            font-size: 1.5rem; /* Consistent with h3 in settings */
            color: var(--white);
            margin-bottom: 1rem; /* Consistent margin */
            text-align: center;
        }

        .sub-section .input-group {
            margin-bottom: 1rem; /* Consistent margin */
        }

        .sub-section .input-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-light); /* Consistent text color */
            font-weight: 600;
            font-size: 0.95rem;
        }

        .sub-section .input-group input[type="password"],
        .sub-section .input-group input[type="email"] { /* Added email input style */
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid var(--border-light);
            border-radius: 15px;
            background: var(--input-background);
            color: var(--white);
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .sub-section .input-group input[type="password"]:focus,
        .sub-section .input-group input[type="email"]:focus {
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(0, 213, 255, 0.2);
        }


        .sub-section button {
            background: var(--button-background); /* Consistent button style */
            color: var(--white);
            border: none;
            border-radius: 15px;
            padding: 0.7rem 1.2rem;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: var(--button-shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%; /* Make buttons full width */
            margin-top: 1rem; /* Space from inputs */
        }
        .sub-section button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--blue), 0 6px 20px var(--pink);
        }

        .sub-section p {
            color: var(--text-light); /* Consistent text color */
            font-size: 0.9rem; /* Consistent font size */
            margin-top: 20px;
            text-align: center; /* Center text */
        }

        .sub-section p a {
            color: var(--blue); /* Use var(--blue) for links */
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s ease;
        }

        .sub-section p a:hover {
            color: var(--pink); /* Consistent hover color */
        }
        /* Custom Message Box Styles (from Home.html) */
        #messageBox {
            position: fixed;
            top: 50%; /* Center vertically */
            left: 50%;
            transform: translate(-50%, -50%); /* Center both horizontally and vertically */
            background-color: var(--card-background-color); /* Default background, will be overridden for success */
            color: var(--text-color-primary); /* Default text color */
            padding: 20px 30px; /* Increased padding for a more substantial box */
            border-radius: 15px; /* More rounded corners, slightly squarer */
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4); /* Enhanced shadow */
            z-index: 1000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            min-width: 280px; /* Ensure a decent minimum width */
            max-width: 90%;
            text-align: center;
            flex-direction: column; /* Stack icon and text vertically */
            align-items: center;
            gap: 15px; /* Space between icon and text */
        }
        #messageBox.show {
            opacity: 1;
            display: flex;
        }
        /* Success message box specific styling */
        #messageBox.success {
            background-image: linear-gradient(45deg, var(--pink), var(--blue)); /* Pink and blue gradient */
            color: var(--white); /* White text for contrast on gradient */
            border: none; /* No border for gradient background */
            box-shadow: 0 8px 30px rgba(0, 213, 255, 0.5), 0 8px 30px rgba(255, 46, 146, 0.5); /* Glowing shadow */
        }
        #messageBox.error { border-left: 5px solid var(--delete-button-color); background-color: var(--card-background-color); color: var(--text-color-primary); }
        #messageBox.info { border-left: 5px solid var(--accent-color); background-color: var(--card-background-color); color: var(--text-color-primary); }
        #messageBox.warning { border-left: 5px solid var(--warning-color); background-color: var(--card-background-color); color: var(--text-color-primary); }

        #messageBox i {
            font-size: 2.5rem; /* Larger icon for prominence */
            margin-bottom: 5px; /* Space between icon and text */
            /* Apply gradient to message box icons */
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        #messageBox.success i { color: var(--white); } /* White icon for success */
        #messageBox.error i { color: var(--delete-button-color); }
        #messageBox.info i { color: var(--accent-color); }
        #messageBox.warning i { color: var(--warning-color); }

        #messageBox span {
            font-size: 1.1rem; /* Slightly larger text */
            font-weight: 600;
        }

        @keyframes pulse-bg {
            0% { background-color: var(--accent-color); }
            50% { background-color: rgba(0, 213, 255, 0.7); }
            100% { background-color: var(--accent-color); }
        }
        #messageBox.loading-pulse { animation: pulse-bg 1.5s infinite ease-in-out; }

        /* Loader styles for buttons (from Home.html) */
        .button-loader {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid var(--white);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: none;
            flex-shrink: 0; /* Prevent loader from shrinking */
        }
        .button-loader.active { display: block; }
        .button-text { display: block; }
        .loading .button-text { display: none; }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Enhanced Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes loading-shimmer {
            0% { background-position: -200px 0; }
            100% { background-position: calc(200px + 100%) 0; }
        }

        .fade-in-up {
            animation: fadeInUp 0.6s ease-out;
        }

        .hover-lift {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .hover-lift:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        /* Loading Skeleton Animation */
        .loading-skeleton {
            background: linear-gradient(90deg, 
                rgba(255, 255, 255, 0.1) 25%, 
                rgba(255, 255, 255, 0.2) 50%, 
                rgba(255, 255, 255, 0.1) 75%);
            background-size: 200px 100%;
            animation: loading-shimmer 1.5s infinite;
            border-radius: 4px;
        }

        .skeleton-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
        }

        .skeleton-text {
            height: 20px;
            margin: 8px 0;
        }
        .skeleton-text.short {
            width: 60%;
        }
        .skeleton-text.medium {
            width: 80%;
        }

        /* Custom Confirmation Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: var(--card-background);
            padding: 30px;
            border-radius: var(--radius);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            text-align: center;
            max-width: 400px;
            width: 90%;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .modal-overlay.active .modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        .modal-content h3 {
            color: var(--white);
            margin-top: 0;
            margin-bottom: 20px;
            font-family: 'Poppins', sans-serif;
        }
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
        }
        .modal-buttons button {
            padding: 10px 25px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .modal-buttons button.confirm-btn {
            background: linear-gradient(90deg, var(--pink), var(--blue));
            color: var(--white);
            box-shadow: 0 4px 10px rgba(0, 213, 255, 0.3);
        }
        .modal-buttons button.confirm-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 213, 255, 0.4);
        }
        .modal-buttons button.cancel-btn {
            background: var(--input-background);
            color: var(--text-light);
            border: 1px solid var(--border-light);
        }
        .modal-buttons button.cancel-btn:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.1);
        }

        /* NEW: JCoin Request Modal Styles */
        #jcoinRequestModal.modal-overlay { /* Specificity for this modal */
            background-color: rgba(0, 0, 0, 0.6);
        }

        #jcoinRequestModal .modal-content {
            max-width: 500px;
            text-align: left;
        }
        #jcoinRequestModal .modal-content h3 {
            text-align: center;
            margin-bottom: 1.5rem;
        }
        #jcoinRequestModal .modal-content h3 i {
            /* Apply gradient to modal header icon */
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-right: 10px;
        }
        #jcoinRequestModal .modal-content .input-group {
            margin-bottom: 1rem;
        }
        #jcoinRequestModal .modal-content .input-group input[type="number"],
        #jcoinRequestModal .modal-content .input-group input[type="file"] {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid var(--border-light);
            border-radius: 15px;
            background: var(--input-background);
            color: var(--white);
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        #jcoinRequestModal .modal-content .input-group input[type="number"]:focus,
        #jcoinRequestModal .modal-content .input-group input[type="file"]:focus {
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(0, 213, 255, 0.2);
        }
        #jcoinRequestModal .modal-content .file-input-label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-light);
            font-weight: 600;
            font-size: 0.95rem;
            text-align: left;
        }
        #jcoinRequestModal .modal-content .file-input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--input-background);
            border: 1px solid var(--border-light);
            border-radius: 15px;
            padding: 0.8rem 1rem;
            cursor: pointer;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        #jcoinRequestModal .modal-content .file-input-wrapper:hover {
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(0, 213, 255, 0.2);
        }
        #jcoinRequestModal .modal-content .file-input-wrapper i {
            /* Apply gradient to file input icon */
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        #jcoinRequestModal .modal-content .file-name {
            flex-grow: 1;
            color: var(--text-light);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .gradient-text { /* Reused from Home.html for consistency */
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        #jcoinRequestModal .modal-content .receipt-preview {
            max-width: 100px;
            max-height: 100px;
            border-radius: 8px;
            object-fit: cover;
            margin-top: 10px;
            border: 1px solid var(--border-light);
            display: none;
        }
        .modal-button {
            background: var(--button-background);
            color: var(--white);
            border: none;
            border-radius: 15px;
            padding: 0.7rem 1.2rem;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: var(--button-shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex: 1; /* Make buttons take equal width */
        }
        .modal-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--blue), 0 66px 20px var(--pink);
        }
        .modal-button.cancel-button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-light);
            box-shadow: none;
        }
        .modal-button.cancel-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 1.5rem;
        }

        /* NEW: Report User Modal Styles */
        #reportUserModal.modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
        }
        #reportUserModal .modal-content {
            max-width: 500px;
            text-align: left;
        }
        #reportUserModal .modal-content h3 {
            text-align: center;
            margin-bottom: 1.5rem;
        }
        #reportUserModal .modal-content h3 i {
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-right: 10px;
        }
        #reportUserModal .modal-content label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-light);
            font-weight: 600;
            font-size: 0.95rem;
        }
        #reportUserModal .modal-content textarea,
        #reportUserModal .modal-content select {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid var(--border-light);
            border-radius: 15px;
            background: var(--input-background);
            color: var(--white);
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        #reportUserModal .modal-content textarea:focus,
        #reportUserModal .modal-content select:focus {
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(0, 213, 255, 0.2);
        }
        #reportUserModal .modal-content .button-group {
            justify-content: center; /* Center buttons in modal */
        }

        /* NEW: Wallet Guide Section */
        .wallet-guide-section {
            padding: 2rem;
            text-align: left;
        }
        .wallet-guide-section h3 {
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
        }
        .wallet-guide-section .guide-item {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid var(--border-light);
        }
        .wallet-guide-section .guide-item h4 {
            font-family: 'Poppins', sans-serif;
            font-size: 1.2rem;
            color: var(--white);
            margin-top: 0;
            margin-bottom: 0.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .wallet-guide-section .guide-item h4 i {
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 1.5rem;
        }
        .wallet-guide-section .guide-item p {
            font-size: 0.95rem;
            color: var(--text-light);
            line-height: 1.6;
            margin-bottom: 0.5rem;
        }
        .wallet-guide-section .guide-item ul {
            list-style: none;
            padding-left: 0;
            margin-top: 0.5rem;
        }
        .wallet-guide-section .guide-item ul li {
            font-size: 0.9rem;
            color: var(--text-color-secondary);
            margin-bottom: 5px;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }
        .wallet-guide-section .guide-item ul li i {
            color: var(--accent-color);
            margin-top: 3px;
            flex-shrink: 0;
        }
        .wallet-guide-section .guide-item strong {
            color: var(--white);
        }
        .wallet-guide-section .guide-item .gradient-text {
            font-weight: 600;
        }
        /* Enhanced Responsive Design */
        @media (max-width: 768px) {
            .profile-section {
                width: 95%;
                padding: 1.5rem;
                margin: 15px auto;
            }

            .profile-pic-wrapper {
                width: 100px;
                height: 100px;
            }

            .profile-name {
                font-size: 1.8rem;
            }

            .profile-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
                padding: 15px;
            }

            .stat-item {
                padding: 12px 8px;
                min-height: 70px;
            }

            .profile-action-buttons {
                flex-direction: column;
                gap: 10px;
            }

            .profile-action-button {
                width: 100%;
                padding: 1rem 1.5rem;
            }

            /* Enhanced mobile header */
            .header-content {
                padding: 0 15px;
            }

            .notification-icon-wrapper {
                margin-right: 10px;
            }

            .notification-icon-wrapper a {
                width: 35px;
                height: 35px;
            }

            .notification-icon-wrapper i {
                font-size: 1.1rem;
            }

            .user-profile-header span {
                font-size: 0.9rem;
                max-width: 120px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
        }

        @media (max-width: 480px) {
            .profile-section {
                width: 98%;
                padding: 1rem;
                margin: 10px auto;
            }

            .profile-pic-wrapper {
                width: 80px;
                height: 80px;
            }

            .profile-name {
                font-size: 1.5rem;
            }

            .profile-stats {
                grid-template-columns: repeat(2, 1fr);
                padding: 12px;
                gap: 10px;
            }

            .stat-item {
                padding: 10px 6px;
                min-height: 60px;
            }

            .stat-value {
                font-size: 1.2rem;
            }

            .stat-label {
                font-size: 0.75rem;
            }

            .profile-action-button {
                padding: 0.8rem 1rem;
                font-size: 0.8rem;
            }

            /* Mobile header adjustments */
            .header-content {
                padding: 0 10px;
            }

            .notification-icon-wrapper a {
                width: 32px;
                height: 32px;
            }

            .notification-icon-wrapper i {
                font-size: 1rem;
            }

            .user-profile-header span {
                font-size: 0.8rem;
                max-width: 100px;
            }
        }

        /* Responsive Adjustments (from Home.html / privacy_settings.html) */
        @media (max-width: 600px) {
            header .header-content-wrapper {
                padding: 0 20px;
            }
            .logo {
                font-size: 1.6rem;
            }
            header nav ul {
                display: none;
            }
            header nav ul li a {
                font-size: 1.1rem;
            }
            .user-profile-header #profileLink {
                padding: 5px;
            }
            .user-profile-header span {
                max-width: 90px;
            }
            .user-profile-header img {
                width: 30px;
                height: 30px;
            }
            .user-profile-header i {
                font-size: 25px;
            }
            #logoutButton {
                width: 25px;
                height: 25px;
                font-size: 0.8rem;
                margin-left: 8px;
            }
            #logoutButton i {
                font-size: 0.8rem;
            }
            .profile-section {
                padding: 1.5rem;
            }
            .profile-name {
                font-size: 1.8rem;
            }
            .profile-bio, .profile-location, .profile-email, .profile-info-item {
                font-size: 0.9rem;
            }
            .profile-level-icon {
                font-size: 2rem;
            }
            .profile-level-name {
                font-size: 1.2rem;
            }
            .profile-stats {
                gap: 10px;
            }
            .stat-value {
                font-size: 1.2rem;
            }
            .stat-label {
                font-size: 0.75rem;
            }
            .profile-action-button {
                padding: 0.7rem 1.2rem;
                font-size: 0.8rem;
            }
            .profile-details-section label {
                font-size: 0.85rem;
            }
            .profile-details-section input[type="text"],
            .profile-details-section input[type="url"],
            .profile-details-section textarea,
            .profile-details-section select { /* NEW */
                padding: 0.7rem 0.9rem;
                font-size: 0.9rem;
            }
            .privacy-toggle-group label {
                font-size: 0.9rem;
            }
            .toggle-switch {
                transform: scale(0.8); /* Scale down for mobile */
                transform-origin: right center;
            }
            .unlocked-rewards-section h3, .friends-snippet-section h3, .recent-activity-section h3, .customization-section h3, .wallet-guide-section h3 {
                font-size: 1.2rem;
            }
            .rewards-grid, .friends-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
                gap: 10px;
            }
            .reward-item, .friend-item {
                font-size: 0.8rem;
            }
            .reward-icon {
                font-size: 2rem;
            }
            .friend-pic-wrapper {
                width: 50px;
                height: 50px;
            }
            .activity-item {
                font-size: 0.85rem;
                padding: 10px;
            }
            .activity-item i {
                font-size: 1rem;
            }
            .customization-option label {
                font-size: 0.85rem;
            }
            .sub-section h2 {
                font-size: 1.3rem;
            }
            .sub-section .input-group label {
                font-size: 0.85rem;
            }
            .sub-section .input-group input[type="password"],
            .sub-section .input-group input[type="email"] {
                padding: 0.7rem 0.9rem;
                font-size: 0.9rem;
            }
            .sub-section button {
                padding: 0.6rem 1rem;
                font-size: 0.8rem;
            }
            .sub-section p {
                font-size: 0.8rem;
            }
            body {
                padding-bottom: 0px; /* Adjusted for no nav/toggle */
            }
        }
    </style>
</head>
<body class="theme-dark-mode">

    <header>
        <div class="header-content-wrapper">
            <a href="/home.html" class="logo">JCHAT</a>
            <nav>
                <ul>
                    <!-- Removed Home and Profile links from header navigation -->
                </ul>
            </nav>
            <div class="user-profile-header">
                <!-- NEW: Admin Icon Link (hidden by default) -->
                <a href="/Admin.html" id="adminIconLink" aria-label="Admin Dashboard">
                    <i class="fas fa-user-cog"></i>
                </a>
                <!-- Notification Icon with Badge -->
                <div class="notification-icon-wrapper">
                    <a href="/notifications.html" aria-label="Notifications">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notificationCount" style="display: none;">0</span>
                    </a>
                </div>
                <!-- Removed Logout Button -->
                <a href="/profile.html" id="profileLink">
                    <img id="headerProfilePic" src="" alt="Profile Picture" style="display: none;">
                    <i id="headerAvatarIcon" class="fas fa-user-circle"></i>
                    <span id="headerDisplayName">Loading...</span>
                </a>
            </div>
        </div>
    </header>

    <main>
        <div class="content-wrapper">
                            <div class="profile-section">
                <div id="profileCoverWrapper" style="width:100%;height:180px;border-radius:14px;overflow:hidden;position:relative;margin-bottom:12px;background:rgba(255,255,255,0.05);border:1px solid var(--border-light);">
                    <img id="profileCoverImg" alt="Cover" style="width:100%;height:100%;object-fit:cover;display:none;">
                    <input type="file" id="profileCoverUploadInput" accept="image/*" style="display:none;">
                    <label for="profileCoverUploadInput" id="editCoverOverlay" style="position:absolute;right:10px;bottom:10px;background:rgba(0,0,0,0.5);padding:6px 10px;border-radius:8px;cursor:pointer;display:none;"><i class="fas fa-camera"></i> Edit Cover</label>
                </div>
                <div class="profile-header-area">
                    <div class="profile-pic-wrapper" id="profilePicWrapper">
                        <img id="profilePagePic" src="" alt="Profile Picture" class="profile-pic" style="display: none;">
                        <i id="profilePageAvatarIcon" class="fas fa-user-circle profile-pic-placeholder"></i>
                        <input type="file" id="profilePicUploadInput" accept="image/*" style="display: none;">
                        <label for="profilePicUploadInput" class="edit-profile-pic-overlay" id="editProfilePicOverlay">
                            <i class="fas fa-camera"></i> Edit
                        </label>
                        <div class="profile-pic-loader"></div> <!-- NEW: Loading spinner for profile pic -->
                    </div>
                    <h2 id="profileUsername" class="profile-name">Loading...</h2>
                    <p id="profileBio" class="profile-bio">No bio provided yet.</p>
                    <p id="profileLocation" class="profile-info-item" style="display: none;"><i class="fas fa-map-marker-alt"></i> <span id="locationText"></span></p>
                    <p id="profileEmail" class="profile-info-item" style="display: none;"><i class="fas fa-envelope"></i> <span id="emailText"></span></p>
                    <p id="profileSchool" class="profile-info-item" style="display: none;"><i class="fas fa-graduation-cap"></i> <span id="schoolText"></span></p>
                    <p id="profileWork" class="profile-info-item" style="display: none;"><i class="fas fa-briefcase"></i> <span id="workText"></span></p>
                    <p id="profileWebsite" class="profile-info-item" style="display: none;"><i class="fas fa-globe"></i> <a id="websiteLink" href="#" target="_blank" rel="noopener noreferrer" class="gradient-text"></a></p>
                    <p id="profileSocialLinks" class="profile-info-item" style="display: none;"><i class="fas fa-share-alt"></i> <span id="socialLinksText"></span></p>


                    <!-- NEW: Level Info Display -->
                    <div class="profile-level-info">
                        <i id="xpLevelIcon" class="fas fa-question-circle profile-level-icon"></i>
                        <span id="xpLevelName" class="profile-level-name">Loading Level...</span>
                    </div>
                                    <div class="progress-bar-container" id="progressBarContainer">
                    <div id="xpProgressBarFill" class="progress-bar-fill" style="background-position: right;"></div>
                    <div id="progressPercentage" class="progress-percentage">0%</div>
                </div>
                    <!-- End NEW: Level Info Display -->

                </div>

                <div class="profile-stats">
                    <div class="stat-item">
                        <span id="statPosts" class="stat-value">0</span>
                        <span class="stat-label">Posts</span>
                    </div>
                    <div class="stat-item">
                        <span id="statFriends" class="stat-value">0</span>
                        <span class="stat-label">Friends</span>
                    </div>
                    <div class="stat-item">
                        <span id="statFollowers" class="stat-value">0</span>
                        <span class="stat-label">Followers</span>
                    </div>
                    <div class="stat-item">
                        <span id="statFollowing" class="stat-value">0</span>
                        <span class="stat-label">Following</span>
                    </div>
                    <!-- JCoins with Exchange Rate -->
                    <div class="stat-item" id="jcoinStatItem">
                        <span id="jCoins" class="stat-value">0</span>
                        <span class="stat-label">JCoins</span>
                        <p class="jcoin-exchange-rate" id="jcoinExchangeRate" style="display: none;">
                            <span id="jcoinUSDValue">$0.00</span> USD
                        </p>
                    </div>
                    <!-- NEW: Gas (XP) Stat Item -->
                    <div class="stat-item" id="gasStatItem">
                        <span id="gasValue" class="stat-value">0</span>
                        <span class="stat-label">Gas (XP)</span>
                    </div>
                </div>

                <div class="profile-actions" id="profileActions">
                    <!-- Buttons will be dynamically added/hidden based on owner/viewer -->
                    <!-- Removed Edit Profile Button -->
                    <a href="/privacy_settings.html" id="privacySettingsButton" class="profile-action-button secondary">
                        <i class="fas fa-user-shield"></i> Privacy Settings
                    </a>
                    <!-- NEW: Wallet Link -->
                    <a href="/wallet.html" id="walletLink" class="profile-action-button secondary disabled-link">
                        <i class="fas fa-lock padlock-icon"></i> My Wallet
                    </a>
                    <p id="walletLockedMessage" class="wallet-locked-message" style="display: none;">
                        Contact admin to unlock wallet access for just #5,000 and you have your wallet Unlocked. Jchatguide@gmail.com
                          Wa +2349013790707 
                          
                        
                    </p>
                    <!-- NEW: Request JCoins Button -->
                    <button id="requestJCoinsButton" class="profile-action-button">
                        <i class="fas fa-coins"></i> Request JCoins
                    


                    <!-- NEW: Report User Button (only visible for other users) -->
                    <button id="reportUserButton" class="profile-action-button danger" style="display: none;">
                        <i class="fas fa-flag"></i> Report User
                    </button>

                    <!-- Removed Add Friend and Message buttons as requested -->
                </div>

                <!-- Tabs: About, Posts, Media, Saved, Activity -->
                <div id="profileTabs" style="display:flex;gap:8px;margin:14px 0;flex-wrap:wrap;">
                    <button class="profile-action-button secondary" data-tab="about">About</button>
                    <button class="profile-action-button secondary" data-tab="posts">Posts</button>
                    <button class="profile-action-button secondary" data-tab="media">Media</button>
                    <button class="profile-action-button secondary" data-tab="highlights">Highlights</button>
                    <button class="profile-action-button secondary" data-tab="saved">Saved</button>
                    <button class="profile-action-button secondary" data-tab="activity">Activity</button>
                </div>
                <!-- About Panel -->
                <div id="tabPanelAbout">
                <!-- Inline Profile Details and Account Settings -->
                <div class="profile-details-section">
                    <label for="displayName">Display Name</label>
                    <input type="text" id="displayName" placeholder="Enter your display name">

                    <label for="bio">Bio</label>
                    <textarea id="bio" placeholder="Tell us about yourself..."></textarea>

                    <label for="locationInput">Location</label>
                    <input type="text" id="locationInput" placeholder="e.g., Lagos, Nigeria">

                    <label for="schoolInput">School/University</label>
                    <input type="text" id="schoolInput" placeholder="e.g., University of Lagos">

                    <label for="workInput">Work/Occupation</label>
                    <input type="text" id="workInput" placeholder="e.g., Software Engineer at Google">

                    <label for="interestsInput">Interests</label>
                    <textarea id="interestsInput" placeholder="e.g., Reading, Hiking, Coding, Photography (comma-separated)"></textarea>

                    <label for="websiteInput">Website/Portfolio</label>
                    <input type="url" id="websiteInput" placeholder="e.g., https://yourwebsite.com">

                    <label for="socialLinksInput">Social Media Links</label>
                    <textarea id="socialLinksInput" placeholder="e.g., LinkedIn: profile_url, Twitter: handle (comma-separated)"></textarea>

                    <button id="saveProfileChanges" class="profile-action-button">
                        <span class="button-text">Save Profile</span>
                        <div class="button-loader"></div>
                    </button>

                    <!-- NEW: Privacy Settings Toggles -->
                    <h3 style="text-align: center; margin-top: 2rem;">Privacy Settings</h3>
                    <div class="privacy-toggle-group">
                        <label for="toggleEmailVisibility">Show Email Publicly</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggleEmailVisibility">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="privacy-toggle-group">
                        <label for="toggleLocationVisibility">Show Location Publicly</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggleLocationVisibility">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="privacy-toggle-group">
                        <label for="toggleOnlineStatusVisibility">Show Online Status</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggleOnlineStatusVisibility">
                            <span class="slider"></span>
                        </label>
                    </div>
                     <div class="privacy-toggle-group">
                        <label for="toggleFriendRequests">Allow Friend Requests</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggleFriendRequests">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="privacy-toggle-group">
                        <label for="toggleMessages">Allow Direct Messages</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggleMessages">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="privacy-toggle-group">
                        <label for="toggleSchoolVisibility">Show School Publicly</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggleSchoolVisibility">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="privacy-toggle-group">
                        <label for="toggleWorkVisibility">Show Work Publicly</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggleWorkVisibility">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="privacy-toggle-group">
                        <label for="toggleInterestsVisibility">Show Interests Publicly</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggleInterestsVisibility">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="privacy-toggle-group">
                        <label for="toggleWebsiteVisibility">Show Website Publicly</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggleWebsiteVisibility">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="privacy-toggle-group">
                        <label for="toggleSocialLinksVisibility">Show Social Links Publicly</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggleSocialLinksVisibility">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <button id="savePrivacySettingsButton" class="profile-action-button secondary">
                        <span class="button-text">Save Privacy Settings</span>
                        <div class="button-loader"></div>
                    </button>

                    <!-- NEW: Profile Customization Section -->
                    <h3 style="text-align: center; margin-top: 2rem;">Profile Customization</h3>
                    <div class="customization-option">
                        <label for="profileFrameSelect">Profile Picture Frame:</label>
                        <select id="profileFrameSelect">
                            <option value="default">Default</option>
                            <option value="gradient">Gradient Frame (Unlocked at Level 25)</option>
                            <option value="diamond">Diamond Frame (Unlocked at Level 200)</option>
                            <!-- Add more options as you define them based on unlockedBenefits -->
                        </select>
                    </div>
                    <div class="customization-option">
                        <label for="chatBubbleStyleSelect">Chat Bubble Style:</label>
                        <select id="chatBubbleStyleSelect">
                            <option value="default">Default</option>
                            <option value="basic">Basic Style (Unlocked at Level 15)</option>
                            <option value="rounded">Rounded Style (Unlocked at Level 40)</option>
                            <!-- Add more options -->
                        </select>
                    </div>
                    <div class="customization-option">
                        <label for="profileThemeSelect">Profile Theme:</label>
                        <select id="profileThemeSelect">
                            <option value="default">Default</option>
                            <option value="solid">Solid Color (Unlocked at Level 65)</option>
                            <option value="animated1">Animated 1 (Unlocked at Level 150)</option>
                            <!-- Add more options -->
                        </select>
                    </div>
                    <button id="saveCustomizationButton" class="profile-action-button">
                        <span class="button-text">Save Customization</span>
                        <div class="button-loader"></div>
                    </button>

                    <!-- Identity & Availability -->
                    <h3 style="text-align:center;margin-top:1.5rem;">Identity & Availability</h3>
                    <div class="profile-details-section">
                        <label for="handleInput">Handle</label>
                        <input type="text" id="handleInput" placeholder="e.g., @yourhandle">
                        <label for="pronounsInput">Pronouns</label>
                        <input type="text" id="pronounsInput" placeholder="e.g., she/her, he/him, they/them">
                        <label for="languagesInput">Languages</label>
                        <input type="text" id="languagesInput" placeholder="e.g., English, Spanish">
                        <label for="timeZoneInput">Time Zone</label>
                        <input type="text" id="timeZoneInput" placeholder="e.g., GMT+1, Africa/Lagos">
                        <label for="statusStateSelect">Status</label>
                        <select id="statusStateSelect">
                            <option value="available">Available</option>
                            <option value="busy">Busy</option>
                            <option value="away">Away</option>
                        </select>
                        <label for="statusTextInput">Status Message</label>
                        <input type="text" id="statusTextInput" placeholder="e.g., Heads down coding">
                        <label for="schedulingLinkInput">Scheduling Link</label>
                        <input type="url" id="schedulingLinkInput" placeholder="e.g., https://cal.com/yourname">
                    </div>

                    <!-- Skills & Endorsements -->
                    <h3 style="text-align:center;margin-top:1.5rem;">Skills & Endorsements</h3>
                    <div class="profile-details-section">
                        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                            <input type="text" id="newSkillInput" placeholder="Add skill (owner only)" style="flex:1;">
                            <button id="addSkillBtn" class="profile-action-button"><i class="fas fa-plus"></i> Add Skill</button>
                        </div>
                        <div id="skillsList" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;"></div>
                    </div>

                    <!-- Featured Badges -->
                    <h3 style="text-align:center;margin-top:1.5rem;">Featured Badges</h3>
                    <div class="profile-details-section">
                        <p style="opacity:0.8;margin:0 0 8px;">Choose up to 3 to feature on your profile.</p>
                        <div id="featuredBadgesChooser" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
                        <div id="featuredBadgesDisplay" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;"></div>
                    </div>

                    <!-- Profile Insights -->
                    <h3 style="text-align:center;margin-top:1.5rem;">Profile Insights</h3>
                    <div class="profile-details-section">
                        <label style="display:flex;align-items:center;gap:8px;">
                            <input type="checkbox" id="analyticsOptInToggle">
                            Enable profile view analytics (owner only)
                        </label>
                        <p id="profileViewsLine" style="margin-top:8px;">Views: <strong id="profileViewsCount">0</strong></p>
                    </div>

                    <!-- Verified Links & QR -->
                    <h3 style="text-align:center;margin-top:1.5rem;">Share Profile</h3>
                    <div class="profile-details-section" style="align-items:center;">
                        <div id="profileShareUrl" style="opacity:0.9;word-break:break-all;margin-bottom:8px;"></div>
                        <img id="profileQrImg" alt="QR" style="width:160px;height:160px;border-radius:8px;border:1px solid var(--border-light);display:none;"/>
                    </div>

                    <!-- Safety Manager -->
                    <h3 style="text-align:center;margin-top:1.5rem;">Safety</h3>
                    <div class="profile-details-section">
                        <button id="openSafetyManagerBtn" class="profile-action-button secondary"><i class="fas fa-shield-alt"></i> Safety Manager</button>
                    </div>

                    <!-- Pinned Post -->
                    <h3 style="text-align:center;margin-top:1.5rem;">Pinned Post</h3>
                    <div id="pinnedPostArea" style="border:1px solid var(--border-light);border-radius:10px;padding:10px;background:rgba(255,255,255,0.03);"></div>

                </div>
                </div> <!-- End Tab About -->

                <!-- Posts Panel -->
                <div id="tabPanelPosts" style="display:none;">
                    <div class="posts-feed-section" id="userPostsFeed" style="display:block;">
                        <h3>Posts by <span id="postsFeedUsername"></span></h3>
                        <p style="text-align: center; color: var(--text-light);" id="loadingUserPostsMessage">Loading posts...</p>
                        <div id="userPostsList" style="display:flex;flex-direction:column;gap:10px;"></div>
                    </div>
                </div>

                <!-- Media Panel -->
                <div id="tabPanelMedia" style="display:none;">
                    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
                        <label>Filter:</label>
                        <select id="mediaFilterSelect" class="profile-action-button secondary" style="padding:6px 10px;">
                            <option value="all">All</option>
                            <option value="image">Images</option>
                            <option value="video">Videos</option>
                        </select>
                    </div>
                    <div id="userMediaGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px;"></div>
                </div>

                <!-- Highlights Panel -->
                <div id="tabPanelHighlights" style="display:none;">
                    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
                        <button id="addHighlightBtn" class="profile-action-button"><i class="fas fa-plus"></i> New Highlight</button>
                    </div>
                    <div id="highlightsGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px;"></div>
                </div>

                <!-- Saved Panel -->
                <div id="tabPanelSaved" style="display:none;">
                    <div id="savedPostsList" style="display:flex;flex-direction:column;gap:8px;"></div>
                    <div id="savedInspirationsList" style="display:flex;flex-direction:column;gap:8px;margin-top:12px;"></div>
                </div>

                <!-- Activity Panel -->
                <div id="tabPanelActivity" style="display:none;">
                    <div class="recent-activity-section" id="recentActivitySection" style="display:block;">
                        <h3>Recent Activity</h3>
                        <ul class="activity-list" id="recentActivityList">
                            <p class="no-activity-message">No recent activity.</p>
                        </ul>
                    </div>
                </div>


                    <!-- Toggle for Account Settings (Email/Password) -->
                    <button id="toggleAccountSettingsButton" class="profile-action-button secondary" style="margin-top: 2rem;">
                        <i class="fas fa-cog"></i> Manage Account Settings
                    </button>

                    <div id="accountSettingsSection" style="display: none; flex-direction: column; width: 100%;">
                        <div class="sub-section">
                            <h2>Account Settings</h2>

                            <div class="input-group">
                                <label for="profileEmailInput">Email Address</label>
                                <input type="email" id="profileEmailInput" placeholder="Your email" disabled>
                            </div>

                            <form id="changeEmailForm">
                                <div class="input-group">
                                    <label for="newEmail">New Email</label>
                                    <input type="email" id="newEmail" placeholder="Enter new email">
                                </div>
                                <div class="input-group">
                                    <label for="currentPasswordForEmail">Current Password</label>
                                    <input type="password" id="currentPasswordForEmail" placeholder="Enter current password">
                                </div>
                                <button type="submit" id="updateEmailButton">
                                    <span class="button-text">Update Email</span>
                                    <div class="button-loader"></div>
                                </button>
                            </form>

                            <div class="input-group">
                                <label for="oldPassword">Old Password</label>
                                <input type="password" id="oldPassword" placeholder="Enter old password">
                            </div>
                            <div class="input-group">
                                <label for="newPassword">New Password</label>
                                <input type="password" id="newPassword" placeholder="Enter new password">
                            </div>
                            <div class="input-group">
                                <label for="confirmNewPassword">Confirm New Password</label>
                                <input type="password" id="confirmNewPassword" placeholder="Confirm new password">
                            </div>
                            <button id="changePasswordButton">
                                <span class="button-text">Change Password</span>
                                <div class="button-loader"></div>
                            </button>

                            <button id="logoutButtonAccount" class="profile-action-button secondary">
                                <i class="fas fa-sign-out-alt"></i> Log Out
                            </button>

                            <p>Need help? <a href="#">Contact Support</a></p>
                            <p>Manage your data: <a href="#">Download Data</a> | <a href="#">Delete Account</a></p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- NEW: Unlocked Rewards Section -->
            <div class="unlocked-rewards-section" id="unlockedRewardsSection" style="display: none;">
                <h3>Your Unlocked Rewards</h3>
                <div class="rewards-grid" id="unlockedRewardsGrid">
                    <p class="no-rewards-message">No rewards unlocked yet.</p>
                </div>
            </div>

            <!-- NEW: Friends Snippet Section -->
            <div class="friends-snippet-section" id="friendsSnippetSection" style="display: none;">
                <h3>Friends You Might Know</h3>
                <div class="friends-grid" id="friendsSnippetGrid">
                    <p class="no-friends-message">Loading friends...</p>
                </div>
            </div>

            <!-- NEW: Recent Activity Section -->
            <div class="recent-activity-section" id="recentActivitySection" style="display: none;">
                <h3>Recent Activity</h3>
                <ul class="activity-list" id="recentActivityList">
                    <p class="no-activity-message">No recent activity.</p>
                </ul>
            </div>

            <!-- NEW: Wallet User Guide Section -->
            <div class="wallet-guide-section">
                <h3>Wallet User Guide</h3>
                <div class="guide-item">
                    <h4><i class="fas fa-wallet"></i> Understanding Your Balance</h4>
                    <p>Your JCHAT Wallet holds your digital currency, JCoins, and your experience points, Gas (XP).</p>
                    <ul>
                        <li><i class="fas fa-circle"></i> <strong>JCoins:</strong> Our in-app currency. Use them for various features, purchases, and even withdraw them for real money (subject to withdrawal rates).</li>
                        <li><i class="fas fa-circle"></i> <strong>Gas (XP):</strong> Your experience points. Earn Gas by engaging with the app, and it contributes to your user level.</li>
                        <li><i class="fas fa-circle"></i> <strong>USD Value:</strong> See the estimated USD value of your JCoins based on the current exchange rate.</li>
                    </ul>
                </div>

                <div class="guide-item">
                    <h4><i class="fas fa-money-bill-wave"></i> Buying JCoins</h4>
                    <p>To top up your JCoins, follow these steps:</p>
                    <ul>
                        <li><i class="fas fa-check-circle"></i> Go to the <a href="/wallet.html" class="gradient-text">My Wallet</a> page.</li>
                        <li><i class="fas fa-check-circle"></i> In the "Buy JCoins" section, you'll find our bank details.</li>
                        <li><i class="fas fa-check-circle"></i> Make a transfer to the provided account number.
                            <br><strong>Important:</strong> Use your JCHAT User ID as the reference for the transfer.</li>
                        <li><i class="fas fa-check-circle"></i> After transferring, fill out the "Custom Purchase" form with the Naira amount you paid.</li>
                        <li><i class="fas fa-check-circle"></i> Upload a clear screenshot or photo of your payment receipt.</li>
                        <li><i class="fas fa-check-circle"></i> Click "Send Purchase Request." An admin will review and credit your account.</li>
                        <li><i class="fas fa-info-circle"></i> Purchases of <span class="gradient-text">#1000</span> and above receive a <span class="gradient-text">10% JCoin bonus</span>!</li>
                    </ul>
                </div>

                <div class="guide-item">
                    <h4><i class="fas fa-gift"></i> Earning JCoins & Gas</h4>
                    <p>There are several ways to earn more on JCHAT:</p>
                    <ul>
                        <li><i class="fas fa-star"></i> <strong>Daily Login Bonus:</strong> Claim free JCoins and Gas every 24 hours from your profile or wallet page.</li>
                        <li><i class="fas fa-user-check"></i> <strong>Complete Your Profile:</strong> Fill out all your profile details for a one-time JCoin and Gas bonus.</li>
                        <li><i class="fas fa-user-plus"></i> <strong>Refer a Friend:</strong> Invite new users to JCHAT and earn JCoins when they join.</li>
                        <li><i class="fas fa-comments"></i> <strong>Engage in Chat:</strong> Earn Gas (XP) by actively participating in conversations and interacting with other users.</li>
                        <li><i class="fas fa-level-up-alt"></i> <strong>Level Up:</strong> Gain Gas to increase your user level and unlock exclusive rewards, titles, and features!</li>
                    </ul>
                </div>

                <div class="guide-item">
                    <h4><i class="fas fa-paper-plane"></i> Sending JCoins</h4>
                    <p>You can send JCoins to other JCHAT users directly from your wallet:</p>
                    <ul>
                        <li><i class="fas fa-arrow-right"></i> On the <a href="/wallet.html" class="gradient-text">My Wallet</a> page, click "Send JCoins."</li>
                        <li><i class="fas fa-arrow-right"></i> Enter the recipient's exact JCHAT User ID.</li>
                        <li><i class="fas fa-arrow-right"></i> Enter the amount of JCoins you wish to send.</li>
                        <li><i class="fas fa-arrow-right"></i> Confirm the transaction with your password for security.</li>
                    </ul>
                </div>

                <div class="guide-item">
                    <h4><i class="fas fa-hand-holding-usd"></i> Withdrawing JCoins</h4>
                    <p>Convert your JCoins into real Naira:</p>
                    <ul>
                        <li><i class="fas fa-money-check-alt"></i> First, ensure your bank details (Bank Name, Account Name, Account Number) are saved in the "Withdraw JCoins" section of your <a href="/wallet.html" class="gradient-text">My Wallet</a> page.</li>
                        <li><i class="fas fa-money-check-alt"></i> The current withdrawal rate is <strong>20000 JCoins = #10,000 NGN</strong>.</li>
                        <li><i class="fas fa-money-check-alt"></i> Click the "Withdraw JCoins" button. Your JCoins will be deducted, and a request sent to an admin.</li>
                        <li><i class="fas fa-money-check-alt"></i> Funds will be transferred to your saved bank account upon admin approval.</li>
                        <li><i class="fas fa-hourglass-half"></i> You can track the status of your withdrawal requests in the "My Withdrawal Requests" history.</li>
                    </ul>
                </div>

                <div class="guide-item">
                    <h4><i class="fas fa-history"></i> Transaction History</h4>
                    <p>Keep track of all your JCoin movements:</p>
                    <ul>
                        <li><i class="fas fa-list-alt"></i> On the <a href="/wallet.html" class="gradient-text">My Wallet</a> page, view your "Transaction History."</li>
                        <li><i class="fas fa-filter"></i> Use the "All Types" filter to view credits, debits, purchases, or withdrawals specifically.</li>
                        <li><i class="fas fa-search"></i> Use the search bar to find specific transactions by description.</li>
                        <li><i class="fas fa-info-circle"></i> Click on any transaction to see more detailed information, including receipt images for purchases.</li>
                    </ul>
                </div>
            </div>
            <!-- End NEW: Wallet User Guide Section -->


            <!-- User's posts feed -->
            <div class="posts-feed-section" id="userPostsFeed" style="display: none;">
                <h3>Posts by <span id="postsFeedUsername"></span></h3>
                <p style="text-align: center; color: var(--text-light);" id="loadingUserPostsMessage">Loading posts...</p>
                <!-- User's posts will be loaded here dynamically -->
            </div>
        </div>
    </main>

    <!-- Custom Message Box (reused from Home.html) -->
    <div id="messageBox"></div>

    <!-- NEW: JCoin Request Modal -->
    <div id="jcoinRequestModal" class="modal-overlay">
        <div class="modal-content">
            <h3><i class="fas fa-coins"></i> Request JCoins</h3>
            <p style="color: var(--text-light); font-size: 0.9rem; text-align: center;">
                Enter the Naira amount you wish to purchase. You will be credited with JCoins based on the current exchange rate.
                <br>
                Amounts of <span class="gradient-text">#1000</span> and above receive a <span class="gradient-text">10% bonus</span>.
            </p>
            <div class="input-group">
                <label for="nairaAmountInput">Naira Amount (NGN):</label>
                <input type="number" id="nairaAmountInput" placeholder="e.g., 500, 1000, 5000" min="100">
                <p class="calculated-jcoins">You will get: <span id="calculatedJCoins">0 JCoins</span></p>
            </div>
            <div class="input-group">
                <label class="file-input-label" for="receiptUploadInput">Upload Payment Receipt:</label>
                <div class="file-input-wrapper">
                    <input type="file" id="receiptUploadInput" accept="image/*" style="display: none;">
                    <i class="fas fa-upload"></i>
                    <span class="file-name" id="receiptFileName">No file chosen</span>
                </div>
                <img id="receiptPreview" class="receipt-preview" style="display: none;">
            </div>
            <div class="button-group">
                <button id="cancelJCoinRequest" class="modal-button cancel-button">Cancel</button>
                <button id="submitJCoinRequestButton" class="modal-button save-button">
                    <span class="button-text">Submit Request</span>
                    <div class="button-loader"></div>
                </button>
            </div>
        </div>
    </div>

    <!-- NEW: Report User Modal -->
    <div id="reportUserModal" class="modal-overlay">
        <div class="modal-content">
            <h3><i class="fas fa-flag"></i> Report User</h3>
            <p style="color: var(--text-light); font-size: 0.9rem; text-align: center;">
                You are reporting <strong id="reportedUsernameDisplay" class="gradient-text"></strong>.
                Please select a reason and provide details.
            </p>
            <div class="input-group">
                <label for="reportReasonSelect">Reason:</label>
                <select id="reportReasonSelect">
                    <option value="">Select a reason</option>
                    <option value="harassment">Harassment / Bullying</option>
                    <option value="spam">Spam / Advertising</option>
                    <option value="inappropriate_content">Inappropriate Content</option>
                    <option value="impersonation">Impersonation</option>
                    <option value="scam">Scam / Fraud</option>
                    <option value="other">Other (please specify)</option>
                </select>
            </div>
            <div class="input-group">
                <label for="reportDetailsTextarea">Details (optional):</label>
                <textarea id="reportDetailsTextarea" rows="4" placeholder="Provide more details about the report..."></textarea>
            </div>
            <div class="button-group">
                <button id="cancelReportButton" class="modal-button cancel-button">Cancel</button>
                <button id="submitReportButton" class="modal-button save-button">
                    <span class="button-text">Submit Report</span>
                    <div class="button-loader"></div>
                </button>
            </div>
        </div>
    </div>
    <script type="module">
        // Import Firebase modules (Updated to v11.8.0 - Latest Stable)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, updateProfile, updateEmail, reauthenticateWithCredential, EmailAuthProvider, updatePassword, signOut, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, setDoc, deleteDoc, collection, query, where, getDocs, runTransaction, writeBatch, serverTimestamp, orderBy, addDoc, arrayUnion, documentId } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-storage.js";
        import { Timestamp } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-firestore.js";

        // --- Firebase & Canvas Environment Configuration ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyBsBinyrD9WZZXRaCvA4gxfX7BIimydDvo",
            authDomain: "jchat-1.firebaseapp.com",
            projectId: "jchat-1",
            storageBucket: "jchat-1.firebasestorage.app",
            appId: "1:328479683167:web:276c0b7e8ea44dd2d6a1ea",
            measurementId: "G-S6Z9GG0R9P"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; // Corrected: Use initialAuthToken variable

        // Cloudinary Configuration
        const cloudinaryConfig = {
            cloudName: "dxld01rcp", // Your Cloudinary Cloud Name
            uploadPreset: "Storage_preset" // Your Cloudinary Upload Preset
        };

        // Initialize Firebase services
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- DOM Elements ---
        const headerProfilePic = document.getElementById('headerProfilePic');
        const headerAvatarIcon = document.getElementById('headerAvatarIcon');
        const headerDisplayName = document.getElementById('headerDisplayName');
        const notificationCountElement = document.getElementById('notificationCount');
        const messageBox = document.getElementById('messageBox');
        const headerNavLinkProfile = document.getElementById('profileLink'); // Corrected ID to match HTML
        const adminIconLink = document.getElementById('adminIconLink');

        const profilePicWrapper = document.getElementById('profilePicWrapper'); // New wrapper for owner check
        const profilePagePic = document.getElementById('profilePagePic');
        const profilePageAvatarIcon = document.getElementById('profilePageAvatarIcon');
        const profilePicUploadInput = document.getElementById('profilePicUploadInput');
        const editProfilePicOverlay = document.getElementById('editProfilePicOverlay');

        const profileUsername = document.getElementById('profileUsername'); // H2 element for username
        const profileBio = document.getElementById('profileBio');
        const profileLocation = document.getElementById('profileLocation'); // P element container
        const locationText = document.getElementById('locationText'); // Span inside profileLocation
        const profileEmail = document.getElementById('profileEmail'); // P element container
        const emailText = document.getElementById('emailText'); // Span inside profileEmail

        // --- Notification Badge Management ---
        function updateNotificationBadge(count) {
            const notificationWrapper = document.querySelector('.notification-icon-wrapper');
            const badge = document.getElementById('notificationCount');
            if (badge && notificationWrapper) {
                if (count > 0) {
                    badge.textContent = count > 99 ? '99+' : count.toString();
                    badge.style.display = 'flex';
                    notificationWrapper.classList.add('has-notifications');
                    console.log(' Notification badge updated:', count, 'notifications');
                } else {
                    badge.style.display = 'none';
                    notificationWrapper.classList.remove('has-notifications');
                    console.log(' No notifications, badge hidden');
                }
            }
        }

        // NEW: User Info Display Elements
        const profileSchool = document.getElementById('profileSchool');
        const schoolText = document.getElementById('schoolText');
        const profileWork = document.getElementById('profileWork');
        const workText = document.getElementById('workText');
        const profileWebsite = document.getElementById('profileWebsite');
        const websiteLink = document.getElementById('websiteLink');
        const profileSocialLinks = document.getElementById('profileSocialLinks');
        const socialLinksText = document.getElementById('socialLinksText');


        const statPosts = document.getElementById('statPosts');
        const statFriends = document.getElementById('statFriends');
        const statFollowers = document.getElementById('statFollowers');
        const statFollowing = document.getElementById('statFollowing');
        const jCoinsSpan = document.getElementById('jCoins'); // Added for jCoins
        const jcoinExchangeRate = document.getElementById('jcoinExchangeRate'); // Added for exchange rate
        const jcoinUSDValue = document.getElementById('jcoinUSDValue'); // Added for USD value

        // XP Level Elements
        const gasValue = document.getElementById('gasValue'); // Gas (XP) value
        const xpLevelIcon = document.getElementById('xpLevelIcon');
        const xpLevelName = document.getElementById('xpLevelName');
        const progressBarContainer = document.getElementById('progressBarContainer'); // NEW: Get the container
        const xpProgressBarFill = document.getElementById('xpProgressBarFill');

        const profileActions = document.getElementById('profileActions');
        const walletLink = document.getElementById('walletLink'); // Wallet link
        const walletLockedMessage = document.getElementById('walletLockedMessage'); // Wallet locked message
        const requestJCoinsButton = document.getElementById('requestJCoinsButton'); // NEW: Request JCoins Button
        const claimDailyBonusButton = document.getElementById('claimDailyBonusButton'); // NEW
        const dailyBonusCountdown = document.getElementById('dailyBonusCountdown'); // NEW
        const reportUserButton = document.getElementById('reportUserButton'); // NEW


        // Inline Edit Fields
        const displayNameInput = document.getElementById('displayName'); // Input for display name
        const bioTextarea = document.getElementById('bio');
        const locationInput = document.getElementById('locationInput'); // Input for location
        // NEW: Inputs for additional user info
        const schoolInput = document.getElementById('schoolInput');
        const workInput = document.getElementById('workInput');
        const interestsInput = document.getElementById('interestsInput');
        const websiteInput = document.getElementById('websiteInput');
        const socialLinksInput = document.getElementById('socialLinksInput');

        const saveProfileChanges = document.getElementById('saveProfileChanges'); // Renamed from saveProfileChangesButton

                    // Cover image wiring
            const profileCoverWrapper = document.getElementById('profileCoverWrapper');
            const profileCoverImg = document.getElementById('profileCoverImg');
            const profileCoverUploadInput = document.getElementById('profileCoverUploadInput');
            const editCoverOverlay = document.getElementById('editCoverOverlay');

            // Tabs wiring
            const tabsContainer = document.getElementById('profileTabs');
            const tabPanelAbout = document.getElementById('tabPanelAbout');
            const tabPanelPosts = document.getElementById('tabPanelPosts');
            const tabPanelMedia = document.getElementById('tabPanelMedia');
            const tabPanelSaved = document.getElementById('tabPanelSaved');
            const tabPanelActivity = document.getElementById('tabPanelActivity');
            const tabPanelHighlights = document.getElementById('tabPanelHighlights');
            const userPostsList = document.getElementById('userPostsList');
            const userMediaGrid = document.getElementById('userMediaGrid');
            const mediaFilterSelect = document.getElementById('mediaFilterSelect');
            const savedPostsList = document.getElementById('savedPostsList');
            const savedInspirationsList = document.getElementById('savedInspirationsList');
            const highlightsGrid = document.getElementById('highlightsGrid');
            const addHighlightBtn = document.getElementById('addHighlightBtn');

            // NEW: Privacy Settings Toggles
            const toggleEmailVisibility = document.getElementById('toggleEmailVisibility');
        const toggleLocationVisibility = document.getElementById('toggleLocationVisibility');
        const toggleOnlineStatusVisibility = document.getElementById('toggleOnlineStatusVisibility');
        const toggleFriendRequests = document.getElementById('toggleFriendRequests');
        const toggleMessages = document.getElementById('toggleMessages');
        const toggleSchoolVisibility = document.getElementById('toggleSchoolVisibility');
        const toggleWorkVisibility = document.getElementById('toggleWorkVisibility');
        const toggleInterestsVisibility = document.getElementById('toggleInterestsVisibility');
        const toggleWebsiteVisibility = document.getElementById('toggleWebsiteVisibility');
        const toggleSocialLinksVisibility = document.getElementById('toggleSocialLinksVisibility');
        const savePrivacySettingsButton = document.getElementById('savePrivacySettingsButton');

        // NEW: Customization Selects
        const profileFrameSelect = document.getElementById('profileFrameSelect');
        const chatBubbleStyleSelect = document.getElementById('chatBubbleStyleSelect');
        const profileThemeSelect = document.getElementById('profileThemeSelect');
        const saveCustomizationButton = document.getElementById('saveCustomizationButton');


        // Account Settings Fields
        const profileEmailInput = document.getElementById('profileEmailInput'); // Disabled email display
        const newEmailInput = document.getElementById('newEmail');
        const currentPasswordForEmailInput = document.getElementById('currentPasswordForEmail');
        const updateEmailButton = document.getElementById('updateEmailButton');
        const oldPasswordInput = document.getElementById('oldPassword');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmNewPasswordInput = document.getElementById('confirmNewPassword');
        const changePasswordButton = document.getElementById('changePasswordButton');
        const logoutButtonAccount = document.getElementById('logoutButtonAccount'); // Logout button in account settings

        // NEW: Toggle for Account Settings Section
        const toggleAccountSettingsButton = document.getElementById('toggleAccountSettingsButton');
        const accountSettingsSection = document.getElementById('accountSettingsSection');


        const userPostsFeed = document.getElementById('userPostsFeed');
        const postsFeedUsername = document.getElementById('postsFeedUsername');
        const loadingUserPostsMessage = document.getElementById('loadingUserPostsMessage');

        // JCoin Request Modal Elements
        const jcoinRequestModal = document.getElementById('jcoinRequestModal');
        const nairaAmountInput = document.getElementById('nairaAmountInput');
        const calculatedJCoinsSpan = document.getElementById('calculatedJCoins');
        const receiptUploadInput = document.getElementById('receiptUploadInput');
        const receiptFileNameSpan = document.getElementById('receiptFileName');
        const receiptPreviewImg = document.getElementById('receiptPreview');
        const cancelJCoinRequestButton = document.getElementById('cancelJCoinRequest');
        const submitJCoinRequestButton = document.getElementById('submitJCoinRequestButton');
        // NEW: Report User Modal Elements
        const reportUserModal = document.getElementById('reportUserModal');
        const reportedUsernameDisplay = document.getElementById('reportedUsernameDisplay');
        const reportReasonSelect = document.getElementById('reportReasonSelect');
        const reportDetailsTextarea = document.getElementById('reportDetailsTextarea');
        const cancelReportButton = document.getElementById('cancelReportButton');
        const submitReportButton = document.getElementById('submitReportButton');
        // NEW: Unlocked Rewards Section
        const unlockedRewardsSection = document.getElementById('unlockedRewardsSection');
        const unlockedRewardsGrid = document.getElementById('unlockedRewardsGrid');
        const noRewardsMessage = document.getElementById('noRewardsMessage');
        // NEW: Friends Snippet Section
        const friendsSnippetSection = document.getElementById('friendsSnippetSection');
        const friendsSnippetGrid = document.getElementById('friendsSnippetGrid');
        const noFriendsMessage = document.getElementById('noFriendsMessage');

                    // NEW: Recent Activity Section
            const recentActivitySection = document.getElementById('recentActivitySection');
            const recentActivityList = document.getElementById('recentActivityList');
            const noActivityMessage = document.getElementById('noActivityMessage');

            // Tabs behavior
            if (tabsContainer) {
                if (tabsContainer) tabsContainer.addEventListener('click', (e) => {
                    const btn = e.target.closest('button[data-tab]');
                    if (!btn) return;
                    const tab = btn.getAttribute('data-tab');
                    [tabPanelAbout, tabPanelPosts, tabPanelMedia, tabPanelSaved, tabPanelActivity, tabPanelHighlights].forEach(p => p && (p.style.display = 'none'));
                    if (tab === 'about') tabPanelAbout.style.display = 'block';
                    if (tab === 'posts') { tabPanelPosts.style.display = 'block'; ensureUserPostsLoaded(); }
                    if (tab === 'media') { tabPanelMedia.style.display = 'block'; ensureUserMediaLoaded(); }
                    if (tab === 'highlights') { tabPanelHighlights.style.display = 'block'; ensureHighlightsLoaded(); }
                    if (tab === 'saved') { tabPanelSaved.style.display = 'block'; ensureSavedLoaded(); }
                    if (tab === 'activity') { tabPanelActivity.style.display = 'block'; ensureActivityLoaded(); }
                });
            }

            async function ensureUserPostsLoaded() {
                if (!userPostsList) return;
                if (userPostsList.dataset.loaded === '1') return;
                userPostsList.innerHTML = '<div style="opacity:0.8;">Loading posts...</div>';
                try {
                    const postsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'posts');
                    const qy = query(postsCollectionRef, where('authorId', '==', displayedUserId), orderBy('createdAt', 'desc'));
                    const snap = await getDocs(qy);
                    userPostsList.innerHTML = '';
                    if (snap.empty) {
                        userPostsList.innerHTML = '<div style="opacity:0.8;">No posts yet.</div>';
                    } else {
                        snap.forEach(docSnap => {
                            const p = docSnap.data();
                            const row = document.createElement('div');
                            row.style.cssText = 'padding:10px;border:1px solid var(--border-light);border-radius:10px;background:rgba(255,255,255,0.03);';
                            row.textContent = p.content || '(no text)';
                            userPostsList.appendChild(row);
                        });
                    }
                    userPostsList.dataset.loaded = '1';
                } catch (e) {
                    userPostsList.innerHTML = '<div style="color:salmon;">Failed to load posts.</div>';
                }
            }

            async function ensureUserMediaLoaded() {
                if (!userMediaGrid) return;
                userMediaGrid.innerHTML = '<div style="opacity:0.8;">Loading media...</div>';
                try {
                    const filter = mediaFilterSelect ? mediaFilterSelect.value : 'all';
                    const postsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'posts');
                    const qy = query(postsCollectionRef, where('authorId', '==', displayedUserId), orderBy('createdAt', 'desc'));
                    const snap = await getDocs(qy);
                    userMediaGrid.innerHTML = '';
                    let count = 0;
                    snap.forEach(docSnap => {
                        const p = docSnap.data();
                        if (p.mediaUrl && p.mediaType && (filter === 'all' || p.mediaType === filter)) {
                            const cell = document.createElement('div');
                            cell.style.cssText = 'position:relative;border-radius:10px;overflow:hidden;border:1px solid var(--border-light);background:rgba(255,255,255,0.03);';
                            if (p.mediaType === 'image') {
                                cell.innerHTML = `<img src="${getCloudinaryImageUrl(p.mediaUrl,'w_320,h_320,c_fill,q_auto')}" alt="media" style="width:100%;height:100%;object-fit:cover;">`;
                            } else if (p.mediaType === 'video') {
                                cell.innerHTML = `<video src="${p.mediaUrl}" style="width:100%;height:100%;object-fit:cover;" controls muted></video>`;
                            }
                            userMediaGrid.appendChild(cell);
                            count++;
                        }
                    });
                    if (count === 0) userMediaGrid.innerHTML = '<div style="opacity:0.8;">No media yet.</div>';
                    userMediaGrid.dataset.loaded = '1';
                } catch (e) {
                    userMediaGrid.innerHTML = '<div style="color:salmon;">Failed to load media.</div>';
                }
            }
            if (mediaFilterSelect) mediaFilterSelect.addEventListener('change', () => { userMediaGrid.dataset.loaded = '0'; ensureUserMediaLoaded(); });

            async function ensureHighlightsLoaded() {
                if (!highlightsGrid) return;
                if (highlightsGrid.dataset.loaded === '1') return;
                highlightsGrid.innerHTML = '<div style="opacity:0.8;">Loading highlights...</div>';
                try {
                    const ref = collection(db, 'artifacts', appId, 'users', displayedUserId, 'highlights');
                    const snap = await getDocs(ref);
                    highlightsGrid.innerHTML = '';
                    if (snap.empty) {
                        highlightsGrid.innerHTML = '<div style="opacity:0.8;">No highlights yet.</div>';
                    } else {
                        snap.forEach(d => {
                            const h = d.data() || {};
                            const card = document.createElement('div');
                            card.style.cssText = 'border:1px solid var(--border-light);border-radius:12px;overflow:hidden;background:rgba(255,255,255,0.03);';
                            const cover = h.coverPicId ? `<img src="${getCloudinaryImageUrl(h.coverPicId,'w_600,h_240,c_fill,q_auto')}" alt="cover" style="width:100%;height:140px;object-fit:cover;">` : '';
                            card.innerHTML = `${cover}<div style="padding:10px;"><div style="font-weight:600;">${h.title || 'Untitled'}</div><div style="opacity:0.8;">${h.description || ''}</div></div>`;
                            highlightsGrid.appendChild(card);
                        });
                    }
                    highlightsGrid.dataset.loaded = '1';
                } catch (e) {
                    highlightsGrid.innerHTML = '<div style="color:salmon;">Failed to load highlights.</div>';
                }
            }
            if (addHighlightBtn) addHighlightBtn.addEventListener('click', async () => {
                if (!currentUser || displayedUserId !== currentUser.uid) { showMessageBox('Only the owner can add highlights.', 'warning'); return; }
                const title = prompt('Title for highlight?');
                if (!title) return;
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'highlights'), { title, createdAt: serverTimestamp() });
                    highlightsGrid.dataset.loaded = '0';
                    ensureHighlightsLoaded();
                } catch (e) {
                    showMessageBox('Failed to add highlight.', 'error');
                }
            });

            async function ensureSavedLoaded() {
                if (!savedPostsList || !savedInspirationsList) return;
                if (savedPostsList.dataset.loaded === '1' && savedInspirationsList.dataset.loaded === '1') return;
                savedPostsList.innerHTML = '<div style="opacity:0.8;">Loading saved posts...</div>';
                savedInspirationsList.innerHTML = '<div style="opacity:0.8;">Loading saved inspirations...</div>';
                try {
                    const savedPostsRef = collection(db, 'artifacts', appId, 'users', displayedUserId, 'saved_posts');
                    const savedSnap = await getDocs(savedPostsRef);
                    savedPostsList.innerHTML = '';
                    if (savedSnap.empty) {
                        savedPostsList.innerHTML = '<div style="opacity:0.8;">No saved posts.</div>';
                    } else {
                        savedSnap.forEach(d => {
                            const pid = d.id;
                            const row = document.createElement('div');
                            row.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border:1px solid var(--border-light);border-radius:10px;background:rgba(255,255,255,0.03);';
                            row.innerHTML = `<span>Post: ${pid}</span>`;
                            savedPostsList.appendChild(row);
                        });
                    }
                    savedPostsList.dataset.loaded = '1';
                } catch (e) {
                    savedPostsList.innerHTML = '<div style="color:salmon;">Failed to load saved posts.</div>';
                }
                try {
                    const savedInspRef = collection(db, 'artifacts', appId, 'users', displayedUserId, 'saved_inspirations');
                    const inspSnap = await getDocs(savedInspRef);
                    savedInspirationsList.innerHTML = '';
                    if (inspSnap.empty) {
                        savedInspirationsList.innerHTML = '<div style="opacity:0.8;">No saved inspirations.</div>';
                    } else {
                        inspSnap.forEach(d => {
                            const data = d.data() || {};
                            const text = data.text || '(no text)';
                            const row = document.createElement('div');
                            row.style.cssText = 'padding:8px 10px;border:1px solid var(--border-light);border-radius:10px;background:rgba(255,255,255,0.03);';
                            row.textContent = text;
                            savedInspirationsList.appendChild(row);
                        });
                    }
                    savedInspirationsList.dataset.loaded = '1';
                } catch (e) {
                    savedInspirationsList.innerHTML = '<div style="color:salmon;">Failed to load saved inspirations.</div>';
                }
            }

            function ensureActivityLoaded() {
                if (!recentActivitySection) return;
                recentActivitySection.style.display = 'block';
            }
            // Cover upload handling (owner only)
            if (profileCoverUploadInput) {
                let originalImage = null;
                let imageNaturalWidth = 0;
                let imageNaturalHeight = 0;
                let cropState = { x: 0, y: 0, w: 0, h: 0, zoom: 1 };

                // New: Auto-crop (center-crop) cover to 16:5 and upload immediately
                async function autoCropAndUploadCover(file) {
                    try {
                        const dataUrl = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = () => resolve(reader.result);
                            reader.onerror = reject;
                            reader.readAsDataURL(file);
                        });
                        const img = new Image();
                        await new Promise((res, rej) => { img.onload = res; img.onerror = rej; img.src = dataUrl; });
                        const targetW = 1600, targetH = 500; // 16:5
                        const srcW = img.naturalWidth, srcH = img.naturalHeight;
                        const srcAspect = srcW / srcH, outAspect = targetW / targetH;
                        let drawW, drawH;
                        if (srcAspect > outAspect) { // too wide
                            drawH = targetH;
                            drawW = Math.round(drawH * srcAspect);
                        } else { // too tall
                            drawW = targetW;
                            drawH = Math.round(drawW / srcAspect);
                        }
                        const canvas = document.createElement('canvas');
                        canvas.width = targetW; canvas.height = targetH;
                        const ctx = canvas.getContext('2d');
                        const dx = Math.round((targetW - drawW) / 2);
                        const dy = Math.round((targetH - drawH) / 2);
                        ctx.drawImage(img, dx, dy, drawW, drawH);
                        const blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', 0.9));
                        if (!blob) throw new Error('Auto-crop failed');
                        const url = await uploadMediaToCloudinary(blob);
                        if (!url) throw new Error('Upload failed');
                        const coverUrl = getCloudinaryImageUrl(url, `w_${targetW},h_${targetH},c_fill,q_auto`);
                        const previewEl = document.getElementById('profileCoverImg');
                        if (previewEl) { previewEl.src = coverUrl; previewEl.style.display = 'block'; }
                        if (currentUser && displayedUserId === currentUser.uid) {
                            await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profiles', 'user_profile'), { coverPicId: url, updatedAt: serverTimestamp() });
                            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUser.uid), { coverPicId: url, updatedAt: serverTimestamp() });
                        }
                        showMessageBox('Cover updated!', 'success');
                    } catch (e) {
                        showMessageBox('Failed to update cover.', 'error');
                    }
                }

                if (profileCoverUploadInput) profileCoverUploadInput.addEventListener('change', async (ev) => {
                    const file = ev.target.files?.[0];
                    if (!file) return;
                    // Use auto-crop immediate upload instead of manual modal
                    await autoCropAndUploadCover(file);
                });
            }


        // --- Global State ---
        let currentUser = null; // The currently authenticated user (Firebase Auth object)
        let currentUserProfileData = null; // The current user's own private profile data (Firestore document)
        let displayedUserId = null; // The ID of the user whose profile is currently being displayed (from URL or current user)
        let displayedUserProfileData = null; // The profile data of the user currently being displayed (could be current user or another user)
        let isAuthReady = false; // Flag to indicate if auth state has been checked
        const ADMIN_UID = 'cc96gdhCRPO72NFZtleRCujHvIq2'; // Admin's User ID
        let currentSystemSettings = {}; // To store system settings (like exchange rates)

        const JCOIN_BONUS_THRESHOLD_NAIRA = 1000; // Naira amount from which JCoin bonus applies
        const JCOIN_BONUS_PERCENTAGE = 0.10; // 10% bonus

        let dailyBonusInterval = null; // For daily bonus countdown timer


        // --- Utility Functions ---

        /**
         * Plays a short notification sound.
         * Uses Tone.js for more robust audio feedback.
         */
        const successSynth = new Tone.Synth().toDestination();
        const errorSynth = new Tone.Synth().toDestination();
        const infoSynth = new Tone.Synth().toDestination();

        successSynth.oscillator.type = "sine";
        successSynth.envelope.attack = 0.01;
        successSynth.envelope.decay = 0.2;
        successSynth.envelope.sustain = 0.0;
        successSynth.envelope.release = 0.5;

        errorSynth.oscillator.type = "sawtooth";
        errorSynth.envelope.attack = 0.01;
        errorSynth.envelope.decay = 0.3;
        errorSynth.envelope.sustain = 0.0;
        errorSynth.envelope.release = 0.5;
        infoSynth.oscillator.type = "triangle";
        infoSynth.envelope.attack = 0.01;
        infoSynth.envelope.decay = 0.1;
        infoSynth.envelope.sustain = 0.0;
        infoSynth.envelope.release = 0.3;

        function playNotificationSound(type) {
            try {
                // Create audio element for the new notification sound
                const audio = new Audio('ne.mp3');
                audio.volume = 0.6; // Set volume to 60%
                
                // Play the notification sound
                audio.play().catch(error => {
                    console.log('JCHAT_DEBUG: Could not play notification sound:', error);
                    // Fallback to Tone.js if audio file fails
                    Tone.start();
                    if (type === 'success') {
                        successSynth.triggerAttackRelease("C5", "8n");
                    } else if (type === 'error') {
                        errorSynth.triggerAttackRelease("C3", "8n");
                    } else if (type === 'info') {
                        infoSynth.triggerAttackRelease("E4", "16n");
                    }
                });
            } catch (error) {
                console.log('JCHAT_DEBUG: Error playing notification sound:', error);
                // Fallback to Tone.js
                Tone.start();
                if (type === 'success') {
                    successSynth.triggerAttackRelease("C5", "8n");
                } else if (type === 'error') {
                    errorSynth.triggerAttackRelease("C3", "8n");
                } else if (type === 'info') {
                    infoSynth.triggerAttackRelease("E4", "16n");
                }
            }
        }
        /**
         * Displays a temporary message box with a given message and type.
         * @param {string} message - The message to display.
         * @param {string} type - The type of message ('success', 'error', 'info', 'loading', 'warning').
         * @param {boolean} [isPersistent=false] - If true, message stays until explicitly cleared or replaced.
         * @param {number} [durationMs=3000] - Duration in milliseconds for the message to display if not persistent.
         */
        function showMessageBox(message, type, isPersistent = false, durationMs = 3000) {
            if (!messageBox) { console.error("JCHAT_ERROR: messageBox element not found."); return; }
            if (messageBox.timeoutId) {
                clearTimeout(messageBox.timeoutId);
            }

            messageBox.innerHTML = `<i id="messageBoxIcon"></i><span id="messageBoxText"></span>`;
            const messageBoxIcon = document.getElementById('messageBoxIcon');
            const messageBoxText = document.getElementById('messageBoxText');

            messageBoxText.textContent = message;
            messageBox.className = 'message-box show ' + type; // Add type class for styling

            // Set icon based on type
            if (type === 'success') {
                messageBoxIcon.classList.add('fas', 'fa-check-circle');
            } else if (type === 'error') {
                messageBoxIcon.classList.add('fas', 'fa-times-circle');
            } else if (type === 'info') {
                messageBoxIcon.classList.add('fas', 'fa-info-circle');
            } else if (type === 'warning') {
                 messageBoxIcon.classList.add('fas', 'fa-exclamation-triangle');
            } else if (type === 'loading') {
                 messageBoxIcon.classList.add('fas', 'fa-spinner', 'fa-spin'); // Spinner for loading
            } else {
                messageBoxIcon.className = ''; // No specific icon
            }

            if (type === 'loading') {
                messageBox.classList.add('loading-pulse');
            } else {
                messageBox.classList.remove('loading-pulse');
            }

            messageBox.style.display = 'flex';
            messageBox.style.opacity = '1';

            if (!isPersistent) {
                messageBox.timeoutId = setTimeout(() => {
                    messageBox.style.opacity = '0';
                    messageBox.addEventListener('transitionend', function handler() {
                        messageBox.style.display = 'none';
                        messageBox.removeEventListener('transitionend', handler);
                        messageBox.classList.remove('loading-pulse');
                    }, { once: true });
                }, durationMs);
            }
        }

        /**
         * Toggles loading state for a button.
         * @param {HTMLElement} buttonElement - The button to toggle.
         * @param {boolean} isLoading - True to show loading, false to hide.
         */
        function toggleButtonLoading(buttonElement, isLoading) {
            if (!buttonElement) return;
            const loader = buttonElement.querySelector('.button-loader');
            const text = buttonElement.querySelector('.button-text');

            if (isLoading) {
                buttonElement.disabled = true;
                buttonElement.classList.add('loading'); // Add loading class for general styling
                if (loader) loader.classList.add('active');
                if (text) text.style.display = 'none';
            } else {
                buttonElement.disabled = false;
                buttonElement.classList.remove('loading');
                if (loader) loader.classList.remove('active');
                if (text) text.style.display = 'block';
            }
        }

        /**
         * Displays a custom confirmation modal.
         * @param {string} message - The message to display in the modal.
         * @returns {Promise<boolean>} Resolves with true if 'Yes' is clicked, false if 'No'.
         */
        function showCustomConfirm(message) {
            return new Promise((resolve) => {
                const customConfirmModal = document.getElementById('customConfirmModal'); // Assuming this exists or is created
                const confirmModalMessage = document.getElementById('confirmModalMessage'); // Assuming this exists
                const confirmYesBtn = document.getElementById('confirmYesBtn');     // Assuming this exists
                const confirmNoBtn = document.getElementById('confirmNoBtn');       // Assuming this exists

                if (!customConfirmModal || !confirmModalMessage) {
                    console.error("JCHAT_ERROR: Custom confirmation modal base elements not found.");
                    resolve(false);
                    return;
                }

                confirmModalMessage.textContent = message;
                customConfirmModal.classList.add('active');

                const handleYes = () => {
                    customConfirmModal.classList.remove('active');
                    confirmYesBtn.removeEventListener('click', handleYes);
                    confirmNoBtn.removeEventListener('click', handleNo);
                    resolve(true);
                };

                const handleNo = () => {
                    customConfirmModal.classList.remove('active');
                    confirmYesBtn.removeEventListener('click', handleYes);
                    confirmNoBtn.removeEventListener('click', handleNo);
                    resolve(false);
                };

                if (confirmYesBtn) confirmYesBtn.addEventListener('click', handleYes);
                if (confirmNoBtn) confirmNoBtn.addEventListener('click', handleNo);
            });
        }

        /**
         * Constructs a Cloudinary URL for an image/video.
         * @param {string} urlOrPublicId - The full Cloudinary URL or the public ID of the image on Cloudinary.
         * @param {string} transformations - Optional Cloudinary transformations.
         * @returns {string|null} The full Cloudinary URL or null if urlOrPublicId is not provided.
         */
        function getCloudinaryImageUrl(urlOrPublicId, transformations = "w_auto,f_auto,q_auto") {
            if (!urlOrPublicId) return null;
            // Check if it's already a full URL (e.g., from Firebase Auth photoURL or existing Cloudinary URL)
            if (urlOrPublicId.startsWith('http://') || urlOrPublicId.startsWith('https://')) {
                // If it's a direct URL to a Cloudinary asset, we can insert transformations
                // This is a simplified approach; a more robust one would parse the URL
                if (urlOrPublicId.includes('res.cloudinary.com')) {
                    const parts = urlOrPublicId.split('/upload/');
                    if (parts.length === 2) {
                        return `${parts[0]}/upload/${transformations}/${parts[1]}`;
                    }
                }
                return urlOrPublicId; // Return as is if it's a general URL not from Cloudinary or already transformed
            }
            // Assume it's a public ID if not a full URL
            return `https://res.cloudinary.com/${cloudinaryConfig.cloudName}/image/upload/${transformations}/${urlOrPublicId}`;
        }

        /**
         * Displays the profile picture or a default icon.
         * @param {HTMLElement} imgElement - The <img> element to update.
         * @param {HTMLElement} iconElement - The <i> element to display if no image.
         * @param {string|null} profilePicId - The Cloudinary public ID or URL, or null.
         * @param {string} usernameInitial - Initial for placeholder.
         * @param {string} transformations - Cloudinary transformations for the image.
         */
        function displayProfilePicture(imgElement, iconElement, profilePicId, usernameInitial, transformations) {
            if (imgElement) { // Ensure imgElement exists
                if (profilePicId) {
                    const imageUrl = getCloudinaryImageUrl(profilePicId, transformations);
                    imgElement.src = imageUrl;
                    imgElement.style.display = 'block';
                    if (iconElement) iconElement.style.display = 'none'; // Null check for iconElement
                    imgElement.onerror = () => {
                        console.error(`JCHAT_ERROR: Failed to load profile picture: ${profilePicId}. Using placeholder.`);
                        imgElement.src = `https://placehold.co/120x120/CCCCCC/000000?text=${usernameInitial}`;
                        imgElement.style.display = 'block';
                        if (iconElement) iconElement.style.display = 'none'; // Null check for iconElement
                    };
                } else {
                    imgElement.src = '';
                    imgElement.style.display = 'none';
                    if (iconElement) iconElement.style.display = 'block'; // Null check for iconElement
                }
            }
        }
        /**
         * Resizes and compresses an image file using a canvas.
         * @param {File} file - The image file to process.
         * @param {number} maxWidth - Maximum width for the resized image.
         * @param {number} maxHeight - Maximum height for the resized image.
         * @param {number} quality - JPEG compression quality (0.0 to 1.0).
         * @returns {Promise<Blob>} A promise that resolves with the processed image as a Blob.
         */
        function resizeImage(file, maxWidth = 800, maxHeight = 800, quality = 0.8) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        // Calculate new dimensions while maintaining aspect ratio
                        if (width > maxWidth) {
                            height = height * (maxWidth / width);
                            width = maxWidth;
                        }
                        if (height > maxHeight) {
                            width = width * (maxHeight / height);
                            height = maxHeight;
                        }

                        canvas.width = width;
                        canvas.height = height;

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob((blob) => {
                            if (blob) {
                                resolve(blob);
                            } else {
                                reject(new Error('Canvas to Blob conversion failed: Resulting blob was null.'));
                            }
                        }, 'image/jpeg', quality);
                    };
                    img.onerror = (error) => {
                        console.error("JCHAT_ERROR: Image element loading error during resize:", error);
                        reject(new Error(`Image loading failed: ${error.message || 'Unknown image loading error.'}`));
                    };
                    img.src = event.target.result;
                };
                reader.onerror = (error) => {
                    console.error("JCHAT_ERROR: FileReader error during readAsDataURL:", error);
                    reject(new Error(`FileReader error: ${error.target.error ? error.target.error.message : 'Unknown error reading file.'}`));
                }
                try {
                    reader.readAsDataURL(file);
                } catch (e) {
                    console.error("JCHAT_ERROR: Error calling readAsDataURL:", e);
                    reject(new Error(`Failed to read file data: ${e.message}`));
                }
            });
        }

        /**
         * Uploads a file (image/video) to Cloudinary.
         * @param {File|Blob} file - The file object (or Blob) to upload.
         * @returns {Promise<string|null>} A promise that resolves with the full secure URL of the uploaded asset, or null on error.
         */
        async function uploadMediaToCloudinary(file) {
            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', cloudinaryConfig.uploadPreset);

                const resourceType = file.type.startsWith('image/') ? 'image' : 'video'; // Determine resource type

                const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/${resourceType}/upload`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("JCHAT_ERROR: Cloudinary upload error:", errorData);
                    throw new Error(`Cloudinary upload failed: ${errorData.error.message || response.statusText}`);
                }

                const data = await response.json();
                return data.secure_url; // Return the secure URL
            } catch (error) {
                console.error("JCHAT_ERROR: Error uploading to Cloudinary:", error);
                return null;
            }
        }
        /**
         * Updates the authorProfilePic in all posts by a given user.
         * This function is called when a user's main profile picture changes.
         * @param {string} userId - The UID of the user whose posts need updating.
         * @param {string|null} newProfilePicUrl - The new profile picture URL.
         */
        async function updatePostsWithNewProfilePic(userId, newProfilePicUrl) {
            try {
                const postsCollectionRef = collection(db, "artifacts", appId, "public", "data", "posts");
                const q = query(postsCollectionRef, where("authorId", "==", userId));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const batch = writeBatch(db);
                    querySnapshot.forEach(docSnap => {
                        const postRef = doc(db, "artifacts", appId, "public", "data", "posts", docSnap.id);
                        batch.update(postRef, { profilePhoto: newProfilePicUrl });
                    });
                    await batch.commit();
                    console.log(`JCHAT_DEBUG: Updated profile picture for ${querySnapshot.size} posts by user ${userId}.`);
                }
            } catch (error) {
                console.error("JCHAT_ERROR: Error updating posts with new profile picture:", error);
                // Not showing message box here as it's a background task after main profile update
            }
        }
        /**
         * Handles the change event for the profile picture upload input.
         * Resizes, uploads to Cloudinary, updates Firestore, and refreshes UI.
         */
        async function handleProfilePicChange(event) {
            if (!currentUser || !isAuthReady || displayedUserId !== currentUser.uid) {
                showMessageBox("You can only change your own profile picture.", 'warning');
                return;
            }

            const file = event.target.files[0];
            if (!file) {
                return; // No file selected
            }

            if (!file.type.startsWith('image/')) {
                showMessageBox("Please select an image file.", "warning");
                return;
            }
            if (file.size > 5 * 1024 * 1024) { // 5MB limit
                showMessageBox("Image size too large. Max 5MB.", "warning");
                return;
            }

            if (profilePicWrapper) profilePicWrapper.classList.add('loading'); // Show loading spinner
            showMessageBox("Uploading profile picture...", 'loading', true);

            try {
                // 1. Resize and compress image
                const resizedImageBlob = await resizeImage(file, 240, 240, 0.9); // Optimized for profile pics

                // 2. Upload to Cloudinary
                const newProfilePicUrl = await uploadMediaToCloudinary(resizedImageBlob);

                if (!newProfilePicUrl) {
                    throw new Error("Cloudinary upload failed.");
                }

                // 3. Update Firebase Auth profile
                await updateProfile(currentUser, {
                    photoURL: newProfilePicUrl
                });
                console.log("JCHAT_DEBUG: Firebase Auth photoURL updated.");

                // 4. Update Firestore private profile
                const privateProfileDocRef = doc(db, "artifacts", appId, "users", currentUser.uid, "profiles", "user_profile");
                await updateDoc(privateProfileDocRef, {
                    profilePicId: newProfilePicUrl, // Store the full URL
                    updatedAt: serverTimestamp()
                });
                console.log("JCHAT_DEBUG: Firestore private profilePicId updated.");

                // 5. Update Firestore public profile
                const publicProfileDocRef = doc(db, "artifacts", appId, "public", "data", "users", currentUser.uid);
                await updateDoc(publicProfileDocRef, {
                    profilePicId: newProfilePicUrl, // Store the full URL
                    updatedAt: serverTimestamp()
                });
                console.log("JCHAT_DEBUG: Firestore public profilePicId updated.");

                // 6. Update profile pictures in user's posts (background task)
                updatePostsWithNewProfilePic(currentUser.uid, newProfilePicUrl);

                // 7. Update UI immediately
                displayProfilePicture(profilePagePic, profilePageAvatarIcon, newProfilePicUrl, (currentUserProfileData?.username || 'U').charAt(0).toUpperCase(), "w_240,h_240,c_fill,g_face,r_max");
                displayProfilePicture(headerProfilePic, headerAvatarIcon, newProfilePicUrl, (currentUserProfileData?.username || 'U').charAt(0).toUpperCase(), "w_70,h_70,c_fill,g_face,r_max");

                showMessageBox("Profile picture updated successfully!", 'success');

                // Refresh currentUserProfileData
                const updatedProfileSnap = await getDoc(privateProfileDocRef);
                if (updatedProfileSnap.exists()) {
                    currentUserProfileData = updatedProfileSnap.data();
                    displayedUserProfileData = currentUserProfileData; // Ensure consistency
                }

            }
            catch (error) {
                console.error("JCHAT_ERROR: Error updating profile picture:", error);
                showMessageBox(`Failed to update profile picture: ${error.message}`, 'error');
            }
            finally {
                if (profilePicWrapper) profilePicWrapper.classList.remove('loading'); // Hide loading spinner
                // Clear file input to allow re-uploading the same file if needed
                event.target.value = '';
            }
        }


        /**
         * Handles user logout.
         */
        async function handleLogout() {
            if (!currentUser) return; // Only allow logout if a user is actually logged in
            try {
                await signOut(auth);
                showMessageBox("Logged out successfully! ", 'success');
                setTimeout(() => {
                    window.location.href = '/login.html'; // Redirect to login page
                }, 1000);
            } catch (error) {
                console.error("JCHAT_ERROR: Error logging out:", error);
                showMessageBox("Failed to log out. Please try again.", 'error');
            }
        }

        /**
         * Handles saving profile changes (display name, bio, location, school, work, interests, website, social links).
         */
        async function handleSaveProfileChanges() {
            if (!currentUser || !isAuthReady || displayedUserId !== currentUser.uid) {
                showMessageBox("You can only edit your own profile.", 'warning');
                return;
            }

            toggleButtonLoading(saveProfileChanges, true);
            showMessageBox("Saving profile...", 'loading', true);

            const newDisplayName = displayNameInput.value.trim();
            const newBio = bioTextarea.value.trim();
            const newLocation = locationInput.value.trim();
            const newSchool = schoolInput.value.trim(); // NEW
            const newWork = workInput.value.trim();     // NEW
            const newInterests = interestsInput.value.trim(); // NEW
            const newWebsite = websiteInput.value.trim();   // NEW
            const newSocialLinks = socialLinksInput.value.trim(); // NEW

            if (!newDisplayName) {
                showMessageBox("Display name cannot be empty.", 'error');
                toggleButtonLoading(saveProfileChanges, false);
                return;
            }

            try {
                // Update Firebase Auth display name
                if (currentUser.displayName !== newDisplayName) {
                    await updateProfile(currentUser, {
                        displayName: newDisplayName
                    });
                    console.log("JCHAT_DEBUG: Firebase Auth displayName updated.");
                }

                // Update Firestore private profile
                const privateProfileDocRef = doc(db, "artifacts", appId, "users", currentUser.uid, "profiles", "user_profile");
                await updateDoc(privateProfileDocRef, {
                    username: newDisplayName, // Update username field in Firestore
                    bio: newBio,
                    location: newLocation,
                    school: newSchool, // NEW
                    work: newWork,     // NEW
                    interests: newInterests, // NEW
                    website: newWebsite,   // NEW
                    socialLinks: newSocialLinks, // NEW
                    updatedAt: serverTimestamp()
                });
                console.log("JCHAT_DEBUG: Firestore private profile updated.");

                // Update Firestore public profile
                const publicProfileDocRef = doc(db, "artifacts", appId, "public", "data", "users", currentUser.uid);
                await updateDoc(publicProfileDocRef, {
                    username: newDisplayName,
                    bio: newBio,
                    location: newLocation,
                    school: newSchool, // NEW
                    work: newWork,     // NEW
                    interests: newInterests, // NEW
                    website: newWebsite,   // NEW
                    socialLinks: newSocialLinks, // NEW
                    updatedAt: serverTimestamp()
                });
                console.log("JCHAT_DEBUG: Firestore public profile updated.");

                // Update header UI immediately
                if (headerDisplayName) headerDisplayName.textContent = newDisplayName; // Null check
                if (profileUsername) profileUsername.textContent = newDisplayName; // Null check
                if (profileBio) profileBio.textContent = newBio || "No bio provided yet."; // Null check

                // Update display for new fields
                if (newLocation) { if (locationText) locationText.textContent = newLocation; if (profileLocation) profileLocation.style.display = 'block'; } else { if (profileLocation) profileLocation.style.display = 'none'; }
                if (newSchool) { if (schoolText) schoolText.textContent = newSchool; if (profileSchool) profileSchool.style.display = 'block'; } else { if (profileSchool) profileSchool.style.display = 'none'; }
                if (newWork) { if (workText) workText.textContent = newWork; if (profileWork) profileWork.style.display = 'block'; } else { if (profileWork) profileWork.style.display = 'none'; }
                if (newWebsite) { if (websiteLink) { websiteLink.href = newWebsite; websiteLink.textContent = newWebsite.replace(/^(https?:\/\/)?(www\.)?/, ''); } if (profileWebsite) profileWebsite.style.display = 'block'; } else { if (profileWebsite) profileWebsite.style.display = 'none'; }
                if (newSocialLinks) { if (socialLinksText) socialLinksText.textContent = newSocialLinks; if (profileSocialLinks) profileSocialLinks.style.display = 'block'; } else { if (profileSocialLinks) profileSocialLinks.style.display = 'none'; }


                showMessageBox("Profile saved successfully!", 'success');

                // Refresh currentUserProfileData
                const updatedProfileSnap = await getDoc(privateProfileDocRef);
                if (updatedProfileSnap.exists()) {
                    currentUserProfileData = updatedProfileSnap.data();
                    displayedUserProfileData = currentUserProfileData; // Ensure consistency
                }

            } catch (error) {
                console.error("JCHAT_ERROR: Error saving profile changes:", error);
                showMessageBox(`Failed to save profile: ${error.message}`, 'error');
            } finally {
                toggleButtonLoading(saveProfileChanges, false);
            }
        }
        /**
         * Handles saving privacy settings.
         */
        async function handleSavePrivacySettings() {
            if (!currentUser || !isAuthReady || displayedUserId !== currentUser.uid) {
                showMessageBox("You can only edit your own privacy settings.", 'warning');
                return;
            }

            toggleButtonLoading(savePrivacySettingsButton, true);
            showMessageBox("Saving privacy settings...", 'loading', true);

            try {
                const newVisibility = {
                    displayName: true, // Display name is always public
                    profilePic: true,  // Profile pic is always public
                    emailPublic: toggleEmailVisibility.checked,
                    location: toggleLocationVisibility.checked,
                    lastOnline: toggleOnlineStatusVisibility.checked, // Assuming this is handled by backend logic
                    allowFriendRequests: toggleFriendRequests.checked,
                    allowMessages: toggleMessages.checked,
                    school: toggleSchoolVisibility.checked,
                    work: toggleWorkVisibility.checked,
                    interests: toggleInterestsVisibility.checked,
                    website: toggleWebsiteVisibility.checked,
                    socialLinks: toggleSocialLinksVisibility.checked
                };

                const privateProfileDocRef = doc(db, "artifacts", appId, "users", currentUser.uid, "profiles", "user_profile");
                await updateDoc(privateProfileDocRef, {
                    visibility: newVisibility,
                    updatedAt: serverTimestamp()
                });

                const publicProfileDocRef = doc(db, "artifacts", appId, "public", "data", "users", currentUser.uid);
                await updateDoc(publicProfileDocRef, {
                    visibility: newVisibility, // Update public record for visibility settings
                    updatedAt: serverTimestamp()
                });

                showMessageBox("Privacy settings saved successfully!", 'success');

                // Refresh currentUserProfileData and re-render profile for immediate effect
                const updatedProfileSnap = await getDoc(privateProfileDocRef);
                if (updatedProfileSnap.exists()) {
                    currentUserProfileData = updatedProfileSnap.data();
                    displayedUserProfileData = currentUserProfileData; // Ensure consistency
                    // Re-call fetchAndDisplayUserProfile to apply new visibility locally
                    await fetchAndDisplayUserProfile(currentUser.uid);
                }

            } catch (error) {
                console.error("JCHAT_ERROR: Error saving privacy settings:", error);
                showMessageBox(`Failed to save privacy settings: ${error.message}`, 'error');
            } finally {
                toggleButtonLoading(savePrivacySettings, false);
            }
        }
        /**
         * Handles saving customization settings.
         */
        async function handleSaveCustomization() {
            if (!currentUser || !isAuthReady || displayedUserId !== currentUser.uid) {
                showMessageBox("You can only customize your own profile.", 'warning');
                return;
            }

            toggleButtonLoading(saveCustomizationButton, true);
            showMessageBox("Saving customization...", 'loading', true);

            try {
                const newProfileFrame = profileFrameSelect.value;
                const newChatBubbleStyle = chatBubbleStyleSelect.value;
                const newProfileTheme = profileThemeSelect.value;

                // Basic validation: Check if user has unlocked these
                const hasFrame = currentUserProfileData.unlockedBenefits.includes(`Unlock: ${newProfileFrame === 'gradient' ? 'Gradient Profile Picture Frame' : (newProfileFrame === 'diamond' ? 'Exclusive \'Diamond\' Profile Picture Frame' : '')}`);
                const hasBubble = currentUserProfileData.unlockedBenefits.includes(`Unlock: ${newChatBubbleStyle === 'basic' ? 'Basic Chat Bubble Style' : (newChatBubbleStyle === 'rounded' ? 'New Chat Bubble Style (Set 2)' : '')}`);
                const hasTheme = currentUserProfileData.unlockedBenefits.includes(`Unlock: ${newProfileTheme === 'solid' ? 'Basic Profile Theme (Solid Color)' : (newProfileTheme === 'animated1' ? 'Premium Profile Theme (Animated 1)' : '')}`);

                if (newProfileFrame !== 'default' && !hasFrame) {
                    showMessageBox(`You haven't unlocked the '${newProfileFrame}' frame yet!`, 'warning');
                    toggleButtonLoading(saveCustomizationButton, false);
                    return;
                }
                if (newChatBubbleStyle !== 'default' && !hasBubble) {
                    showMessageBox(`You haven't unlocked the '${newChatBubbleStyle}' chat bubble style yet!`, 'warning');
                    toggleButtonLoading(saveCustomizationButton, false);
                    return;
                }
                if (newProfileTheme !== 'default' && !hasTheme) {
                    showMessageBox(`You haven't unlocked the '${newProfileTheme}' profile theme yet!`, 'warning');
                    toggleButtonLoading(saveCustomizationButton, false);
                    return;
                }


                const privateProfileDocRef = doc(db, "artifacts", appId, "users", currentUser.uid, "profiles", "user_profile");
                await updateDoc(privateProfileDocRef, {
                    profileFrame: newProfileFrame,
                    chatBubbleStyle: newChatBubbleStyle,
                    profileTheme: newProfileTheme,
                    updatedAt: serverTimestamp()
                });

                showMessageBox("Customization saved successfully!", 'success');
                // Re-fetch current user profile data
                const updatedProfileSnap = await getDoc(privateProfileDocRef);
                if (updatedProfileSnap.exists()) {
                    currentUserProfileData = updatedProfileSnap.data();
                    displayedUserProfileData = currentUserProfileData; // Ensure consistency
                }

            } catch (error) {
                console.error("JCHAT_ERROR: Error saving customization:", error);
                showMessageBox(`Failed to save customization: ${error.message}`, 'error');
            } finally {
                toggleButtonLoading(saveCustomizationButton, false);
            }
        }
        /**
         * Handles changing user's email address.
         */
        async function handleChangeEmail(event) {
            event.preventDefault(); // Prevent form submission
            if (!currentUser || !isAuthReady) {
                showMessageBox("You must be logged in to change your email.", 'warning');
                return;
            }

            toggleButtonLoading(updateEmailButton, true);
            showMessageBox("Updating email...", 'loading', true);

            const newEmail = newEmailInput.value.trim();
            const currentPassword = currentPasswordForEmailInput.value.trim();

            if (!newEmail || !currentPassword) {
                showMessageBox("Please fill in both new email and current password.", 'error');
                toggleButtonLoading(updateEmailButton, false);
                return;
            }

            if (newEmail === currentUser.email) {
                showMessageBox("New email is the same as current email.", 'info');
                toggleButtonLoading(updateEmailButton, false);
                return;
            }

            try {
                // Reauthenticate user first
                const credential = EmailAuthProvider.credential(currentUser.email, currentPassword);
                await reauthenticateWithCredential(currentUser, credential);
                console.log("JCHAT_DEBUG: User reauthenticated successfully.");

                // Update email
                await updateEmail(currentUser, newEmail);
                console.log("JCHAT_DEBUG: Firebase Auth email updated.");

                // Update Firestore private profile
                const privateProfileDocRef = doc(db, "artifacts", appId, "users", currentUser.uid, "profiles", "user_profile");
                await updateDoc(privateProfileDocRef, {
                    email: newEmail,
                    updatedAt: serverTimestamp()
                });
                console.log("JCHAT_DEBUG: Firestore private email updated.");

                showMessageBox("Email updated successfully! Please verify your new email.", 'success');
                if (profileEmailInput) profileEmailInput.value = newEmail; // Update displayed email, null check
                if (newEmailInput) newEmailInput.value = ''; // Null check
                if (currentPasswordForEmailInput) currentPasswordForEmailInput.value = ''; // Null check

                // Refresh currentUserProfileData
                const updatedProfileSnap = await getDoc(privateProfileDocRef);
                if (updatedProfileSnap.exists()) {
                    currentUserProfileData = updatedProfileSnap.data();
                }

            } catch (error) {
                console.error("JCHAT_ERROR: Error updating email:", error);
                let errorMessage = "Failed to update email. Please check your current password.";
                if (error.code === 'auth/wrong-password') {
                    errorMessage = "Incorrect current password.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Invalid email format.";
                } else if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "This email is already in use by another account.";
                } else if (error.code === 'auth/requires-recent-login') {
                    errorMessage = "Please log out and log back in to update your email.";
                }
                showMessageBox(`${errorMessage} (${error.message})`, 'error');
            } finally {
                toggleButtonLoading(updateEmailButton, false);
            }
        }

        /**
         * Handles changing user's password.
         */
        async function handleChangePassword() {
            if (!currentUser || !isAuthReady) {
                showMessageBox("You must be logged in to change your password.", 'warning');
                return;
            }

            toggleButtonLoading(changePasswordButton, true);
            showMessageBox("Changing password...", 'loading', true);

            const oldPassword = oldPasswordInput.value.trim();
            const newPassword = newPasswordInput.value.trim();
            const confirmNewPassword = confirmNewPasswordInput.value.trim();

            if (!oldPassword || !newPassword || !confirmNewPassword) {
                showMessageBox("Please fill in all password fields.", 'error');
                toggleButtonLoading(changePasswordButton, false);
                return;
            }

            if (newPassword !== confirmNewPassword) {
                showMessageBox("New password and confirmation do not match.", 'error');
                toggleButtonLoading(changePasswordButton, false);
                return;
            }

            if (newPassword.length < 6) {
                showMessageBox("New password must be at least 6 characters long.", 'error');
                toggleButtonLoading(changePasswordButton, false);
                return;
            }

            try {
                // Reauthenticate user first
                const credential = EmailAuthProvider.credential(currentUser.email, oldPassword);
                await reauthenticateWithCredential(currentUser, credential);
                console.log("JCHAT_DEBUG: User reauthenticated successfully.");

                // Update password
                await updatePassword(currentUser, newPassword);
                console.log("JCHAT_DEBUG: Firebase Auth password updated.");

                showMessageBox("Password updated successfully!", 'success');
                if (oldPasswordInput) oldPasswordInput.value = ''; // Null check
                if (newPasswordInput) newPasswordInput.value = ''; // Null check
                if (confirmNewPasswordInput) confirmNewPasswordInput.value = ''; // Null check

            } catch (error) {
                console.error("JCHAT_ERROR: Error updating password:", error);
                let errorMessage = "Failed to update password. Please check your old password.";
                if (error.code === 'auth/wrong-password') {
                    errorMessage = "Incorrect old password.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "New password is too weak. Please choose a stronger one.";
                } else if (error.code === 'auth/requires-recent-login') {
                    errorMessage = "Please log out and log back in to update your password.";
                }
                showMessageBox(`${errorMessage} (${error.message})`, 'error');
            } finally {
                toggleButtonLoading(changePasswordButton, false);
            }
        }

        /**
         * Calculates the total cumulative Gas required to reach a specific level N.
         * Formula: Total_Gas_for_Level_N = 1500 * N * (N + 1) / 2
         * @param {number} level - The target level N.
         * @returns {number} The total cumulative Gas required to reach that level.
         */
        function getTotalGasRequiredToReachLevel(level) {
            if (level <= 0) return 0;
            return 1500 * level * (level + 1) / 2;
        }
        /**
         * Defines level names, icons, and rewards for various levels.
         * This is a client-side representation and should ideally match server-side logic.
         * @param {number} level - The current level.
         * @returns {{level: number, name: string, icon: string, jCoinReward: number, gasReward: number, otherRewards: string[]}} Level information.
         */
        function getLevelInfo(level) {
            let jCoinReward = 0;
            let gasReward = 0;
            let name = `Level ${level}`;
            let icon = "fas fa-question-circle";
            let otherRewards = []; // Array to hold other reward descriptions

            // Base JCoin and Gas rewards scale linearly
            // Starting values and increments are adjusted to provide a smoother curve up to 500
            if (level >= 1 && level <= 25) { // Tier 1: Early Explorer
                jCoinReward = 10 + (level - 1) * 5; // Start 10, +5/level
                gasReward = 5 + (level - 1) * 2;   // Start 5, +2/level
                const levelNames = [
                    "Novice", "Beginner", "Apprentice", "Explorer", "Pioneer",
                    "Communicator", "Socialite", "Networker", "Influencer", "Trendsetter",
                    "Innovator", "Creator", "Visionary", "Architect", "Maestro",
                    "Strategist", "Guardian", "Champion", "Hero", "Legend",
                    "Mythic", "Celestial", "Divine", "Transcendent", "Cosmic Being"
                ];
                const levelIcons = [
                    "fas fa-leaf", "fas fa-seedling", "fas fa-user-graduate", "fas fa-map-marker-alt", "fas fa-compass",
                    "fas fa-comments", "fas fa-users", "fas fa-share-alt", "fas fa-star", "fas fa-fire",
                    "fas fa-lightbulb", "fas fa-paint-brush", "fas fa-eye", "fas fa-building", "fas fa-music",
                    "fas fa-chess", "fas fa-shield-alt", "fas fa-trophy", "fas fa-mask", "fas fa-dragon",
                    "fas fa-meteor", "fas fa-galaxy", "fas fa-hand-sparkles", "fas fa-infinity", "fas fa-atom"
                ];
                name = levelNames[level - 1] || `Level ${level}`;
                icon = levelIcons[level - 1] || "fas fa-question-circle";

                // Specific other rewards for Tier 1
                if (level === 1) otherRewards.push("Badge: 'Newbie'");
                if (level === 3) otherRewards.push("Unlock: 1-Hour XP Boost");
                if (level === 5) otherRewards.push("Badge: 'Chat Starter'", "Unlock: Basic Profile Picture Frame");
                if (level === 8) otherRewards.push("Unlock: Common Emote Pack (Set 1)");
                if (level === 10) otherRewards.push("Title: 'Friendly Face'", "Increased Message Character Limit (+10)");
                if (level === 13) otherRewards.push("Unlock: 3-Hour XP Boost");
                if (level === 15) otherRewards.push("Badge: 'Community Contributor'", "Unlock: Basic Chat Bubble Style");
                if (level === 18) otherRewards.push("Unlock: Common Emote Pack (Set 2)");
                if (level === 20) otherRewards.push("Title: 'Early Explorer'", "Increased Message Character Limit (+15)");
                if (level === 25) otherRewards.push("Badge: 'Veteran Chatter'", "Unlock: Gradient Profile Picture Frame");

            } else if (level >= 26 && level <= 100) { // Tier 2: Active Member (Levels 26 - 100)
                jCoinReward = 120 + (level - 26) * 8; // Starts higher, increases more
                gasReward = 30 + (level - 26) * 3;
                const tierNames = ["Active Member", "Group Enthusiast", "Social Butterfly", "Community Builder"];
                const tierIcons = ["fas fa-user-check", "fas fa-users-cog", "fas fa-globe-europe", "fas fa-handshake"];
                const tierIndex = Math.floor((level - 26) / 19); // Cycle every ~19 levels for 4 names
                name = `${tierNames[tierIndex % tierNames.length]} Lv. ${level}`;
                icon = tierIcons[tierIndex % tierIcons.length];

                // Specific other rewards for Tier 2
                if (level === 30) otherRewards.push("Badge: 'Active Member'", "Unlock: Uncommon Emote Pack (Set 1)");
                if (level === 35) otherRewards.push("Increased Friend Limit (+10)");
                if (level === 40) otherRewards.push("Unlock: New Chat Bubble Style (Set 2)");
                if (level === 45) otherRewards.push("Unlock: 1-Day XP Boost");
                if (level === 50) otherRewards.push("Title: 'Centurion'", "Permanent: 1% JCoin Shop Discount", "Badge: '50-Level Achiever'");
                if (level === 55) otherRewards.push("Unlock: Uncommon Emote Pack (Set 3)");
                if (level === 60) otherRewards.push("Increased Message Character Limit (+20)");
                if (level === 65) otherRewards.push("Unlock: Basic Profile Theme (Solid Color)");
                if (level === 70) otherRewards.push("Increased Friend Limit (+15)");
                if (level === 75) otherRewards.push("Title: 'Dedicated User'", "Unlock: Rare Emote Pack (Set 1)");
                if (level === 80) otherRewards.push("Unlock: New Chat Bubble Style (Set 3)");
                if (level === 85) otherRewards.push("Unlock: 3-Day XP Boost");
                if (level === 90) otherRewards.push("Increased Group Creation Limit (+1)");
                if (level === 95) otherRewards.push("Unlock: Uncommon Profile Picture Frame");
                if (level === 100) otherRewards.push("Title: 'Master Conversationalist'", "Badge: 'Century Mark'", "Permanent: 2% JCoin Shop Discount", "Unlock: Exclusive 'Golden' Profile Picture Frame");

            } else if (level >= 101 && level <= 250) { // Tier 3: Dedicated User (Levels 101 - 250)
                jCoinReward = 750 + (level - 101) * 12;
                gasReward = 150 + (level - 101) * 5;
                const tierNames = ["Dedicated User", "JCHAT Elite", "Master Communicator", "Community Architect"];
                const tierIcons = ["fas fa-user-shield", "fas fa-gem", "fas fa-microphone-alt", "fas fa-sitemap"];
                const tierIndex = Math.floor((level - 101) / 37); // Cycle every ~37 levels for 4 names
                name = `${tierNames[tierIndex % tierNames.length]} Lv. ${level}`;
                icon = tierIcons[tierIndex % tierIcons.length];

                // Specific other rewards for Tier 3
                if (level === 110) otherRewards.push("Unlock: Animated Emote Pack (Set 1)");
                if (level === 120) otherRewards.push("Increased Media Upload Size (+5MB)");
                if (level === 125) otherRewards.push("Title: 'Rising Star'", "Unlock: Custom Chat Font (Style 1)");
                if (level === 130) otherRewards.push("Unlock: 7-Day XP Boost");
                if (level === 140) otherRewards.push("Permanent: 3% JCoin Shop Discount");
                if (level === 150) otherRewards.push("Badge: 'JCHAT Expert'", "Unlock: Premium Profile Theme (Animated 1)");
                if (level === 160) otherRewards.push("Increased Group Member Capacity (+5)");
                if (level === 170) otherRewards.push("Unlock: Animated Emote Pack (Set 2)");
                if (level === 175) otherRewards.push("Title: 'Elite Communicator'", "Unlock: Custom Chat Font (Style 2)");
                if (level === 180) otherRewards.push("Increased Message Character Limit (+25)");
                if (level === 190) otherRewards.push("Permanent: 4% JCoin Shop Discount");
                if (level === 200) otherRewards.push("Badge: 'Double Century'", "Title: 'JCHAT Champion'", "Unlock: Exclusive 'Diamond' Profile Picture Frame", "Voucher: 1-Day Free Group Promotion");
                if (level === 210) otherRewards.push("Increased Media Upload Size (+10MB)");
                if (level === 220) otherRewards.push("Unlock: Premium Profile Theme (Animated 2)");
                if (level === 230) otherRewards.push("Unlock: Rare Emote Pack (Set 2)");
                if (level === 240) otherRewards.push("Priority Support Access");
                if (level === 250) otherRewards.push("Badge: 'Quarter-Millennium'", "Title: 'The Architect'", "Early Access: Next Major Feature Beta");

            } else if (level >= 251 && level <= 400) { // Tier 4: JCHAT Legend (Levels 251 - 400)
                jCoinReward = 2500 + (level - 251) * 20;
                gasReward = 500 + (level - 251) * 10;
                const tierNames = ["JCHAT Legend", "Grandmaster", "Cosmic Converser", "Eternal Speaker"];
                const tierIcons = ["fas fa-star-half-alt", "fas fa-chess-king", "fas fa-galaxy", "fas fa-infinity"];
                const tierIndex = Math.floor((level - 251) / 37); // Cycle every ~37 levels for 4 names
                name = `${tierNames[tierIndex % tierNames.length]} Lv. ${level}`;
                icon = tierIcons[tierIndex % tierIcons.length];

                // Specific other rewards for Tier 4
                if (level === 260) otherRewards.push("Permanent: 5% JCoin Shop Discount");
                if (level === 275) otherRewards.push("Title: 'Grand Strategist'", "Unlock: Legendary Emote Pack (Set 1)");
                if (level === 290) otherRewards.push("Increased Group Creation Limit (+2)");
                if (level === 300) otherRewards.push("Badge: 'Triple Century'", "Title: 'JCHAT Grandmaster'", "Voucher: 3-Day Free Group Promotion", "Unlock: Exclusive VIP Chat Room Access");
                if (level === 310) otherRewards.push("Increased Media Upload Size (+15MB)");
                if (level === 325) otherRewards.push("Title: 'Cosmic Weaver'", "Unlock: Custom Chat Font (Style 3)");
                if (level === 340) otherRewards.push("Permanent: 7% JCoin Shop Discount");
                if (level === 350) otherRewards.push("Badge: 'JCHAT Luminary'", "Unlock: Personalized Emote Slot (1 custom upload)");
                if (level === 360) otherRewards.push("Increased Group Member Capacity (+10)");
                if (level === 375) otherRewards.push("Title: 'The Eternal Flame'", "Unlock: Legendary Emote Pack (Set 2)");
                if (level === 390) otherRewards.push("Ad-Free Experience (1 Month)");
                if (level === 400) otherRewards.push("Badge: 'Quad Century'", "Title: 'The Unrivaled'", "Permanent: 10% JCoin Shop Discount", "Unlock: Unique Profile Aura (Tier 1)");

            } else if (level >= 401 && level <= 500) { // Tier 5: The Unrivaled (Levels 401 - 500)
                jCoinReward = 5000 + (level - 401) * 30;
                gasReward = 1000 + (level - 401) * 15;
                const tierNames = ["The Unrivaled", "Cosmic Creator", "JCHAT Deity", "Apex Being"];
                const tierIcons = ["fas fa-infinity", "fas fa-solar-system", "fas fa-hand-holding-heart", "fas fa-star-and-crescent"];
                const tierIndex = Math.floor((level - 401) / 25); // Cycle every 25 levels for 4 names
                name = `${tierNames[tierIndex % tierNames.length]} Lv. ${level}`;
                icon = tierIcons[tierIndex % tierIcons.length];

                // Specific other rewards for Tier 5
                if (level === 410) otherRewards.push("Ad-Free Experience (3 Months)");
                if (level === 425) otherRewards.push("Title: 'Pinnacle Performer'", "Unlock: Unique Profile Aura (Tier 2)");
                if (level === 440) otherRewards.push("Increased Media Upload Size (+20MB)");
                if (level === 450) otherRewards.push("Badge: 'Near-God'", "Unlock: Mythic Emote Pack (Set 1)");
                if (level === 460) otherRewards.push("Permanent: 12% JCoin Shop Discount");
                if (level === 475) otherRewards.push("Title: 'Cosmic Architect'", "Voucher: 7-Day Free Group Promotion");
                if (level === 480) otherRewards.push("Ad-Free Experience (6 Months)");
                if (level === 490) otherRewards.push("Unlock: Exclusive 'Cosmic' Animated Avatar Frame");
                if (level === 500) {
                    otherRewards.push(
                        "Badge: 'JCHAT Deity'",
                        "Title: 'The Absolute'",
                        "Lifetime Premium Status (Ad-Free, All Cosmetics Unlocked)",
                        "Personalized Group Creation Perk (Custom starting benefits for new groups)",
                        "Acknowledgment on JCHAT Hall of Fame (Your name/ID listed on a special page)",
                        "Exclusive Discord Role (if applicable)",
                        "Voting Rights on Future Feature Development"
                    );
                }
            } else if (level > 500) {
                // Beyond level 500, continue scaling rewards and use a generic "Master" tier
                jCoinReward = 5000 + (500 - 401) * 30 + (level - 500) * 50;
                gasReward = 1000 + (500 - 401) * 8 + (level - 500) * 15;
                name = `Master Lv. ${level}`;
                icon = "fas fa-star";
                otherRewards.push("Continued JCoin & Gas Rewards", "Exclusive Recognition (Tier 6)");
                if (level % 100 === 0) otherRewards.push("Special Milestone Bonus");
            }

            return {
                level: level,
                name: name,
                icon: icon,
                jCoinReward: jCoinReward,
                gasReward: gasReward,
                otherRewards: otherRewards
            };
        }
        /**
         * Checks if the user has leveled up and applies rewards.
         * This function is called after any update to totalGasEarned.
         * @param {string} userId - The UID of the current user.
         * @param {number} oldLevel - The user's level before the current update.
         * @param {number} newTotalGasEarned - The user's total cumulative Gas after the update.
         */
        async function checkAndApplyLevelUps(userId, oldLevel, newTotalGasEarned) {
            let currentLevel = oldLevel;
            let updated = false;
            let levelsGainedMessages = [];

            while (true) {
                const nextLevel = currentLevel + 1;
                // If it's a new user with 0 totalGasEarned, and the initial level is 1
                // The condition totalGasEarned >= gasNeededForNextLevel should only trigger if they have enough for Level 1, then Level 2, etc.
                const gasNeededForNextLevel = getTotalGasRequiredToReachLevel(nextLevel);

                // If user has not yet earned enough XP for the next level, or has reached max defined level
                if (newTotalGasEarned < gasNeededForNextLevel) {
                    break;
                }

                // If here, user has enough XP for nextLevel
                const levelInfo = getLevelInfo(nextLevel);
                currentLevel = nextLevel;
                updated = true;

                try {
                    await runTransaction(db, async (transaction) => {
                        const userProfileDocRef = doc(db, "artifacts", appId, "users", userId, "profiles", "user_profile");
                        const userProfileSnap = await transaction.get(userProfileDocRef);

                        if (!userProfileSnap.exists()) {
                            throw new Error("User profile not found during level-up transaction.");
                        }

                        const currentProfileData = userProfileSnap.data();
                        const updatedJCoins = (currentProfileData.jCoins || 0) + levelInfo.jCoinReward;
                        const updatedGas = (currentProfileData.gas || 0) + levelInfo.gasReward;
                        const updatedUnlockedBenefits = [...(currentProfileData.unlockedBenefits || [])];

                        // Add new benefits, avoiding duplicates
                        if (levelInfo.otherRewards && levelInfo.otherRewards.length > 0) {
                            levelInfo.otherRewards.forEach(benefit => {
                                if (!updatedUnlockedBenefits.includes(benefit)) {
                                    updatedUnlockedBenefits.push(benefit);
                                }
                            });
                        }

                        transaction.update(userProfileDocRef, {
                            level: currentLevel,
                            jCoins: updatedJCoins,
                            gas: updatedGas,
                            unlockedBenefits: updatedUnlockedBenefits,
                            updatedAt: serverTimestamp()
                        });

                        // Also update public profile for level and totalGasEarned
                        const publicProfileDocRef = doc(db, "artifacts", appId, "public", "data", "users", userId);
                        transaction.update(publicProfileDocRef, {
                            level: currentLevel,
                            totalGasEarned: newTotalGasEarned, // Ensure public profile also reflects totalGasEarned
                            updatedAt: serverTimestamp()
                        });
                    });

                    levelsGainedMessages.push(` You reached Level ${currentLevel}: ${levelInfo.name}! You received ${levelInfo.jCoinReward} JCoins and ${levelInfo.gasReward} Gas.`);
                    if (levelInfo.otherRewards.length > 0) {
                        levelsGainedMessages[levelsGainedMessages.length - 1] += ` Unlocked: ${levelInfo.otherRewards.join(', ')}.`;
                    }
                    console.log(`JCHAT_DEBUG: User ${userId} leveled up to ${currentLevel}.`);

                } catch (transactionError) {
                    console.error("JCHAT_ERROR: Transaction failed during level-up:", transactionError);
                    showMessageBox(`Failed to apply level-up rewards for Level ${currentLevel}: ${transactionError.message}`, 'error');
                    break; // Stop processing further levels if a transaction fails
                }
            }

            if (updated) {
                // Show all level-up messages
                levelsGainedMessages.forEach(msg => showMessageBox(msg, 'success', false, 5000));
                // Re-fetch and display the profile to update UI with new level, JCoins, Gas
                await fetchAndDisplayUserProfile(userId);
            }
        }
        /**
         * Fetches and displays the current user's profile data for the header.
         * This function runs on every page to ensure header is consistent.
         * @param {firebase.User} user - The authenticated Firebase user object.
         */
        async function fetchAndDisplayHeaderProfile(user) {
            try {
                const privateProfileDocRef = doc(db, "artifacts", appId, "users", user.uid, "profiles", "user_profile");
                const publicProfileDocRef = doc(db, "artifacts", appId, "public", "data", "users", user.uid);
                
                const privateDocSnap = await getDoc(privateProfileDocRef);

                let profileData = null;
                if (privateDocSnap.exists()) {
                    profileData = privateDocSnap.data();
                    // Fix for createdAt if it's missing or malformed (not a Timestamp)
                    if (!profileData.createdAt || typeof profileData.createdAt.toDate !== 'function') {
                        console.warn("JCHAT_WARN: Private user_profile createdAt is missing or malformed. Attempting to fix.");
                        await updateDoc(privateProfileDocRef, { createdAt: serverTimestamp() });
                        // Re-fetch to get the correct Timestamp object
                        const updatedSnap = await getDoc(privateProfileDocRef);
                        profileData.createdAt = updatedSnap.data().createdAt;
                    }
                    // Ensure 'gas' field exists, initialize if not
                    if (profileData.gas === undefined) {
                        console.log("JCHAT_DEBUG: 'gas' field missing in profile, initializing to 0.");
                        await updateDoc(privateProfileDocRef, { gas: 0 });
                        profileData.gas = 0;
                    }
                    // Ensure 'totalGasEarned' field exists, initialize if not
                    if (profileData.totalGasEarned === undefined) {
                        console.log("JCHAT_DEBUG: 'totalGasEarned' field missing in profile, initializing to 0.");
                        await updateDoc(privateProfileDocRef, { totalGasEarned: 0 });
                        profileData.totalGasEarned = 0;
                    }
                    // Ensure 'level' field exists, initialize if not
                    if (profileData.level === undefined) {
                        console.log("JCHAT_DEBUG: 'level' field missing in profile, initializing to 1.");
                        await updateDoc(privateProfileDocRef, { level: 1 });
                        profileData.level = 1;
                    }
                    if (profileData.walletUnlocked === undefined) { // NEW: Initialize walletUnlocked
                        console.log("JCHAT_DEBUG: 'walletUnlocked' field missing in profile, initializing to false.");
                        await updateDoc(privateProfileDocRef, { walletUnlocked: false });
                        profileData.walletUnlocked = false;
                    }
                    if (profileData.unlockedBenefits === undefined) { // NEW: Initialize unlockedBenefits
                        console.log("JCHAT_DEBUG: 'unlockedBenefits' field missing in profile, initializing to [].");
                        await updateDoc(privateProfileDocRef, { unlockedBenefits: [] });
                        profileData.unlockedBenefits = [];
                    }
                    if (profileData.lastDailyBonusClaimDate === undefined) { // NEW: Initialize lastDailyBonusClaimDate
                        console.log("JCHAT_DEBUG: 'lastDailyBonusClaimDate' missing, initializing to null.");
                        await updateDoc(privateProfileDocRef, { lastDailyBonusClaimDate: null });
                        profileData.lastDailyBonusClaimDate = null;
                    }
                    // NEW: Initialize additional profile fields
                    if (profileData.school === undefined) { await updateDoc(privateProfileDocRef, { school: "" }); profileData.school = ""; }
                    if (profileData.work === undefined) { await updateDoc(privateProfileDocRef, { work: "" }); profileData.work = ""; }
                    if (profileData.interests === undefined) { await updateDoc(privateProfileDocRef, { interests: "" }); profileData.interests = ""; }
                    if (profileData.website === undefined) { await updateDoc(privateProfileDocRef, { website: "" }); profileData.website = ""; }
                    if (profileData.socialLinks === undefined) { await updateDoc(privateProfileDocRef, { socialLinks: "" }); profileData.socialLinks = ""; }
                    if (profileData.profileFrame === undefined) { await updateDoc(privateProfileDocRef, { profileFrame: "default" }); profileData.profileFrame = "default"; } // NEW
                    if (profileData.chatBubbleStyle === undefined) { await updateDoc(privateProfileDocRef, { chatBubbleStyle: "default" }); profileData.chatBubbleStyle = "default"; } // NEW
                    if (profileData.profileTheme === undefined) { await updateDoc(privateProfileDocRef, { profileTheme: "default" }); profileData.profileTheme = "default"; } // NEW


                    console.log("JCHAT_DEBUG: Fetched existing profile data for header:", profileData);
                } else {
                    // If private profile doesn't exist, create a basic one
                    profileData = {
                        username: user.displayName || `User_${user.uid.substring(0, 8)}`,
                        email: user.email || "",
                        profilePicId: user.photoURL || null,
                        bio: "",
                        location: "",
                        school: "", // NEW
                        work: "", // NEW
                        interests: "", // NEW
                        website: "", // NEW
                        socialLinks: "", // NEW
                        friendsCount: 0,
                        followersCount: 0,
                        followingCount: 0,
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp(),
                        inspirationType: "motivational",
                        visibility: {
                            displayName: true, profilePic: true, bio: false, location: false,
                            emailPublic: false, lastOnline: false, allowFriendRequests: true, allowMessages: true,
                            school: false, work: false, interests: false, website: false, socialLinks: false // NEW visibility defaults
                        },
                        totalPosts: 0,
                        jCoins: 0, // Initialize jCoins
                        gas: 0, // Initialize GAS
                        totalGasEarned: 0, // Initialize totalGasEarned
                        level: 1, // Initialize level
                        walletUnlocked: false, // NEW: Default to locked wallet
                        unlockedBenefits: [], // NEW: Initialize unlockedBenefits
                        lastDailyBonusClaimDate: null, // NEW: Initialize daily bonus claim date
                        profileFrame: "default", // NEW
                        chatBubbleStyle: "default", // NEW
                        profileTheme: "default", // NEW
                    };
                    await setDoc(privateProfileDocRef, profileData);
                    console.log("JCHAT_DEBUG: Created new profile data for header:", profileData);

                    // Also create/update public profile
                    await setDoc(publicProfileDocRef, {
                        username: profileData.username,
                        profilePicId: profileData.profilePicId,
                        bio: profileData.bio,
                        location: profileData.location,
                        school: profileData.school, // NEW
                        work: profileData.work,     // NEW
                        interests: profileData.interests, // NEW
                        website: profileData.website,   // NEW
                        socialLinks: profileData.socialLinks, // NEW
                        createdAt: profileData.createdAt,
                        updatedAt: profileData.updatedAt,
                        visibility: profileData.visibility,
                        totalPosts: profileData.totalPosts,
                        level: profileData.level, // Include level in public profile
                        totalGasEarned: profileData.totalGasEarned, // Include totalGasEarned in public profile
                        profileFrame: profileData.profileFrame, // NEW: Public profile also needs customization info
                        chatBubbleStyle: profileData.chatBubbleStyle, // NEW
                        profileTheme: profileData.profileTheme, // NEW
                    }, { merge: true });
                }

                // Store current user's profile data globally
                currentUserProfileData = profileData;

                // Update header UI
                const usernameInitial = (profileData.username || "J").charAt(0).toUpperCase();
                displayProfilePicture(headerProfilePic, headerAvatarIcon, profileData?.profilePicId, usernameInitial, "w_70,h_70,c_fill,g_face,r_max");
                headerDisplayName.textContent = profileData.username || "JCHAT User";
                if (headerNavLinkProfile) headerNavLinkProfile.href = `/profile.html?userId=${user.uid}`; // Ensure header nav link is correct, null check

                // Show Admin Icon if current user is admin
                if (adminIconLink) { // Null check
                    if (user.uid === ADMIN_UID) {
                        adminIconLink.style.display = 'block';
                    } else {
                        adminIconLink.style.display = 'none';
                    }
                }

            } catch (error) {
                console.error("JCHAT_ERROR: Error fetching or creating profile for header:", error);
                const usernameInitial = (user.displayName || "J").charAt(0).toUpperCase();
                displayProfilePicture(headerProfilePic, headerAvatarIcon, user.photoURL, usernameInitial, "w_70,h_70,c_fill,g_face,r_max");
                if (headerDisplayName) headerDisplayName.textContent = user.displayName || "JCHAT User"; // Null check
                showMessageBox(`Error loading header profile: ${error.message}`, 'error');
            }
        }
        /**
         * Fetches and displays the notification count for the current user.
         * @param {string} userId - The UID of the current user.
         */
        async function fetchNotificationCount(userId) {
            try {
                const notificationsCollectionRef = collection(db, "artifacts", appId, "users", userId, "notifications");
                const q = query(notificationsCollectionRef, where("read", "==", false));
                const querySnapshot = await getDocs(q);
                const unreadCount = querySnapshot.size;

                if (unreadCount > 0) {
                    if (notificationCountElement) { // Null check
                        notificationCountElement.textContent = unreadCount;
                        notificationCountElement.style.display = 'flex';
                    }
                } else {
                    if (notificationCountElement) { // Null check
                        notificationCountElement.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error("JCHAT_ERROR: Error fetching notification count:", error);
                if (notificationCountElement) notificationCountElement.style.display = 'none'; // Null check
            }
        }

        // --- Profile Page Specific Functions ---

        /**
         * Fetches system settings to get exchange rates for JCoins.
         */
        async function fetchSystemSettings() {
            const systemSettingsDocRef = doc(db, "artifacts", appId, "public", "data", "settings", "system_settings");
            try {
                const docSnap = await getDoc(systemSettingsDocRef);
                if (docSnap.exists()) {
                    currentSystemSettings = docSnap.data();
                    console.log("JCHAT_DEBUG: System settings fetched:", currentSystemSettings);
                } else {
                    console.warn("JCHAT_WARNING: System settings document not found. Using default values.");
                    currentSystemSettings = {
                        jcoinNairaRate: 7.5, // Default if not found
                        dailyBonusAmount: 50 // Default if not found
                    };
                }
            } catch (error) {
                console.error("JCHAT_ERROR: Error fetching system settings:", error);
                showMessageBox("Failed to load system settings.", 'error');
            }
        }


        /**
         * Shows the JCoin request modal.
         */
        function showJCoinRequestModal() {
            if (!currentUser || !currentUserProfileData || !currentUserProfileData.walletUnlocked) {
                showMessageBox("Your wallet must be unlocked by an admin to request JCoins.", 'warning');
                return;
            }
            if (jcoinRequestModal) jcoinRequestModal.classList.add('active'); // Null check
            if (nairaAmountInput) nairaAmountInput.value = ''; // Null check
            if (calculatedJCoinsSpan) calculatedJCoinsSpan.textContent = '0 JCoins'; // Null check
            if (receiptUploadInput) receiptUploadInput.value = ''; // Clear file input, null check
            if (receiptFileNameSpan) receiptFileNameSpan.textContent = 'No file chosen'; // Null check
            if (receiptPreviewImg) { // Null check
                receiptPreviewImg.style.display = 'none';
                receiptPreviewImg.src = '';
            }
        }

        /**
         * Hides the JCoin request modal.
         */
        function hideJCoinRequestModal() {
            if (jcoinRequestModal) jcoinRequestModal.classList.remove('active'); // Null check
        }
        /**
         * Calculates the JCoins based on Naira amount and bonus.
         * @param {number} nairaAmount - The Naira amount entered by the user.
         * @returns {number} The calculated JCoins.
         */
        function calculateJCoins(nairaAmount) {
            const jcoinNairaRate = currentSystemSettings.jcoinNairaRate || 7.5; // Use fetched rate or default
            let baseJCoins = Math.floor(nairaAmount / jcoinNairaRate);
            let bonusJCoins = 0;
            if (nairaAmount >= JCOIN_BONUS_THRESHOLD_NAIRA) {
                bonusJCoins = Math.floor(baseJCoins * JCOIN_BONUS_PERCENTAGE);
            }
            return baseJCoins + bonusJCoins;
        }

        /**
         * Submits the JCoin purchase request to Firestore.
         */
        async function submitJCoinRequest() {
            if (!currentUser || !currentUserProfileData) {
                showMessageBox("You must be logged in to submit a request.", 'error');
                return;
            }
            if (!currentUserProfileData.walletUnlocked) {
                showMessageBox("Your wallet must be unlocked by an admin to request JCoins.", 'warning');
                return;
            }

            const nairaAmount = parseInt(nairaAmountInput.value);
            const receiptFile = receiptUploadInput.files[0];

            if (isNaN(nairaAmount) || nairaAmount <= 0) {
                showMessageBox("Please enter a valid Naira amount.", 'error');
                return;
            }
            if (nairaAmount < 100) { // Minimum request amount
                showMessageBox("Minimum request amount is #100.", 'warning');
                return;
            }
            if (!receiptFile) {
                showMessageBox("Please upload a payment receipt.", 'error');
                return;
            }

            toggleButtonLoading(submitJCoinRequestButton, true);
            showMessageBox("Submitting JCoin request...", 'loading', true);

            try {
                const requestedJCoins = calculateJCoins(nairaAmount);
                const uploadedReceiptUrl = await uploadMediaToCloudinary(receiptFile); // Corrected function call

                if (!uploadedReceiptUrl) {
                    throw new Error("Failed to upload receipt image.");
                }

                const jcoinBuyRequestsCollectionRef = collection(db, "artifacts", appId, "public", "data", "jcoin_buy_requests");

                await addDoc(jcoinBuyRequestsCollectionRef, {
                    userId: currentUser.uid,
                    username: currentUserProfileData.username || `User_${currentUser.uid.substring(0, 8)}`,
                    profilePicId: currentUserProfileData.profilePicId || null,
                    requestedNairaPrice: nairaAmount,
                    requestedJCoins: requestedJCoins,
                    receiptImageUrl: uploadedReceiptUrl,
                    status: 'pending', // Always pending for admin review
                    timestamp: serverTimestamp()
                });

                showMessageBox("JCoin request submitted successfully! An admin will review it shortly.", 'success');
                hideJCoinRequestModal(); // Close modal on success
            } catch (error) {
                console.error("JCHAT_ERROR: Error submitting JCoin request:", error);
                showMessageBox(`Failed to submit request: ${error.message}`, 'error');
            } finally {
                toggleButtonLoading(submitJCoinRequestButton, false);
            }
        }

        // --- NEW: Pending Activity Reward Creation Function ---
        /**
         * Creates a pending activity reward document for admin review.
         * This system allows for manual approval of XP/JCoin rewards, preventing abuse.
         * @param {string} userId - The ID of the user who performed the activity.
         * @param {string} username - The username of the user.
         * @param {string} activityType - The type of activity (e.g., 'daily_login', 'profile_complete').
         * @param {number} suggestedXpReward - The suggested XP amount to award (can be negative for deductions).
         * @param {number} suggestedJCoinReward - The suggested JCoin amount to award (can be negative for deductions).
         * @param {string} [activityId=null] - Optional: ID of the specific activity.
         */
        async function createPendingActivityReward(
            userId,
            username,
            activityType,
            suggestedXpReward,
            suggestedJCoinReward,
            activityId = null
        ) {
            try {
                const pendingRewardsCollectionRef = collection(db, "artifacts", appId, "public", "data", "pending_activity_rewards");

                const newRewardDocRef = await addDoc(pendingRewardsCollectionRef, {
                    userId: userId,
                    username: username,
                    activityType: activityType,
                    suggestedXpReward: suggestedXpReward,
                    suggestedJCoinReward: suggestedJCoinReward,
                    status: 'pending', // Always pending for admin review
                    timestamp: serverTimestamp(),
                    activityId: activityId
                });

                console.log(`JCHAT_DEBUG: Pending activity reward created with ID: ${newRewardDocRef.id}`);
            } catch (error) {
                console.error("JCHAT_ERROR: Error creating pending activity reward:", error);
            }
        }
        /**
         * Handles claiming the daily JCoin bonus.
         * Now creates a pending reward for admin approval instead of directly awarding.
         */
        async function claimDailyBonus() {
            if (!currentUser || !currentUserProfileData) {
                showMessageBox("You must be logged in to claim the daily bonus.", 'warning');
                return;
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize to start of day

            const lastClaimDate = currentUserProfileData.lastDailyBonusClaimDate ?
                new Date(currentUserProfileData.lastDailyBonusClaimDate.toDate()) : null;

            if (lastClaimDate && lastClaimDate.toDateString() === today.toDateString()) {
                showMessageBox("You have already claimed your daily bonus today! Come back tomorrow.", 'info');
                return;
            }
            const dailyBonusAmount = currentSystemSettings.dailyBonusAmount || 50; // Use fetched amount or default

            // In a real application, consider adding a custom confirmation modal here instead of alert/confirm.
            // For now, assume a simple confirmation or proceed directly.
            const confirmed = true; // Replace with actual custom confirm if implemented

            // If a custom confirm dialog is available and used:
            // const confirmed = await showCustomConfirm(`Claim your daily bonus of ${dailyBonusAmount} JCoins?`);
            // if (!confirmed) {
            //     return;
            // }

            toggleButtonLoading(claimDailyBonusButton, true);
            showMessageBox("Claiming daily bonus...", 'loading', true);

            try {
                const userProfileDocRef = doc(db, "artifacts", appId, "users", currentUser.uid, "profiles", "user_profile");

                await runTransaction(db, async (transaction) => {
                    const userProfileSnap = await transaction.get(userProfileDocRef);
                    if (!userProfileSnap.exists()) {
                        throw new Error("User profile not found for daily bonus.");
                    }
                    const currentProfileData = userProfileSnap.data();

                    const currentLastClaimDate = currentProfileData.lastDailyBonusClaimDate ?
                        new Date(currentProfileData.lastDailyBonusClaimDate.toDate()) : null;

                    // Double-check race condition: ensure it hasn't been claimed since this function started
                    if (currentLastClaimDate && currentLastClaimDate.toDateString() === today.toDateString()) {
                        throw new Error("Daily bonus already claimed.");
                    }

                    // Update only the lastDailyBonusClaimDate to prevent multiple claims
                    transaction.update(userProfileDocRef, {
                        lastDailyBonusClaimDate: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    });
                });

                // Create a pending reward for admin review instead of directly awarding
                await createPendingActivityReward(
                    currentUser.uid,
                    currentUserProfileData.username,
                    'daily_login',
                    10, // Suggested XP reward for daily login
                    dailyBonusAmount  // Suggested JCoin reward for daily login
                );

                showMessageBox(`Daily bonus claim submitted! ${dailyBonusAmount} JCoins and 10 XP are pending admin approval.`, 'success');
                playNotificationSound('success');
                
                // Update local data for UI (without actually adding the coins yet)
                currentUserProfileData.lastDailyBonusClaimDate = Timestamp.fromDate(new Date());
                updateDailyBonusUI(); // Update button and countdown
            } catch (error) {
                console.error("JCHAT_ERROR: Error claiming daily bonus:", error);
                showMessageBox(`Failed to claim bonus: ${error.message}`, 'error');
                playNotificationSound('error');
            } finally {
                toggleButtonLoading(claimDailyBonusButton, false);
            }
        }

        /**
         * Updates the daily bonus claim button and countdown timer.
         */
        function updateDailyBonusUI() {
            if (!currentUserProfileData || displayedUserId !== currentUser.uid) {
                if (claimDailyBonusButton) claimDailyBonusButton.style.display = 'none';
                if (dailyBonusCountdown) dailyBonusCountdown.style.display = 'none';
                return;
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const lastClaimDate = currentUserProfileData.lastDailyBonusClaimDate ?
                new Date(currentUserProfileData.lastDailyBonusClaimDate.toDate()) : null;

            if (lastClaimDate && lastClaimDate.toDateString() === today.toDateString()) {
                // Already claimed today
                if (claimDailyBonusButton) claimDailyBonusButton.style.display = 'none';
                if (dailyBonusCountdown) dailyBonusCountdown.style.display = 'block';

                // Calculate time until next midnight
                const nextMidnight = new Date(today);
                nextMidnight.setDate(today.getDate() + 1);
                const timeLeft = nextMidnight.getTime() - new Date().getTime();

                if (dailyBonusInterval) clearInterval(dailyBonusInterval);
                dailyBonusInterval = setInterval(() => {
                    const remainingTime = nextMidnight.getTime() - new Date().getTime();
                    if (remainingTime <= 0) {
                        clearInterval(dailyBonusInterval);
                        if (dailyBonusCountdown) dailyBonusCountdown.style.display = 'none';
                        if (claimDailyBonusButton) {
                            claimDailyBonusButton.style.display = 'inline-flex';
                            toggleButtonLoading(claimDailyBonusButton, false);
                        }
                        if (dailyBonusCountdown) dailyBonusCountdown.textContent = '';
                        return;
                    }
                    const hours = Math.floor((remainingTime % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((remainingTime % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((remainingTime % (1000 * 60)) / 1000);

                    if (dailyBonusCountdown) dailyBonusCountdown.textContent = `Next bonus in: ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }, 1000);

            } else {
                // Can claim today
                if (claimDailyBonusButton) {
                    claimDailyBonusButton.style.display = 'inline-flex';
                    toggleButtonLoading(claimDailyBonusButton, false);
                }
                if (dailyBonusCountdown) dailyBonusCountdown.style.display = 'none';
                if (dailyBonusInterval) clearInterval(dailyBonusInterval);
            }
        }


        /**
         * Shows the report user modal for the displayed user.
         */
        function showReportUserModal() {
            if (!currentUser || displayedUserId === currentUser.uid) {
                showMessageBox("You cannot report yourself.", 'warning');
                return;
            }
            if (!displayedUserProfileData) {
                showMessageBox("Could not load user data to report.", 'error');
                return;
            }
            if (reportUserModal) reportUserModal.classList.add('active');
            if (reportedUsernameDisplay) reportedUsernameDisplay.textContent = displayedUserProfileData.username || 'Unknown User';
            if (reportReasonSelect) reportReasonSelect.value = ''; // Reset select
            if (reportDetailsTextarea) reportDetailsTextarea.value = ''; // Reset textarea
        }

        /**
         * Hides the report user modal.
         */
        function hideReportUserModal() {
            if (reportUserModal) reportUserModal.classList.remove('active');
        }
        /**
         * Submits a user report to Firestore.
         */
        async function submitReport() {
            if (!currentUser || !displayedUserProfileData) {
                showMessageBox("Cannot submit report without user data.", 'error');
                return;
            }
            if (displayedUserId === currentUser.uid) {
                showMessageBox("You cannot report yourself.", 'warning');
                return;
            }

            const reason = reportReasonSelect.value;
            const details = reportDetailsTextarea.value.trim();

            if (!reason) {
                showMessageBox("Please select a reason for the report.", 'error');
                return;
            }

            toggleButtonLoading(submitReportButton, true);
            showMessageBox("Submitting report...", 'loading', true);

            try {
                const reportsCollectionRef = collection(db, "artifacts", appId, "public", "data", "reports");
                await addDoc(reportsCollectionRef, {
                    reporterId: currentUser.uid,
                    reporterUsername: currentUserProfileData?.username || `User_${currentUser.uid.substring(0, 8)}`,
                    reportedId: displayedUserId,
                    reportedUsername: displayedUserProfileData.username || `User_${displayedUserId.substring(0, 8)}`,
                    contentType: "user", // Reporting the user themselves
                    contentId: displayedUserId, // The ID of the reported user
                    reason: reason,
                    details: details,
                    status: "pending", // Pending admin review
                    timestamp: serverTimestamp()
                });

                showMessageBox("Report submitted successfully! Thank you for helping us maintain a safe community.", 'success');
                hideReportUserModal();
            } catch (error) {
                console.error("JCHAT_ERROR: Error submitting report:", error);
                showMessageBox(`Failed to submit report: ${error.message}`, 'error');
            } finally {
                toggleButtonLoading(submitReportButton, false);
            }
        }


        /**
         * Fetches and displays unlocked rewards/benefits for the current user.
         */
        async function fetchAndDisplayUnlockedRewards() {
            if (!unlockedRewardsSection || !unlockedRewardsGrid || !noRewardsMessage) return;

            if (displayedUserId !== currentUser.uid) { // Only show for the owner of the profile
                unlockedRewardsSection.style.display = 'none';
                return;
            }
            unlockedRewardsSection.style.display = 'block';

            if (!currentUserProfileData || !currentUserProfileData.unlockedBenefits) {
                unlockedRewardsGrid.innerHTML = '';
                noRewardsMessage.style.display = 'block';
                return;
            }

            const unlockedBenefits = currentUserProfileData.unlockedBenefits;
            unlockedRewardsGrid.innerHTML = ''; // Clear previous
            if (unlockedBenefits.length === 0) {
                noRewardsMessage.style.display = 'block';
            } else {
                noRewardsMessage.style.display = 'none';
                unlockedBenefits.forEach(benefit => {
                    const rewardItem = document.createElement('div');
                    rewardItem.classList.add('reward-item');

                    let iconClass = 'fas fa-gem'; // Default icon
                    let name = benefit;

                    // Attempt to parse icon and name from benefit string
                    if (benefit.startsWith("Badge:")) {
                        iconClass = 'fas fa-certificate';
                        name = benefit.replace('Badge: \'', '').replace('\'', '');
                    } else if (benefit.startsWith("Unlock:")) {
                        if (benefit.includes("XP Boost")) iconClass = 'fas fa-rocket';
                        else if (benefit.includes("Profile Picture Frame")) iconClass = 'fas fa-image'; // Using a more general image icon
                        else if (benefit.includes("Emote Pack")) iconClass = 'fas fa-smile';
                        else if (benefit.includes("Chat Bubble Style")) iconClass = 'fas fa-comment-alt';
                        else if (benefit.includes("Profile Theme")) iconClass = 'fas fa-palette';
                        else if (benefit.includes("Custom Chat Font")) iconClass = 'fas fa-font';
                        else if (benefit.includes("Personalized Emote Slot")) iconClass = 'fas fa-paint-brush'; // Or fas fa-upload
                        else if (benefit.includes("Profile Aura")) iconClass = 'fas fa-crown';
                        else if (benefit.includes("Exclusive VIP Chat Room Access")) iconClass = 'fas fa-lock-open';
                        else if (benefit.includes("Lifetime Premium Status")) iconClass = 'fas fa-star';
                        else if (benefit.includes("Early Access")) iconClass = 'fas fa-flask';
                        else if (benefit.includes("Priority Support")) iconClass = 'fas fa-headset';
                        else if (benefit.includes("Ad-Free Experience")) iconClass = 'fas fa-ad'; // New Ad-Free icon

                        name = benefit.replace('Unlock: ', '');
                        if (name.includes('(') && name.includes(')')) { // Remove parenthesized info for cleaner display
                            name = name.substring(0, name.indexOf('(')).trim();
                        }
                    } else if (benefit.startsWith("Title:")) {
                        iconClass = 'fas fa-award';
                        name = benefit.replace('Title: \'', '').replace('\'', '');
                    } else if (benefit.includes("Discount")) {
                        iconClass = 'fas fa-tags';
                    } else if (benefit.includes("Voucher")) {
                        iconClass = 'fas fa-ticket-alt'; // Icon for vouchers
                    }


                    rewardItem.innerHTML = `
                        <i class="${iconClass} reward-icon"></i>
                        <span>${name}</span>
                    `;
                    unlockedRewardsGrid.appendChild(rewardItem);
                });
            }
        }

        /**
         * Fetches and displays a snippet of friends/followers.
         * For simplicity, this will show a few *random* public profiles from the 'users' collection
         * if the user has a decent number of "friends" or "followers" count (mock data).
         * In a real app, you would query the actual friends list.
         */
        async function fetchAndDisplayFriendsSnippet() {
            if (!friendsSnippetSection || !friendsSnippetGrid || !noFriendsMessage) return;

            // Only show if it's the owner's profile and they have friends, or if another user has public friend count
            if (displayedUserId !== currentUser.uid && !(displayedUserProfileData.friendsCount > 0)) {
                 friendsSnippetSection.style.display = 'none';
                 return;
            }
            friendsSnippetSection.style.display = 'block';

            friendsSnippetGrid.innerHTML = '';
            noFriendsMessage.style.display = 'block'; // Assume no friends initially

            try {
                // Simulate fetching a few friends/followers
                // In a real app, you'd have a 'friends' subcollection for each user.
                // For example: collection(db, "artifacts", appId, "users", displayedUserId, "friends")
                const publicUsersRef = collection(db, "artifacts", appId, "public", "data", "users");
                const q = query(publicUsersRef, where(documentId(), '!=', displayedUserId)); // Exclude current user
                const querySnapshot = await getDocs(q);

                let availableUsers = [];
                querySnapshot.forEach(docSnap => {
                    const userData = docSnap.data();
                    // Include users with public profiles and at least a username
                    if (userData.visibility?.profilePic && userData.username && userData.profilePicId) {
                        availableUsers.push({ id: docSnap.id, ...userData });
                    }
                });

                if (availableUsers.length > 0) {
                    noFriendsMessage.style.display = 'none';
                    // Shuffle and pick a few random ones (max 5)
                    const shuffled = availableUsers.sort(() => 0.5 - Math.random());
                    const friendsToShow = shuffled.slice(0, 5);

                    friendsToShow.forEach(friend => {
                        const friendItem = document.createElement('a'); // Make it a link to their profile
                        friendItem.href = `/profile.html?userId=${friend.id}`;
                        friendItem.classList.add('friend-item');
                        friendItem.innerHTML = `
                            <div class="friend-pic-wrapper">
                                <img src="${getCloudinaryImageUrl(friend.profilePicId, 'w_120,h_120,c_fill,g_face,r_max')}" alt="${friend.username} Pic" onerror="this.onerror=null; this.src='https://placehold.co/60x60/CCCCCC/000000?text=${friend.username.charAt(0).toUpperCase()}';">
                            </div>
                            <span class="friend-name">${friend.username}</span>
                        `;
                        friendsSnippetGrid.appendChild(friendItem);
                    });
                } else {
                    noFriendsMessage.textContent = "No friends to display or no public profiles.";
                }

            } catch (error) {
                console.error("JCHAT_ERROR: Error fetching friends snippet:", error);
                noFriendsMessage.textContent = "Failed to load friends.";
            }
        }
        /**
         * Fetches and displays recent activity logs for the current user.
         * For non-owners, it would only show public activity if logged.
         */
        async function fetchAndDisplayRecentActivity() {
            if (!recentActivitySection || !recentActivityList || !noActivityMessage) return;

            if (displayedUserId !== currentUser.uid) { // Only show for the owner of the profile
                recentActivitySection.style.display = 'none';
                return;
            }
            recentActivitySection.style.display = 'block';

            recentActivityList.innerHTML = ''; // Clear previous
            noActivityMessage.style.display = 'block'; // Assume no activity initially

            try {
                const activityLogsRef = collection(db, "artifacts", appId, "users", currentUser.uid, "activity_logs");
                // Fetch latest 5 activities
                const q = query(activityLogsRef, orderBy("timestamp", "desc")); // Order by timestamp
                const querySnapshot = await getDocs(q); // Use getDocs for one-time fetch

                if (querySnapshot.empty) {
                    noActivityMessage.style.display = 'block';
                } else {
                    noActivityMessage.style.display = 'none';
                    let activities = [];
                    querySnapshot.forEach(docSnap => {
                        activities.push(docSnap.data());
                    });
                    
                    // Limit to latest 5 activities
                    activities = activities.slice(0, 5);

                    activities.forEach(activity => {
                        const activityItem = document.createElement('li');
                        activityItem.classList.add('activity-item');

                        let icon = 'fas fa-info-circle';
                        let text = 'Performed an action.';

                        if (activity.type === 'post_created') {
                            icon = 'fas fa-pencil-alt';
                            text = `Posted a new message: "${activity.contentSnippet || 'No content snippet'}"`;
                        } else if (activity.type === 'level_up') {
                            icon = 'fas fa-star';
                            text = `Reached Level ${activity.newLevel || '?'}: ${activity.levelName || 'New Level'}!`;
                        } else if (activity.type === 'jcoins_earned') {
                            icon = 'fas fa-coins';
                            text = `Earned ${activity.amount} JCoins for ${activity.reason || 'activity'}.`;
                        } else if (activity.type === 'daily_bonus_claimed') {
                            icon = 'fas fa-gift';
                            text = `Claimed daily bonus of ${activity.jCoinsEarned} JCoins.`;
                        } else if (activity.type === 'profile_updated') {
                            icon = 'fas fa-user-edit';
                            text = `Updated profile information.`;
                        } else if (activity.type === 'friend_added') {
                            icon = 'fas fa-user-plus';
                            text = `Became friends with ${activity.friendUsername || 'someone'}.`;
                        } else if (activity.type === 'chat_message_sent') {
                            icon = 'fas fa-comment-dots';
                            text = `Sent a chat message.`;
                        }

                        const timestamp = activity.timestamp ? new Date(activity.timestamp.toDate()).toLocaleString() : 'N/A';

                        activityItem.innerHTML = `
                            <i class="${icon}"></i>
                            <span>${text}</span>
                            <span class="activity-timestamp">${timestamp}</span>
                        `;
                        recentActivityList.appendChild(activityItem);
                    });
                }
            } catch (error) {
                console.error("JCHAT_ERROR: Error fetching recent activity:", error);
                noActivityMessage.textContent = "Failed to load recent activity.";
            }
        }
        /**
         * Fetches and displays a user's profile data.
         * Determines if it's the current user's profile or another user's.
         * @param {string} userIdToDisplay - The UID of the user whose profile should be displayed.
         */
        async function fetchAndDisplayUserProfile(userIdToDisplay) {
            // Clear previous state and show loader
            showMessageBox("Loading profile...", 'loading', true);
            if (profileUsername) profileUsername.textContent = "Loading...";
            if (profileBio) profileBio.textContent = "Loading...";
            if (profileLocation) profileLocation.style.display = 'none';
            if (profileEmail) profileEmail.style.display = 'none';
            if (profileSchool) profileSchool.style.display = 'none'; // NEW
            if (profileWork) profileWork.style.display = 'none';   // NEW
            if (profileWebsite) profileWebsite.style.display = 'none'; // NEW
            if (profileSocialLinks) profileSocialLinks.style.display = 'none'; // NEW

            if (statPosts) statPosts.textContent = "0";
            if (statFriends) statFriends.textContent = "0";
            if (statFollowers) statFollowers.textContent = "0";
            if (statFollowing) statFollowing.textContent = "0";
            if (jCoinsSpan) jCoinsSpan.textContent = "0"; // Reset jCoins
            if (jcoinExchangeRate) jcoinExchangeRate.style.display = 'none'; // Hide exchange rate by default
            if (gasValue) gasValue.textContent = "0"; // Reset Gas (XP)
            if (xpLevelIcon) xpLevelIcon.className = "fas fa-question-circle profile-level-icon"; // Reset icon
            if (xpLevelName) xpLevelName.textContent = "Loading Level..."; // Reset level name
                    if (xpProgressBarFill) xpProgressBarFill.style.width = "0%"; // Reset progress bar
        if (xpProgressBarFill) xpProgressBarFill.style.backgroundPosition = "right"; // Reset gradient position
        
        // Reset percentage display
        const progressPercentageElement = document.getElementById('progressPercentage');
        if (progressPercentageElement) {
            progressPercentageElement.textContent = "0%";
            progressPercentageElement.style.color = '#fff';
            progressPercentageElement.style.textShadow = '0 0 3px rgba(0, 0, 0, 0.8)';
        }
            if (profilePagePic) profilePagePic.style.display = 'none';
            if (profilePageAvatarIcon) profilePageAvatarIcon.style.display = 'block';
            
            // Hide all action buttons initially
            if (walletLink) walletLink.style.display = 'none'; // Hide wallet link
            if (walletLockedMessage) walletLockedMessage.style.display = 'none'; // Hide wallet locked message
            if (requestJCoinsButton) requestJCoinsButton.style.display = 'none'; // Hide request JCoins button
            if (claimDailyBonusButton) claimDailyBonusButton.style.display = 'none'; // NEW: Hide claim daily bonus button
            if (dailyBonusCountdown) dailyBonusCountdown.style.display = 'none'; // NEW: Hide daily bonus countdown
            if (reportUserButton) reportUserButton.style.display = 'none'; // NEW: Hide report user button
            // Hide inline edit fields and account settings by default
            const profileDetailsSection = displayNameInput ? displayNameInput.closest('.profile-details-section') : null; // Null check for displayNameInput
            if (profileDetailsSection) {
                profileDetailsSection.style.display = 'none';
            }
            if (accountSettingsSection) accountSettingsSection.style.display = 'none'; // NEW: Hide account settings by default
            if (toggleAccountSettingsButton) toggleAccountSettingsButton.style.display = 'none'; // NEW: Hide toggle button by default

            // NEW: Hide new sections by default
            if (unlockedRewardsSection) unlockedRewardsSection.style.display = 'none';
            if (friendsSnippetSection) friendsSnippetSection.style.display = 'none';
            if (recentActivitySection) recentActivitySection.style.display = 'none';
            if (profileFrameSelect) profileFrameSelect.closest('.customization-option').style.display = 'none'; // Hide parent div
            if (chatBubbleStyleSelect) chatBubbleStyleSelect.closest('.customization-option').style.display = 'none';
            if (profileThemeSelect) profileThemeSelect.closest('.customization-option').style.display = 'none';
            if (saveCustomizationButton) saveCustomizationButton.style.display = 'none';
            if (savePrivacySettingsButton) savePrivacySettingsButton.style.display = 'none';
            if (toggleEmailVisibility) toggleEmailVisibility.closest('.privacy-toggle-group').style.display = 'none'; // Hide parent div
            if (toggleLocationVisibility) toggleLocationVisibility.closest('.privacy-toggle-group').style.display = 'none';
            if (toggleOnlineStatusVisibility) toggleOnlineStatusVisibility.closest('.privacy-toggle-group').style.display = 'none';
            if (toggleFriendRequests) toggleFriendRequests.closest('.privacy-toggle-group').style.display = 'none';
            if (toggleMessages) toggleMessages.closest('.privacy-toggle-group').style.display = 'none';
            if (toggleSchoolVisibility) toggleSchoolVisibility.closest('.privacy-toggle-group').style.display = 'none';
            if (toggleWorkVisibility) toggleWorkVisibility.closest('.privacy-toggle-group').style.display = 'none';
            if (toggleInterestsVisibility) toggleInterestsVisibility.closest('.privacy-toggle-group').style.display = 'none';
            if (toggleWebsiteVisibility) toggleWebsiteVisibility.closest('.privacy-toggle-group').style.display = 'none';
            if (toggleSocialLinksVisibility) toggleSocialLinksVisibility.closest('.privacy-toggle-group').style.display = 'none';


            let profileDocRef;
            let isCurrentUserProfile = false;

            if (currentUser && userIdToDisplay === currentUser.uid) {
                // Displaying current user's profile (private data)
                profileDocRef = doc(db, "artifacts", appId, "users", userIdToDisplay, "profiles", "user_profile");
                isCurrentUserProfile = true;
                if (profilePicWrapper) profilePicWrapper.classList.add('owner'); // Null check
            } else {
                // Displaying another user's profile (public data)
                profileDocRef = doc(db, "artifacts", appId, "public", "data", "users", userIdToDisplay);
                isCurrentUserProfile = false;
                if (profilePicWrapper) profilePicWrapper.classList.remove('owner'); // Null check
            }

            try {
                const docSnap = await getDoc(profileDocRef);

                if (docSnap.exists()) {
                    // Store the fetched profile data globally for the currently displayed user
                    // If it's the current user's profile, store it in currentUserProfileData
                    if (isCurrentUserProfile) {
                        currentUserProfileData = docSnap.data();
                        displayedUserProfileData = currentUserProfileData; // Both point to the same for owner
                    } else {
                        displayedUserProfileData = docSnap.data();
                    }
                    
                    // IMPORTANT: Ensure userId is always part of displayedUserProfileData
                    displayedUserProfileData.userId = userIdToDisplay;

                    console.log(`JCHAT_DEBUG: Fetched profile data for ${userIdToDisplay}:`, displayedUserProfileData);

                    // Apply visibility settings if it's another user's profile
                    const visibility = displayedUserProfileData.visibility || {};

                    // Cover image display (respect visibility if added later)
                    if (profileCoverImg && displayedUserProfileData.coverPicId) {
                        profileCoverImg.src = getCloudinaryImageUrl(displayedUserProfileData.coverPicId, 'w_1600,h_400,c_fill,q_auto');
                        profileCoverImg.style.display = 'block';
                    }
                    if (editCoverOverlay) {
                        editCoverOverlay.style.display = (currentUser && isCurrentUserProfile) ? 'block' : 'none';
                    }

                    if (profileUsername) profileUsername.textContent = displayedUserProfileData.username || "JCHAT User"; // Null check
                    const usernameInitial = (displayedUserProfileData.username || "J").charAt(0).toUpperCase();

                    // Profile Picture
                    if (profilePagePic && profilePageAvatarIcon) { // Null check
                        if (displayedUserProfileData.profilePicId && (isCurrentUserProfile || visibility.profilePic)) {
                            displayProfilePicture(profilePagePic, profilePageAvatarIcon, displayedUserProfileData.profilePicId, usernameInitial, "w_240,h_240,c_fill,g_face,r_max");
                        } else {
                            profilePagePic.style.display = 'none';
                            profilePageAvatarIcon.style.display = 'block';
                        }
                    }


                    // Bio
                    if (profileBio) { // Null check
                        if (displayedUserProfileData.bio && (isCurrentUserProfile || visibility.bio)) {
                            profileBio.textContent = displayedUserProfileData.bio;
                        } else {
                            profileBio.textContent = isCurrentUserProfile ? "No bio provided yet." : "Bio not publicly available.";
                        }
                    }

                    // Location
                    if (profileLocation && locationText) { // Null check
                        if (displayedUserProfileData.location && (isCurrentUserProfile || visibility.location)) {
                            locationText.textContent = displayedUserProfileData.location;
                            profileLocation.style.display = 'block';
                        } else {
                            profileLocation.style.display = 'none';
                        }
                    }

                    // Email (only for owner or if public)
                    if (profileEmail && emailText) { // Null check
                        if (displayedUserProfileData.email && (isCurrentUserProfile || visibility.emailPublic)) {
                            emailText.textContent = displayedUserProfileData.email;
                            profileEmail.style.display = 'block';
                        } else {
                            profileEmail.style.display = 'none';
                        }
                    }

                    // NEW: Display additional user info based on visibility
                    if (profileSchool && schoolText) {
                        if (displayedUserProfileData.school && (isCurrentUserProfile || visibility.school)) {
                            schoolText.textContent = displayedUserProfileData.school;
                            profileSchool.style.display = 'block';
                        } else {
                            profileSchool.style.display = 'none';
                        }
                    }
                    if (profileWork && workText) {
                        if (displayedUserProfileData.work && (isCurrentUserProfile || visibility.work)) {
                            workText.textContent = displayedUserProfileData.work;
                            profileWork.style.display = 'block';
                        } else {
                            profileWork.style.display = 'none';
                        }
                    }
                    if (profileWebsite && websiteLink) {
                        if (displayedUserProfileData.website && (isCurrentUserProfile || visibility.website)) {
                            websiteLink.href = displayedUserProfileData.website;
                            websiteLink.textContent = displayedUserProfileData.website.replace(/^(https?:\/\/)?(www\.)?/, ''); // Display cleaner URL
                            profileWebsite.style.display = 'block';
                        } else {
                            profileWebsite.style.display = 'none';
                        }
                    }
                    if (profileSocialLinks && socialLinksText) {
                        if (displayedUserProfileData.socialLinks && (isCurrentUserProfile || visibility.socialLinks)) {
                            socialLinksText.textContent = displayedUserProfileData.socialLinks;
                            profileSocialLinks.style.display = 'block';
                        } else {
                            profileSocialLinks.style.display = 'none';
                        }
                    }


                    // Stats (always show for owner, for others based on public profile data)
                    if (statPosts) statPosts.textContent = displayedUserProfileData.totalPosts ?? 0; // Null check
                    if (statFriends) statFriends.textContent = displayedUserProfileData.friendsCount ?? 0; // Null check
                    if (statFollowers) statFollowers.textContent = displayedUserProfileData.followersCount ?? 0; // Null check
                    if (statFollowing) statFollowing.textContent = displayedUserProfileData.followingCount ?? 0; // Null check
                    
                    // JCoins (only visible to owner)
                    const fallbackUserCurrency = (typeof userCurrency === 'object' && userCurrency) ? userCurrency : { code: 'USD', symbol: '$', label: 'USD' };
                    if (jCoinsSpan && jcoinExchangeRate && jcoinUSDValue) { // Null check
                        if (isCurrentUserProfile) {
                            jCoinsSpan.textContent = (displayedUserProfileData.jCoins ?? 0).toLocaleString();
                            if (typeof setUserCurrencyFromProfile === 'function') {
                                setUserCurrencyFromProfile(displayedUserProfileData);
                            }
                            const j = (displayedUserProfileData.jCoins ?? 0);
                            let fiatValue = 0;
                            const uc = (typeof userCurrency === 'object' && userCurrency) ? userCurrency : { code: 'USD', symbol: '$', label: 'USD' };
                            if (uc.code === 'NGN') {
                                const rate = currentSystemSettings.jcoinNairaRate || 7.5;
                                fiatValue = j * rate; // JCoins to NGN using configured rate
                            } else {
                                const nairaRate = currentSystemSettings.jcoinNairaRate || 7.5;
                                const usdPerNaira = 0.001; // existing assumption in app
                                fiatValue = j * nairaRate * usdPerNaira; // approximate USD
                            }
                            const fmt = (typeof formatLocalCurrency === 'function') ? formatLocalCurrency : (amt => `$${Number(amt).toFixed(2)}`);
                            jcoinUSDValue.textContent = fmt(fiatValue);
                            jcoinExchangeRate.style.display = 'flex'; // Use flex to align icon and text
                            if (jCoinsSpan.closest('.stat-item')) jCoinsSpan.closest('.stat-item').style.display = 'block'; // Ensure the entire stat item is visible
                        } else {
                            // Hide JCoins and exchange rate for other users
                            if (jCoinsSpan.closest('.stat-item')) jCoinsSpan.closest('.stat-item').style.display = 'none';
                        }
                    }
                    
                    // NEW: Display Gas (XP) and Level Progress
                    const currentGasBalance = displayedUserProfileData.gas ?? 0; // Current spendable Gas
                    const totalGasEarned = displayedUserProfileData.totalGasEarned ?? 0; // Cumulative Gas for leveling

                    // Determine current level based on totalGasEarned
                    let currentLevel = 1; // Start from Level 1
                    for (let i = 1; i <= 500; i++) { // Check up to max level 500 (or higher if you extend getLevelInfo)
                        const gasNeededToReachLevelI = getTotalGasRequiredToReachLevel(i);
                        if (totalGasEarned >= gasNeededToReachLevelI) {
                            currentLevel = i;
                        } else {
                            break; // Stop when totalGasEarned is less than what's needed for the current 'i' level
                        }
                    }
                    // Ensure level displayed is at least 1, even if totalGasEarned is 0
                    currentLevel = Math.max(1, currentLevel);

                    const levelInfo = getLevelInfo(currentLevel); // Get info for the calculated level

                    if (gasValue) gasValue.textContent = currentGasBalance.toLocaleString(); // Display current Gas balance, null check

                    // Update Level Name and Icon
                    if (xpLevelName) xpLevelName.textContent = levelInfo.name; // Null check
                    if (xpLevelIcon) xpLevelIcon.className = `${levelInfo.icon} profile-level-icon`; // Null check

                    let progressPercentage = 0;
                    const gasNeededForCurrentDisplayedLevel = getTotalGasRequiredToReachLevel(currentLevel);
                    const gasNeededForNextLevel = getTotalGasRequiredToReachLevel(currentLevel + 1);

                    if (currentLevel < 500) { // For levels up to 500, calculate progress
                        const gasEarnedInCurrentLevelSegment = totalGasEarned - gasNeededForCurrentDisplayedLevel;
                        const gasRequiredForCurrentLevelSegment = gasNeededForNextLevel - gasNeededForCurrentDisplayedLevel;
                        
                        if (gasRequiredForCurrentLevelSegment > 0) {
                            progressPercentage = Math.min(100, (gasEarnedInCurrentLevelSegment / gasRequiredForCurrentLevelSegment) * 100);
                        } else {
                            progressPercentage = 100; // Should not happen if formula is correct, but as a safeguard (e.g., if totalGasEarned is exactly at target)
                        }
                    } else {
                        progressPercentage = 100; // Maxed out for levels beyond 500
                        if (xpLevelName) xpLevelName.textContent = `MAX Level (${levelInfo.name})`;
                    }

                    // Set background-position for the gradient fill
                    // When progressPercentage is 0, background-position is right (0% of the gradient shown)
                    // When progressPercentage is 100, background-position is left (100% of the gradient shown)
                    const backgroundPosition = 100 - progressPercentage; // Invert for background-position: left to right fill
                    if (xpProgressBarFill) {
                        xpProgressBarFill.style.backgroundPosition = `${backgroundPosition}% 0`; // Set background-position
                        xpProgressBarFill.style.width = `100%`; // Ensure width is always 100%
                    }

                    // Update percentage display
                    const progressPercentageElement = document.getElementById('progressPercentage');
                    if (progressPercentageElement) {
                        progressPercentageElement.textContent = `${Math.round(progressPercentage)}%`;
                        
                        // Update text color based on progress percentage for better visibility
                        if (progressPercentage < 30) {
                            progressPercentageElement.style.color = '#fff'; // White for low progress
                            progressPercentageElement.style.textShadow = '0 0 3px rgba(0, 0, 0, 0.8)';
                        } else if (progressPercentage < 70) {
                            progressPercentageElement.style.color = '#000'; // Black for medium progress
                            progressPercentageElement.style.textShadow = '0 0 2px rgba(255, 255, 255, 0.8)';
                        } else {
                            progressPercentageElement.style.color = '#000'; // Black for high progress
                            progressPercentageElement.style.textShadow = '0 0 2px rgba(255, 255, 255, 0.8)';
                        }
                    }


                    // Action Buttons and Inline Edit Fields
                    if (isCurrentUserProfile) {
                        if (walletLink) walletLink.style.display = 'inline-flex'; // Null check
                        if (requestJCoinsButton) requestJCoinsButton.style.display = 'inline-flex'; // Show Request JCoins button for owner, null check
                        if (claimDailyBonusButton) claimDailyBonusButton.style.display = 'inline-flex'; // NEW: Show daily bonus button
                        updateDailyBonusUI(); // NEW: Update daily bonus UI

                        // Wallet Link Logic (only for owner)
                        if (walletLink && walletLockedMessage) { // Null check
                            walletLink.style.display = 'inline-flex';
                            if (displayedUserProfileData.walletUnlocked) {
                                walletLink.classList.remove('disabled-link');
                                walletLockedMessage.style.display = 'none';
                                if (walletLink.querySelector('.padlock-icon')) { // Null check for inner icon
                                    walletLink.querySelector('.padlock-icon').classList.remove('fa-lock');
                                    walletLink.querySelector('.padlock-icon').classList.add('fa-unlock-alt');
                                }
                            } else {
                                walletLink.classList.add('disabled-link');
                                walletLockedMessage.style.display = 'block';
                                if (walletLink.querySelector('.padlock-icon')) { // Null check for inner icon
                                    walletLink.querySelector('.padlock-icon').classList.add('fa-lock');
                                    walletLink.querySelector('.padlock-icon').classList.remove('fa-unlock-alt');
                                }
                            }
                        }

                        // Show inline edit fields and account settings for owner
                        const profileDetailsSection = displayNameInput ? displayNameInput.closest('.profile-details-section') : null; // Null check
                        if (profileDetailsSection) {
                            profileDetailsSection.style.display = 'flex';
                        }
                        // Populate inline edit fields
                        if (displayNameInput) displayNameInput.value = displayedUserProfileData.username || ""; // Null check
                        if (bioTextarea) bioTextarea.value = displayedUserProfileData.bio || ""; // Null check
                        if (locationInput) locationInput.value = displayedUserProfileData.location || ""; // Null check
                        if (schoolInput) schoolInput.value = displayedUserProfileData.school || ""; // NEW
                        if (workInput) workInput.value = displayedUserProfileData.work || ""; // NEW
                        if (interestsInput) interestsInput.value = displayedUserProfileData.interests || ""; // NEW
                        if (websiteInput) websiteInput.value = displayedUserProfileData.website || ""; // NEW
                        if (socialLinksInput) socialLinksInput.value = displayedUserProfileData.socialLinks || ""; // NEW

                        // Populate privacy toggles
                        if (toggleEmailVisibility) toggleEmailVisibility.checked = visibility.emailPublic ?? false;
                        if (toggleLocationVisibility) toggleLocationVisibility.checked = visibility.location ?? false;
                        if (toggleOnlineStatusVisibility) toggleOnlineStatusVisibility.checked = visibility.lastOnline ?? false;
                        if (toggleFriendRequests) toggleFriendRequests.checked = visibility.allowFriendRequests ?? true;
                        if (toggleMessages) toggleMessages.checked = visibility.allowMessages ?? true;
                        if (toggleSchoolVisibility) toggleSchoolVisibility.checked = visibility.school ?? false;
                        if (toggleWorkVisibility) toggleWorkVisibility.checked = visibility.work ?? false;
                        if (toggleInterestsVisibility) toggleInterestsVisibility.checked = visibility.interests ?? false;
                        if (toggleWebsiteVisibility) toggleWebsiteVisibility.checked = visibility.website ?? false;
                        if (toggleSocialLinksVisibility) toggleSocialLinksVisibility.checked = visibility.socialLinks ?? false;
                        // Show privacy toggles and save button
                        if (toggleEmailVisibility) toggleEmailVisibility.closest('.privacy-toggle-group').style.display = 'flex';
                        if (toggleLocationVisibility) toggleLocationVisibility.closest('.privacy-toggle-group').style.display = 'flex';
                        if (toggleOnlineStatusVisibility) toggleOnlineStatusVisibility.closest('.privacy-toggle-group').style.display = 'flex';
                        if (toggleFriendRequests) toggleFriendRequests.closest('.privacy-toggle-group').style.display = 'flex';
                        if (toggleMessages) toggleMessages.closest('.privacy-toggle-group').style.display = 'flex';
                        if (toggleSchoolVisibility) toggleSchoolVisibility.closest('.privacy-toggle-group').style.display = 'flex';
                        if (toggleWorkVisibility) toggleWorkVisibility.closest('.privacy-toggle-group').style.display = 'flex';
                        if (toggleInterestsVisibility) toggleInterestsVisibility.closest('.privacy-toggle-group').style.display = 'flex';
                        if (toggleWebsiteVisibility) toggleWebsiteVisibility.closest('.privacy-toggle-group').style.display = 'flex';
                        if (toggleSocialLinksVisibility) toggleSocialLinksVisibility.closest('.privacy-toggle-group').style.display = 'flex';
                        if (savePrivacySettingsButton) savePrivacySettingsButton.style.display = 'inline-flex';


                        // Populate customization selects
                        if (profileFrameSelect) profileFrameSelect.value = displayedUserProfileData.profileFrame || 'default';
                        if (chatBubbleStyleSelect) chatBubbleStyleSelect.value = displayedUserProfileData.chatBubbleStyle || 'default';
                        if (profileThemeSelect) profileThemeSelect.value = displayedUserProfileData.profileTheme || 'default';
                        // Show customization options and save button
                        if (profileFrameSelect) profileFrameSelect.closest('.customization-option').style.display = 'flex';
                        if (chatBubbleStyleSelect) chatBubbleStyleSelect.closest('.customization-option').style.display = 'flex';
                        if (profileThemeSelect) profileThemeSelect.closest('.customization-option').style.display = 'flex';
                        if (saveCustomizationButton) saveCustomizationButton.style.display = 'inline-flex';


                        if (profileEmailInput) profileEmailInput.value = displayedUserProfileData.email || ""; // Populate disabled email field, null check

                        // Show toggle button for account settings
                        if (toggleAccountSettingsButton) toggleAccountSettingsButton.style.display = 'inline-flex';

                        // NEW: Show unlocked rewards and recent activity for owner
                        await fetchAndDisplayUnlockedRewards();
                        await fetchAndDisplayRecentActivity();

                    } else if (currentUser) { // If logged in and viewing another user
                        // Hide all owner-specific buttons and editing sections
                        if (walletLink) walletLink.style.display = 'none'; // Hide wallet link for others, null check
                        if (walletLockedMessage) walletLockedMessage.style.display = 'none'; // Hide message for others, null check
                        if (requestJCoinsButton) requestJCoinsButton.style.display = 'none'; // Hide request JCoins button for others, null check
                        if (claimDailyBonusButton) claimDailyBonusButton.style.display = 'none'; // Hide daily bonus button for others
                        if (dailyBonusCountdown) dailyBonusCountdown.style.display = 'none'; // Hide daily bonus countdown for others
                        
                        // Show Report User Button
                        if (reportUserButton) reportUserButton.style.display = 'inline-flex';

                        // Hide inline edit fields and account settings
                        const profileDetailsSection = displayNameInput ? displayNameInput.closest('.profile-details-section') : null; // Null check
                        if (profileDetailsSection) {
                            profileDetailsSection.style.display = 'none';
                        }
                        if (toggleAccountSettingsButton) toggleAccountSettingsButton.style.display = 'none'; // NEW: Hide toggle button for others
                        if (accountSettingsSection) accountSettingsSection.style.display = 'none'; // NEW: Hide account settings for others

                        // Hide owner-specific sections
                        if (unlockedRewardsSection) unlockedRewardsSection.style.display = 'none';
                        if (recentActivitySection) recentActivitySection.style.display = 'none';
                        if (profileFrameSelect) profileFrameSelect.closest('.customization-option').style.display = 'none';
                        if (chatBubbleStyleSelect) chatBubbleStyleSelect.closest('.customization-option').style.display = 'none';
                        if (profileThemeSelect) profileThemeSelect.closest('.customization-option').style.display = 'none';
                        if (saveCustomizationButton) saveCustomizationButton.style.display = 'none';
                        if (savePrivacySettingsButton) savePrivacySettingsButton.style.display = 'none';
                        if (toggleEmailVisibility) toggleEmailVisibility.closest('.privacy-toggle-group').style.display = 'none';
                        if (toggleLocationVisibility) toggleLocationVisibility.closest('.privacy-toggle-group').style.display = 'none';
                        if (toggleOnlineStatusVisibility) toggleOnlineStatusVisibility.closest('.privacy-toggle-group').style.display = 'none';
                        if (toggleFriendRequests) toggleFriendRequests.closest('.privacy-toggle-group').style.display = 'none';
                        if (toggleMessages) toggleMessages.closest('.privacy-toggle-group').style.display = 'none';
                        if (toggleSchoolVisibility) toggleSchoolVisibility.closest('.privacy-toggle-group').style.display = 'none';
                        if (toggleWorkVisibility) toggleWorkVisibility.closest('.privacy-toggle-group').style.display = 'none';
                        if (toggleInterestsVisibility) toggleInterestsVisibility.closest('.privacy-toggle-group').style.display = 'none';
                        if (toggleWebsiteVisibility) toggleWebsiteVisibility.closest('.privacy-toggle-group').style.display = 'none';
                        if (toggleSocialLinksVisibility) toggleSocialLinksVisibility.closest('.privacy-toggle-group').style.display = 'none';
                    } else { // Not logged in, viewing any profile
                        if (walletLink) walletLink.style.display = 'none'; // Hide wallet link, null check
                        if (walletLockedMessage) walletLockedMessage.style.display = 'none'; // Hide message, null check
                        if (requestJCoinsButton) requestJCoinsButton.style.display = 'none'; // Hide request JCoins button, null check
                        if (claimDailyBonusButton) claimDailyBonusButton.style.display = 'none'; // Hide daily bonus button
                        if (dailyBonusCountdown) dailyBonusCountdown.style.display = 'none'; // Hide daily bonus countdown
                        if (reportUserButton) reportUserButton.style.display = 'none'; // Hide report user button
                        // Hide inline edit fields and account settings
                        const profileDetailsSection = displayNameInput ? displayNameInput.closest('.profile-details-section') : null; // Null check
                        if (profileDetailsSection) {
                            profileDetailsSection.style.display = 'none';
                        }
                        if (toggleAccountSettingsButton) toggleAccountSettingsButton.style.display = 'none'; // NEW: Hide toggle button
                        if (accountSettingsSection) accountSettingsSection.style.display = 'none'; // NEW: Hide account settings
                        // Hide all new sections as well if profile not found
                        if (unlockedRewardsSection) unlockedRewardsSection.style.display = 'none';
                        if (friendsSnippetSection) friendsSnippetSection.style.display = 'none';
                        if (recentActivitySection) recentActivitySection.style.display = 'none';
                        if (profileFrameSelect) profileFrameSelect.closest('.customization-option').style.display = 'none';
                        if (chatBubbleStyleSelect) chatBubbleStyleSelect.closest('.customization-option').style.display = 'none';
                        if (profileThemeSelect) profileThemeSelect.closest('.customization-option').style.display = 'none';
                        if (saveCustomizationButton) saveCustomizationButton.style.display = 'none';
                        if (savePrivacySettingsButton) savePrivacySettingsButton.style.display = 'none';
                        if (toggleEmailVisibility) toggleEmailVisibility.closest('.privacy-toggle-group').style.display = 'none';
                        if (toggleLocationVisibility) toggleLocationVisibility.closest('.privacy-toggle-group').style.display = 'none';
                        if (toggleOnlineStatusVisibility) toggleOnlineStatusVisibility.closest('.privacy-toggle-group').style.display = 'none';
                        if (toggleFriendRequests) toggleFriendRequests.closest('.privacy-toggle-group').style.display = 'none';
                        if (toggleMessages) toggleMessages.closest('.privacy-toggle-group').style.display = 'none';
                        if (toggleSchoolVisibility) toggleSchoolVisibility.closest('.privacy-toggle-group').style.display = 'none';
                        if (toggleWorkVisibility) toggleWorkVisibility.closest('.privacy-toggle-group').style.display = 'none';
                        if (toggleInterestsVisibility) toggleInterestsVisibility.closest('.privacy-toggle-group').style.display = 'none';
                        if (toggleWebsiteVisibility) toggleWebsiteVisibility.closest('.privacy-toggle-group').style.display = 'none';
                        if (toggleSocialLinksVisibility) toggleSocialLinksVisibility.closest('.privacy-toggle-group').style.display = 'none';


                        // Ensure loader is dismissed in this case too, as profile display might not proceed.
                        if (messageBox && messageBox.classList.contains('loading-pulse')) { // Null check
                            messageBox.style.opacity = '0';
                            messageBox.addEventListener('transitionend', function handler() {
                                messageBox.style.display = 'none';
                                messageBox.removeEventListener('transitionend', handler);
                                messageBox.classList.remove('loading-pulse');
                            }, { once: true });
                        }
                    }

                    // Load user's posts (if desired on profile page)
                    // await fetchAndDisplayUserPosts(userIdToDisplay, displayedUserProfileData.username || "User");
                    if (userPostsFeed) userPostsFeed.style.display = 'none'; // Keep posts section hidden for now as it's not fully styled for this page., null check

                    // NEW: Fetch and display friends snippet for any displayed profile
                    await fetchAndDisplayFriendsSnippet();


                    showMessageBox("Profile loaded!", 'success');

                    // After displaying profile, check for level ups (only for owner)
                    if (isCurrentUserProfile && currentUserProfileData) {
                        await checkAndApplyLevelUps(currentUser.uid, currentUserProfileData.level, currentUserProfileData.totalGasEarned);
                    }

                } else {
                    if (profileUsername) profileUsername.textContent = "User Not Found"; // Null check
                    if (profileBio) profileBio.textContent = "This user profile does not exist or is unavailable."; // Null check
                    showMessageBox("User profile not found.", 'error');
                    // Hide inline edit fields and account settings
                    const profileDetailsSection = displayNameInput ? displayNameInput.closest('.profile-details-section') : null; // Null check
                    if (profileDetailsSection) {
                        profileDetailsSection.style.display = 'none';
                    }
                    if (toggleAccountSettingsButton) toggleAccountSettingsButton.style.display = 'none'; // NEW: Hide toggle button
                    if (accountSettingsSection) accountSettingsSection.style.display = 'none'; // NEW: Hide account settings
                    // Hide all new sections as well if profile not found
                    if (unlockedRewardsSection) unlockedRewardsSection.style.display = 'none';
                    if (friendsSnippetSection) friendsSnippetSection.style.display = 'none';
                    if (recentActivitySection) recentActivitySection.style.display = 'none';
                    if (profileFrameSelect) profileFrameSelect.closest('.customization-option').style.display = 'none';
                    if (chatBubbleStyleSelect) chatBubbleStyleSelect.closest('.customization-option').style.display = 'none';
                    if (profileThemeSelect) profileThemeSelect.closest('.customization-option').style.display = 'none';
                    if (saveCustomizationButton) saveCustomizationButton.style.display = 'none';
                    if (savePrivacySettingsButton) savePrivacySettingsButton.style.display = 'none';
                    if (toggleEmailVisibility) toggleEmailVisibility.closest('.privacy-toggle-group').style.display = 'none';
                    if (toggleLocationVisibility) toggleLocationVisibility.closest('.privacy-toggle-group').style.display = 'none';
                    if (toggleOnlineStatusVisibility) toggleOnlineStatusVisibility.closest('.privacy-toggle-group').style.display = 'none';
                    if (toggleFriendRequests) toggleFriendRequests.closest('.privacy-toggle-group').style.display = 'none';
                    if (toggleMessages) toggleMessages.closest('.privacy-toggle-group').style.display = 'none';
                    if (toggleSchoolVisibility) toggleSchoolVisibility.closest('.privacy-toggle-group').style.display = 'none';
                    if (toggleWorkVisibility) toggleWorkVisibility.closest('.privacy-toggle-group').style.display = 'none';
                    if (toggleInterestsVisibility) toggleInterestsVisibility.closest('.privacy-toggle-group').style.display = 'none';
                    if (toggleWebsiteVisibility) toggleWebsiteVisibility.closest('.privacy-toggle-group').style.display = 'none';
                    if (toggleSocialLinksVisibility) toggleSocialLinksVisibility.closest('.privacy-toggle-group').style.display = 'none';

                }
            } catch (error) {
                console.error("JCHAT_ERROR: Error fetching user profile:", error);
                if (profileUsername) profileUsername.textContent = "Error Loading Profile"; // Null check
                if (profileBio) profileBio.textContent = "An error occurred while loading this profile."; // Null check
                showMessageBox(`Failed to load profile: ${error.message}`, 'error');
                // Hide inline edit fields and account settings
                const profileDetailsSection = displayNameInput ? displayNameInput.closest('.profile-details-section') : null; // Null check
                if (profileDetailsSection) {
                    profileDetailsSection.style.display = 'none';
                }
                if (toggleAccountSettingsButton) toggleAccountSettingsButton.style.display = 'none'; // NEW: Hide toggle button
                if (accountSettingsSection) accountSettingsSection.style.display = 'none'; // NEW: Hide account settings
                // Hide all new sections on error as well
                if (unlockedRewardsSection) unlockedRewardsSection.style.display = 'none';
                if (friendsSnippetSection) friendsSnippetSection.style.display = 'none';
                if (recentActivitySection) recentActivitySection.style.display = 'none';
                if (profileFrameSelect) profileFrameSelect.closest('.customization-option').style.display = 'none';
                if (chatBubbleStyleSelect) chatBubbleStyleSelect.closest('.customization-option').style.display = 'none';
                if (profileThemeSelect) profileThemeSelect.closest('.customization-option').style.display = 'none';
                if (saveCustomizationButton) saveCustomizationButton.style.display = 'none';
                if (savePrivacySettingsButton) savePrivacySettingsButton.style.display = 'none';
                if (toggleEmailVisibility) toggleEmailVisibility.closest('.privacy-toggle-group').style.display = 'none';
                if (toggleLocationVisibility) toggleLocationVisibility.closest('.privacy-toggle-group').style.display = 'none';
                if (toggleOnlineStatusVisibility) toggleOnlineStatusVisibility.closest('.privacy-toggle-group').style.display = 'none';
                if (toggleFriendRequests) toggleFriendRequests.closest('.privacy-toggle-group').style.display = 'none';
                if (toggleMessages) toggleMessages.closest('.privacy-toggle-group').style.display = 'none';
                if (toggleSchoolVisibility) toggleSchoolVisibility.closest('.privacy-toggle-group').style.display = 'none';
                if (toggleWorkVisibility) toggleWorkVisibility.closest('.privacy-toggle-group').style.display = 'none';
                if (toggleInterestsVisibility) toggleInterestsVisibility.closest('.privacy-toggle-group').style.display = 'none';
                if (toggleWebsiteVisibility) toggleWebsiteVisibility.closest('.privacy-toggle-group').style.display = 'none';
                if (toggleSocialLinksVisibility) toggleSocialLinksVisibility.closest('.privacy-toggle-group').style.display = 'none';


            } finally {
                // Ensure the message box clears if it was persistent loading type
                // This ensures the loader is always dismissed.
                if (messageBox && messageBox.classList.contains('loading-pulse')) { // Null check for messageBox
                    messageBox.style.opacity = '0';
                    messageBox.addEventListener('transitionend', function handler() {
                        messageBox.style.display = 'none';
                        messageBox.removeEventListener('transitionend', handler);
                        messageBox.classList.remove('loading-pulse');
                    }, { once: true });
                }
            }
        }
        // --- Authentication State Listener ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                isAuthReady = true; // Set auth ready flag
                console.log("JCHAT_DEBUG: User authenticated in Profile Page:", user.uid);
                
                // Fetch system settings first as they are needed by profile display functions
                await fetchSystemSettings();
                // Fetch header profile next, as it sets currentUserProfileData
                await fetchAndDisplayHeaderProfile(user); 

                // Determine which user's profile to display
                const urlParams = new URLSearchParams(window.location.search);
                displayedUserId = urlParams.get('userId') || currentUser.uid; // Default to current user's ID

                // Only fetch and display user profile if auth is ready and currentUserProfileData is set
                // This prevents race conditions where profile data might not be available yet.
                if (isAuthReady && currentUserProfileData) {
                    await fetchAndDisplayUserProfile(displayedUserId);
                    fetchNotificationCount(user.uid); // Fetch notification count
                } else {
                    console.warn("JCHAT_WARN: Authentication not fully ready or currentUserProfileData missing. Skipping profile display for now.");
                    // Ensure loader is dismissed in this case too, as profile display might not proceed.
                    if (messageBox && messageBox.classList.contains('loading-pulse')) { // Null check
                        messageBox.style.opacity = '0';
                        messageBox.addEventListener('transitionend', function handler() {
                            messageBox.style.display = 'none';
                            messageBox.removeEventListener('transitionend', handler);
                            messageBox.classList.remove('loading-pulse');
                        }, { once: true });
                    }
                }

            } else {
                console.log("JCHAT_DEBUG: No user signed in.");
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("JCHAT_DEBUG: Signed in with custom token.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("JCHAT_DEBUG: Signed in anonymously.");
                    }
                    // onAuthStateChanged will be triggered again with the new user
                } catch (error) {
                    console.error("JCHAT_ERROR: Error during anonymous sign-in or custom token sign-in:", error);
                    if (!auth.currentUser) {
                        window.location.href = '/login.html';
                    }
                }
                isAuthReady = false;
                if (logoutButtonAccount) logoutButtonAccount.disabled = true; // Account settings logout button, null check
                if (headerDisplayName) headerDisplayName.textContent = "Guest"; // Null check
                if (headerProfilePic) headerProfilePic.style.display = 'none'; // Null check
                if (headerAvatarIcon) headerAvatarIcon.style.display = 'block'; // Null check
                if (adminIconLink) adminIconLink.style.display = 'none'; // Ensure admin icon is hidden, null check
                showMessageBox("Please log in to view profiles.", 'info', true);
                // Display generic message if not logged in and no specific user ID is provided
                if (profileUsername) profileUsername.textContent = "Please Log In"; // Null check
                if (profileBio) profileBio.textContent = "Log in to view your profile or search for other users."; // Null check
                if (profileActions) profileActions.innerHTML = ''; // Clear actions, null check
                // Hide inline edit fields and account settings
                const profileDetailsSection = displayNameInput ? displayNameInput.closest('.profile-details-section') : null; // Null check
                if (profileDetailsSection) {
                    profileDetailsSection.style.display = 'none';
                }
                if (toggleAccountSettingsButton) toggleAccountSettingsButton.style.display = 'none'; // NEW: Hide toggle button
                if (accountSettingsSection) accountSettingsSection.style.display = 'none'; // NEW: Hide account settings
                // Hide all new sections as well
                if (unlockedRewardsSection) unlockedRewardsSection.style.display = 'none';
                if (friendsSnippetSection) friendsSnippetSection.style.display = 'none';
                if (recentActivitySection) recentActivitySection.style.display = 'none';
                if (profileFrameSelect) profileFrameSelect.closest('.customization-option').style.display = 'none';
                if (chatBubbleStyleSelect) chatBubbleStyleSelect.closest('.customization-option').style.display = 'none';
                if (profileThemeSelect) profileThemeSelect.closest('.customization-option').style.display = 'none';
                if (saveCustomizationButton) saveCustomizationButton.style.display = 'none';
                if (savePrivacySettingsButton) savePrivacySettingsButton.style.display = 'none';
                if (toggleEmailVisibility) toggleEmailVisibility.closest('.privacy-toggle-group').style.display = 'none';
                if (toggleLocationVisibility) toggleLocationVisibility.closest('.privacy-toggle-group').style.display = 'none';
                if (toggleOnlineStatusVisibility) toggleOnlineStatusVisibility.closest('.privacy-toggle-group').style.display = 'none';
                if (toggleFriendRequests) toggleFriendRequests.closest('.privacy-toggle-group').style.display = 'none';
                if (toggleMessages) toggleMessages.closest('.privacy-toggle-group').style.display = 'none';
                if (toggleSchoolVisibility) toggleSchoolVisibility.closest('.privacy-toggle-group').style.display = 'none';
                if (toggleWorkVisibility) toggleWorkVisibility.closest('.privacy-toggle-group').style.display = 'none';
                if (toggleInterestsVisibility) toggleInterestsVisibility.closest('.privacy-toggle-group').style.display = 'none';
                if (toggleWebsiteVisibility) toggleWebsiteVisibility.closest('.privacy-toggle-group').style.display = 'none';
                if (toggleSocialLinksVisibility) toggleSocialLinksVisibility.closest('.privacy-toggle-group').style.display = 'none';


                // Ensure loader is dismissed in this case too
                if (messageBox && messageBox.classList.contains('loading-pulse')) { // Null check
                    messageBox.style.opacity = '0';
                    messageBox.addEventListener('transitionend', function handler() {
                        messageBox.style.display = 'none';
                        messageBox.removeEventListener('transitionend', handler);
                        messageBox.classList.remove('loading-pulse');
                    }, { once: true });
                }
            }
        });
        // --- Event Listeners (moved to DOMContentLoaded for safety) ---
        document.addEventListener('DOMContentLoaded', () => {
            // Apply theme on load
            const savedTheme = localStorage.getItem('jchat-theme');
            const themes = ['theme-light-mode', 'theme-dark-mode', 'theme-glass-mode', 'theme-sunset-mode'];
            if (savedTheme && themes.includes(savedTheme)) {
                document.body.classList.remove(...themes);
                document.body.classList.add(savedTheme);
            } else {
                document.body.classList.remove(...themes);
                document.body.classList.add('theme-dark-mode'); // Default
            }

            // Profile Picture Upload
            if (profilePicUploadInput) profilePicUploadInput.addEventListener('change', handleProfilePicChange); // Null check

            // Profile Edit
            if (saveProfileChanges) saveProfileChanges.addEventListener('click', handleSaveProfileChanges); // Null check

            // Privacy Settings
            if (savePrivacySettingsButton) savePrivacySettingsButton.addEventListener('click', handleSavePrivacySettings);

            // Customization Settings
            if (saveCustomizationButton) saveCustomizationButton.addEventListener('click', handleSaveCustomization);


            // Account Settings Toggle
            if (toggleAccountSettingsButton) {
                toggleAccountSettingsButton.addEventListener('click', () => {
                    if (accountSettingsSection) {
                        const isHidden = accountSettingsSection.style.display === 'none';
                        accountSettingsSection.style.display = isHidden ? 'flex' : 'none'; // Use flex for column layout
                        // Change button text/icon based on state
                        toggleAccountSettingsButton.innerHTML = isHidden ?
                            '<i class="fas fa-times-circle"></i> Close Settings' :
                            '<i class="fas fa-cog"></i> Manage Account Settings';
                    }
                });
            }

            // Account Settings
            const changeEmailForm = document.getElementById('changeEmailForm'); // Get form element here
            if (changeEmailForm) changeEmailForm.addEventListener('submit', handleChangeEmail); // Null check
            if (updateEmailButton) updateEmailButton.addEventListener('click', handleChangeEmail); // Also listen to button click
            if (changePasswordButton) changePasswordButton.addEventListener('click', handleChangePassword); // Null check
            if (logoutButtonAccount) logoutButtonAccount.addEventListener('click', handleLogout); // Logout button in account settings, null check

            // JCoin Request Modal Event Listeners
            if (requestJCoinsButton) requestJCoinsButton.addEventListener('click', showJCoinRequestModal); // Null check
            if (cancelJCoinRequestButton) cancelJCoinRequestButton.addEventListener('click', hideJCoinRequestModal); // Null check
            if (submitJCoinRequestButton) submitJCoinRequestButton.addEventListener('click', submitJCoinRequest); // Null check

            // Calculate JCoins dynamically as Naira amount changes
            if (nairaAmountInput && calculatedJCoinsSpan) { // Null check
                nairaAmountInput.addEventListener('input', () => {
                    const nairaAmount = parseInt(nairaAmountInput.value);
                    if (!isNaN(nairaAmount) && nairaAmount > 0) {
                        const calculatedJCoins = calculateJCoins(nairaAmount);
                        calculatedJCoinsSpan.textContent = `${calculatedJCoins.toLocaleString()} JCoins`;
                    } else {
                        calculatedJCoinsSpan.textContent = '0 JCoins';
                    }
                });
            }


            // Handle receipt file input change
            if (receiptUploadInput && receiptFileNameSpan && receiptPreviewImg) { // Null check
                receiptUploadInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        receiptFileNameSpan.textContent = file.name;
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            receiptPreviewImg.src = e.target.result;
                            receiptPreviewImg.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    } else {
                        receiptFileNameSpan.textContent = 'No file chosen';
                        receiptPreviewImg.style.display = 'none';
                        receiptPreviewImg.src = '';
                    }
                });
            }


            // Allow clicking the custom file input wrapper to trigger the hidden input
            const fileInputWrapper = document.querySelector('.file-input-wrapper');
            if (fileInputWrapper && receiptUploadInput) { // Null check
                fileInputWrapper.addEventListener('click', () => {
                    receiptUploadInput.click();
                });
            }

            // NEW: Explicit click listener for the progress bar container
            if (progressBarContainer) { // Null check
                progressBarContainer.style.cursor = 'pointer'; // Add pointer cursor to indicate clickability
                progressBarContainer.addEventListener('click', () => {
                    window.location.href = '/levels.html'; // Navigate to levels.html
                });
            }

            // NEW: Daily Bonus button listener
            if (claimDailyBonusButton) claimDailyBonusButton.addEventListener('click', claimDailyBonus);

            // NEW: Report User button and modal listeners
            if (reportUserButton) reportUserButton.addEventListener('click', showReportUserModal);
            if (cancelReportButton) cancelReportButton.addEventListener('click', hideReportUserModal);
            if (submitReportButton) submitReportButton.addEventListener('click', submitReport);

        });

        window.addEventListener('storage', (event) => {
            if (event.key === 'jchat-theme') {
                const newTheme = event.newValue || 'theme-dark-mode';
                const themes = ['theme-light-mode', 'theme-dark-mode', 'theme-glass-mode', 'theme-sunset-mode'];
                if (themes.includes(newTheme)) {
                    document.body.classList.remove(...themes);
                    document.body.classList.add(newTheme);
                }
            }
        });

        window.addEventListener('beforeunload', () => {
            // Clear daily bonus interval on page unload
            if (dailyBonusInterval) {
                clearInterval(dailyBonusInterval);
                dailyBonusInterval = null;
            }
            // No specific Firestore listeners to unsubscribe from on this page currently
        });

    </script>
</body>
</html>