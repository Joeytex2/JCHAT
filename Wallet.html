<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JCHAT - Wallet</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        *, *::before, *::after { box-sizing: border-box; }
        :root {
            --pink: #ff2e92; --blue: #00d5ff; --white: #fff; --text-light: rgba(255,255,255,.7);
            --card: linear-gradient(145deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
            --border: rgba(255,255,255,.08); --header: linear-gradient(135deg, rgba(10,10,20,.85), rgba(10,10,20,.75));
        }
        body { margin:0; font-family: Inter, sans-serif; color:var(--white); background: rgba(10,10,10,.75);
               background-image: radial-gradient(circle at top left, var(--blue), transparent 120px),
                                 radial-gradient(circle at bottom right, var(--pink), transparent 160px);
               min-height:100vh; }
        header { position:sticky; top:0; background:var(--header); border-bottom:1px solid var(--border); z-index:5; }
        .header-content { max-width:960px; margin:0 auto; padding:12px 16px; display:flex; align-items:center; justify-content:space-between; }
        .logo { font-weight:800; font-size:1.3rem; background-image: linear-gradient(90deg, var(--blue), var(--pink)); -webkit-background-clip:text; background-clip:text; color:transparent; text-decoration:none; }
        main { max-width:960px; margin:0 auto; padding:16px; display:flex; flex-direction:column; gap:16px; }
        .card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; }
        .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
        .label { color:var(--text-light); font-weight:600; }
        .actions { display:flex; gap:10px; justify-content:flex-end; }
        .btn { background: linear-gradient(90deg, var(--blue), var(--pink)); color:#fff; border:none; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:700; }
        .btn.secondary { background: rgba(255,255,255,.08); border:1px solid var(--border); }
        input[type="file"], input[type="text"], input[type="number"] { width:100%; background: rgba(255,255,255,.05); border:1px solid var(--border); color:#fff; padding:10px; border-radius:10px; }
        .badge { padding:4px 8px; border-radius:999px; font-size:.8rem; border:1px solid var(--border); }
        .success { color:#00e676; }
        .warning { color:#ffb300; }
        .error { color:#ff5252; }
        .list { display:flex; flex-direction:column; gap:10px; }
        .req { border:1px solid var(--border); border-radius:12px; padding:12px; display:flex; justify-content:space-between; gap:10px; }
        .muted { color:var(--text-light); }
    </style>
</head>
<body>
<header>
    <div class="header-content">
        <a href="/Home.html" class="logo">JCHAT</a>
        <div class="row">
            <a href="/gas_management.html" class="badge" id="adminLink" style="display:none;">Admin</a>
            <a href="/Profile.html" class="badge">Profile</a>
        </div>
    </div>
</header>
<main>
    <div class="card">
        <h2 style="margin:0 0 8px;">Wallet Payment Hub</h2>
        <div class="muted">All payments are via bank transfer. Upload your receipt here; a developer will approve and unlock your features.</div>
    </div>

    <div class="card" id="intentCard" style="display:none;">
        <div class="row">
            <div class="label">Intent:</div>
            <div id="intentLabel" class="badge"></div>
        </div>
        <div class="row">
            <div class="label">Amount:</div>
            <div id="intentAmount" class="badge"></div>
            <div id="intentCurrency" class="badge"></div>
        </div>
        <div class="row" id="planRow" style="display:none;">
            <div class="label">Plan:</div>
            <div id="intentPlan" class="badge"></div>
        </div>
    </div>

    <div class="card">
        <h3 style="margin:0 0 8px;">Bank Details</h3>
        <div class="row"><div class="label">Bank:</div><div>Opay</div></div>
        <div class="row"><div class="label">Account:</div><div>8111609765</div></div>
        <div class="row"><div class="label">Name:</div><div>Elechi Joshua</div></div>
        <div class="muted">Transfer the exact amount. Then upload your receipt below and submit.</div>
    </div>

    <div class="card">
        <h3 style="margin:0 0 8px;">Upload Receipt</h3>
        <input type="file" id="receiptInput" accept="image/*">
        <div class="actions">
            <button class="btn" id="submitRequestBtn">Submit for Approval</button>
        </div>
        <div id="submitStatus" class="muted" style="margin-top:8px;"></div>
    </div>

    <div class="card">
        <h3 style="margin:0 0 8px;">My Requests</h3>
        <div id="myRequests" class="list"></div>
        <div id="noReqMsg" class="muted">No requests yet.</div>
    </div>
</main>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, addDoc, getDoc, getDocs, collection, serverTimestamp, query, where, orderBy } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-firestore.js";

    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
        apiKey: "AIzaSyBsBinyrD9WZZXRaCvA4gxfX7BIimydDvo",
        authDomain: "jchat-1.firebaseapp.com",
        projectId: "jchat-1",
        storageBucket: "jchat-1.firebasestorage.app",
        messagingSenderId: "328479683167",
        appId: "1:328479683167:web:276c0b7e8ea44dd2d6a1ea",
        measurementId: "G-S6Z9GG0R9P"
    };
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const cloudinaryConfig = { cloudName: "dxld01rcp", uploadPreset: "Storage_preset" };

    const adminLink = document.getElementById('adminLink');
    const intentCard = document.getElementById('intentCard');
    const intentLabel = document.getElementById('intentLabel');
    const intentAmount = document.getElementById('intentAmount');
    const intentCurrency = document.getElementById('intentCurrency');
    const intentPlan = document.getElementById('intentPlan');
    const planRow = document.getElementById('planRow');
    const receiptInput = document.getElementById('receiptInput');
    const submitBtn = document.getElementById('submitRequestBtn');
    const submitStatus = document.getElementById('submitStatus');
    const myRequests = document.getElementById('myRequests');
    const noReqMsg = document.getElementById('noReqMsg');

    const params = new URLSearchParams(location.search);
    const mode = params.get('subscribe') ? 'subscribe' : (params.get('unlock') ? 'unlock' : (params.get('buyJCoins') ? 'jcoins' : null));
    let payload = { amount: params.get('amount') || '0', currency: params.get('currency') || 'NGN' };
    if (mode === 'subscribe') { payload.plan = params.get('plan') || 'starter'; }
    if (mode === 'jcoins') { payload.jcoins = params.get('j') || '0'; }

    function showIntent() {
        if (!mode) return;
        intentCard.style.display = 'block';
        intentLabel.textContent = mode === 'subscribe' ? 'Subscription' : (mode === 'unlock' ? 'Wallet Unlock' : 'JCoins');
        intentAmount.textContent = `₦${payload.amount}`;
        intentCurrency.textContent = payload.currency;
        if (mode === 'subscribe') { planRow.style.display = 'flex'; intentPlan.textContent = payload.plan; }
    }

    async function uploadReceipt(file) {
        const endpoint = `https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/auto/upload`;
        const form = new FormData();
        form.append('file', file);
        form.append('upload_preset', cloudinaryConfig.uploadPreset);
        const res = await fetch(endpoint, { method: 'POST', body: form });
        if (!res.ok) throw new Error('Upload failed');
        const json = await res.json();
        return json.secure_url;
    }

    async function createRequest(uid, receiptUrl) {
        if (mode === 'unlock') {
            await addDoc(collection(db, 'artifacts', appId, 'billing', 'wallet_unlock_requests'), {
                userId: uid, receiptUrl, amount: Number(payload.amount)||0, currency: payload.currency, status: 'pending', createdAt: serverTimestamp()
            });
        } else if (mode === 'subscribe') {
            await addDoc(collection(db, 'artifacts', appId, 'billing', 'premium_requests'), {
                userId: uid, plan: payload.plan, cycle: 'monthly', amount: Number(payload.amount)||0, currency: payload.currency, status: 'pending', receiptUrl, createdAt: serverTimestamp()
            });
        } else if (mode === 'jcoins') {
            await addDoc(collection(db, 'artifacts', appId, 'billing', 'jcoin_purchases'), {
                userId: uid, jcoins: Number(payload.jcoins)||0, amount: Number(payload.amount)||0, currency: payload.currency, status: 'pending', receiptUrl, createdAt: serverTimestamp()
            });
        } else {
            throw new Error('No intent provided');
        }
    }

    async function loadMyRequests(uid) {
        myRequests.innerHTML = '';
        const reqs = [];
        const cols = [
            collection(db, 'artifacts', appId, 'billing', 'premium_requests'),
            collection(db, 'artifacts', appId, 'billing', 'wallet_unlock_requests'),
            collection(db, 'artifacts', appId, 'billing', 'jcoin_purchases')
        ];
        for (const c of cols) {
            const qy = query(c, where('userId','==', uid), orderBy('createdAt','desc'));
            const snap = await getDocs(qy).catch(()=>null);
            if (snap) snap.forEach(d=> reqs.push({ id:d.id, ...d.data(), _col: c.path.split('/').pop() }));
        }
        reqs.sort((a,b)=> (b.createdAt?.toMillis?.()||0) - (a.createdAt?.toMillis?.()||0));
        if (reqs.length === 0) { noReqMsg.style.display='block'; return; }
        noReqMsg.style.display='none';
        for (const r of reqs) {
            const div = document.createElement('div');
            div.className = 'req';
            div.innerHTML = `<div><div class="label">${r._col}</div><div class="muted">${r.plan?('Plan: '+r.plan): (r.jcoins?('JCoins: '+r.jcoins):'')}</div><div>Amount: ₦${r.amount||0}</div></div><div class="badge">${r.status||'pending'}</div>`;
            myRequests.appendChild(div);
        }
    }

    submitBtn.addEventListener('click', async ()=>{
        submitStatus.textContent = '';
        if (!auth.currentUser) { submitStatus.textContent = 'Please log in.'; return; }
        const f = receiptInput.files?.[0];
        if (!f) { submitStatus.textContent = 'Select a receipt image.'; return; }
        try {
            submitBtn.disabled = true; submitStatus.textContent = 'Uploading receipt...';
            const url = await uploadReceipt(f);
            submitStatus.textContent = 'Creating request...';
            await createRequest(auth.currentUser.uid, url);
            submitStatus.innerHTML = '<span class="success">Submitted. Awaiting admin approval.</span>';
            await loadMyRequests(auth.currentUser.uid);
        } catch (e) {
            console.error(e);
            submitStatus.innerHTML = '<span class="error">Failed to submit. Try again.</span>';
        } finally {
            submitBtn.disabled = false;
        }
    });

    onAuthStateChanged(auth, async (user)=>{
        showIntent();
        if (user) {
            // Show admin link for admin UID
            if (user.uid === 'cc96gdhCRPO72NFZtleRCujHvIq2') adminLink.style.display = 'inline-flex';
            await loadMyRequests(user.uid);
        } else {
            // stay on page; actions will prompt login when pressing submit
        }
    });
</script>
</body>
</html>