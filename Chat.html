<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JCHAT - Messages</title>
    <link rel="canonical" href="https://jchat.app/Chat.html">
    <link rel="manifest" href="/manifest.webmanifest">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">

    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">

    <!-- Preconnects -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://firebaseio.com" crossorigin>
    <link rel="preconnect" href="https://res.cloudinary.com" crossorigin>

    <style>
        :root {
            --pink: #ff2e92;
            --blue: #00d5ff;
            --glass-blue: rgba(0, 213, 255, .15);
            --radius: 16px;
            --white: #fff;
            --text-light: rgba(255, 255, 255, .7);
            --background-main: #1a1a2e;
            --background-gradient-1: #16213e;
            --background-gradient-2: #0f3460;
            --card-background: linear-gradient(145deg, rgba(255, 255, 255, .03), rgba(255, 255, 255, .01));
            --header-background: linear-gradient(135deg, rgba(10, 10, 20, .85), rgba(10, 10, 20, .75));
            --border-light: rgba(255, 255, 255, .08);
            --input-background: rgba(255, 255, 255, 0.06);
            --button-background: linear-gradient(90deg, var(--blue), var(--pink));
            --button-shadow: 0 4px 15px rgba(0, 213, 255, 0.25), 0 4px 15px rgba(255, 46, 146, 0.25);
            --border-color: #3a3a5a;
        }
        body { min-height: 100vh; margin: 0; padding: 0; font-family: 'Inter', sans-serif; color: var(--white);
            background-color: var(--background-main);
            background-image: radial-gradient(circle at top left, var(--background-gradient-1), transparent 100px), radial-gradient(circle at bottom right, var(--background-gradient-2), transparent 150px);
            overflow: hidden; }
        *, *::before, *::after { box-sizing: border-box; }

        header { position: fixed; top:0; left:0; right:0; height:56px; background: var(--header-background); border-bottom:1px solid var(--border-light); z-index:10; display:flex; justify-content:center; }
        .header-content-wrapper { width:100%; max-width: 1400px; padding: 0 20px; display:flex; align-items:center; justify-content:space-between; }
        .logo { font-family:'Poppins',sans-serif; font-size:1.6rem; font-weight:800; background-image:linear-gradient(90deg,var(--blue),var(--pink)); background-clip:text; -webkit-background-clip:text; color:transparent; text-decoration:none; letter-spacing:-0.02em; }
        .user-profile-header { display:flex; align-items:center; gap:10px; }
        .notification-icon-wrapper { position:relative; }
        .notification-icon-wrapper a { width:36px; height:36px; display:flex; align-items:center; justify-content:center; border-radius:50%; background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.2); }
        .notification-badge { position:absolute; top:-6px; right:-6px; background:#ff4757; color:#fff; border-radius:999px; font-size:11px; padding:2px 6px; font-weight:800; }
        .user-profile-header img { width:32px; height:32px; border-radius:50%; border:2px solid var(--blue); object-fit:cover; }
        .user-profile-header span { font-weight:600; background-image:linear-gradient(90deg,var(--blue),var(--pink)); background-clip:text; -webkit-background-clip:text; color:transparent; }

        main { position:absolute; top:56px; left:0; right:0; bottom:0; display:flex; justify-content:center; }
        .messenger-layout { width:100%; max-width: 1400px; height:100%; display:grid; grid-template-columns: 320px 1fr 320px; gap:12px; padding: 12px; }

        .panel { background: var(--card-background); border: 1px solid var(--glass-blue); border-radius: var(--radius); box-shadow: 0 8px 25px rgba(0,0,0,.2); display:flex; flex-direction:column; min-height:0; }

        /* Left panel: chats list */
        .left-panel header { all: unset; display:flex; align-items:center; gap:8px; padding:12px 12px 0 12px; }
        .chat-search { margin:12px; }
        .chat-search input { width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--border-color); background:var(--input-background); color:#fff; outline:none; }
        .chat-list { overflow-y:auto; padding:8px; display:flex; flex-direction:column; gap:6px; }
        .chat-item { display:grid; grid-template-columns: 40px 1fr auto; gap:10px; align-items:center; padding:10px; border-radius:12px; cursor:pointer; transition: background .2s ease; }
        .chat-item:hover { background: rgba(255,255,255,0.06); }
        .chat-item.active { background: rgba(0,213,255,0.12); border: 1px solid rgba(0,213,255,0.25); }
        .chat-avatar { width:40px; height:40px; border-radius:50%; background:linear-gradient(45deg,var(--blue),var(--pink)); display:flex; align-items:center; justify-content:center; font-weight:800; }
        .chat-meta { display:flex; flex-direction:column; min-width:0; }
        .chat-name { font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .chat-preview { font-size:12px; color:var(--text-light); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .chat-right { display:flex; flex-direction:column; align-items:flex-end; gap:6px; }
        .unread-badge { background:#25D366; color:#0b1f0f; padding:2px 6px; font-size:11px; font-weight:900; border-radius:999px; }
        .time { font-size:11px; color:var(--text-light); }

        /* Center panel: thread */
        .center-panel .thread-header { display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid var(--border-light); }
        .partner-box { display:flex; align-items:center; gap:10px; min-width:0; }
        .partner-avatar { width:36px; height:36px; border-radius:50%; background:linear-gradient(45deg,var(--blue),var(--pink)); display:flex; align-items:center; justify-content:center; font-weight:800; }
        .partner-name { font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .thread-actions { display:flex; align-items:center; gap:8px; }
        .icon-btn { width:36px; height:36px; display:flex; align-items:center; justify-content:center; border-radius:50%; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.15); cursor:pointer; }

        .messages { flex:1; overflow-y:auto; padding:16px; display:flex; flex-direction:column; gap:8px; }
        .msg { max-width:70%; padding:10px 14px; border-radius:14px; font-size:0.95rem; white-space:pre-wrap; word-break:break-word; }
        .msg.sent { margin-left:auto; background:linear-gradient(90deg,var(--blue),var(--pink)); color:#fff; border-bottom-right-radius:2px; }
        .msg.recv { margin-right:auto; background: var(--input-background); color:#fff; border:1px solid var(--border-light); border-bottom-left-radius:2px; }
        .msg-time { font-size:11px; color:var(--text-light); margin-top:4px; }

        .composer { display:flex; gap:10px; padding:12px; border-top:1px solid var(--border-light); }
        .composer textarea { flex:1; padding:10px 12px; border-radius:12px; border:1px solid var(--border-color); background:var(--input-background); color:#fff; outline:none; resize:none; min-height:44px; max-height:140px; }
        .composer button { background: var(--button-background); color:#fff; border:none; border-radius:12px; padding:0 16px; font-weight:800; cursor:pointer; height:44px; box-shadow: var(--button-shadow); }

        /* Right panel: details */
        .right-panel .details-header { padding:12px 16px; border-bottom:1px solid var(--border-light); font-weight:800; }
        .details-body { padding:12px 16px; overflow-y:auto; display:flex; flex-direction:column; gap:12px; }
        .detail-row { display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 0; border-bottom:1px dashed rgba(255,255,255,0.06); }
        .switch { position:relative; width:38px; height:22px; background:rgba(255,255,255,0.15); border-radius:999px; cursor:pointer; }
        .switch::after { content:""; position:absolute; top:3px; left:3px; width:16px; height:16px; background:#fff; border-radius:50%; transition:left .2s ease; }
        .switch.active { background:#25D366; }
        .switch.active::after { left:19px; }

        /* Responsive */
        @media (max-width: 1200px) {
            .messenger-layout { grid-template-columns: 320px 1fr; }
            .right-panel { display:none; }
        }
        @media (max-width: 800px) {
            .messenger-layout { grid-template-columns: 1fr; }
            .left-panel { display:block; }
            .center-panel { display:none; }
            .messenger-layout.show-thread .left-panel { display:none; }
            .messenger-layout.show-thread .center-panel { display:flex; }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content-wrapper">
            <a class="logo" href="/Home.html">JCHAT</a>
            <div class="user-profile-header">
                <div class="notification-icon-wrapper">
                    <a id="notificationsLink" href="/notifications.html" aria-label="Notifications"><i class="fas fa-bell"></i></a>
                    <span id="notificationsBadge" class="notification-badge" style="display:none"></span>
                </div>
                <a id="profileLink" href="/Profile.html">
                    <img id="profileAvatar" src="https://placehold.co/64x64/1a1a2e/ffffff?text=J" alt="Profile">
                    <span id="profileName">User</span>
                </a>
            </div>
        </div>
    </header>

    <main>
        <div id="layout" class="messenger-layout">
            <section class="panel left-panel" aria-label="Chats">
                <header>
                    <h3 style="margin:0;font-family:Poppins,sans-serif">Chats</h3>
                </header>
                <div class="chat-search">
                    <input id="chatSearch" type="text" placeholder="Search or start new chat (enter user ID)...">
                </div>
                <div id="chatList" class="chat-list"></div>
            </section>

            <section class="panel center-panel" aria-label="Conversation" style="display:flex">
                <div class="thread-header">
                    <div class="partner-box">
                        <div id="partnerAvatar" class="partner-avatar">U</div>
                        <div style="min-width:0">
                            <div id="partnerName" class="partner-name">Select a chat</div>
                            <div id="partnerSub" style="font-size:12px;color:var(--text-light)">No chat selected</div>
                        </div>
                    </div>
                    <div class="thread-actions">
                        <button id="backToList" class="icon-btn" title="Back" style="display:none"><i class="fas fa-arrow-left"></i></button>
                        <button class="icon-btn" title="Call" disabled><i class="fas fa-phone"></i></button>
                        <button class="icon-btn" title="Video" disabled><i class="fas fa-video"></i></button>
                    </div>
                </div>
                <div id="messages" class="messages"></div>
                <div class="composer">
                    <textarea id="messageInput" placeholder="Type a message..." aria-label="Message"></textarea>
                    <button id="sendMessageBtn" aria-label="Send"><i class="fas fa-paper-plane"></i></button>
                </div>
            </section>

            <aside class="panel right-panel" aria-label="Details">
                <div class="details-header">Chat details</div>
                <div class="details-body">
                    <div class="detail-row"><span>Mute notifications</span><div id="muteSwitch" class="switch"></div></div>
                    <div class="detail-row"><span>Theme</span><div>Default</div></div>
                    <div class="detail-row"><span>Shared media</span><div id="sharedMediaCount">0</div></div>
                    <div class="detail-row"><span>Partner ID</span><div id="detailPartnerId">-</div></div>
                </div>
            </aside>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, limit, onSnapshot, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyBsBinyrD9WZZXRaCvA4gxfX7BIimydDvo",
            authDomain: "jchat-1.firebaseapp.com",
            projectId: "jchat-1",
            storageBucket: "jchat-1.firebasestorage.app",
            messagingSenderId: "680440616768",
            appId: "1:680440616768:web:6b4f03f7fa1be4cb8e83e9"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const layoutEl = document.getElementById('layout');
        const chatListEl = document.getElementById('chatList');
        const chatSearchEl = document.getElementById('chatSearch');
        const messagesEl = document.getElementById('messages');
        const inputEl = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendMessageBtn');
        const partnerAvatarEl = document.getElementById('partnerAvatar');
        const partnerNameEl = document.getElementById('partnerName');
        const partnerSubEl = document.getElementById('partnerSub');
        const backBtn = document.getElementById('backToList');
        const notificationsBadgeEl = document.getElementById('notificationsBadge');
        const profileNameEl = document.getElementById('profileName');
        const profileAvatarEl = document.getElementById('profileAvatar');
        const detailPartnerIdEl = document.getElementById('detailPartnerId');
        const sharedMediaCountEl = document.getElementById('sharedMediaCount');
        const muteSwitchEl = document.getElementById('muteSwitch');

        let unsubscribe = null;
        let currentUser = null;
        let activePartnerId = '';
        let sharedMediaCount = 0;

        function getParam(name){ return new URLSearchParams(location.search).get(name) || ''; }
        function setParam(name, value){ const u=new URL(location.href); if(value){u.searchParams.set(name,value);} else {u.searchParams.delete(name);} history.pushState({},'',u); }
        function getChatRoomId(a,b){ if(!a||!b) return 'public_chat'; return [a,b].sort().join('_'); }

        function initials(id){ if(!id) return 'U'; return id.toString().slice(0,2).toUpperCase(); }
        function fmtTime(ts){ try{ return new Intl.DateTimeFormat(undefined,{hour:'2-digit',minute:'2-digit'}).format(ts);}catch{return '';} }

        function loadRecents(){ try{ return JSON.parse(localStorage.getItem('jchat_recents')||'[]'); }catch{return [];} }
        function saveRecents(items){ localStorage.setItem('jchat_recents', JSON.stringify(items.slice(0,50))); }

        function upsertRecent(partnerId, lastText, timeMs, unreadDelta){
            const items = loadRecents();
            const now = timeMs || Date.now();
            const idx = items.findIndex(r=>r.partnerId===partnerId);
            if(idx>=0){
                const it = items[idx];
                it.lastText = lastText ?? it.lastText ?? '';
                it.updatedAt = now;
                it.unread = Math.max(0, (it.unread||0) + (unreadDelta||0));
                items.splice(idx,1);
                items.unshift(it);
            } else {
                items.unshift({ partnerId, lastText: lastText||'', updatedAt: now, unread: Math.max(0, unreadDelta||0) });
            }
            saveRecents(items);
            renderChatList();
        }
        function markRecentRead(partnerId){
            const items = loadRecents();
            const idx = items.findIndex(r=>r.partnerId===partnerId);
            if(idx>=0){ items[idx].unread = 0; saveRecents(items); renderChatList(); }
        }

        function renderChatList(){
            const q = chatSearchEl.value.trim();
            const items = loadRecents().filter(it => !q || it.partnerId.includes(q));
            chatListEl.innerHTML='';
            // Public chat entry
            const pub = document.createElement('div');
            pub.className = 'chat-item' + (activePartnerId?'' : ' active');
            pub.innerHTML = `<div class="chat-avatar">🌐</div><div class="chat-meta"><div class="chat-name">Public Chat</div><div class="chat-preview">Everyone can chat here</div></div><div class="chat-right"><span class="time"></span></div>`;
            pub.onclick = ()=> selectPartner('');
            chatListEl.appendChild(pub);

            for(const it of items){
                const row = document.createElement('div');
                row.className = 'chat-item' + (activePartnerId===it.partnerId ? ' active' : '');
                row.innerHTML = `
                    <div class="chat-avatar">${initials(it.partnerId)}</div>
                    <div class="chat-meta">
                        <div class="chat-name">${it.partnerId}</div>
                        <div class="chat-preview">${(it.lastText||'').replace(/</g,'&lt;')}</div>
                    </div>
                    <div class="chat-right">
                        <span class="time">${it.updatedAt ? new Intl.DateTimeFormat(undefined,{hour:'2-digit',minute:'2-digit'}).format(new Date(it.updatedAt)) : ''}</span>
                        ${it.unread ? `<span class="unread-badge">${it.unread}</span>` : ''}
                    </div>`;
                row.onclick = ()=> selectPartner(it.partnerId);
                chatListEl.appendChild(row);
            }

            // If query typed that is not in recents, show quick start
            if(q && !items.some(i=>i.partnerId===q)){
                const quick = document.createElement('div');
                quick.className='chat-item';
                quick.innerHTML = `<div class="chat-avatar">${initials(q)}</div><div class="chat-meta"><div class="chat-name">Start chat</div><div class="chat-preview">${q}</div></div>`;
                quick.onclick = ()=> selectPartner(q);
                chatListEl.appendChild(quick);
            }
        }

        function renderMessage(data, myUid){
            const wrap = document.createElement('div');
            wrap.className = 'msg ' + (data.senderId===myUid ? 'sent' : 'recv');
            const text = (data.text||'').toString();
            const time = data.createdAt?.toDate ? data.createdAt.toDate() : null;
            wrap.textContent = text;
            const meta = document.createElement('div');
            meta.className = 'msg-time';
            meta.textContent = time ? fmtTime(time) : '';
            wrap.appendChild(meta);
            // naive shared media counter
            if(/https?:\/\//i.test(text)) { sharedMediaCount++; sharedMediaCountEl.textContent = String(sharedMediaCount); }
            return wrap;
        }

        function setThreadHeader(pid){
            const isPublic = !pid;
            partnerAvatarEl.textContent = isPublic ? '🌐' : initials(pid);
            partnerNameEl.textContent = isPublic ? 'Public Chat' : pid;
            partnerSubEl.textContent = isPublic ? 'Everyone can see messages here' : 'Private conversation';
            detailPartnerIdEl.textContent = isPublic ? '-' : pid;
            sharedMediaCount = 0; sharedMediaCountEl.textContent = '0';
            markRecentRead(pid);
        }

        function scrollToBottom(){ messagesEl.scrollTop = messagesEl.scrollHeight; }

        async function ensureRoom(userUid, partnerId){
            const chatRoomId = getChatRoomId(userUid, partnerId);
            const roomRef = doc(db, 'chats', chatRoomId);
            const snap = await getDoc(roomRef);
            if(!snap.exists()) await setDoc(roomRef, { createdAt: serverTimestamp(), createdBy: userUid });
        }

        async function bindThread(user, partnerId){
            activePartnerId = partnerId || '';
            setParam('uid', activePartnerId || null);
            setThreadHeader(activePartnerId);
            messagesEl.innerHTML = '';
            if(unsubscribe){ unsubscribe(); unsubscribe=null; }
            await ensureRoom(user.uid, activePartnerId);
            const chatRoomId = getChatRoomId(user.uid, activePartnerId);
            const qy = query(collection(db, 'chats', chatRoomId, 'messages'), orderBy('createdAt','asc'), limit(500));
            unsubscribe = onSnapshot(qy, (snap)=>{
                messagesEl.innerHTML='';
                snap.forEach(d=> messagesEl.appendChild(renderMessage(d.data(), user.uid)) );
                scrollToBottom();
            });
            // mobile show
            if(window.matchMedia('(max-width: 800px)').matches){
                layoutEl.classList.add('show-thread');
                backBtn.style.display='flex';
            }
        }

        async function selectPartner(pid){
            if(!currentUser) return;
            await bindThread(currentUser, pid);
        }

        function updateProfileHeader(user){
            profileNameEl.textContent = user.displayName || (user.isAnonymous ? 'Guest' : 'User');
            if(user.photoURL) profileAvatarEl.src = user.photoURL;
        }

        // Events
        chatSearchEl.addEventListener('keydown', (e)=>{
            if(e.key==='Enter'){
                const v = chatSearchEl.value.trim();
                if(v) selectPartner(v);
            }
        });
        chatSearchEl.addEventListener('input', renderChatList);
        backBtn.addEventListener('click', ()=>{
            layoutEl.classList.remove('show-thread');
            backBtn.style.display='none';
        });
        muteSwitchEl.addEventListener('click', ()=>{ muteSwitchEl.classList.toggle('active'); });

        sendBtn.addEventListener('click', async ()=>{
            if(!currentUser) return;
            const text = inputEl.value.trim();
            if(!text) return;
            inputEl.value='';
            const chatRoomId = getChatRoomId(currentUser.uid, activePartnerId);
            try{
                await addDoc(collection(db, 'chats', chatRoomId, 'messages'), { text, senderId: currentUser.uid, createdAt: serverTimestamp() });
                upsertRecent(activePartnerId || '', text, Date.now(), 0);
            }catch(err){ console.error('send failed', err); }
        });
        inputEl.addEventListener('keydown', (e)=>{
            if((e.key==='Enter'||e.keyCode===13) && !e.shiftKey){ e.preventDefault(); sendBtn.click(); }
        });

        // Auth
        onAuthStateChanged(auth, async (user)=>{
            try {
                if(!user){ await signInAnonymously(auth); return; }
                currentUser = user;
                updateProfileHeader(user);
                renderChatList();
                const initialPartner = getParam('uid') || '';
                if(initialPartner || initialPartner===''){
                    await bindThread(user, initialPartner);
                }
                notificationsBadgeEl.style.display='none';
            } catch(err){ console.error('init error', err); }
        });

        // Unread heuristic: increment when a message arrives for inactive thread (only while this page is open)
        window.addEventListener('message', ()=>{});
    </script>
</body>
</html>