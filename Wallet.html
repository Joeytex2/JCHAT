<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JCHAT - My Wallet</title>

    <!-- Google Fonts: Poppins for headings, Inter for body text -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Preconnect to Firebase and Cloudinary domains for faster loading -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://*.firebaseio.com" crossorigin>
    <link rel="preconnect" href="https://res.cloudinary.com" crossorigin>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* Universal box-sizing for consistent layout */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        /* Global CSS Variables for easy theme switching (consistent with other JCHAT pages) */
        :root {
            --pink: #ff2e92;
            --blue: #00d5ff;
            --glass-black: rgba(10, 10, 10, .75);
            --glass-blue: rgba(0, 213, 255, .15);
            --radius: 20px;
            --transition: .3s ease;

            /* These variables will be overridden by theme classes */
            --white: #fff;
            --text-light: rgba(255, 255, 255, .7);
            --background-main: rgba(10, 10, 10, .75);
            --background-gradient-1: #00d5ff;
            --background-gradient-2: #ff2e92;
            --card-background: linear-gradient(145deg, rgba(255, 255, 255, .03), rgba(255, 255, 255, .01));
            --header-background: linear-gradient(135deg, rgba(10, 10, 10, .85), rgba(10, 10, 10, .75));
            --border-light: rgba(255, 255, 255, .05);
            --input-background: rgba(255, 255, 255, 0.05);
            --button-background: linear-gradient(90deg, var(--blue), var(--pink));
            --button-shadow: 0 4px 15px var(--blue), 0 4px 15px var(--pink);

            /* NEW: Consistent theming variables from Profile.html */
            --background-color-primary: #1a1a2e;
            --background-color-secondary: #0f0f1f;
            --header-background-color: #2a2a4a;
            --footer-background-color: #2a2a4a;
            --content-background-color: #20203a;
            --card-background-color: #2a2a4a;
            --text-color-primary: #e0e0e0;
            --text-color-secondary: #b0b0d0;
            --notification-badge-color: #ff2e92;
            --status-online: #4CAF50;
            --status-offline: #6c757d;
            --status-away: #FFC107;
            --delete-button-color: #dc3545;
            --warning-color: #ffc107;
            --accent-color: #00d5ff; /* A bright cyan */
            --accent-color-dark: #00aaff;
            --border-color: #3a3a5a;

            /* Specific wallet colors */
            --jcoin-color: #ffd700; /* Gold for JCoins */
            --gas-color: #00d5ff; /* Blue for Gas/XP */
            --transaction-positive: #4CAF50; /* Green for income */
            --transaction-negative: #F44336; /* Red for expenses */
            --bonus-color: #00d5ff; /* Blue for bonus text */
            --withdraw-button-color: #28a745; /* Green for withdraw button */
            --earn-color: #ffa500; /* Orange for earning features */
        }

        /* --- Theme Definitions (Light and Dark Mode) --- */
        /* Light Mode */
        body.theme-light-mode {
            --background-main: #f0f2f5;
            --background-gradient-1: #e0e2e5;
            --background-gradient-2: #d0d2d5;
            --white: #333;
            --text-light: #666;
            --card-background: rgba(255, 255, 255, 0.95);
            --header-background: rgba(255, 255, 255, 0.98);
            --border-light: rgba(0, 0, 0, 0.1);
            --input-background: rgba(0, 0, 0, 0.05);
            --button-background: linear-gradient(90deg, #6dd5ed, #2193b0);
            --button-shadow: 0 4px 15px rgba(109, 213, 237, 0.4), 0 4px 15px rgba(33, 147, 176, 0.4);

            /* New variables override for light mode */
            --background-color-primary: #f0f2f5;
            --background-color-secondary: #e0e2e5;
            --header-background-color: #ffffff;
            --footer-background-color: #ffffff;
            --content-background-color: #f7f9fb;
            --card-background-color: #ffffff;
            --text-color-primary: #333333;
            --text-color-secondary: #666666;
            --text-color-light: #999999;
            --accent-color: #007bff;
            --accent-color-dark: #0056b3;
            --border-color: #e0e0e0;
            --input-background-color: #f0f0f0;
            --button-background: #e9ecef;
            --button-hover-background: #dee2e6;
            --active-item-background: rgba(0, 123, 255, 0.1);
            --notification-badge-color: #dc3545;
            --status-online: #28a745;
            --status-offline: #6c757d;
            --status-away: #ffc107;
            --delete-button-color: #dc3545;
            --warning-color: #ffc107;
            --withdraw-button-color: #28a745;
            --earn-color: #ff8c00;
        }

        /* Dark Mode */
        body.theme-dark-mode {
            --background-main: #1a1a2e;
            --background-gradient-1: #16213e;
            --background-gradient-2: #0f3460;
            --white: #e0e0e0;
            --text-light: #a0a0a0;
            --card-background: rgba(25, 25, 40, 0.7);
            --header-background: linear-gradient(135deg, rgba(10, 10, 20, .85), rgba(10, 10, 20, .75));
            --border-light: rgba(255, 255, 255, 0.08);
            --input-background: rgba(255, 255, 255, 0.08);
            --button-background: linear-gradient(90deg, #e94560, #ba2f49);
            --button-shadow: 0 4px 15px rgba(233, 69, 96, 0.4), 0 4px 15px rgba(186, 47, 73, 0.4);

            /* New variables override for dark mode */
            --background-color-primary: #121212;
            --background-color-secondary: #1e1e1e;
            --header-background-color: #2c2c2c;
            --footer-background-color: #2c2c2c;
            --content-background-color: #242424;
            --card-background-color: #2c2c2c;
            --text-color-primary: #ffffff;
            --text-color-secondary: #bbbbbb;
            --accent-color: #bb86fc;
            --accent-color-dark: #9a67ea;
            --border-color: #444444;
            --input-background-color: #383838;
            --button-background: #383838;
            --button-hover-background: #505050;
            --active-item-background: rgba(187, 134, 252, 0.2);
            --notification-badge-color: #cf6679;
            --delete-button-color: #f44336;
            --warning-color: #ffeb3b;
            --withdraw-button-color: #28a745;
            --earn-color: #ffb74d;
        }

        /* Glass Mode specific variables */
        body.theme-glass-mode {
            --background-main: rgba(10, 10, 10, 0.75);
            background-image: url('https://source.unsplash.com/random/1920x1080?abstract,blur') !important;
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
            backdrop-filter: blur(10px);
            --card-background: rgba(25, 25, 40, 0.7);
            --white: #e0e0e0;
            --text-light: rgba(255, 255, 255, 0.7);
            --input-background: rgba(255, 255, 255, 0.05);
            --border-light: rgba(255, 255, 255, 0.1);
            --button-background: linear-gradient(90deg, var(--pink), var(--blue));
            --button-shadow: 0 4px 15px var(--blue), 0 4px 15px var(--pink);
            box-shadow: inset 0 0 100px rgba(0, 0, 0, 0.5);

            /* New variables override for glass mode */
            --background-color-primary: rgba(10, 10, 10, 0.75);
            --background-color-secondary: rgba(10, 10, 10, 0.6);
            --header-background-color: rgba(10, 10, 10, 0.85);
            --footer-background-color: rgba(10, 10, 10, 0.85);
            --content-background-color: rgba(10, 10, 10, 0.75);
            --card-background-color: rgba(25, 25, 40, 0.7);
            --text-color-primary: #e0e0e0;
            --text-color-secondary: #b0b0d0;
            --accent-color: #00d5ff;
            --accent-color-dark: #00aaff;
            --border-color: rgba(255, 255, 255, 0.1);
            --input-background-color: rgba(255, 255, 255, 0.05);
            --button-background: rgba(0, 213, 255, 0.15);
            --button-hover-background: rgba(0, 213, 255, 0.25);
            --active-item-background: rgba(0, 213, 255, 0.1);
            --withdraw-button-color: #28a745;
            --earn-color: #ffaa00;
        }

        /* Sunset Theme */
        body.theme-sunset-mode {
            background: linear-gradient(to top, #ff7e5f, #feb47b) !important;
            --background-main: linear-gradient(to top, #ff7e5f, #feb47b);
            --card-background: rgba(255, 255, 255, 0.15);
            --white: #fff;
            --text-light: rgba(255, 255, 255, 0.8);
            --input-background: rgba(255, 255, 255, 0.1);
            --border-light: rgba(255, 255, 255, 0.3);
            --button-background: linear-gradient(90deg, #fd746c, #ff9068);
            --button-shadow: 0 4px 15px rgba(253, 116, 108, 0.4), 0 4px 15px rgba(255, 144, 104, 0.4);

            /* New variables override for sunset mode */
            --background-color-primary: #ff7e5f;
            --background-color-secondary: #feb47b;
            --header-background-color: rgba(255, 126, 95, 0.9);
            --footer-background-color: rgba(255, 126, 95, 0.9);
            --content-background-color: rgba(255, 126, 95, 0.85);
            --card-background-color: rgba(255, 255, 255, 0.15);
            --text-color-primary: #fff;
            --text-color-secondary: rgba(255, 255, 255, 0.8);
            --accent-color: #ffd700;
            --accent-color-dark: #ccaa00;
            --border-color: rgba(255, 255, 255, 0.3);
            --input-background-color: rgba(255, 255, 255, 0.1);
            --button-background: rgba(255, 255, 255, 0.2);
            --button-hover-background: rgba(255, 255, 255, 0.3);
            --active-item-background: rgba(255, 215, 0, 0.1);
            --withdraw-button-color: #28a745;
            --earn-color: #ff9800;
        }

        /* Always show scrollbar to prevent layout shifts */
        html {
            overflow-y: scroll;
        }

        body {
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
            padding-bottom: 20px; /* Reduced padding as no bottom nav */
            background-color: var(--background-main);
            background-image: radial-gradient(circle at top left, var(--background-gradient-1), transparent 100px),
                              radial-gradient(circle at bottom right, var(--background-gradient-2), transparent 150px);
            color: var(--white);
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        /* Header Styling (consistent with other JCHAT pages) */
        header {
            background: var(--header-background);
            border-bottom: 1px solid var(--border-light);
            padding: 10px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 55px;
            z-index: 10;
            display: flex;
            justify-content: center;
        }

        header .header-content-wrapper {
            display: flex;
            justify-content: space-between; /* Space between logo and profile */
            align-items: center;
            width: 100%;
            max-width: 1200px;
            padding: 0 30px;
        }

        .logo {
            font-family: 'Poppins', sans-serif;
            font-size: 1.8rem;
            font-weight: 800;
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            letter-spacing: -0.03em;
            text-decoration: none;
        }

        /* Removed header nav styling */

        .user-profile-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-profile-header #profileLink {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: var(--white);
            transition: opacity 0.3s ease, background-color 0.3s ease;
            padding: 5px 10px;
            border-radius: var(--radius);
        }

        .user-profile-header #profileLink:hover {
            opacity: 0.8;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .user-profile-header img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--blue);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: opacity 0.3s ease;
        }

        .user-profile-header i {
            font-size: 30px;
            color: var(--text-light);
        }

        .user-profile-header span {
            font-weight: 600;
            font-size: 1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
        }

        /* Removed adminIconLink styling */

        /* Main Content Area */
        main {
            flex-grow: 1;
            padding: 40px 0;
            padding-top: 55px; /* Adjust for fixed header */
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            text-align: center;
        }

        .content-wrapper {
            width: 100%;
            max-width: 800px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
        }

        /* Wallet Section Styling */
        .wallet-section {
            background: var(--card-background);
            border: 1px solid var(--glass-blue);
            backdrop-filter: blur(10px) saturate(180%);
            border-radius: var(--radius);
            box-shadow: 0 8px 25px rgba(0, 0, 0, .3);
            padding: 2rem;
            width: 90%;
            max-width: 600px;
            margin: 20px auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
            text-align: center;
        }

        .wallet-section h1 {
            font-family: 'Poppins', sans-serif;
            font-size: 2.5rem;
            font-weight: 800;
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            margin: 0;
        }

        .balance-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-top: 1rem;
            padding: 15px 25px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            border: 1px solid var(--border-light);
            width: 100%;
        }

        .balance-label {
            font-size: 1.1rem;
            color: var(--text-light);
            font-weight: 600;
        }

        .jcoin-value {
            font-family: 'Poppins', sans-serif;
            font-size: 3.5rem;
            font-weight: 800;
            color: var(--jcoin-color); /* Gold color for JCoins */
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            line-height: 1;
        }

        .gas-value { /* NEW: Style for Gas/XP value */
            font-family: 'Poppins', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--gas-color); /* Blue for Gas */
            text-shadow: 0 0 8px rgba(0, 213, 255, 0.5);
            line-height: 1;
            margin-top: 10px; /* Space between JCoins and Gas */
        }

        .usd-value {
            font-size: 1.5rem;
            color: var(--white);
            font-weight: 700;
            margin-top: 5px;
        }

        .wallet-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .wallet-action-button {
            background: var(--button-background);
            color: var(--white);
            border: none;
            border-radius: 15px;
            padding: 0.8rem 1.5rem;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: var(--button-shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .wallet-action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--blue), 0 6px 20px var(--pink);
        }

        .wallet-action-button.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--white);
            border: 1px solid var(--border-light);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
        }

        .wallet-action-button.secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .transaction-history-section {
            width: 100%;
            margin-top: 2rem;
            text-align: left;
        }

        .transaction-history-section h2 {
            font-family: 'Poppins', sans-serif;
            font-size: 1.8rem;
            font-weight: 700;
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            margin-bottom: 1rem;
            text-align: center;
        }

        /* NEW: Transaction Filters and Search */
        .transaction-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
            width: 100%;
        }
        .transaction-controls select,
        .transaction-controls input[type="text"] {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--border-light);
            background-color: var(--input-background);
            color: var(--white);
            font-size: 0.9rem;
            outline: none;
            flex-grow: 1;
            max-width: 250px;
        }
        .transaction-controls select option {
            background-color: var(--input-background);
            color: var(--white);
        }

        .transaction-list {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-light);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .transaction-item {
            display: flex;
            flex-direction: column; /* Stack details vertically */
            align-items: flex-start;
            padding: 10px 0;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.05);
            cursor: pointer; /* Make clickable */
            transition: background-color 0.2s ease;
        }
        .transaction-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-header {
            display: flex;
            justify-content: space-between;
            width: 100%;
            align-items: center;
            margin-bottom: 5px;
        }

        .transaction-description {
            font-size: 0.95rem;
            color: var(--white);
            font-weight: 600;
        }

        .transaction-amount {
            font-size: 1rem;
            font-weight: 700;
            margin-left: 15px;
            white-space: nowrap;
        }

        .transaction-amount.positive {
            color: var(--transaction-positive);
        }

        .transaction-amount.negative {
            color: var(--transaction-negative);
        }

        .transaction-timestamp {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 0px;
        }

        .no-transactions-message {
            text-align: center;
            color: var(--text-light);
            padding: 20px;
        }

        /* Buy JCoins Panel Styles */
        .buy-jcoins-panel {
            background: var(--card-background);
            border: 1px solid var(--glass-blue);
            backdrop-filter: blur(10px) saturate(180%);
            border-radius: var(--radius);
            box-shadow: 0 8px 25px rgba(0, 0, 0, .3);
            padding: 2rem;
            width: 90%;
            max-width: 600px;
            margin: 20px auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
            text-align: center;
        }

        .buy-jcoins-panel h2 {
            font-family: 'Poppins', sans-serif;
            font-size: 2rem;
            font-weight: 700;
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            margin-top: 0;
        }

        .bank-details-section {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            border: 1px solid var(--border-light);
            display: grid;
            grid-template-columns: 1fr;
            row-gap: 6px;
        }

        .bank-details-section h3 {
            font-family: 'Poppins', sans-serif;
            font-size: 1.2rem;
            color: var(--jcoin-color);
            margin-top: 0;
            margin-bottom: 10px;
        }

        .bank-details-section p {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-bottom: 5px;
        }

        .bank-details-section .copy-button {
            background: rgba(255, 255, 255, 0.1);
            color: var(--white);
            border: 1px solid var(--border-light);
            border-radius: 6px;
            padding: 6px 12px;
            cursor: pointer;
            transition: transform 0.15s ease, background 0.2s ease;
            font-size: 0.75rem;
            margin-left: 10px;
        }

        .bank-details-section .copy-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .bank-logo {
            background: rgba(255,255,255,0.6);
            border-radius: 6px;
            padding: 4px 6px;
        }

        @media (max-width: 768px) {
            .package-bonus {
                font-size: 0.75rem;
            }
            .bank-details-section h3, .bank-details-form h3 {
                font-size: 1.1rem;
            }
            .bank-details-section p, .bank-details-form .input-group label {
                font-size: 0.85rem;
            }
            .bank-details-section .copy-button {
                padding: 6px 10px;
                font-size: 0.7rem;
            }
        }

        /* Manual Buy Section Styles */
        .manual-buy-section {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            padding: 20px;
            width: 100%;
            text-align: center;
            border: 1px solid var(--border-light);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .manual-buy-section h3 {
            font-family: 'Poppins', sans-serif;
            font-size: 1.5rem;
            color: var(--jcoin-color);
            margin-top: 0;
            margin-bottom: 5px;
        }

        .manual-buy-section .input-group {
            text-align: left;
        }

        .manual-buy-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-light);
        }

        .manual-buy-section input[type="number"],
        .manual-buy-section input[type="text"] { /* Added text type for bank details */
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            background-color: var(--input-background);
            color: var(--white);
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .manual-buy-section input[type="number"]:focus,
        .manual-buy-section input[type="text"]:focus {
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(0, 213, 255, 0.2);
        }

        /* NEW: File input wrapper for receipt */
        .file-input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--input-background);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 12px 15px;
            cursor: pointer;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .file-input-wrapper:hover {
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(0, 213, 255, 0.2);
        }
        .file-input-wrapper i {
            color: var(--text-light);
        }
        .file-name {
            flex-grow: 1;
            color: var(--text-light);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .receipt-preview {
            max-width: 100px;
            max-height: 100px;
            border-radius: 8px;
            object-fit: cover;
            margin-top: 10px;
            border: 1px solid var(--border-light);
            display: none; /* Hidden by default */
        }


        .manual-buy-section .whatsapp-info {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .manual-buy-section .whatsapp-info a {
            color: var(--bonus-color);
            text-decoration: none;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: color 0.2s ease;
        }

        .manual-buy-section .whatsapp-info a:hover {
            color: var(--pink);
        }


        .calculated-jcoins {
            margin-top: 10px;
            padding: 10px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.03);
        }

        .calculated-jcoins p {
            margin: 5px 0;
            font-size: 1rem;
            color: var(--white);
        }

        .calculated-jcoins #calculatedJCoins {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--jcoin-color);
        }

        .calculated-jcoins #calculatedBonus {
            font-size: 0.9rem;
            color: var(--bonus-color);
            font-weight: 600;
        }
        .calculated-jcoins #calculatedBonus.no-bonus {
            color: var(--text-light);
            font-weight: 400;
        }

        /* JCoin Packages Grid (for pre-defined options) */
        .jcoin-packages-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            width: 100%;
            margin-top: 1.5rem;
        }

        .jcoin-package-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-light);
            border-radius: 15px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .jcoin-package-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
            background: rgba(255, 255, 255, 0.1);
        }

        .package-price {
            font-family: 'Poppins', sans-serif;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--white);
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .package-jcoins {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--jcoin-color);
        }

        .package-bonus {
            font-size: 0.85rem;
            color: var(--bonus-color);
            font-weight: 600;
        }
        .package-bonus.no-bonus {
            color: var(--text-light);
            font-weight: 400;
        }

        /* NEW: Earn JCoins Section */
        .earn-jcoins-section {
            background: var(--card-background);
            border: 1px solid var(--glass-blue);
            backdrop-filter: blur(10px) saturate(180%);
            border-radius: var(--radius);
            box-shadow: 0 8px 25px rgba(0, 0, 0, .3);
            padding: 2rem;
            width: 90%;
            max-width: 600px;
            margin: 20px auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
            text-align: center;
        }
        .earn-jcoins-section h2 {
            font-family: 'Poppins', sans-serif;
            font-size: 2rem;
            font-weight: 700;
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--earn-color), var(--jcoin-color));
            margin-top: 0;
        }
        .earn-opportunities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            width: 100%;
        }
        .earn-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-light);
            border-radius: 15px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            text-align: center;
        }
        .earn-card i {
            font-size: 2.5rem;
            color: var(--earn-color);
        }
        .earn-card h3 {
            font-size: 1.2rem;
            color: var(--white);
            margin: 0;
        }
        .earn-card p {
            font-size: 0.9rem;
            color: var(--text-light);
            margin: 0;
        }
        .earn-card .earn-reward {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--jcoin-color);
        }
        .earn-card button {
            background: linear-gradient(90deg, var(--earn-color), var(--jcoin-color));
            color: var(--white);
            border: none;
            border-radius: 10px;
            padding: 0.6rem 1.2rem;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, opacity 0.2s ease;
        }
        .earn-card button:hover:not(:disabled) {
            transform: translateY(-2px);
            opacity: 0.9;
        }
        .earn-card button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background: var(--text-light);
        }

        /* NEW: Withdrawal Section Styles */
        .withdrawal-section {
            background: var(--card-background);
            border: 1px solid var(--glass-blue);
            backdrop-filter: blur(10px) saturate(180%);
            border-radius: var(--radius);
            box-shadow: 0 8px 25px rgba(0, 0, 0, .3);
            padding: 2rem;
            width: 90%;
            max-width: 600px;
            margin: 20px auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
            text-align: center;
        }

        .withdrawal-section h2 {
            font-family: 'Poppins', sans-serif;
            font-size: 2rem;
            font-weight: 700;
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--pink), var(--blue)); /* Reversed gradient for contrast */
            margin-top: 0;
        }

        .withdrawal-info {
            font-size: 1rem;
            color: var(--text-light);
            margin-bottom: 1rem;
            font-weight: 600; /* Make it bold */
        }

        .withdrawal-info strong {
            color: var(--jcoin-color);
            font-size: 1.1rem;
        }

        .withdrawal-button {
            background-color: var(--withdraw-button-color); /* Green color */
            color: var(--white);
            border: none;
            border-radius: 15px;
            padding: 0.8rem 1.5rem;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4); /* Green shadow */
            transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 1rem;
        }

        .withdrawal-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.6);
        }

        .withdrawal-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
            /* Optional: Add a specific background for disabled pending state */
            background-color: #6c757d; /* Grey out when disabled */
        }

        .withdrawal-message {
            font-size: 0.9rem;
            color: var(--warning-color);
            margin-top: 10px;
            font-weight: 600;
            display: none; /* Hidden by default */
        }
        .withdrawal-message.show {
            display: block;
        }


        /* Bank Details Form */
        .bank-details-form {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            padding: 20px;
            width: 100%;
            text-align: left;
            border: 1px solid var(--border-light);
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 1rem;
        }

        .bank-details-form h3 {
            font-family: 'Poppins', sans-serif;
            font-size: 1.5rem;
            color: var(--jcoin-color);
            margin-top: 0;
            margin-bottom: 5px;
            text-align: center;
        }

        .bank-details-form .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-light);
        }

        .bank-details-form .input-group input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            background-color: var(--input-background);
            color: var(--white);
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .bank-details-form .input-group input:focus {
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(0, 213, 255, 0.2);
        }

        .bank-details-form .save-button {
            background: linear-gradient(90deg, var(--blue), var(--pink));
            color: var(--white);
            border: none;
            border-radius: 15px;
            padding: 0.8rem 1.5rem;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: var(--button-shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            margin-top: 1rem;
        }

        .bank-details-form .save-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--blue), 0 6px 20px var(--pink);
        }
        .bank-details-form .save-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* NEW: Withdrawal History Section */
        .withdrawal-history-section {
            width: 100%;
            margin-top: 2rem;
            text-align: left;
        }

        .withdrawal-history-section h3 {
            font-family: 'Poppins', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--pink), var(--blue));
            margin-bottom: 1rem;
            text-align: center;
        }

        .withdrawal-list {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            padding: 15px;
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid var(--border-light);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .withdrawal-item {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 10px 0;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.05);
        }

        .withdrawal-item:last-child {
            border-bottom: none;
        }

        .withdrawal-item-header {
            display: flex;
            justify-content: space-between;
            width: 100%;
            align-items: center;
            margin-bottom: 5px;
        }

        .withdrawal-amount-display {
            font-size: 1rem;
            font-weight: 700;
            color: var(--jcoin-color);
        }

        .withdrawal-status {
            font-size: 0.9rem;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 5px;
            text-transform: capitalize;
        }
        .withdrawal-status.pending { background-color: var(--warning-color); color: #333; }
        .withdrawal-status.completed { background-color: var(--transaction-positive); color: #fff; }
        .withdrawal-status.rejected { background-color: var(--transaction-negative); color: #fff; }

        .withdrawal-details {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        /* Custom Message Box Styles (consistent with other JCHAT pages) */
        #messageBox {
            position: fixed;
            top: 50%; /* Center vertically */
            left: 50%;
            transform: translate(-50%, -50%); /* Center both horizontally and vertically */
            background-color: var(--card-background-color); /* Default background, will be overridden for success */
            color: var(--text-color-primary); /* Default text color */
            padding: 20px 30px; /* Increased padding for a more substantial box */
            border-radius: 15px; /* More rounded corners, slightly squarer */
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4); /* Enhanced shadow */
            z-index: 1000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            min-width: 280px; /* Ensure a decent minimum width */
            max-width: 90%;
            text-align: center;
            flex-direction: column; /* Stack icon and text vertically */
            align-items: center;
            gap: 15px; /* Space between icon and text */
        }
        #messageBox.show {
            opacity: 1;
            display: flex;
        }
        /* Success message box specific styling */
        #messageBox.success {
            background-image: linear-gradient(45deg, var(--pink), var(--blue)); /* Pink and blue gradient */
            color: var(--white); /* White text for contrast on gradient */
            border: none; /* No border for gradient background */
            box-shadow: 0 8px 30px rgba(0, 213, 255, 0.5), 0 8px 30px rgba(255, 46, 146, 0.5); /* Glowing shadow */
        }
        #messageBox.error { border-left: 5px solid var(--delete-button-color); background-color: var(--card-background-color); color: var(--text-color-primary); }
        #messageBox.info { border-left: 5px solid var(--accent-color); background-color: var(--card-background-color); color: var(--text-color-primary); }
        #messageBox.warning { border-left: 5px solid var(--warning-color); background-color: var(--card-background-color); color: var(--text-color-primary); }

        #messageBox i {
            font-size: 2.5rem; /* Larger icon for prominence */
            margin-bottom: 5px; /* Space between icon and text */
            /* Apply gradient to message box icons */
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent; /* Fallback */
        }
        #messageBox.success i { color: var(--white); } /* White icon for success */
        #messageBox.error i { color: var(--delete-button-color); }
        #messageBox.info i { color: var(--accent-color); }
        #messageBox.warning i { color: var(--warning-color); }

        #messageBox span {
            font-size: 1.1rem; /* Slightly larger text */
            font-weight: 600;
        }

        @keyframes pulse-bg {
            0% { background-color: var(--accent-color); }
            50% { background-color: rgba(0, 213, 255, 0.7); }
            100% { background-color: var(--accent-color); }
        }
        #messageBox.loading-pulse { animation: pulse-bg 1.5s infinite ease-in-out; }

        /* Loader styles for buttons (consistent with other JCHAT pages) */
        .button-loader {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid var(--white);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: none;
            flex-shrink: 0;
        }
        .button-loader.active { display: block; }
        .button-text { display: block; }
        .loading .button-text { display: none; }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* NEW: Send JCoins Modal Styles */
        #sendJCoinsModal.modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            position: fixed; /* Ensure it covers the whole screen */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000; /* Ensure it's on top of other content */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        #sendJCoinsModal.modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        #sendJCoinsModal .modal-content {
            max-width: 450px;
            text-align: left;
            background: var(--card-background);
            border: 1px solid var(--glass-blue);
            backdrop-filter: blur(10px) saturate(180%);
            border-radius: var(--radius);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }
        #sendJCoinsModal.modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        #sendJCoinsModal .modal-content h3 {
            text-align: center;
            margin-bottom: 1.5rem;
            font-family: 'Poppins', sans-serif;
            font-size: 1.8rem;
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        #sendJCoinsModal .modal-content h3 i {
            margin-right: 10px;
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        #sendJCoinsModal .modal-content .input-group {
            margin-bottom: 1rem;
        }
        #sendJCoinsModal .modal-content .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-light);
        }
        #sendJCoinsModal .modal-content .input-group input[type="text"],
        #sendJCoinsModal .modal-content .input-group input[type="number"] {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            background-color: var(--input-background);
            color: var(--white);
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        #sendJCoinsModal .modal-content .input-group input[type="text"]:focus,
        #sendJCoinsModal .modal-content .input-group input[type="number"]:focus {
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(0, 213, 255, 0.2);
        }
        #sendJCoinsModal .modal-content .current-balance-info {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-top: 5px;
            text-align: right;
        }
        #sendJCoinsModal .modal-content .current-balance-info span {
            font-weight: 700;
            color: var(--jcoin-color);
        }
        #sendJCoinsModal .modal-content .button-group {
            display: flex;
            gap: 15px;
            margin-top: 1.5rem;
            justify-content: center;
        }
        #sendJCoinsModal .modal-content .modal-button {
            flex: 1;
            padding: 10px 20px;
            border: none;
            border-radius: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        #sendJCoinsModal .modal-content .modal-button.confirm-button {
            background: linear-gradient(90deg, var(--blue), var(--pink));
            color: var(--white);
            box-shadow: 0 4px 15px var(--blue), 0 4px 15px var(--pink);
        }
        #sendJCoinsModal .modal-content .modal-button.confirm-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--blue), 0 6px 20px var(--pink);
        }
        #sendJCoinsModal .modal-content .modal-button.cancel-button {
            background: rgba(255, 255, 255, 0.1);
            color: var(--white);
            border: 1px solid var(--border-light);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
        }
        #sendJCoinsModal .modal-content .modal-button.cancel-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        /* NEW: 2FA Confirmation Modal Styles */
        #twoFAModal.modal-overlay {
            background-color: rgba(0, 0, 0, 0.7);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001; /* Higher than other modals */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        #twoFAModal.modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        #twoFAModal .modal-content {
            max-width: 380px;
            text-align: center;
            background: var(--card-background);
            border: 1px solid var(--glass-blue);
            backdrop-filter: blur(10px) saturate(180%);
            border-radius: var(--radius);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6);
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }
        #twoFAModal.modal-overlay.active .modal-content {
            transform: translateY(0);
        }
        #twoFAModal .modal-content h3 {
            font-family: 'Poppins', sans-serif;
            font-size: 1.6rem;
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1rem;
        }
        #twoFAModal .modal-content p {
            color: var(--text-light);
            font-size: 0.95rem;
            margin-bottom: 1rem;
        }
        #twoFAModal .modal-content input[type="password"] {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            background-color: var(--input-background);
            color: var(--white);
            font-size: 1rem;
            outline: none;
            text-align: center;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        #twoFAModal .modal-content input[type="password"]:focus {
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(0, 213, 255, 0.2);
        }
        #twoFAModal .modal-content .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 1rem;
        }
        #twoFAModal .modal-content .modal-button {
            flex: 1;
            padding: 10px 20px;
            border: none;
            border-radius: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        #twoFAModal .modal-content .modal-button.confirm-button {
            background: linear-gradient(90deg, var(--blue), var(--pink));
            color: var(--white);
            box-shadow: 0 4px 15px var(--blue), 0 4px 15px var(--pink);
        }
        #twoFAModal .modal-content .modal-button.confirm-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--blue), 0 6px 20px var(--pink);
        }
        #twoFAModal .modal-content .modal-button.cancel-button {
            background: rgba(255, 255, 255, 0.1);
            color: var(--white);
            border: 1px solid var(--border-light);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
        }
        #twoFAModal .modal-content .modal-button.cancel-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        /* NEW: Transaction Details Modal */
        #transactionDetailsModal.modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        #transactionDetailsModal.modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        #transactionDetailsModal .modal-content {
            max-width: 450px;
            text-align: left;
            background: var(--card-background);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid var(--border-light);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            transform: translateY(10px);
            transition: transform 0.3s ease;
        }
        #transactionDetailsModal.modal-overlay.active .modal-content {
            transform: translateY(0);
        }
        
        /* NEW: Receive Modal */
        #receiveJCoinsModal.modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        #receiveJCoinsModal.modal-overlay.active { opacity: 1; visibility: visible; }
        #receiveJCoinsModal .modal-content {
            max-width: 420px;
            text-align: center;
            background: var(--card-background);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid var(--border-light);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            transform: translateY(10px);
            transition: transform 0.3s ease;
        }
        #receiveJCoinsModal.modal-overlay.active .modal-content { transform: translateY(0); }
        #receiveJCoinsModal .modal-content h3 {
            margin-bottom: 1rem;
            background: linear-gradient(90deg, var(--blue), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .transaction-controls input[type="date"] {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--border-light);
            background: var(--input-background);
            color: var(--white);
        }

        /* Responsive Adjustments (consistent with other JCHAT pages) */
        @media (max-width: 600px) {
            header .header-content-wrapper {
                padding: 0 20px;
            }
            .logo {
                font-size: 1.6rem;
            }
            /* Removed header nav ul styling */
            .user-profile-header #profileLink {
                padding: 5px;
            }
            .user-profile-header span {
                max-width: 90px;
            }
            .user-profile-header img {
                width: 30px;
                height: 30px;
            }
            .user-profile-header i {
                font-size: 25px;
            }
            .wallet-section, .buy-jcoins-panel, .withdrawal-section, .earn-jcoins-section {
                padding: 1.5rem;
            }
            .wallet-section h1, .buy-jcoins-panel h2, .withdrawal-section h2, .earn-jcoins-section h2 {
                font-size: 2rem;
            }
            .jcoin-value {
                font-size: 2.8rem;
            }
            .gas-value {
                font-size: 2rem;
            }
            .usd-value {
                font-size: 1.2rem;
            }
            .wallet-action-button, .withdrawal-button, .bank-details-form .save-button {
                padding: 0.7rem 1.2rem;
                font-size: 0.8rem;
            }
            .transaction-history-section h2, .withdrawal-history-section h3 {
                font-size: 1.5rem;
            }
            .transaction-description, .withdrawal-details {
                font-size: 0.85rem;
            }
            .transaction-amount, .withdrawal-amount-display {
                font-size: 0.9rem;
            }
            .jcoin-packages-grid, .earn-opportunities-grid {
                grid-template-columns: 1fr; /* Stack packages on small screens */
            }
            .package-price {
                font-size: 1.5rem;
            }
            .package-jcoins {
                font-size: 1rem;
            }
            .package-bonus {
                font-size: 0.75rem;
            }
            .bank-details-section h3, .bank-details-form h3 {
                font-size: 1.1rem;
            }
            .bank-details-section p, .bank-details-form .input-group label {
                font-size: 0.85rem;
            }
            .bank-details-section .copy-button {
                padding: 6px 10px;
                font-size: 0.7rem;
            }
            /* Removed bottom nav bar and toggle button responsive styling */
            body {
                padding-bottom: 20px; /* Adjusted for no bottom nav */
            }
            #sendJCoinsModal .modal-content, #twoFAModal .modal-content, #transactionDetailsModal .modal-content {
                padding: 20px;
            }
            #sendJCoinsModal .modal-content h3, #twoFAModal .modal-content h3, #transactionDetailsModal .modal-content h3 {
                font-size: 1.5rem;
            }
            #sendJCoinsModal .modal-content .modal-button, #twoFAModal .modal-content .modal-button, #transactionDetailsModal .modal-content .close-button {
                padding: 0.7rem 1.2rem;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body class="theme-dark-mode">

    <header>
        <div class="header-content-wrapper">
            <a href="#" class="logo">JCHAT</a> <!-- Changed to # as no home.html link -->
            <!-- Removed nav element -->
            <div class="user-profile-header">
                <!-- Removed adminIconLink -->
                <a href="Profile.html" id="profileLink">
                    <img id="headerProfilePic" src="" alt="Profile Picture" style="display: none;">
                    <i id="headerAvatarIcon" class="fas fa-user-circle"></i>
                    <span id="headerDisplayName">Loading...</span>
                </a>
            </div>
        </div>
    </header>

    <main>
        <div class="content-wrapper">
            <div class="wallet-section">
                <h1>My JCHAT Wallet</h1>
                <p style="color: var(--text-light); font-size: 0.9rem; opacity: 0.8;">
                    Your personal JCoin balance and transaction history.
                </p>

                <div class="balance-display">
                    <span class="balance-label">Current Balance</span>
                    <span id="jcoinBalance" class="jcoin-value">0</span>
                    <span id="gasBalance" class="gas-value">0 Gas (XP)</span>
                    <span id="usdBalance" class="usd-value"></span>
                </div>

                                    <div class="wallet-buttons">
                        <button id="sendJCoinsButton" class="wallet-action-button">
                            <i class="fas fa-paper-plane"></i> Send JCoins
                        </button>
                        <button id="receiveJCoinsButton" class="wallet-action-button secondary">
                            <i class="fas fa-qrcode"></i> Receive JCoins
                        </button>
                        <a href="#" id="requestJCoinsLink" class="wallet-action-button secondary"> <!-- Changed to # -->
                            <i class="fas fa-coins"></i> Request JCoins
                        </a>
                    </div>

                <div class="transaction-history-section">
                    <h2>Transaction History</h2>
                    <!-- Simplified: filters/exports removed -->
                    <div id="transactionList" class="transaction-list">
                        <p class="no-transactions-message" id="noTransactionsMessage">No transactions yet.</p>
                    </div>
                    <!-- Load more removed -->
                </div>
            </div>

            <!-- Buy JCoins Panel -->
            <div class="buy-jcoins-panel">
                <h2>Buy JCoins</h2>
                <p style="color: var(--text-light); font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem;">
                    Pay via OPay, then submit your receipt below.
                </p>

                <div class="bank-details-section">
                    <h3>OPay Details</h3>
                    <div style="display:flex;align-items:center;gap:8px;"><i class="fas fa-university" style="font-size:20px;color:var(--jcoin-color);"></i><span><strong>Bank:</strong> OPay</span></div>
                    <p><strong>Account Name:</strong> ELECHI JOSHUA</p>
                    <p>
                        <strong>Account Number:</strong> <span id="bankAccountNumber">8111609765</span>
                        <button class="copy-button" onclick="copyToClipboard('8111609765')">Copy</button>
                    </p>
                    <p>
                        <strong>Reference:</strong> Your JCHAT User ID (<span id="userReferenceId">Loading...</span>)
                        <button class="copy-button" onclick="copyToClipboard(document.getElementById('userReferenceId').textContent)">Copy</button>
                    </p>
                </div>

                <div class="bank-details-section" style="margin-top:12px;">
                    <h3>Bank Transfer (Keystone Bank)</h3>
                    <div style="display:flex;align-items:center;gap:8px;"><i class="fas fa-university" style="font-size:20px;color:var(--jcoin-color);"></i><span><strong>Bank:</strong> Keystone Bank</span></div>
                    <p><strong>Account Name:</strong> ELECHI OSOUNDU JOSHUA</p>
                    <p>
                        <strong>Account Number:</strong> <span>6042862356</span>
                        <button class="copy-button" onclick="copyToClipboard('6042862356')">Copy</button>
                    </p>
                    <p>
                        <strong>Reference:</strong> Your JCHAT User ID (<span id="userReferenceId">Loading...</span>)
                        <button class="copy-button" onclick="copyToClipboard(document.getElementById('userReferenceId').textContent)">Copy</button>
                    </p>
                    <p style="font-size:0.9rem;color:var(--text-light);">After payment, upload your receipt below and tap "Send Purchase Request".</p>
                </div>

                <!-- Manual Buy Section -->
                <div class="manual-buy-section">
                    <h3>Submit Receipt</h3>
                    <div class="input-group">
                        <label for="nairaInput">Amount Paid (NGN):</label>
                        <input type="number" id="nairaInput" min="200" step="1" placeholder="e.g., 200, 1000, 5000">
                    </div>
                    <!-- Receipt Upload Input -->
                    <div class="input-group">
                        <label for="receiptUploadInput">Upload Payment Receipt:</label>
                        <div class="file-input-wrapper">
                            <input type="file" id="receiptUploadInput" accept="image/*" style="display: none;">
                            <i class="fas fa-upload"></i>
                            <span class="file-name" id="receiptFileName">No file chosen</span>
                        </div>
                        <img id="receiptPreview" class="receipt-preview" style="display: none;">
                    </div>
                    <div class="calculated-jcoins">
                        <p>You will get: <span id="calculatedJCoins">0</span> JCoins</p>
                        <p id="calculatedBonus" class="package-bonus no-bonus">No Bonus</p>
                    </div>
                    <button id="sendManualBuyRequestButton" class="wallet-action-button">
                        <span class="button-text">Send Purchase Request</span>
                        <div class="button-loader"></div>
                    </button>
                    <div class="whatsapp-info">
                        <p style="font-weight:600;">Need help?</p>
                        <div style="display:flex;flex-direction:column;gap:6px;">
                            <a href="mailto:jchatguide@gmail.com" target="_blank"><i class="fas fa-envelope"></i> jchatguide@gmail.com</a>
                            <a href="https://wa.me/2348111609765" target="_blank"><i class="fab fa-whatsapp"></i> WhatsApp +2348111609765</a>
                            <a href="tel:+2349013790707"><i class="fas fa-phone"></i> Phone +2349013790707</a>
                        </div>
                    </div>
                </div>
                <!-- End Manual Buy Section -->

                <!-- Packages removed for simplicity -->
            </div>
            <!-- END Buy JCoins Panel -->

            <!-- Earn/Withdraw removed for simplicity -->
        </div>
    </main>

    <!-- Custom Message Box -->
    <div id="messageBox"></div>

    <!-- NEW: Send JCoins Modal -->
    <div id="sendJCoinsModal" class="modal-overlay">
        <div class="modal-content">
            <h3><i class="fas fa-paper-plane"></i> Send JCoins</h3>
            <p style="color: var(--text-light); font-size: 0.9rem; text-align: center;">
                Transfer JCoins to another JCHAT user.
            </p>
            <div class="input-group">
                <label for="recipientIdInput">Recipient User ID:</label>
                <input type="text" id="recipientIdInput" placeholder="Enter recipient's User ID (e.g., 123abc456def)">
            </div>
            <div class="input-group">
                <label for="sendAmountInput">Amount to Send:</label>
                <input type="number" id="sendAmountInput" min="1" step="1" placeholder="e.g., 10, 50, 100">
                <p class="current-balance-info">Your Balance: <span id="yourJCoinsBalance">0</span> JCoins</p>
            </div>
            <div class="button-group">
                <button id="cancelSendJCoins" class="modal-button cancel-button">Cancel</button>
                <button id="confirmSendJCoins" class="modal-button confirm-button">
                    <span class="button-text">Send JCoins</span>
                    <div class="button-loader"></div>
                </button>
            </div>
        </div>
    </div>

    <!-- NEW: 2FA Confirmation Modal -->
    <div id="twoFAModal" class="modal-overlay">
        <div class="modal-content">
            <h3>Confirm Action</h3>
            <p id="twoFAModalMessage">Please confirm your action.</p>
            <div class="input-group">
                <label for="twoFAPasswordInput">Enter your JCHAT password:</label>
                <input type="password" id="twoFAPasswordInput" placeholder="Your password" autocomplete="current-password">
            </div>
            <div class="button-group">
                <button id="cancelTwoFA" class="modal-button cancel-button">Cancel</button>
                <button id="confirmTwoFA" class="modal-button confirm-button">
                    <span class="button-text">Confirm</span>
                    <div class="button-loader"></div>
                </button>
            </div>
        </div>
    </div>

    <!-- NEW: Receive JCoins Modal -->
    <div id="receiveJCoinsModal" class="modal-overlay">
        <div class="modal-content">
            <h3><i class="fas fa-qrcode"></i> Receive JCoins</h3>
            <p style="color: var(--text-light); font-size: 0.9rem; text-align: center;">
                Share this QR or your User ID to receive JCoins.
            </p>
            <div style="display:flex;flex-direction:column;align-items:center;gap:12px;">
                <canvas id="receiveQrCanvas" width="220" height="220" style="background:rgba(255,255,255,0.05);border-radius:12px;padding:10px;"></canvas>
                <p style="font-size:0.9rem;color:var(--text-light);">Your User ID: <span id="receiveUserId">-</span> <button id="copyReceiveUserId" class="copy-button" style="padding:4px 8px;">Copy</button></p>
                <div class="button-group" style="width:100%;">
                    <button id="downloadQrPng" class="modal-button confirm-button"><i class="fas fa-download"></i> Download PNG</button>
                    <button id="closeReceiveModal" class="modal-button cancel-button">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW: Transaction Details Modal -->
    <div id="transactionDetailsModal" class="modal-overlay">
        <div class="modal-content">
            <h3>Transaction Details</h3>
            <p><strong>Type:</strong> <span id="detailType"></span></p>
            <p><strong>Amount:</strong> <span id="detailAmount"></span> JCoins</p>
            <p><strong>ID:</strong> <span id="detailId"></span> <button id="copyDetailIdBtn" class="copy-button" style="padding:4px 8px;">Copy</button></p>
            <p><strong>Description:</strong> <span id="detailDescription"></span></p>
            <p><strong>Date:</strong> <span id="detailTimestamp"></span></p>
            <p id="detailStatusContainer" style="display: none;"><strong>Status:</strong> <span id="detailStatus"></span></p>
            <p id="detailReceiptContainer" style="display: none;"><strong>Receipt:</strong> <a id="detailReceiptLink" href="#" target="_blank">View Receipt</a></p>
            <button class="close-button" onclick="hideTransactionDetailsModal()">Close</button>
        </div>
    </div>


    <!-- Removed Bottom Navigation Bar -->
    <!-- Removed Navigation Toggle Button -->

    <!-- Tone.js for sound effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <script>
      console.log('JCHAT_DEBUG: Wallet bootstrap');
      window.addEventListener('error', function(e){ try { console.error('JCHAT_GLOBAL_ERROR:', e.message || e, e.error && e.error.stack); } catch(_) {} });
      window.addEventListener('unhandledrejection', function(e){ try { console.error('JCHAT_GLOBAL_UNHANDLED:', e.reason); } catch(_) {} });
    </script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithCustomToken, signInAnonymously, reauthenticateWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, orderBy, onSnapshot, addDoc, serverTimestamp, where, runTransaction, limit, startAfter, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // Currency helpers fallback + dynamic import
        window.userCurrency = window.userCurrency || { code: 'USD', symbol: '$', label: 'USD' };
        let userCurrency = window.userCurrency;
        let setUserCurrencyFromProfile = function(_) { window.userCurrency = window.userCurrency || userCurrency; return window.userCurrency; };
        let formatLocalCurrency = function(amount) {
            const uc = (window.userCurrency && typeof window.userCurrency === 'object') ? window.userCurrency : userCurrency;
            try { return new Intl.NumberFormat(undefined, { style: 'currency', currency: uc.code }).format(Number(amount)); }
            catch (_) { return `${uc.symbol}${Number(amount).toFixed(2)} ${uc.label}`; }
        };
        let applyCurrencyDisplayForWallet = function(grid){
            const amountLabel = document.querySelector('label[for="nairaInput"]');
            if (amountLabel) amountLabel.textContent = (userCurrency.code === 'NGN') ? 'Amount Paid (NGN):' : 'Amount Paid';
        };
        let inferCountryCodeFromProfileOrLocale = function(profile){
            try {
                const pref = localStorage.getItem('jchat-currency-preference');
                if (pref && pref !== 'AUTO') return pref === 'NGN' ? 'NG' : null;
                const raw = (profile?.country || '').toString().trim().toLowerCase();
                if (raw && (raw==='ng' || raw==='ngn' || raw==='nigeria' || raw.includes('nigeria'))) return 'NG';
                const lang = navigator.language || '';
                const m = lang.match(/-([A-Z]{2})$/); if (m && m[1]) return m[1];
            } catch(_){}
            return null;
        };
        (async () => {
            try {
                const mod = await import('/currency.js');
                userCurrency = mod.userCurrency || userCurrency; window.userCurrency = userCurrency;
                setUserCurrencyFromProfile = mod.setUserCurrencyFromProfile || setUserCurrencyFromProfile;
                formatLocalCurrency = mod.formatLocalCurrency || formatLocalCurrency;
                applyCurrencyDisplayForWallet = mod.applyCurrencyDisplayForWallet || applyCurrencyDisplayForWallet;
                inferCountryCodeFromProfileOrLocale = mod.inferCountryCodeFromProfileOrLocale || inferCountryCodeFromProfileOrLocale;
                console.log('JCHAT_DEBUG: currency.js loaded in Wallet');
            } catch(e) {
                console.warn('JCHAT_WARN: currency.js failed in Wallet, using fallback.', e);
            }
        })();

        // --- Firebase & Canvas Environment Configuration ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyBsBinyrD9WZZXRaCvA4gxfX7BIimydDvo",
            authDomain: "jchat-1.firebaseapp.com",
            projectId: "jchat-1",
            storageBucket: "jchat-1.firebasestorage.app",
            messagingSenderId: "328479683167",
            appId: "1:328479683167:web:276c0b7e8ea44dd2d6a1ea",
            measurementId: "G-S6Z9GG0R9P"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Cloudinary Configuration (for profile pictures in header and receipt uploads)
        const cloudinaryConfig = {
            cloudName: "dxld01rcp",
            uploadPreset: "Storage_preset"
        };

        // Initialize Firebase services
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app); // Re-initialized Firebase Storage

        // --- DOM Elements ---
        const headerProfilePic = document.getElementById('headerProfilePic');
        const headerAvatarIcon = document.getElementById('headerAvatarIcon');
        const headerDisplayName = document.getElementById('headerDisplayName');
        const messageBox = document.getElementById('messageBox');
        // Removed headerNavLinkProfile
        // Removed adminIconLink

        const jcoinBalanceElement = document.getElementById('jcoinBalance');
        const gasBalanceElement = document.getElementById('gasBalance'); // NEW
        const usdBalanceElement = document.getElementById('usdBalance');
        const transactionListElement = document.getElementById('transactionList');
        const noTransactionsMessage = document.getElementById('noTransactionsMessage');
        const loadMoreTransactionsButton = document.getElementById('loadMoreTransactionsButton'); // NEW
        const transactionTypeFilter = document.getElementById('transactionTypeFilter'); // NEW
        const transactionDateFromInput = document.getElementById('transactionDateFrom'); // NEW
        const transactionDateToInput = document.getElementById('transactionDateTo'); // NEW
        const transactionSearchInput = document.getElementById('transactionSearchInput'); // NEW
        const exportCsvButton = document.getElementById('exportCsvButton'); // NEW
        const exportJsonButton = document.getElementById('exportJsonButton'); // NEW

        // Wallet Buttons
        const sendJCoinsButton = document.getElementById('sendJCoinsButton'); // NEW
        const receiveJCoinsButton = document.getElementById('receiveJCoinsButton'); // NEW
        const requestJCoinsLink = document.getElementById('requestJCoinsLink'); // NEW

        // Buy JCoins Panel Elements
        const bankAccountNumberSpan = document.getElementById('bankAccountNumber');
        const userReferenceIdSpan = document.getElementById('userReferenceId');
        const jcoinPackagesGrid = document.getElementById('jcoinPackagesGrid');

        // Manual Buy Section Elements
        const nairaInput = document.getElementById('nairaInput');
        const receiptUploadInput = document.getElementById('receiptUploadInput'); // RESTORED
        const receiptFileNameSpan = document.getElementById('receiptFileName'); // RESTORED
        const receiptPreviewImg = document.getElementById('receiptPreview'); // RESTORED
        const calculatedJCoinsSpan = document.getElementById('calculatedJCoins');
        const calculatedBonusSpan = document.getElementById('calculatedBonus');
        const sendManualBuyRequestButton = document.getElementById('sendManualBuyRequestButton');

        // Send JCoins Modal Elements (NEW)
        const sendJCoinsModal = document.getElementById('sendJCoinsModal');
        const recipientIdInput = document.getElementById('recipientIdInput');
        const sendAmountInput = document.getElementById('sendAmountInput');
        const yourJCoinsBalanceSpan = document.getElementById('yourJCoinsBalance');
        const cancelSendJCoinsButton = document.getElementById('cancelSendJCoins');
        const confirmSendJCoinsButton = document.getElementById('confirmSendJCoins');

        // Withdrawal Section Elements (NEW)
        const withdrawalButton = document.getElementById('withdrawButton');
        const withdrawalMessage = document.getElementById('withdrawalMessage');
        const pendingWithdrawalMessage = document.getElementById('pendingWithdrawalMessage');

        // Bank Details Form Elements (NEW)
        const bankNameInput = document.getElementById('bankNameInput');
        const accountNameInput = document.getElementById('accountNameInput');
        const accountNumberInput = document.getElementById('accountNumberInput');
        const saveBankDetailsButton = document.getElementById('saveBankDetailsButton');

        // Withdrawal History Elements (NEW)
        const withdrawalListElement = document.getElementById('withdrawalList');
        const noWithdrawalsMessage = document.getElementById('noWithdrawalsMessage');

        // Earn JCoins Elements (NEW)
        const claimDailyBonusButton = document.getElementById('claimDailyBonusButton');

        // 2FA Modal Elements (NEW)
        const twoFAModal = document.getElementById('twoFAModal');
        const twoFAModalMessage = document.getElementById('twoFAModalMessage');
        const twoFAPasswordInput = document.getElementById('twoFAPasswordInput');
        const cancelTwoFAButton = document.getElementById('cancelTwoFA');
        const confirmTwoFAButton = document.getElementById('confirmTwoFA');

        // Transaction Details Modal Elements (NEW)
        const transactionDetailsModal = document.getElementById('transactionDetailsModal');
        const detailType = document.getElementById('detailType');
        const detailAmount = document.getElementById('detailAmount');
        const detailId = document.getElementById('detailId');
        const copyDetailIdBtn = document.getElementById('copyDetailIdBtn');
        const detailDescription = document.getElementById('detailDescription');
        const detailTimestamp = document.getElementById('detailTimestamp');
        const detailStatusContainer = document.getElementById('detailStatusContainer');
        const detailStatus = document.getElementById('detailStatus');
        const detailReceiptContainer = document.getElementById('detailReceiptContainer');
        const detailReceiptLink = document.getElementById('detailReceiptLink');

        // Receive JCoins Modal Elements (NEW)
        const receiveJCoinsModal = document.getElementById('receiveJCoinsModal');
        const receiveQrCanvas = document.getElementById('receiveQrCanvas');
        const receiveUserIdSpan = document.getElementById('receiveUserId');
        const copyReceiveUserIdBtn = document.getElementById('copyReceiveUserId');
        const downloadQrPngBtn = document.getElementById('downloadQrPng');
        const closeReceiveModalBtn = document.getElementById('closeReceiveModal');


        // --- Global State ---
        let isAuthReady = false;
        let currentUser = null;
        let currentUserProfile = null; // Store current user's profile data
        let unsubscribeProfile = null; // To store unsubscribe function for profile listener
        let unsubscribeTransactions = null; // To store unsubscribe function for transactions listener
        let unsubscribePendingBuyRequests = null; // To store unsubscribe for buy requests
        let unsubscribePendingWithdrawalRequests = null; // To store unsubscribe for withdrawal requests
        let hasPendingBuyRequest = false; // Flag to prevent multiple pending buy requests
        let hasPendingWithdrawalRequest = false; // Flag to prevent multiple pending withdrawal requests
        let selectedReceiptFile = null; // To store the selected receipt file for upload
        let lastVisibleTransaction = null; // For pagination
        const TRANSACTIONS_PER_PAGE = 10; // Number of transactions to load per page

        let twoFAAction = null; // Stores the function to execute after 2FA
        let twoFAArgs = null; // Stores arguments for the 2FA action

        // --- Constants ---
        // JCoin Rates
        const JCOIN_TO_USD_RATE = 0.005; // 1 JCoin = $0.005 USD (for display purposes)
        // Adjusted based on #10,000 for 25,000 JCoins (10000 / 25000 = 0.4)
        const JCOIN_BUY_RATE_NGN_PER_JCOIN = 0.4; // Cost of 1 JCoin in NGN when buying (e.g., 1 JCoin costs 0.4 NGN)

        // Withdrawal Constants
        const WITHDRAWAL_JCOIN_AMOUNT = 20000; // JCoins required for withdrawal
        const WITHDRAWAL_NAIRA_AMOUNT = 10000; // Naira received for withdrawal
        // Derived selling rate: 1 JCoin sells for (WITHDRAWAL_NAIRA_AMOUNT / WITHDRAWAL_JCOIN_AMOUNT) NGN = 10000 / 20000 = 0.5 NGN

        // Daily Bonus Constants
        const DAILY_BONUS_JCOINS = 5;
        const DAILY_BONUS_GAS = 10;

        const ADMIN_UID = 'cc96gdhCRPO72NFZtleRCujHvIq2'; // Admin's User ID


        // Define JCoin packages with Naira prices and bonuses
        // The baseJCoins will be calculated as Math.floor(nairaPrice / JCOIN_BUY_RATE_NGN_PER_JCOIN)
        // Order from highest to lowest Naira price as requested
        const JCOIN_PACKAGES = [
            { nairaPrice: 10000, bonusPercent: 0, description: "Ultimate Pack" }, // 10000 / 0.4 = 25000 JCoins. User specified 25000. No additional bonus.
            { nairaPrice: 5000, bonusPercent: 15, description: "Platinum Tier" }, // 5000 / 0.4 = 12500. Bonus 15% (1875). Total 14375.
            { nairaPrice: 2000, bonusPercent: 10, description: "Gold Tier" },    // 2000 / 0.4 = 5000. Bonus 10% (500). Total 5500.
            { nairaPrice: 1000, bonusPercent: 5, description: "Silver Tier" },   // 1000 / 0.4 = 2500. Bonus 5% (125). Total 2625.
            { nairaPrice: 500, bonusPercent: 0, description: "Bronze Tier" },    // 500 / 0.4 = 1250. No bonus.
            { nairaPrice: 200, bonusPercent: 0, description: "Starter Pack" },   // 200 / 0.4 = 500. No bonus.
        ];

        // --- Currency/Locale Helpers ---
        // moved to currency.js to avoid duplication

        // --- Utility Functions (consistent with other JCHAT pages) ---

        /**
         * Plays a short, success-like sound tone using Tone.js.
         */
        async function playSuccessTone() {
            try {
                // Ensure Tone.js is started (required for audio context)
                await Tone.start();
                const synth = new Tone.Synth().toDestination();
                synth.triggerAttackRelease("C5", "8n"); // Play a C5 note for an 8th note duration
                synth.triggerAttackRelease("E5", "8n", Tone.now() + 0.1); // Play an E5 note slightly after C5
                synth.triggerAttackRelease("G5", "8n", Tone.now() + 0.2); // Play a G5 note slightly after G5
            } catch (error) {
                console.warn("JCHAT_WARN: Failed to play success tone:", error);
            }
        }

        /**
         * Plays a short, coin-like sound notification using Tone.js.
         */
        async function playCoinSound() {
            try {
                await Tone.start();
                const synth = new Tone.MembraneSynth().toDestination(); // Use MembraneSynth for a "pop" or "coin" sound
                synth.triggerAttackRelease("C4", "16n"); // A quick, sharp note
            } catch (error) {
                console.warn("JCHAT_WARN: Failed to play coin sound:", error);
            }
        }


        /**
         * Displays a temporary message box with a given message and type.
         * @param {string} message - The message to display.
         * @param {string} type - The type of message ('success', 'error', 'info', 'loading', 'warning').
         * @param {boolean} [isPersistent=false] - If true, message stays until explicitly cleared or replaced.
         * @param {number} [durationMs=3000] - Duration in milliseconds for the message to display if not persistent.
         */
        function showMessageBox(message, type, isPersistent = false, durationMs = 3000) {
            if (messageBox.timeoutId) {
                clearTimeout(messageBox.timeoutId);
            }

            messageBox.innerHTML = `<i id="messageBoxIcon"></i><span id="messageBoxText"></span>`;
            const messageBoxIcon = messageBox.querySelector('#messageBoxIcon');
            const messageBoxText = messageBox.querySelector('#messageBoxText');

            messageBoxText.textContent = message;
            messageBox.className = 'message-box show ' + type; // Add type class for styling

            // Set icon based on type
            if (type === 'success') {
                messageBoxIcon.classList.add('fas', 'fa-check-circle');
            } else if (type === 'error') {
                messageBoxIcon.classList.add('fas', 'fa-times-circle');
            } else if (type === 'info') {
                messageBoxIcon.classList.add('fas', 'fa-info-circle');
            } else if (type === 'warning') {
                 messageBoxIcon.classList.add('fas', 'fa-exclamation-triangle');
            } else if (type === 'loading') {
                 messageBoxIcon.classList.add('fas', 'fa-spinner', 'fa-spin'); // Spinner for loading
            } else {
                messageBoxIcon.className = ''; // No specific icon
            }

            if (type === 'loading') {
                messageBox.classList.add('loading-pulse');
            } else {
                messageBox.classList.remove('loading-pulse');
            }

            messageBox.style.display = 'flex';
            messageBox.style.opacity = '1';

            if (!isPersistent) {
                messageBox.timeoutId = setTimeout(() => {
                    messageBox.style.opacity = '0';
                    messageBox.addEventListener('transitionend', function handler() {
                        messageBox.style.display = 'none';
                        messageBox.removeEventListener('transitionend', handler);
                        messageBox.classList.remove('loading-pulse');
                    }, { once: true });
                }, durationMs);
            }
        }

        /**
         * Copies text to the clipboard.
         * @param {string} text - The text to copy.
         */
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed'; // Avoid scrolling to bottom
            textarea.style.opacity = '0'; // Hide it
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showMessageBox('Copied to clipboard!', 'success');
                } else {
                    showMessageBox('Failed to copy. Please try manually.', 'error');
                }
            } catch (err) {
                console.error('Failed to copy text: ', err);
                showMessageBox('Failed to copy. Please try manually.', 'error');
            }
            document.body.removeChild(textarea);
        }

        /**
         * Constructs a Cloudinary URL for an image/video.
         * @param {string} urlOrPublicId - The full Cloudinary URL or the public ID of the image on Cloudinary.
         * @param {string} transformations - Optional Cloudinary transformations.
         * @returns {string|null} The full Cloudinary URL or null if urlOrPublicId is not provided.
         */
        function getCloudinaryImageUrl(urlOrPublicId, transformations = "w_auto,f_auto,q_auto") {
            if (!urlOrPublicId) return null;
            // Check if it's already a full URL (e.g., from Firebase Auth photoURL or existing Cloudinary URL)
            if (urlOrPublicId.startsWith('http://') || urlOrPublicId.startsWith('https://')) {
                // If it's a direct URL to a Cloudinary asset, we can insert transformations
                // This is a simplified approach; a more robust one would parse the URL
                if (urlOrPublicId.includes('res.cloudinary.com')) {
                    const parts = urlOrPublicId.split('/upload/');
                    if (parts.length === 2) {
                        return `${parts[0]}/upload/${transformations}/${parts[1]}`;
                    }
                }
                return urlOrPublicId; // Return as is if it's a general URL not from Cloudinary or already transformed
            }
            // Assume it's a public ID if not a full URL
            return `https://res.cloudinary.com/${cloudinaryConfig.cloudName}/image/upload/${transformations}/${urlOrPublicId}`;
        }

        /**
         * Displays the profile picture or a default icon.
         * @param {HTMLElement} imgElement - The <img> element to update.
         * @param {HTMLElement} iconElement - The <i> element to display if no image.
         * @param {string|null} profilePicId - The Cloudinary public ID or URL, or null.
         * @param {string} usernameInitial - Initial for placeholder.
         * @param {string} transformations - Cloudinary transformations.
         */
        function displayProfilePicture(imgElement, iconElement, profilePicId, usernameInitial, transformations) {
            if (imgElement) { // Ensure imgElement exists
                if (profilePicId) {
                    const imageUrl = getCloudinaryImageUrl(profilePicId, transformations);
                    imgElement.src = imageUrl;
                    imgElement.style.display = 'block';
                    if (iconElement) iconElement.style.display = 'none'; // Null check for iconElement
                    imgElement.onerror = () => {
                        console.error(`JCHAT_ERROR: Failed to load profile picture: ${profilePicId}. Using placeholder.`);
                        imgElement.src = `https://placehold.co/40x40/CCCCCC/000000?text=${usernameInitial}`;
                        imgElement.style.display = 'block';
                        if (iconElement) iconElement.style.display = 'none'; // Null check for iconElement
                    };
                } else {
                    imgElement.src = '';
                    imgElement.style.display = 'none';
                    if (iconElement) iconElement.style.display = 'block'; // Null check for iconElement
                }
            }
        }

        /**
         * Fetches and displays the current user's profile data for the header.
         * This function runs on every page to ensure header is consistent.
         * @param {firebase.User} user - The authenticated Firebase user object.
         */
        async function fetchAndDisplayHeaderProfile(user) {
            try {
                const privateProfileDocRef = doc(db, "artifacts", appId, "users", user.uid, "profiles", "user_profile");
                const privateDocSnap = await getDoc(privateProfileDocRef);

                let profileData = null;
                if (privateDocSnap.exists()) {
                    profileData = privateDocSnap.data();
                    // Initialize missing fields if they don't exist
                    if (profileData.jCoins === undefined) {
                        await updateDoc(privateProfileDocRef, { jCoins: 0 });
                        profileData.jCoins = 0;
                    }
                    if (profileData.gas === undefined) {
                        await updateDoc(privateProfileDocRef, { gas: 0 });
                        profileData.gas = 0;
                    }
                    if (profileData.totalGasEarned === undefined) {
                        await updateDoc(privateProfileDocRef, { totalGasEarned: 0 });
                        profileData.totalGasEarned = 0;
                    }
                    if (profileData.level === undefined) {
                        await updateDoc(privateProfileDocRef, { level: 1 });
                        profileData.level = 1;
                    }
                    if (profileData.walletUnlocked === undefined) {
                        await updateDoc(privateProfileDocRef, { walletUnlocked: false });
                        profileData.walletUnlocked = false;
                    }
                    if (profileData.unlockedBenefits === undefined) {
                        await updateDoc(privateProfileDocRef, { unlockedBenefits: [] });
                        profileData.unlockedBenefits = [];
                    }
                    if (profileData.bankDetails === undefined) { // NEW: Initialize bankDetails
                        await updateDoc(privateProfileDocRef, { bankDetails: {} });
                        profileData.bankDetails = {};
                    }
                    // Fix for createdAt if it's missing or malformed (not a Timestamp)
                    if (!profileData.createdAt || typeof profileData.createdAt.toDate !== 'function') {
                        console.warn("JCHAT_WARN: Private user_profile createdAt is missing or malformed. Attempting to fix.");
                        await updateDoc(privateProfileDocRef, { createdAt: serverTimestamp() });
                        // Re-fetch to get the correct Timestamp object
                        const updatedSnap = await getDoc(privateProfileDocRef);
                        profileData.createdAt = updatedSnap.data().createdAt;
                    }

                } else {
                    // If private profile doesn't exist, create a basic one
                    profileData = {
                        username: user.displayName || `User_${user.uid.substring(0, 8)}`,
                        email: user.email || "",
                        profilePicId: user.photoURL || null,
                        bio: "",
                        location: "",
                        friendsCount: 0,
                        followersCount: 0,
                        followingCount: 0,
                        createdAt: serverTimestamp(), // Use serverTimestamp for consistency
                        updatedAt: serverTimestamp(),
                        inspirationType: "motivational",
                        visibility: {
                            displayName: true, profilePic: true, bio: false, location: false,
                            emailPublic: false, lastOnline: false, allowFriendRequests: true, allowMessages: true,
                        },
                        totalPosts: 0,
                        jCoins: 0,
                        gas: 0,
                        totalGasEarned: 0,
                        level: 1,
                        walletUnlocked: false,
                        unlockedBenefits: [],
                        bankDetails: {} // NEW: Initialize bankDetails
                    };
                    await setDoc(privateProfileDocRef, profileData);
                    console.log("JCHAT_DEBUG: Created new profile data for header:", profileData);

                    // Also create/update public profile
                    const publicProfileDocRef = doc(db, "artifacts", appId, "public", "data", "users", user.uid);
                    await setDoc(publicProfileDocRef, {
                        username: profileData.username,
                        profilePicId: profileData.profilePicId,
                        bio: profileData.bio,
                        location: profileData.location,
                        createdAt: profileData.createdAt,
                        updatedAt: profileData.updatedAt,
                        visibility: profileData.visibility,
                        totalPosts: profileData.totalPosts,
                        level: profileData.level,
                        totalGasEarned: profileData.totalGasEarned
                    }, { merge: true });
                }

                // Update header UI
                const usernameInitial = (profileData.username || "J").charAt(0).toUpperCase();
                displayProfilePicture(headerProfilePic, headerAvatarIcon, profileData?.profilePicId, usernameInitial, "w_70,h_70,c_fill,g_face,r_max");
                headerDisplayName.textContent = profileData.username || "JCHAT User";
                // Removed headerNavLinkProfile update
                if (document.getElementById('profileLink')) document.getElementById('profileLink').href = `Profile.html?userId=${user.uid}`;

                // Removed Admin Icon logic
                // if (adminIconLink) adminIconLink.style.display = 'none'; // Ensure admin icon is hidden

            } catch (error) {
                console.error("JCHAT_ERROR: Error fetching or creating profile for header:", error);
                const usernameInitial = (user.displayName || "J").charAt(0).toUpperCase();
                displayProfilePicture(headerProfilePic, headerAvatarIcon, user.photoURL, usernameInitial, "w_70,h_70,c_fill,g_face,r_max");
                if (headerDisplayName) headerDisplayName.textContent = user.displayName || "JCHAT User"; // Null check
                showMessageBox(`Error loading header profile: ${error.message}`, 'error');
            }
        }


        /**
         * Toggles loading state for a button.
         * @param {HTMLElement} buttonElement - The button to toggle.
         * @param {boolean} isLoading - True to show loading, false to hide.
         */
        function toggleButtonLoading(buttonElement, isLoading) {
            if (!buttonElement) return;
            const loader = buttonElement.querySelector('.button-loader');
            const text = buttonElement.querySelector('.button-text');

            if (isLoading) {
                buttonElement.disabled = true;
                buttonElement.classList.add('loading'); // Add loading class for general styling
                if (loader) loader.classList.add('active');
                if (text) text.style.display = 'none';
            } else {
                buttonElement.disabled = false;
                buttonElement.classList.remove('loading');
                if (loader) loader.classList.remove('active');
                if (text) text.style.display = 'block';
            }
        }

        /**
         * Shows the 2FA confirmation modal.
         * @param {string} message - Message to display in the modal.
         * @param {Function} actionCallback - The function to call if 2FA is confirmed.
         * @param {Array} args - Arguments to pass to the actionCallback.
         */
        function showTwoFAModal(message, actionCallback, args) {
            if (!twoFAModal || !twoFAModalMessage || !twoFAPasswordInput) return;
            twoFAModalMessage.textContent = message;
            twoFAPasswordInput.value = ''; // Clear previous input
            twoFAAction = actionCallback;
            twoFAArgs = args;
            twoFAModal.classList.add('active');
            twoFAPasswordInput.focus();
        }

        /**
         * Hides the 2FA confirmation modal.
         */
        function hideTwoFAModal() {
            if (twoFAModal) twoFAModal.classList.remove('active');
            twoFAAction = null;
            twoFAArgs = null;
            if (twoFAPasswordInput) twoFAPasswordInput.value = '';
        }

        /**
         * Handles the 2FA confirmation logic.
         */
        async function handleTwoFAConfirmation() {
            if (!currentUser || !twoFAPasswordInput || !twoFAAction) {
                showMessageBox("2FA error: No action or user.", 'error');
                hideTwoFAModal();
                return;
            }
            try {
                const credential = EmailAuthProvider.credential(currentUser.email, twoFAPasswordInput.value);
                await reauthenticateWithCredential(currentUser, credential);
                showMessageBox("Authentication successful. Proceeding with action...", 'info');
                hideTwoFAModal();
                // Execute the stored action with its arguments
                const args = Array.isArray(twoFAArgs) ? twoFAArgs : [];
                await twoFAAction(...args);
            } catch (error) {
                console.error("JCHAT_ERROR: 2FA re-authentication failed:", error);
                showMessageBox(error.message || "2FA failed.", 'error');
                hideTwoFAModal();
            }
        }


        /**
         * Shows the transaction details modal.
         * @param {Object} transaction - The transaction object to display.
         */
        function showTransactionDetailsModal(transaction) {
            if (!transactionDetailsModal) return;

            detailType.textContent = transaction.type.charAt(0).toUpperCase() + transaction.type.slice(1);
            detailAmount.textContent = transaction.amount.toLocaleString();
            detailDescription.textContent = transaction.description;
            detailTimestamp.textContent = transaction.timestamp ? new Date(transaction.timestamp.toDate()).toLocaleString() : 'N/A';

            // ID and copy
            if (detailId) detailId.textContent = transaction.id || '';
            if (copyDetailIdBtn) {
                copyDetailIdBtn.onclick = () => copyToClipboard(transaction.id || '');
            }

            // Handle status for buy/withdrawal requests
            if (transaction.status) {
                detailStatusContainer.style.display = 'block';
                detailStatus.textContent = transaction.status.charAt(0).toUpperCase() + transaction.status.slice(1);
            } else {
                detailStatusContainer.style.display = 'none';
            }

            // Handle receipt link for buy requests
            if (transaction.receiptImageUrl) {
                detailReceiptContainer.style.display = 'block';
                detailReceiptLink.href = transaction.receiptImageUrl;
            } else {
                detailReceiptContainer.style.display = 'none';
            }

            transactionDetailsModal.classList.add('active');
        }

        /**
         * Hides the transaction details modal.
         */
        function hideTransactionDetailsModal() {
            if (transactionDetailsModal) transactionDetailsModal.classList.remove('active');
        }


        // --- Wallet Page Specific Functions ---

        /**
         * Renders the JCoin packages in the grid.
         */
        function renderJCoinPackages() {
            if (!jcoinPackagesGrid) return; // Null check
            jcoinPackagesGrid.innerHTML = ''; // Clear existing packages

            JCOIN_PACKAGES.forEach(pkg => {
                // Calculate base JCoins using the new buying rate
                const baseJCoins = Math.floor(pkg.nairaPrice / JCOIN_BUY_RATE_NGN_PER_JCOIN);
                const bonusJCoins = Math.floor(baseJCoins * (pkg.bonusPercent / 100));
                const totalJCoins = baseJCoins + bonusJCoins;

                const packageCard = document.createElement('div');
                packageCard.classList.add('jcoin-package-card');
                packageCard.dataset.nairaPrice = pkg.nairaPrice;
                packageCard.dataset.jcoins = totalJCoins;

                packageCard.innerHTML = `
                    <span class="package-price">#${pkg.nairaPrice.toLocaleString()}</span>
                    <span class="package-jcoins">${totalJCoins.toLocaleString()} JCoins</span>
                    <span class="package-bonus ${bonusJCoins === 0 ? 'no-bonus' : ''}">
                        ${bonusJCoins > 0 ? `+${bonusJCoins.toLocaleString()} Bonus JCoins (${pkg.bonusPercent}%)` : 'No Bonus'}
                    </span>
                    <span style="font-size: 0.8rem; color: var(--text-light);">(${pkg.description})</span>
                `;

                packageCard.addEventListener('click', () => {
                    // Pre-fill manual input and trigger request
                    if (nairaInput) nairaInput.value = pkg.nairaPrice;
                    calculateJCoinsForManualInput();
                    // Optional: Scroll to manual buy section
                    if (sendManualBuyRequestButton) sendManualBuyRequestButton.scrollIntoView({ behavior: 'smooth', block: 'center' });
                });
                jcoinPackagesGrid.appendChild(packageCard);
            });
        }

        /**
         * Calculates JCoins and bonus based on Naira input for the manual purchase.
         */
        function calculateJCoinsForManualInput() {
            if (!nairaInput || !calculatedJCoinsSpan || !calculatedBonusSpan) return; // Null check

            const nairaAmount = parseInt(nairaInput.value);
            if (isNaN(nairaAmount) || nairaAmount < 0) {
                calculatedJCoinsSpan.textContent = "0";
                calculatedBonusSpan.textContent = "Invalid Amount";
                calculatedBonusSpan.classList.add('no-bonus');
                return;
            }

            // Calculate base JCoins using the new buying rate
            let baseJCoins = Math.floor(nairaAmount / JCOIN_BUY_RATE_NGN_PER_JCOIN);
            let bonusPercent = 0;

            // Find the highest applicable bonus tier for custom amount
            // Iterate through packages in descending order of price to find the highest applicable bonus
            for (let i = JCOIN_PACKAGES.length - 1; i >= 0; i--) {
                if (nairaAmount >= JCOIN_PACKAGES[i].nairaPrice) {
                    bonusPercent = JCOIN_PACKAGES[i].bonusPercent;
                    break;
                }
            }

            const bonusJCoins = Math.floor(baseJCoins * (bonusPercent / 100));
            const totalJCoins = baseJCoins + bonusJCoins;

            calculatedJCoinsSpan.textContent = totalJCoins.toLocaleString();
            if (bonusJCoins > 0) {
                calculatedBonusSpan.textContent = `+${bonusJCoins.toLocaleString()} Bonus JCoins (${bonusPercent}%)`;
                calculatedBonusSpan.classList.remove('no-bonus');
            } else {
                calculatedBonusSpan.textContent = "No Bonus";
                calculatedBonusSpan.classList.add('no-bonus');
            }
        }

        /**
         * Handles the receipt file upload input change.
         */
        function handleReceiptUpload(event) {
            const file = event.target.files[0];
            if (file) {
                selectedReceiptFile = file; // Store the file globally
                if (receiptFileNameSpan) receiptFileNameSpan.textContent = file.name; // Null check
                const reader = new FileReader();
                reader.onload = (e) => {
                    if (receiptPreviewImg) { // Null check
                        receiptPreviewImg.src = e.target.result;
                        receiptPreviewImg.style.display = 'block';
                    }
                };
                reader.readAsDataURL(file);
            } else {
                selectedReceiptFile = null;
                if (receiptFileNameSpan) receiptFileNameSpan.textContent = 'No file chosen'; // Null check
                if (receiptPreviewImg) { // Null check
                    receiptPreviewImg.style.display = 'none';
                    receiptPreviewImg.src = '';
                }
            }
        }


        /**
         * Sends a buy JCoins request to the admin.
         * This request expects manual payment and receipt submission via WhatsApp or Profile page.
         * @param {number} nairaAmount - The Naira amount for the package.
         * @param {number} jcoinAmount - The total JCoins in the package (including bonus).
         */
        async function sendBuyJCoinsRequest() {
            if (!currentUser || !currentUserProfile) {
                showMessageBox("Please log in to send a JCoin purchase request.", 'error');
                return;
            }

            if (hasPendingBuyRequest) {
                showMessageBox("You already have a pending purchase request. Please wait for it to be processed.", 'info');
                return;
            }

            const nairaAmount = parseInt(nairaInput.value);
            const jcoinAmount = parseInt(calculatedJCoinsSpan.textContent.replace(/,/g, '')); // Get calculated JCoins

            if (isNaN(nairaAmount) || nairaAmount <= 0) {
                showMessageBox("Please enter a valid Naira amount.", 'error');
                return;
            }
            if (nairaAmount < 200) { // Minimum request amount, updated to match lowest package
                showMessageBox("Minimum purchase amount is #200.", 'warning');
                return;
            }
            if (!selectedReceiptFile) {
                showMessageBox("Please upload a payment receipt.", 'error');
                return;
            }

            // Disable button and show loader to prevent double clicks
            if (sendManualBuyRequestButton) toggleButtonLoading(sendManualBuyRequestButton, true); // Null check
            document.querySelectorAll('.jcoin-package-card').forEach(card => card.style.pointerEvents = 'none');


            showMessageBox(`Uploading receipt and sending purchase request...`, 'loading', true);

            try {
                const formData = new FormData();
                formData.append('file', selectedReceiptFile);
                formData.append('upload_preset', cloudinaryConfig.uploadPreset);

                const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/image/upload`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("JCHAT_ERROR: Cloudinary upload error:", errorData);
                    throw new Error(`Cloudinary upload failed: ${errorData.error.message || response.statusText}`);
                }

                const data = await response.json();
                const uploadedReceiptUrl = data.secure_url;

                const buyRequestsCollectionRef = collection(db, "artifacts", appId, "public", "data", "jcoin_buy_requests");

                await addDoc(buyRequestsCollectionRef, {
                    userId: currentUser.uid,
                    username: currentUserProfile.username || currentUser.displayName || "Unknown User",
                    requestedNairaPrice: nairaAmount,
                    requestedJCoins: jcoinAmount,
                    receiptImageUrl: uploadedReceiptUrl, // Now includes the uploaded URL
                    status: 'pending', // 'pending', 'completed', 'rejected'
                    adminId: ADMIN_UID, // The specific admin UID to notify
                    timestamp: serverTimestamp(),
                });

                hasPendingBuyRequest = true; // Set flag
                showMessageBox(
                    `Your request for ${jcoinAmount.toLocaleString()} JCoins has been sent! An admin will review it shortly.`,
                    'success',
                    true // Keep message persistent until user navigates or dismisses
                );
                playCoinSound(); // Play coin sound on successful request sent

                // Clear input fields and receipt preview after successful request
                if (nairaInput) nairaInput.value = ''; // Null check
                calculateJCoinsForManualInput(); // Recalculate to reset display
                if (receiptUploadInput) receiptUploadInput.value = ''; // Clear file input, null check
                handleReceiptUpload({ target: { files: [] } }); // Reset receipt preview

            } catch (error) {
                console.error("JCHAT_ERROR: Error sending JCoin purchase request:", error);
                showMessageBox(`Failed to send purchase request: ${error.message}`, 'error');
            } finally {
                if (sendManualBuyRequestButton) toggleButtonLoading(sendManualBuyRequestButton, false); // Null check
                // Button remains disabled if hasPendingRequest is true, re-enabled otherwise by onSnapshot
            }
        }

        /**
         * Shows the Send JCoins modal.
         */
        function showSendJCoinsModal() {
            if (!currentUser || !currentUserProfile) {
                showMessageBox("Please log in to send JCoins.", "warning");
                return;
            }
            if (sendJCoinsModal) sendJCoinsModal.classList.add('active'); // Null check
            if (recipientIdInput) recipientIdInput.value = ''; // Null check
            if (sendAmountInput) sendAmountInput.value = ''; // Null check
            if (yourJCoinsBalanceSpan) yourJCoinsBalanceSpan.textContent = (currentUserProfile.jCoins || 0).toLocaleString(); // Null check
        }

        /**
         * Hides the Send JCoins modal.
         */
        function hideSendJCoinsModal() {
            if (sendJCoinsModal) sendJCoinsModal.classList.remove('active'); // Null check
        }

        /**
         * Handles sending JCoins from one user to another.
         */
        async function sendJCoinsConfirmed() {
            if (!currentUser || !currentUserProfile) {
                showMessageBox("You must be logged in to send JCoins.", 'error');
                return;
            }

            const recipientId = recipientIdInput.value.trim();
            const amount = parseInt(sendAmountInput.value);

            if (!recipientId) {
                showMessageBox("Please enter a recipient User ID.", 'error');
                return;
            }
            if (recipientId === currentUser.uid) {
                showMessageBox("You cannot send JCoins to yourself.", 'warning');
                return;
            }
            if (isNaN(amount) || amount <= 0) {
                showMessageBox("Please enter a valid positive amount to send.", 'error');
                return;
            }
            if (amount > (currentUserProfile.jCoins || 0)) {
                showMessageBox("Insufficient JCoins balance.", 'error');
                return;
            }

            toggleButtonLoading(confirmSendJCoinsButton, true);
            showMessageBox("Sending JCoins...", 'loading', true);

            try {
                await runTransaction(db, async (transaction) => {
                    const senderProfileRef = doc(db, "artifacts", appId, "users", currentUser.uid, "profiles", "user_profile");
                    const recipientProfileRef = doc(db, "artifacts", appId, "users", recipientId, "profiles", "user_profile");

                    const senderProfileSnap = await transaction.get(senderProfileRef);
                    const recipientProfileSnap = await transaction.get(recipientProfileRef);

                    if (!senderProfileSnap.exists()) {
                        throw new Error("Sender profile not found.");
                    }
                    if (!recipientProfileSnap.exists()) {
                        throw new Error("Recipient user ID not found. Please check the ID.");
                    }

                    const senderData = senderProfileSnap.data();
                    const recipientData = recipientProfileSnap.data();

                    const senderCurrentJCoins = senderData.jCoins || 0;
                    const recipientCurrentJCoins = recipientData.jCoins || 0;

                    if (senderCurrentJCoins < amount) {
                        throw new Error("Insufficient JCoins balance. Transaction cancelled.");
                    }

                    // Update sender's balance
                    transaction.update(senderProfileRef, {
                        jCoins: senderCurrentJCoins - amount,
                        updatedAt: serverTimestamp()
                    });

                    // Update recipient's balance
                    transaction.update(recipientProfileRef, {
                        jCoins: recipientCurrentJCoins + amount,
                        updatedAt: serverTimestamp()
                    });

                    // Add transaction for sender (debit)
                    const senderTransactionsRef = collection(db, "artifacts", appId, "users", currentUser.uid, "transactions");
                    await addDoc(senderTransactionsRef, { // Use addDoc for new documents
                        type: 'debit',
                        amount: amount,
                        description: `Sent JCoins to ${recipientData.username || recipientId}`,
                        timestamp: serverTimestamp()
                    });

                    // Add transaction for recipient (credit)
                    const recipientTransactionsRef = collection(db, "artifacts", appId, "users", recipientId, "transactions");
                    await addDoc(recipientTransactionsRef, { // Use addDoc for new documents
                        type: 'credit',
                        amount: amount,
                        description: `Received JCoins from ${senderData.username || currentUser.uid}`,
                        timestamp: serverTimestamp()
                    });

                    // Add notification for recipient
                    const recipientNotificationsRef = collection(db, "artifacts", appId, "users", recipientId, "notifications");
                    await addDoc(recipientNotificationsRef, { // Use addDoc for new documents
                        type: 'jcoin_transfer',
                        message: `You received ${amount.toLocaleString()} JCoins from ${senderData.username || currentUser.uid}!`,
                        read: false,
                        timestamp: serverTimestamp(),
                        senderId: currentUser.uid,
                        jcoinAmount: amount
                    });
                });

                showMessageBox(`Successfully sent ${amount.toLocaleString()} JCoins to ${recipientId}!`, 'success');
                playSuccessTone(); // Play success sound
                hideSendJCoinsModal(); // Close modal

            } catch (error) {
                console.error("JCHAT_ERROR: Error sending JCoins:", error);
                showMessageBox(`Failed to send JCoins: ${error.message}`, 'error');
            } finally {
                toggleButtonLoading(confirmSendJCoinsButton, false);
            }
        }

        /**
         * Saves the user's bank details to their profile.
         */
        async function saveBankDetails() {
            if (!currentUser || !currentUserProfile) {
                showMessageBox("Please log in to save bank details.", 'error');
                return;
            }

            const bankName = bankNameInput.value.trim();
            const accountName = accountNameInput.value.trim();
            const accountNumber = accountNumberInput.value.trim();

            if (!bankName || !accountName || !accountNumber) {
                showMessageBox("Please fill in all bank details.", 'error');
                return;
            }

            toggleButtonLoading(saveBankDetailsButton, true);
            showMessageBox("Saving bank details...", 'loading', true);

            try {
                const userProfileDocRef = doc(db, "artifacts", appId, "users", currentUser.uid, "profiles", "user_profile");
                await updateDoc(userProfileDocRef, {
                    bankDetails: {
                        bankName: bankName,
                        accountName: accountName,
                        accountNumber: accountNumber
                    },
                    updatedAt: serverTimestamp()
                });

                showMessageBox("Bank details saved successfully!", 'success');
                // Update local profile data
                currentUserProfile.bankDetails = { bankName, accountName, accountNumber };
                updateWithdrawalButtonState(); // Re-evaluate withdrawal button state
            } catch (error) {
                console.error("JCHAT_ERROR: Error saving bank details:", error);
                showMessageBox(`Failed to save bank details: ${error.message}`, 'error');
            } finally {
                toggleButtonLoading(saveBankDetailsButton, false);
            }
        }

        /**
         * Sends a withdrawal request for 20000 JCoins.
         */
        async function sendWithdrawalRequestConfirmed() {
            if (!currentUser || !currentUserProfile) {
                showMessageBox("Please log in to withdraw JCoins.", 'error');
                return;
            }

            if (hasPendingWithdrawalRequest) {
                showMessageBox("You already have a pending withdrawal request. Please wait for it to be processed.", 'info');
                return;
            }

            if ((currentUserProfile.jCoins || 0) < WITHDRAWAL_JCOIN_AMOUNT) {
                showMessageBox(`You need at least ${WITHDRAWAL_JCOIN_AMOUNT} JCoins to withdraw.`, 'warning');
                return;
            }

            const bankDetails = currentUserProfile.bankDetails;
            if (!bankDetails || !bankDetails.bankName || !bankDetails.accountName || !bankDetails.accountNumber) {
                showMessageBox("Please save your bank details before requesting a withdrawal.", 'warning');
                // Optionally, scroll to bank details section
                if (bankNameInput) bankNameInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }

            toggleButtonLoading(withdrawalButton, true);
            showMessageBox("Sending withdrawal request and deducting JCoins...", 'loading', true);

            try {
                await runTransaction(db, async (transaction) => {
                    const userProfileDocRef = doc(db, "artifacts", appId, "users", currentUser.uid, "profiles", "user_profile");
                    const withdrawalRequestsCollectionRef = collection(db, "artifacts", appId, "public", "data", "jcoin_withdrawal_requests");
                    const userTransactionsCollectionRef = collection(db, "artifacts", appId, "users", currentUser.uid, "transactions");
                    const adminNotificationsCollectionRef = collection(db, "artifacts", appId, "users", ADMIN_UID, "notifications"); // Admin's notifications

                    const userProfileSnap = await transaction.get(userProfileDocRef);
                    if (!userProfileSnap.exists()) {
                        throw new Error("User profile not found.");
                    }

                    const currentJCoins = userProfileSnap.data().jCoins || 0;
                    if (currentJCoins < WITHDRAWAL_JCOIN_AMOUNT) {
                        throw new Error("Insufficient JCoins balance for withdrawal.");
                    }

                    // Deduct JCoins from user's balance
                    transaction.update(userProfileDocRef, {
                        jCoins: currentJCoins - WITHDRAWAL_JCOIN_AMOUNT,
                        updatedAt: serverTimestamp()
                    });

                    // Add a withdrawal request
                    await addDoc(withdrawalRequestsCollectionRef, { // Use addDoc for new documents
                        userId: currentUser.uid,
                        username: currentUserProfile.username || currentUser.displayName || "Unknown User",
                        jcoinAmount: WITHDRAWAL_JCOIN_AMOUNT,
                        nairaAmount: WITHDRAWAL_NAIRA_AMOUNT,
                        bankDetails: bankDetails,
                        status: 'pending',
                        timestamp: serverTimestamp()
                    });

                    // Add a transaction record for the user's debit
                    await addDoc(userTransactionsCollectionRef, { // Use addDoc for new documents
                        type: 'debit',
                        amount: WITHDRAWAL_JCOIN_AMOUNT,
                        description: `Withdrawal request for ${WITHDRAWAL_NAIRA_AMOUNT.toLocaleString()} NGN (Pending)`,
                        timestamp: serverTimestamp()
                    });

                    // Notify admin
                    await addDoc(adminNotificationsCollectionRef, { // Use addDoc for new documents
                        type: 'withdrawal_request',
                        message: `New withdrawal request from ${currentUserProfile.username || currentUser.uid} for ${WITHDRAWAL_JCOIN_AMOUNT} JCoins (#${WITHDRAWAL_NAIRA_AMOUNT.toLocaleString()} NGN).`,
                        read: false,
                        timestamp: serverTimestamp(),
                        userId: currentUser.uid,
                        jcoinAmount: WITHDRAWAL_JCOIN_AMOUNT
                    });
                });

                showMessageBox(
                    `${WITHDRAWAL_JCOIN_AMOUNT} JCoins deducted. Withdrawal request sent for #${WITHDRAWAL_NAIRA_AMOUNT.toLocaleString()} NGN! Awaiting admin approval.`,
                    'success',
                    true
                );
                playSuccessTone();
                hasPendingWithdrawalRequest = true; // Set flag
                updateWithdrawalButtonState(); // Update button state
            } catch (error) {
                console.error("JCHAT_ERROR: Error sending withdrawal request:", error);
                showMessageBox(`Failed to send withdrawal request: ${error.message}`, 'error');
            } finally {
                toggleButtonLoading(withdrawalButton, false);
            }
        }

        /**
         * Updates the state of the withdrawal button and messages.
         */
        function updateWithdrawalButtonState() {
            if (!withdrawalButton || !withdrawalMessage || !pendingWithdrawalMessage) return; // Null checks

            const currentJCoins = currentUserProfile ? (currentUserProfile.jCoins || 0) : 0;
            const hasBankDetails = currentUserProfile && currentUserProfile.bankDetails &&
                                   currentUserProfile.bankDetails.bankName &&
                                   currentUserProfile.bankDetails.accountName &&
                                   currentUserProfile.bankDetails.accountNumber;

            // Hide all messages first
            withdrawalMessage.classList.remove('show');
            pendingWithdrawalMessage.classList.remove('show');

            if (!currentUser) {
                withdrawalButton.disabled = true;
                withdrawalButton.classList.add('disabled-pending'); // Add class for visual cue
                withdrawalMessage.textContent = "Please log in to withdraw JCoins.";
                withdrawalMessage.classList.add('show');
                return;
            }

            if (hasPendingWithdrawalRequest) {
                withdrawalButton.disabled = true;
                withdrawalButton.classList.add('disabled-pending'); // Add class for visual cue
                pendingWithdrawalMessage.textContent = "You have a pending withdrawal request. Please wait for admin approval.";
                pendingWithdrawalMessage.classList.add('show');
                return;
            }

            if (currentJCoins < WITHDRAWAL_JCOIN_AMOUNT) {
                withdrawalButton.disabled = true;
                withdrawalButton.classList.remove('disabled-pending'); // Remove pending class if not pending
                withdrawalMessage.textContent = `You need at least ${WITHDRAWAL_JCOIN_AMOUNT} JCoins to withdraw.`;
                withdrawalMessage.classList.add('show');
            } else if (!hasBankDetails) {
                withdrawalButton.disabled = true;
                withdrawalButton.classList.remove('disabled-pending'); // Remove pending class if not pending
                withdrawalMessage.textContent = "Please save your bank details to enable withdrawal.";
                withdrawalMessage.classList.add('show');
            }
            else {
                withdrawalButton.disabled = false;
                withdrawalButton.classList.remove('disabled-pending'); // Remove pending class if not pending
                // No message needed if button is enabled
            }
        }

        /**
         * Renders the user's withdrawal history.
         * @param {Array} withdrawals - Array of withdrawal request documents.
         */
        function renderWithdrawalHistory(withdrawals) {
            if (!withdrawalListElement) return;
            withdrawalListElement.innerHTML = ''; // Clear existing list

            if (withdrawals.length === 0) {
                if (noWithdrawalsMessage) noWithdrawalsMessage.style.display = 'block';
            } else {
                if (noWithdrawalsMessage) noWithdrawalsMessage.style.display = 'none';
                withdrawals.forEach(withdrawalDoc => {
                    const withdrawal = withdrawalDoc.data();
                    const withdrawalItem = document.createElement('div');
                    withdrawalItem.classList.add('withdrawal-item');

                    const timestamp = withdrawal.timestamp ? new Date(withdrawal.timestamp.toDate()).toLocaleString() : 'N/A';
                    const statusClass = withdrawal.status || 'pending'; // Default to pending if not set

                    withdrawalItem.innerHTML = `
                        <div class="withdrawal-item-header">
                            <span class="withdrawal-amount-display">${withdrawal.jcoinAmount.toLocaleString()} JCoins</span>
                            <span class="withdrawal-status ${statusClass}">${statusClass}</span>
                        </div>
                        <span class="withdrawal-details">Requested for #${withdrawal.nairaAmount.toLocaleString()} NGN</span>
                        <span class="withdrawal-details">Bank: ${withdrawal.bankDetails?.bankName || 'N/A'} - ${withdrawal.bankDetails?.accountNumber || 'N/A'}</span>
                        <span class="withdrawal-details">Date: ${timestamp}</span>
                    `;
                    withdrawalListElement.appendChild(withdrawalItem);
                });
            }
        }

        /**
         * Claims the daily bonus for the user.
         */
        async function claimDailyBonus() {
            if (!currentUser || !currentUserProfile) {
                showMessageBox("Please log in to claim your daily bonus.", 'error');
                return;
            }

            const lastClaimDate = localStorage.getItem(`jchat-daily-bonus-${currentUser.uid}`);
            const today = new Date().toDateString();

            if (lastClaimDate === today) {
                showMessageBox("You've already claimed your daily bonus today! Come back tomorrow.", 'info');
                return;
            }

            toggleButtonLoading(claimDailyBonusButton, true);
            showMessageBox("Claiming daily bonus...", 'loading', true);

            try {
                const userProfileDocRef = doc(db, "artifacts", appId, "users", currentUser.uid, "profiles", "user_profile");
                await runTransaction(db, async (transaction) => {
                    const userProfileSnap = await transaction.get(userProfileDocRef);
                    if (!userProfileSnap.exists()) {
                        throw new Error("User profile not found.");
                    }

                    const currentJCoins = userProfileSnap.data().jCoins || 0;
                    const currentGas = userProfileSnap.data().gas || 0;
                    const totalGasEarned = userProfileSnap.data().totalGasEarned || 0;

                    transaction.update(userProfileDocRef, {
                        jCoins: currentJCoins + DAILY_BONUS_JCOINS,
                        gas: currentGas + DAILY_BONUS_GAS,
                        totalGasEarned: totalGasEarned + DAILY_BONUS_GAS,
                        updatedAt: serverTimestamp()
                    });

                    // Add a transaction record for the bonus
                    const userTransactionsCollectionRef = collection(db, "artifacts", appId, "users", currentUser.uid, "transactions");
                    await addDoc(userTransactionsCollectionRef, {
                        type: 'credit',
                        amount: DAILY_BONUS_JCOINS,
                        description: `Daily Login Bonus`,
                        timestamp: serverTimestamp()
                    });
                });

                localStorage.setItem(`jchat-daily-bonus-${currentUser.uid}`, today);
                showMessageBox(`Daily bonus claimed! You received ${DAILY_BONUS_JCOINS} JCoins and ${DAILY_BONUS_GAS} Gas (XP).`, 'success');
                playCoinSound();
                updateDailyBonusButtonState(); // Update button state immediately
            } catch (error) {
                console.error("JCHAT_ERROR: Error claiming daily bonus:", error);
                showMessageBox(`Failed to claim daily bonus: ${error.message}`, 'error');
            } finally {
                toggleButtonLoading(claimDailyBonusButton, false);
            }
        }

        /**
         * Updates the state of the daily bonus button.
         */
        function updateDailyBonusButtonState() {
            if (!claimDailyBonusButton || !currentUser) return;

            const lastClaimDate = localStorage.getItem(`jchat-daily-bonus-${currentUser.uid}`);
            const today = new Date().toDateString();

            if (lastClaimDate === today) {
                claimDailyBonusButton.disabled = true;
                claimDailyBonusButton.textContent = "Claimed Today!";
            } else {
                claimDailyBonusButton.disabled = false;
                claimDailyBonusButton.textContent = "Claim Now";
            }
        }


        /**
         * Fetches and displays the user's JCoin balance, Gas balance, and transaction history.
         * @param {boolean} [loadMore=false] - If true, appends to existing transactions.
         */
        async function fetchAndDisplayWallet(loadMore = false) {
            if (!currentUser) {
                if (jcoinBalanceElement) jcoinBalanceElement.textContent = "0"; // Null check
                if (gasBalanceElement) gasBalanceElement.textContent = "0 Gas (XP)"; // Null check
                if (usdBalanceElement) usdBalanceElement.textContent = formatLocalCurrency(0) + ' ' + userCurrency.label; // Null check
                if (noTransactionsMessage) noTransactionsMessage.style.display = 'block'; // Null check
                if (noTransactionsMessage) noTransactionsMessage.textContent = "Please log in to view your wallet."; // Null check
                if (userReferenceIdSpan) userReferenceIdSpan.textContent = "N/A"; // Hide user ID for non-logged in, null check
                if (loadMoreTransactionsButton) loadMoreTransactionsButton.style.display = 'none'; // Hide load more button
                updateWithdrawalButtonState(); // Update withdrawal button for logged out state
                renderWithdrawalHistory([]); // Clear withdrawal history
                return;
            }

            if (userReferenceIdSpan) userReferenceIdSpan.textContent = currentUser.uid; // Display user's ID for reference, null check

            if (!loadMore) {
                showMessageBox("Loading wallet...", 'loading', true);
            }

            const userProfileDocRef = doc(db, "artifacts", appId, "users", currentUser.uid, "profiles", "user_profile");
            const transactionsCollectionRef = collection(db, "artifacts", appId, "users", currentUser.uid, "transactions");
            const buyRequestsCollectionRef = collection(db, "artifacts", appId, "public", "data", "jcoin_buy_requests");
            const withdrawalRequestsCollectionRef = collection(db, "artifacts", appId, "public", "data", "jcoin_withdrawal_requests");


            // Listen for real-time updates to the user's profile (for JCoins, Gas, and Bank Details)
            if (unsubscribeProfile) unsubscribeProfile(); // Unsubscribe previous listener if exists
            unsubscribeProfile = onSnapshot(userProfileDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    currentUserProfile = docSnap.data(); // Keep profile data updated
                    const jCoins = currentUserProfile.jCoins ?? 0;
                    const gas = currentUserProfile.gas ?? 0; // NEW: Get gas balance

                    // Infer currency once when profile loads/changes
                    setUserCurrencyFromProfile(currentUserProfile);
                    applyCurrencyDisplayForWallet(jcoinPackagesGrid);

                    if (jcoinBalanceElement) jcoinBalanceElement.textContent = jCoins.toLocaleString(); // Null check
                    if (gasBalanceElement) gasBalanceElement.textContent = `${gas.toLocaleString()} Gas (XP)`; // Null check

                    // Balance value display in local currency (NGN for Nigeria, USD otherwise)
                    if (usdBalanceElement) {
                        if (userCurrency.code === 'NGN') {
                            const ngnValue = (jCoins * JCOIN_BUY_RATE_NGN_PER_JCOIN).toFixed(2);
                            usdBalanceElement.textContent = `${formatLocalCurrency(ngnValue)} ${userCurrency.label}`;
                        } else {
                            const usdValue = (jCoins * JCOIN_TO_USD_RATE).toFixed(2);
                            usdBalanceElement.textContent = `${formatLocalCurrency(usdValue)} ${userCurrency.label}`;
                        }
                    }

                    // Populate bank details form
                    if (bankNameInput) bankNameInput.value = currentUserProfile.bankDetails?.bankName || '';
                    if (accountNameInput) accountNameInput.value = currentUserProfile.bankDetails?.accountName || '';
                    if (accountNumberInput) accountNumberInput.value = currentUserProfile.bankDetails?.accountNumber || '';

                    updateWithdrawalButtonState(); // Update withdrawal button state based on new balance/bank details
                    updateDailyBonusButtonState(); // Update daily bonus button state
                    if (!loadMore) { // Only show "Wallet loaded" if it's the initial load
                        showMessageBox("Wallet loaded!", 'success');
                    }
                } else {
                    currentUserProfile = null;
                    if (jcoinBalanceElement) jcoinBalanceElement.textContent = "0"; // Null check
                    if (gasBalanceElement) gasBalanceElement.textContent = "0 Gas (XP)"; // Null check
                    if (usdBalanceElement) usdBalanceElement.textContent = formatLocalCurrency(0) + ' ' + userCurrency.label; // Null check
                    showMessageBox("User profile not found. JCoins are 0.", 'info');
                    updateWithdrawalButtonState(); // Update withdrawal button state
                    updateDailyBonusButtonState(); // Update daily bonus button state
                }
            }, (error) => {
                console.error("JCHAT_ERROR: Error listening to profile for wallet:", error);
                showMessageBox(`Error loading wallet: ${error.message}`, 'error');
            });

            // Listen for real-time updates to the user's transactions
            if (unsubscribeTransactions) unsubscribeTransactions(); // Unsubscribe previous listener if exists

            // Build transaction query with filters and pagination
            let qTransactions = query(transactionsCollectionRef, orderBy("timestamp", "desc"), limit(TRANSACTIONS_PER_PAGE));

            const filterType = transactionTypeFilter ? transactionTypeFilter.value : 'all';
            const searchTerm = transactionSearchInput ? transactionSearchInput.value.toLowerCase() : '';
            // Date filter inputs
            let fromDate = null, toDate = null;
            if (transactionDateFromInput && transactionDateFromInput.value) {
                fromDate = new Date(transactionDateFromInput.value + 'T00:00:00');
            }
            if (transactionDateToInput && transactionDateToInput.value) {
                toDate = new Date(transactionDateToInput.value + 'T23:59:59.999');
            }

            if (filterType !== 'all') {
                qTransactions = query(qTransactions, where("type", "==", filterType));
            }
            // Note: Firestore does not support 'contains' or full-text search directly.
            // For search, we'll filter client-side after fetching, or implement a more complex backend search.
            // For now, if a search term is present, we'll fetch all and filter, or apply a 'startsWith' if possible (not for descriptions).

            if (loadMore && lastVisibleTransaction) {
                qTransactions = query(qTransactions, startAfter(lastVisibleTransaction));
            }

            unsubscribeTransactions = onSnapshot(qTransactions, (snapshot) => {
                if (!loadMore) {
                    if (transactionListElement) transactionListElement.innerHTML = ''; // Clear existing list, null check
                }

                const newTransactions = [];
                snapshot.docs.forEach(doc => {
                    const transaction = doc.data();
                    // Client-side filtering for search term
                    if (searchTerm && !(transaction.description || '').toLowerCase().includes(searchTerm)) {
                        return; // Skip if search term not found
                    }
                    // Date range filter (client-side)
                    const txDate = transaction.timestamp ? transaction.timestamp.toDate() : null;
                    if (fromDate && (!txDate || txDate < fromDate)) return;
                    if (toDate && (!txDate || txDate > toDate)) return;
                    newTransactions.push({ id: doc.id, ...transaction });
                });

                if (newTransactions.length > 0) {
                    lastVisibleTransaction = snapshot.docs[snapshot.docs.length - 1];
                    if (noTransactionsMessage) noTransactionsMessage.style.display = 'none'; // Null check
                    newTransactions.forEach(transaction => {
                        const transactionItem = document.createElement('div');
                        transactionItem.classList.add('transaction-item');
                        transactionItem.dataset.id = transaction.id; // Store document ID for detail view

                        const timestamp = transaction.timestamp ? new Date(transaction.timestamp.toDate()).toLocaleString() : 'N/A';

                        transactionItem.innerHTML = `
                            <div class="transaction-header">
                                <span class="transaction-description">${transaction.description}</span>
                                <span class="transaction-amount ${transaction.type === 'credit' ? 'positive' : 'negative'}">
                                    ${transaction.type === 'credit' ? '+' : '-'}${(Number(transaction.amount)||0).toLocaleString()} JCoins
                                </span>
                            </div>
                            <span class="transaction-timestamp">${timestamp}</span>
                        `;
                        transactionItem.addEventListener('click', () => showTransactionDetailsModal(transaction));
                        if (transactionListElement) transactionListElement.appendChild(transactionItem); // Null check
                    });
                    if (loadMoreTransactionsButton) {
                        loadMoreTransactionsButton.style.display = (snapshot.docs.length === TRANSACTIONS_PER_PAGE) ? 'block' : 'none';
                    }
                } else if (!loadMore) {
                    if (noTransactionsMessage) noTransactionsMessage.style.display = 'block'; // Null check
                    if (noTransactionsMessage) noTransactionsMessage.textContent = "No transactions yet."; // Null check
                    if (loadMoreTransactionsButton) loadMoreTransactionsButton.style.display = 'none';
                } else {
                    if (loadMoreTransactionsButton) loadMoreTransactionsButton.style.display = 'none';
                }
            }, (error) => {
                console.error("JCHAT_ERROR: Error listening to transactions:", error);
                showMessageBox(`Error loading transactions: ${error.message}`, 'error');
            });

            // Check for existing pending BUY requests from this user
            if (unsubscribePendingBuyRequests) unsubscribePendingBuyRequests();
            const qPendingBuyRequests = query(buyRequestsCollectionRef,
                where("userId", "==", currentUser.uid),
                where("status", "==", "pending")
            );
            unsubscribePendingBuyRequests = onSnapshot(qPendingBuyRequests, (snapshot) => {
                if (snapshot.empty) {
                    hasPendingBuyRequest = false;
                    if (sendManualBuyRequestButton) sendManualBuyRequestButton.disabled = false; // Null check
                    document.querySelectorAll('.jcoin-package-card').forEach(card => card.style.pointerEvents = 'auto');
                } else {
                    hasPendingBuyRequest = true;
                    if (sendManualBuyRequestButton) sendManualBuyRequestButton.disabled = true; // Null check
                    document.querySelectorAll('.jcoin-package-card').forEach(card => card.style.pointerEvents = 'none');
                    showMessageBox("You have a pending JCoin purchase request. Please wait for it to be processed.", 'info', true);
                }
            }, (error) => {
                console.error("JCHAT_ERROR: Error checking pending buy requests:", error);
            });

            // Check for existing pending WITHDRAWAL requests from this user
            if (unsubscribePendingWithdrawalRequests) unsubscribePendingWithdrawalRequests();
            let qPendingWithdrawalRequests;
            try {
                qPendingWithdrawalRequests = query(withdrawalRequestsCollectionRef,
                    where("userId", "==", currentUser.uid),
                    orderBy("timestamp", "desc") // Order for display in history
                );
            } catch (_) {
                // Fallback without orderBy if index missing
                qPendingWithdrawalRequests = query(withdrawalRequestsCollectionRef,
                    where("userId", "==", currentUser.uid)
                );
            }
            unsubscribePendingWithdrawalRequests = onSnapshot(qPendingWithdrawalRequests, (snapshot) => {
                const withdrawals = [];
                let pendingFound = false;
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    withdrawals.push({ id: doc.id, ...data });
                    if (data.status === 'pending') {
                        pendingFound = true;
                    }
                });
                hasPendingWithdrawalRequest = pendingFound;
                renderWithdrawalHistory(withdrawals); // Render withdrawal history
                updateWithdrawalButtonState(); // Update button state based on pending withdrawal status
            }, (error) => {
                console.error("JCHAT_ERROR: Error checking pending withdrawal requests:", error);
            });
        }


        // --- Authentication State Listener ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                isAuthReady = true;
                console.log("JCHAT_DEBUG: User authenticated in Wallet Page:", user.uid);
                await fetchAndDisplayHeaderProfile(user);
                fetchAndDisplayWallet(); // Fetch wallet data and check pending requests
                // Render packages only for Nigerian users; others see message via applyCurrencyDisplay
                if (inferCountryCodeFromProfileOrLocale(currentUserProfile) === 'NG') {
                    renderJCoinPackages(); // Render packages after user is loaded
                } else {
                    applyCurrencyDisplayForWallet(jcoinPackagesGrid);
                }
                updateDailyBonusButtonState(); // Update daily bonus button state on auth

            } else {
                console.log("JCHAT_DEBUG: No user signed in. Attempting anonymous sign-in or redirecting to login page.");
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("JCHAT_DEBUG: Signed in with custom token.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("JCHAT_DEBUG: Signed in anonymously.");
                    }
                    // onAuthStateChanged will be triggered again with the new user
                } catch (error) {
                    console.error("JCHAT_ERROR: Error during anonymous sign-in or custom token sign-in:", error);
                    if (!auth.currentUser) {
                        // Redirect to a login page if no user or anonymous sign-in fails
                        // For this isolated HTML, we'll just show a message.
                        // window.location.href = '/login.html';
                    }
                }
                isAuthReady = false;
                if (headerDisplayName) headerDisplayName.textContent = "Guest"; // Null check
                if (headerProfilePic) headerProfilePic.style.display = 'none'; // Null check
                if (headerAvatarIcon) headerAvatarIcon.style.display = 'block'; // Null check
                // Removed adminIconLink logic
                showMessageBox("Please log in to view your wallet.", 'info', true);
                if (jcoinBalanceElement) jcoinBalanceElement.textContent = "0"; // Null check
                if (gasBalanceElement) gasBalanceElement.textContent = "0 Gas (XP)"; // Null check
                if (usdBalanceElement) usdBalanceElement.textContent = formatLocalCurrency(0) + ' ' + userCurrency.label; // Null check
                if (noTransactionsMessage) noTransactionsMessage.style.display = 'block'; // Null check
                if (noTransactionsMessage) noTransactionsMessage.textContent = "Please log in to view your wallet."; // Null check
                if (userReferenceIdSpan) userReferenceIdSpan.textContent = "N/A"; // Hide user ID for non-logged in, null check
                if (jcoinPackagesGrid) jcoinPackagesGrid.innerHTML = '<p style="text-align: center; color: var(--text-light);">Please log in to see JCoin packages.</p>'; // Null check
                if (sendManualBuyRequestButton) sendManualBuyRequestButton.disabled = true; // Disable manual buy for guests, null check
                updateWithdrawalButtonState(); // Update withdrawal button for logged out state
                updateDailyBonusButtonState(); // Update daily bonus button state for logged out state
                renderWithdrawalHistory([]); // Clear withdrawal history for logged out state
            }
        });

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log('JCHAT_DEBUG: DOMContentLoaded - Wallet init');
            // Generate random logos for bank icons
            const bankLogos = document.querySelectorAll('img.bank-logo');
            bankLogos.forEach(img => {
                const bank = img.getAttribute('data-bank') || 'BNK';
                const initials = bank.split(/\s+/).map(w => w[0]).join('').slice(0,3).toUpperCase();
                const canvas = document.createElement('canvas');
                canvas.width = 120; canvas.height = 40;
                const ctx = canvas.getContext('2d');
                // random pastel color based on bank name
                let hash = 0; for (let i=0;i<bank.length;i++) hash = (hash*31 + bank.charCodeAt(i))>>>0;
                const hue = hash % 360; const sat = 60; const light = 70;
                ctx.fillStyle = `hsl(${hue} ${sat}% ${light}%)`;
                ctx.fillRect(0,0,120,40);
                ctx.fillStyle = '#111';
                ctx.font = 'bold 20px Poppins, sans-serif';
                ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.fillText(initials, 60, 22);
                img.src = canvas.toDataURL('image/png');
            });
            // Apply theme on load
            const savedTheme = localStorage.getItem('jchat-theme');
            const themes = ['theme-light-mode', 'theme-dark-mode', 'theme-glass-mode', 'theme-sunset-mode'];
            if (savedTheme && themes.includes(savedTheme)) {
                document.body.classList.remove(...themes);
                document.body.classList.add(savedTheme);
            } else {
                document.body.classList.remove(...themes);
                document.body.classList.add('theme-dark-mode');
            }

            // Manual Buy JCoins input listener
            if (nairaInput) nairaInput.addEventListener('input', calculateJCoinsForManualInput); // Null check

            // Receipt upload listener
            if (receiptUploadInput) receiptUploadInput.addEventListener('change', handleReceiptUpload); // Null check
            const fileInputWrapper = document.querySelector('.file-input-wrapper');
            if (fileInputWrapper && receiptUploadInput) { // Null check
                fileInputWrapper.addEventListener('click', () => {
                    receiptUploadInput.click();
                });
            }

            if (sendManualBuyRequestButton) { // Null check
                sendManualBuyRequestButton.addEventListener('click', () => {
                    if (currentUser && currentUser.email) {
                        showTwoFAModal("Enter your password to confirm JCoin purchase request:", sendBuyJCoinsRequest, []);
                    } else {
                        sendBuyJCoinsRequest(); // Allow anonymous if no email is set
                    }
                });
            }

            // Send JCoins button and modal listeners
            if (sendJCoinsButton) sendJCoinsButton.addEventListener('click', showSendJCoinsModal); // Null check
            if (cancelSendJCoinsButton) cancelSendJCoinsButton.addEventListener('click', hideSendJCoinsModal); // Null check
            if (confirmSendJCoinsButton) confirmSendJCoinsButton.addEventListener('click', () => {
                if (currentUser && currentUser.email) {
                    showTwoFAModal("Enter your password to confirm JCoin transfer:", sendJCoinsConfirmed, []);
                } else {
                    sendJCoinsConfirmed(); // Allow anonymous if no email is set
                }
            }); // Null check

            // Receive button listeners
            if (receiveJCoinsButton) receiveJCoinsButton.addEventListener('click', showReceiveModal);
            if (closeReceiveModalBtn) closeReceiveModalBtn.addEventListener('click', hideReceiveModal);
            if (copyReceiveUserIdBtn) copyReceiveUserIdBtn.addEventListener('click', () => copyToClipboard(receiveUserIdSpan.textContent));
            if (downloadQrPngBtn) downloadQrPngBtn.addEventListener('click', () => downloadCanvasAsPng(receiveQrCanvas, `jchat-receive-${currentUser?.uid || 'user'}.png`));

            // Withdrawal button listener
            if (withdrawalButton) withdrawalButton.addEventListener('click', () => {
                if (currentUser && currentUser.email) {
                    showTwoFAModal("Enter your password to confirm JCoin withdrawal:", sendWithdrawalRequestConfirmed, []);
                } else {
                    sendWithdrawalRequestConfirmed(); // Allow anonymous if no email is set
                }
            }); // Null check

            // Save Bank Details button listener
            if (saveBankDetailsButton) saveBankDetailsButton.addEventListener('click', saveBankDetails); // Null check

            // Daily Bonus button listener
            if (claimDailyBonusButton) claimDailyBonusButton.addEventListener('click', claimDailyBonus); // Null check

            // 2FA Modal listeners
            if (cancelTwoFAButton) cancelTwoFAButton.addEventListener('click', hideTwoFAModal);
            if (confirmTwoFAButton) confirmTwoFAButton.addEventListener('click', handleTwoFAConfirmation);
            if (twoFAPasswordInput) {
                twoFAPasswordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        handleTwoFAConfirmation();
                    }
                });
            }

            // Transaction History Filters
            if (transactionTypeFilter) transactionTypeFilter.addEventListener('change', () => fetchAndDisplayWallet(false));
            if (transactionSearchInput) transactionSearchInput.addEventListener('input', () => fetchAndDisplayWallet(false));
            if (loadMoreTransactionsButton) loadMoreTransactionsButton.addEventListener('click', () => fetchAndDisplayWallet(true));
            if (transactionDateFromInput) transactionDateFromInput.addEventListener('change', () => fetchAndDisplayWallet(false));
            if (transactionDateToInput) transactionDateToInput.addEventListener('change', () => fetchAndDisplayWallet(false));
            if (exportCsvButton) exportCsvButton.addEventListener('click', async () => {
                if (!currentUser) return showMessageBox('Please log in.', 'warning');
                showMessageBox('Preparing CSV export...', 'loading', true);
                try {
                    const filters = getCurrentFilterState();
                    const items = await fetchAllTransactionsForExport(filters);
                    const rows = items.map(t => ({
                        id: t.id,
                        type: t.type,
                        amount: t.amount,
                        description: t.description,
                        status: t.status || '',
                        timestamp: t.timestamp ? t.timestamp.toDate().toISOString() : ''
                    }));
                    const csv = toCsv(rows);
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `jchat-transactions-${Date.now()}.csv`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showMessageBox('CSV downloaded.', 'success');
                } catch (e) {
                    console.error(e);
                    showMessageBox('Failed to export CSV.', 'error');
                }
            });
            if (exportJsonButton) exportJsonButton.addEventListener('click', async () => {
                if (!currentUser) return showMessageBox('Please log in.', 'warning');
                showMessageBox('Preparing JSON export...', 'loading', true);
                try {
                    const filters = getCurrentFilterState();
                    const items = await fetchAllTransactionsForExport(filters);
                    const json = JSON.stringify(items.map(t => ({
                        id: t.id,
                        type: t.type,
                        amount: t.amount,
                        description: t.description,
                        status: t.status || '',
                        timestamp: t.timestamp ? t.timestamp.toDate().toISOString() : ''
                    })), null, 2);
                    const blob = new Blob([json], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `jchat-transactions-${Date.now()}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showMessageBox('JSON downloaded.', 'success');
                } catch (e) {
                    console.error(e);
                    showMessageBox('Failed to export JSON.', 'error');
                }
            });
        });

        function getCurrentFilterState() {
            const filterType = transactionTypeFilter?.value || 'all';
            const searchTerm = (transactionSearchInput?.value || '').toLowerCase();
            let from = null, to = null;
            if (transactionDateFromInput?.value) from = new Date(transactionDateFromInput.value + 'T00:00:00');
            if (transactionDateToInput?.value) to = new Date(transactionDateToInput.value + 'T23:59:59.999');
            return { type: filterType, searchTerm, from, to };
        }

        window.addEventListener('storage', (event) => {
            if (event.key === 'jchat-theme') {
                const newTheme = event.newValue || 'theme-dark-mode';
                const themes = ['theme-light-mode', 'theme-dark-mode', 'theme-glass-mode', 'theme-sunset-mode'];
                if (themes.includes(newTheme)) {
                    document.body.classList.remove(...themes);
                    document.body.classList.add(newTheme);
                }
            }
        });

        window.addEventListener('beforeunload', () => {
            if (unsubscribeProfile) unsubscribeProfile();
            if (unsubscribeTransactions) unsubscribeTransactions();
            if (unsubscribePendingBuyRequests) unsubscribePendingBuyRequests();
            if (unsubscribePendingWithdrawalRequests) unsubscribePendingWithdrawalRequests();
        });

        // --- Removed Bottom Navigation Bar Toggle Logic ---
        // const bottomNavBar = document.getElementById('bottomNavBar');
        // const navToggleBtn = document.getElementById('navToggleBtn');

        // function toggleNavBarVisibility() {
        //     const toggleIcon = navToggleBtn.querySelector('i');
        //     const isHidden = bottomNavBar.classList.toggle('nav-bar-hidden-full');

        //     if (isHidden) {
        //         if (toggleIcon) toggleIcon.classList.remove('fa-chevron-down'); // Null check
        //         if (toggleIcon) toggleIcon.classList.add('fa-chevron-up'); // Null check
        //     } else {
        //         if (toggleIcon) toggleIcon.classList.remove('fa-chevron-up'); // Null check
        //         if (toggleIcon) toggleIcon.classList.add('fa-chevron-down'); // Null check
        //     }
        // }

        // if (bottomNavBar) bottomNavBar.classList.add('nav-bar-hidden-full'); // Null check
        // if (navToggleBtn && navToggleBtn.querySelector('i')) { // Null check
        //     navToggleBtn.querySelector('i').classList.remove('fa-chevron-down');
        //     navToggleBtn.querySelector('i').classList.add('fa-chevron-up');
        // }
        // if (navToggleBtn) navToggleBtn.addEventListener('click', toggleNavBarVisibility); // Null check

        // --- QR code generation (simple) ---
        function drawSimpleQr(canvas, text) {
            // Placeholder tiny pseudo-QR (not a real QR encoder). For real QR, integrate a small lib later.
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#000';
            // Hash text into deterministic squares
            let hash = 0;
            for (let i = 0; i < text.length; i++) hash = (hash * 31 + text.charCodeAt(i)) >>> 0;
            const size = 21; // 21x21 pseudo grid
            const cell = Math.floor((canvas.width - 20) / size);
            const offset = 10;
            for (let y = 0; y < size; y++) {
                for (let x = 0; x < size; x++) {
                    const bit = ((hash >> ((x + y * size) % 31)) & 1) === 1;
                    if ((x < 4 && y < 4) || (x > size - 5 && y < 4) || (x < 4 && y > size - 5)) {
                        // finder-like squares
                        ctx.fillStyle = '#000';
                        ctx.fillRect(offset + x * cell, offset + y * cell, cell, cell);
                    } else if (bit) {
                        ctx.fillStyle = '#000';
                        ctx.fillRect(offset + x * cell, offset + y * cell, cell, cell);
                    }
                }
            }
        }

        function showReceiveModal() {
            if (!receiveJCoinsModal || !currentUser) return;
            receiveUserIdSpan.textContent = currentUser.uid;
            drawSimpleQr(receiveQrCanvas, `jchat:uid:${currentUser.uid}`);
            receiveJCoinsModal.classList.add('active');
        }
        function hideReceiveModal() {
            if (receiveJCoinsModal) receiveJCoinsModal.classList.remove('active');
        }

        function downloadCanvasAsPng(canvas, filename) {
            const link = document.createElement('a');
            link.download = filename;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        // --- Export helpers ---
        function toCsv(rows) {
            if (!rows.length) return '';
            const headers = Object.keys(rows[0]);
            const escape = (v) => {
                if (v == null) return '';
                const s = String(v).replace(/"/g, '""');
                return /[",\n]/.test(s) ? `"${s}"` : s;
            };
            return rows.map(row => headers.map(fieldName => escape(row[fieldName])).join(',')).join('\n');
        }
    </script>
</body>
</html>