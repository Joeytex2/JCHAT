<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JCHAT - Profile</title>

    <!-- Google Fonts: Poppins for headings, Inter for body text -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Preconnect to Firebase and Cloudinary domains for faster loading -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://*.firebaseio.com" crossorigin>
    <link rel="preconnect" href="https://res.cloudinary.com" crossorigin>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* Universal box-sizing for consistent layout */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        /* Global CSS Variables for easy theme switching */
        :root {
            --pink: #ff2e92;
            --blue: #00d5ff;
            --glass-black: rgba(10, 10, 10, .75);
            --glass-blue: rgba(0, 213, 255, .15);
            --radius: 20px;
            --transition: .3s ease;

            /* These variables will be overridden by theme classes */
            --white: #fff;
            --text-light: rgba(255, 255, 255, .7);
            --background-main: rgba(10, 10, 10, .75);
            --background-gradient-1: #00d5ff;
            --background-gradient-2: #ff2e92;
            --card-background: linear-gradient(145deg, rgba(255, 255, 255, .03), rgba(255, 255, 255, .01));
            --header-background: linear-gradient(135deg, rgba(10, 10, 10, .85), rgba(10, 10, 10, .75));
            --border-light: rgba(255, 255, 255, .05);
            --input-background: rgba(255, 255, 255, 0.05);
            --button-background: linear-gradient(90deg, var(--blue), var(--pink));
            --button-shadow: 0 4px 15px var(--blue), 0 44px 15px var(--pink);

            /* New variables for consistent theming */
            --background-color-primary: #1a1a2e;
            --background-color-secondary: #0f0f1f;
            --header-background-color: #2a2a4a;
            --footer-background-color: #2a2a4a;
            --content-background-color: #20203a;
            --card-background-color: #2a2a4a;
            --text-color-primary: #e0e0e0;
            --text-color-secondary: #b0b0d0;
            --notification-badge-color: #ff2e92;
            --status-online: #4CAF50;
            --status-offline: #6c757d;
            --status-away: #FFC107;
            --delete-button-color: #dc3545;
            --warning-color: #ffc107;
            --accent-color: #00d5ff; /* A bright cyan */
            --accent-color-dark: #00aaff;
            --border-color: #3a3a5a;
        }

        /* --- Theme Definitions (Light and Dark Mode) --- */
        /* Light Mode */
        body.theme-light-mode {
            --background-main: #f0f2f5; /* Light gray background */
            --background-gradient-1: #e0e2e5; /* Subtle lighter gradient */
            --background-gradient-2: #d0d2d5; /* Subtle darker gradient */
            --white: #333; /* Dark text for readability */
            --text-light: #666; /* Lighter dark text */
            --card-background: rgba(255, 255, 255, 0.95); /* Near white cards */
            --header-background: rgba(255, 255, 255, 0.98); /* Near white header */
            --border-light: rgba(0, 0, 0, 0.1); /* Light borders */
            --input-background: rgba(0, 0, 0, 0.05); /* Light input background */
            --button-background: linear-gradient(90deg, #6dd5ed, #2193b0); /* Blue gradient */
            --button-shadow: 0 4px 15px rgba(109, 213, 237, 0.4), 0 4px 15px rgba(33, 147, 176, 0.4);

            /* New variables override for light mode */
            --background-color-primary: #f0f2f5;
            --background-color-secondary: #e0e2e5;
            --header-background-color: #ffffff;
            --footer-background-color: #ffffff;
            --content-background-color: #f7f9fb;
            --card-background-color: #ffffff;
            --text-color-primary: #333333;
            --text-color-secondary: #666666;
            --text-color-light: #999999;
            --accent-color: #007bff;
            --accent-color-dark: #0056b3;
            --border-color: #e0e0e0;
            --input-background-color: #f0f0f0;
            --button-background: #e9ecef;
            --button-hover-background: #dee2e6;
            --active-item-background: rgba(0, 123, 255, 0.1);
            --notification-badge-color: #dc3545;
            --status-online: #28a745;
            --status-offline: #6c757d;
            --status-away: #ffc107;
            --delete-button-color: #dc3545;
            --warning-color: #ffc107;
        }

        /* Dark Mode */
        body.theme-dark-mode {
            --background-main: #1a1a2e; /* Deep purple-dark blue */
            --background-gradient-1: #16213e; /* Slightly lighter deep blue */
            --background-gradient-2: #0f3460; /* Darker blue */
            --white: #e0e0e0; /* Off-white text */
            --text-light: #a0a0a0; /* Grayish text */
            --card-background: rgba(25, 25, 40, 0.7); /* Darker, less transparent cards */
            --header-background: linear-gradient(135deg, rgba(10, 10, 20, .85), rgba(10, 10, 20, .75)); /* Original dark header */
            --border-light: rgba(255, 255, 255, 0.08); /* Subtle white borders */
            --input-background: rgba(255, 255, 255, 0.08);
            --button-background: linear-gradient(90deg, #e94560, #ba2f49); /* Reddish gradient */
            --button-shadow: 0 4px 15px rgba(233, 69, 96, 0.4), 0 4px 15px rgba(186, 47, 73, 0.4);

            /* New variables override for dark mode */
            --background-color-primary: #121212;
            --background-color-secondary: #1e1e1e;
            --header-background-color: #2c2c2c;
            --footer-background-color: #2c2c2c;
            --content-background-color: #242424;
            --card-background-color: #2c2c2c;
            --text-color-primary: #ffffff;
            --text-color-secondary: #bbbbbb;
            --accent-color: #bb86fc;
            --accent-color-dark: #9a67ea;
            --border-color: #444444;
            --input-background-color: #383838;
            --button-background: #383838;
            --button-hover-background: #505050;
            --active-item-background: rgba(187, 134, 252, 0.2);
            --notification-badge-color: #cf6679;
            --delete-button-color: #f44336;
            --warning-color: #ffeb3b;
        }

        /* Glass Mode specific variables (from original Profile.html snippet, adapted) */
        body.theme-glass-mode {
            --background-main: rgba(10, 10, 10, 0.75);
            background-image: url('https://source.unsplash.com/random/1920x1080?abstract,blur') !important;
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
            backdrop-filter: blur(10px);
            --card-background: rgba(25, 25, 40, 0.7);
            --white: #e0e0e0; /* text-color */
            --text-light: rgba(255, 255, 255, 0.7);
            --input-background: rgba(255, 255, 255, 0.05);
            --border-light: rgba(255, 255, 255, 0.1); /* glass-border-color */
            --button-background: linear-gradient(90deg, var(--pink), var(--blue));
            --button-shadow: 0 4px 15px var(--blue), 0 4px 15px var(--pink);
            box-shadow: inset 0 0 100px rgba(0, 0, 0, 0.5); /* Inner shadow for glass effect */

            /* New variables override for glass mode */
            --background-color-primary: rgba(10, 10, 10, 0.75);
            --background-color-secondary: rgba(10, 10, 10, 0.6);
            --header-background-color: rgba(10, 10, 10, 0.85);
            --footer-background-color: rgba(10, 10, 10, 0.85);
            --content-background-color: rgba(10, 10, 10, 0.75);
            --card-background-color: rgba(25, 25, 40, 0.7);
            --text-color-primary: #e0e0e0;
            --text-color-secondary: #b0b0d0;
            --accent-color: #00d5ff;
            --accent-color-dark: #00aaff;
            --border-color: rgba(255, 255, 255, 0.1);
            --input-background-color: rgba(255, 255, 255, 0.05);
            --button-background: rgba(0, 213, 255, 0.15); /* Glassy button */
            --button-hover-background: rgba(0, 213, 255, 0.25);
            --active-item-background: rgba(0, 213, 255, 0.1);
        }

        /* NEW: Sunset Theme (from original Profile.html snippet, adapted) */
        body.theme-sunset-mode {
            background: linear-gradient(to top, #ff7e5f, #feb47b) !important;
            --background-main: linear-gradient(to top, #ff7e5f, #feb47b);
            --card-background: rgba(255, 255, 255, 0.15); /* Slightly transparent white for contrast */
            --white: #fff; /* White text for readability */
            --text-light: rgba(255, 255, 255, 0.8);
            --input-background: rgba(255, 255, 255, 0.1);
            --border-light: rgba(255, 255, 255, 0.3);
            --button-background: linear-gradient(90deg, #fd746c, #ff9068); /* Sunset gradient */
            --button-shadow: 0 4px 15px rgba(253, 116, 108, 0.4), 0 4px 15px rgba(255, 144, 104, 0.4);

            /* New variables override for sunset mode */
            --background-color-primary: #ff7e5f;
            --background-color-secondary: #feb47b;
            --header-background-color: rgba(255, 126, 95, 0.9);
            --footer-background-color: rgba(255, 126, 95, 0.9);
            --content-background-color: rgba(255, 126, 95, 0.85);
            --card-background-color: rgba(255, 255, 255, 0.15);
            --text-color-primary: #fff;
            --text-color-secondary: rgba(255, 255, 255, 0.8);
            --accent-color: #ffd700;
            --accent-color-dark: #ccaa00;
            --border-color: rgba(255, 255, 255, 0.3);
            --input-background-color: rgba(255, 255, 255, 0.2);
            --button-background: rgba(255, 255, 255, 0.2);
            --button-hover-background: rgba(255, 255, 255, 0.3);
            --active-item-background: rgba(255, 215, 0, 0.1);
        }


        /* Always show scrollbar to prevent layout shifts */
        html {
            overflow-y: scroll;
        }

        body {
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden; /* Prevent horizontal scroll */
            padding-bottom: 120px; /* Space for nav bar (60px) + toggle button (60px) */
            background-color: var(--background-main);
            background-image: radial-gradient(circle at top left, var(--background-gradient-1), transparent 100px),
                              radial-gradient(circle at bottom right, var(--background-gradient-2), transparent 150px);
            color: var(--white);
            transition: background-color 0.5s ease, color 0.5s ease; /* Smooth theme transition */
        }

        /* Header Styling (from Home.html) */
        header {
            background: var(--header-background);
            border-bottom: 1px solid var(--border-light);
            padding: 10px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 55px;
            z-index: 10;
            display: flex;
            justify-content: center;
        }

        header .header-content-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 1200px;
            padding: 0 30px;
        }

        .logo {
            font-family: 'Poppins', sans-serif;
            font-size: 1.8rem;
            font-weight: 800;
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            letter-spacing: -0.03em;
            text-decoration: none;
        }

        /* Header Navigation (from Home.html) */
        header nav ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            gap: 25px;
        }

        header nav ul li a {
            color: var(--white);
            text-decoration: none;
            font-weight: 600;
            font-size: 1.1rem;
            padding: 5px 0;
            position: relative;
            transition: color var(--transition);
        }

        header nav ul li a::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: 0;
            width: 0;
            height: 3px;
            background: var(--blue);
            border-radius: 2px;
            transition: width var(--transition);
        }

        header nav ul li a:hover {
            color: var(--blue);
        }

        header nav ul li a:hover::after {
            width: 100%;
        }

        /* User Profile Header Styling (from Home.html) */
        .user-profile-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Notification Icon Styling (from Home.html) */
        .notification-icon-wrapper {
            position: relative;
            margin-right: 15px; /* Space between notification and profile */
        }

        .notification-icon-wrapper a {
            text-decoration: none; /* Remove underline from link */
            color: inherit; /* Inherit color from parent */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-icon-wrapper i {
            font-size: 1.5rem; /* Adjust size as needed */
            /* Apply gradient to icons */
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent; /* Fallback for browsers that don't support background-clip: text on icons */
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .notification-icon-wrapper i:hover {
            transform: scale(1.1);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--notification-badge-color); /* Use pink for notifications */
            color: var(--white);
            border-radius: 50%;
            padding: 3px 7px;
            font-size: 0.7rem;
            font-weight: 700;
            min-width: 20px;
            text-align: center;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            /* Hide if no notifications */
            display: none;
        }

        .user-profile-header #profileLink {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: var(--white);
            transition: opacity 0.3s ease, background-color 0.3s ease;
            padding: 5px 10px;
            border-radius: var(--radius);
        }

        .user-profile-header #profileLink:hover {
            opacity: 0.8;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .user-profile-header img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--accent-color); /* Used accent-color for consistency */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: opacity 0.3s ease;
        }

        .user-profile-header i {
            font-size: 30px;
            /* Apply gradient to icons */
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent; /* Fallback */
        }

        .user-profile-header span {
            font-weight: 600;
            font-size: 1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
            /* Apply gradient to names */
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent; /* Fallback */
        }

        /* NEW: Admin Icon Styling */
        #adminIconLink {
            display: none; /* Hidden by default */
            margin-right: 15px; /* Space it out from other icons */
            /* Apply gradient to icons */
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent; /* Fallback */
            font-size: 1.5rem;
            transition: transform 0.2s ease;
        }

        #adminIconLink:hover {
            transform: scale(1.1);
        }


        /* Logout Button Styling (from Home.html) */
        #logoutButton {
            background: linear-gradient(90deg, var(--pink), var(--blue));
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.3s ease;
            opacity: 0.8;
            margin-left: 10px;
        }

        #logoutButton:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px var(--pink), 0 44px 15px var(--blue);
            opacity: 1;
        }

        #logoutButton i {
            color: var(--white);
            font-size: 0.9rem;
        }

        /* Main Content Area (from Home.html) */
        main {
            flex-grow: 1;
            padding: 40px 0;
            padding-top: 55px; /* Adjust for fixed header */
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* Align content to top */
            text-align: center;
        }

        .content-wrapper {
            width: 100%;
            max-width: 800px; /* Adjust as needed */
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
        }

        /* Profile Section (adapted from original Profile.html and settings-section) */
        .profile-section {
            background: var(--card-background);
            border: 1px solid var(--glass-blue); /* Consistent border */
            backdrop-filter: blur(10px) saturate(180%);
            border-radius: var(--radius);
            box-shadow: 0 8px 25px rgba(0, 0, 0, .3);
            padding: 2rem;
            width: 90%;
            max-width: 600px; /* Max width for consistency */
            margin: 20px auto;
            display: flex;
            flex-direction: column;
            align-items: center; /* Center content */
            gap: 1.5rem;
            text-align: center;
            position: relative;
        }

        .profile-header-area { /* New wrapper for top part of profile */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            width: 100%;
        }

        .profile-pic-wrapper {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            overflow: hidden;
            border: 4px solid var(--blue);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            position: relative;
            flex-shrink: 0;
        }

        .profile-pic {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .profile-pic-placeholder {
            font-size: 100px;
            /* Apply gradient to icons */
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent; /* Fallback */
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .edit-profile-pic-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 40%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s ease;
            /* Ensure it's not clickable when not owner */
            pointer-events: none;
        }

        .profile-pic-wrapper:hover .edit-profile-pic-overlay {
            opacity: 1;
        }
        /* Make overlay clickable only for owner */
        .profile-pic-wrapper.owner .edit-profile-pic-overlay {
            pointer-events: auto;
        }

        /* NEW: Profile picture loading spinner */
        .profile-pic-wrapper .profile-pic-loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--blue);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            display: none; /* Hidden by default */
        }
        .profile-pic-wrapper.loading .profile-pic-loader {
            display: block;
        }
        .profile-pic-wrapper.loading .profile-pic,
        .profile-pic-wrapper.loading .profile-pic-placeholder,
        .profile-pic-wrapper.loading .edit-profile-pic-overlay {
            opacity: 0.3; /* Dim content while loading */
            pointer-events: none; /* Disable interaction */
        }


        .profile-name {
            font-family: 'Poppins', sans-serif;
            font-size: 2.2rem;
            font-weight: 800;
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            margin: 0;
            text-align: center;
        }

        .profile-bio, .profile-location, .profile-email, .profile-info-item {
            font-size: 1rem;
            color: var(--text-light);
            margin: 0;
            line-height: 1.5;
        }

        .profile-location i, .profile-email i, .profile-info-item i {
            /* Apply gradient to icons */
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent; /* Fallback */
            margin-right: 5px;
        }


        .profile-stats {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-top: 1rem;
            flex-wrap: wrap;
            gap: 15px;
            background: rgba(0, 0, 0, 0.2); /* Consistent with old profile, but blended */
            border-radius: 10px;
            padding: 10px 0;
            border: 1px solid var(--border-light); /* Consistent border */
        }

        .stat-item {
            text-align: center;
            color: var(--white); /* Use --white for main text */
            flex: 1 1 30%; /* Allow items to grow/shrink, 3 items per row on wider screens */
            min-width: 100px; /* Minimum width to prevent squishing */
        }

        .stat-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--white);
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-light); /* Lighter text for labels */
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* NEW: Level Display and Progress Bar Styles */
        .level-link-wrapper {
            text-decoration: none; /* Remove underline from the link */
            color: inherit; /* Inherit text color */
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%; /* Ensure it takes full width for centering */
            padding: 5px 0; /* Add some padding */
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .level-link-wrapper:hover {
            transform: translateY(-2px);
        }

        .level-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            width: 100%; /* Ensure it takes full width */
        }

        .profile-level-info { /* Adjusted to target the new div */
            display: flex;
            flex-direction: column; /* Stack icon and name */
            align-items: center;
            gap: 8px;
            margin-top: 10px; /* Space from bio/location */
        }

        .profile-level-name {
            font-family: 'Poppins', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            /* Apply gradient to level name */
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0; /* Remove default margin */
        }

        .profile-level-icon {
            font-size: 2.5rem; /* Larger icon for the main level display */
            /* Apply gradient to level icon */
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .progress-bar-container {
            width: 80%; /* Adjust width as needed */
            height: 10px;
            background-color: rgba(255, 255, 255, 0.1); /* Lighter background for the bar */
            border-radius: 5px;
            overflow: hidden;
            margin-top: 5px; /* Space between level name and bar */
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .progress-bar-fill {
            height: 100%;
            width: 100%; /* Always 100% width, the gradient moves */
            background-image: linear-gradient(90deg, var(--pink), var(--blue)); /* Pink to blue gradient */
            background-size: 200% 100%; /* Make gradient twice as wide */
            background-position: right; /* Start with blue showing */
            border-radius: 5px; /* Match container border-radius */
            transition: background-position 0.5s ease-out; /* Smooth transition for position */
        }

        /* Hide the "XP Level" label as requested */
        .level-link-wrapper .stat-label {
            display: none;
        }

        /* JCoin Exchange Rate Display */
        .jcoin-exchange-rate {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 5px;
            text-align: center;
            display: flex; /* Make it a flex container to align icon and text */
            align-items: center;
            justify-content: center;
            gap: 5px; /* Space between icon and text */
        }

        /* Padlock icon styling */
        .padlock-icon {
            font-size: 0.9rem; /* Smaller for inline text */
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--pink), var(--blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Wallet link specific styling */
        #walletLink.disabled-link {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none; /* Disables click events */
            background: rgba(255, 255, 255, 0.05); /* Greyed out background */
            box-shadow: none;
        }
        #walletLink.disabled-link:hover {
            transform: none; /* No hover effect when disabled */
            box-shadow: none;
        }
        .wallet-locked-message {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 5px;
            text-align: center;
        }


        .profile-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .profile-action-button {
            background: var(--button-background);
            color: var(--white);
            border: none;
            border-radius: 15px;
            padding: 0.8rem 1.5rem;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: var(--button-shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .profile-action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--blue), 0 6px 20px var(--pink);
        }

        .profile-action-button.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--white);
            border: 1px solid var(--border-light);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
        }

        .profile-action-button.secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        /* Specific button styles for dynamic states */
        /* Removed .profile-action-button.sent, .profile-action-button.friends, .profile-action-button.accept, .profile-action-button.unfriend as these buttons are removed */


        /* Icons within action buttons */
        .profile-action-button i {
            /* Apply gradient to icons */
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }


        /* Inline Profile Details (from original Profile.html snippet) */
        .profile-details-section { /* Renamed from .profile-details to avoid conflict */
            width: 100%;
            text-align: left;
            margin-top: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .profile-details-section label {
            display: block;
            text-align: left;
            margin-bottom: 5px;
            color: var(--text-light); /* Consistent text color */
            font-weight: 600;
            font-size: 0.95rem;
        }

        .profile-details-section input[type="text"],
        .profile-details-section input[type="url"], /* Added for website */
        .profile-details-section textarea {
            width: 100%;
            padding: 0.8rem 1rem;
            margin-bottom: 15px; /* Keep original margin for spacing between fields */
            border: 1px solid var(--border-light); /* Consistent border */
            border-radius: 15px; /* Consistent radius */
            background: var(--input-background); /* Consistent background */
            color: var(--white); /* Consistent text color */
            font-size: 1rem; /* Consistent font size */
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            outline: none;
        }

        .profile-details-section input[type="text"]:focus,
        .profile-details-section input[type="url"]:focus,
        .profile-details-section textarea:focus {
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(0, 213, 255, 0.2);
        }

        .profile-details-section textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Account Settings Sub-section (from original Profile.html snippet) */
        .sub-section {
            margin-top: 30px;
            padding-top: 22px; /* Increased padding-top to give more space from previous section */
            border-top: 1px solid var(--border-light); /* Consistent border */
            text-align: left;
        }

        .sub-section h2 {
            font-family: 'Poppins', sans-serif;
            font-weight: 700; /* Consistent with h3 in settings */
            font-size: 1.5rem; /* Consistent with h3 in settings */
            color: var(--white);
            margin-bottom: 1rem; /* Consistent margin */
            text-align: center;
        }

        .sub-section .input-group {
            margin-bottom: 1rem; /* Consistent margin */
        }

        .sub-section .input-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-light); /* Consistent text color */
            font-weight: 600;
            font-size: 0.95rem;
        }

        .sub-section .input-group input[type="password"],
        .sub-section .input-group input[type="email"] { /* Added email input style */
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid var(--border-light);
            border-radius: 15px;
            background: var(--input-background);
            color: var(--white);
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .sub-section .input-group input[type="password"]:focus,
        .sub-section .input-group input[type="email"]:focus {
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(0, 213, 255, 0.2);
        }


        .sub-section button {
            background: var(--button-background); /* Consistent button style */
            color: var(--white);
            border: none;
            border-radius: 15px;
            padding: 0.7rem 1.2rem;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: var(--button-shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%; /* Make buttons full width */
            margin-top: 1rem; /* Space from inputs */
        }
        .sub-section button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--blue), 0 6px 20px var(--pink);
        }

        .sub-section p {
            color: var(--text-light); /* Consistent text color */
            font-size: 0.9rem; /* Consistent font size */
            margin-top: 20px;
            text-align: center; /* Center text */
        }

        .sub-section p a {
            color: var(--blue); /* Use var(--blue) for links */
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s ease;
        }

        .sub-section p a:hover {
            color: var(--pink); /* Consistent hover color */
        }

        /* Custom Message Box Styles (from Home.html) */
        #messageBox {
            position: fixed;
            top: 50%; /* Center vertically */
            left: 50%;
            transform: translate(-50%, -50%); /* Center both horizontally and vertically */
            background-color: var(--card-background-color); /* Default background, will be overridden for success */
            color: var(--text-color-primary); /* Default text color */
            padding: 20px 30px; /* Increased padding for a more substantial box */
            border-radius: 15px; /* More rounded corners, slightly squarer */
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4); /* Enhanced shadow */
            z-index: 1000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            min-width: 280px; /* Ensure a decent minimum width */
            max-width: 90%;
            text-align: center;
            flex-direction: column; /* Stack icon and text vertically */
            align-items: center;
            gap: 15px; /* Space between icon and text */
        }
        #messageBox.show {
            opacity: 1;
            display: flex;
        }
        /* Success message box specific styling */
        #messageBox.success {
            background-image: linear-gradient(45deg, var(--pink), var(--blue)); /* Pink and blue gradient */
            color: var(--white); /* White text for contrast on gradient */
            border: none; /* No border for gradient background */
            box-shadow: 0 8px 30px rgba(0, 213, 255, 0.5), 0 8px 30px rgba(255, 46, 146, 0.5); /* Glowing shadow */
        }
        #messageBox.error { border-left: 5px solid var(--delete-button-color); background-color: var(--card-background-color); color: var(--text-color-primary); }
        #messageBox.info { border-left: 5px solid var(--accent-color); background-color: var(--card-background-color); color: var(--text-color-primary); }
        #messageBox.warning { border-left: 5px solid var(--warning-color); background-color: var(--card-background-color); color: var(--text-color-primary); }

        #messageBox i {
            font-size: 2.5rem; /* Larger icon for prominence */
            margin-bottom: 5px; /* Space between icon and text */
            /* Apply gradient to message box icons */
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        #messageBox.success i { color: var(--white); } /* White icon for success */
        #messageBox.error i { color: var(--delete-button-color); }
        #messageBox.info i { color: var(--accent-color); }
        #messageBox.warning i { color: var(--warning-color); }

        #messageBox span {
            font-size: 1.1rem; /* Slightly larger text */
            font-weight: 600;
        }

        @keyframes pulse-bg {
            0% { background-color: var(--accent-color); }
            50% { background-color: rgba(0, 213, 255, 0.7); }
            100% { background-color: var(--accent-color); }
        }
        #messageBox.loading-pulse { animation: pulse-bg 1.5s infinite ease-in-out; }

        /* Loader styles for buttons (from Home.html) */
        .button-loader {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid var(--white);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: none;
            flex-shrink: 0; /* Prevent loader from shrinking */
        }
        .button-loader.active { display: block; }
        .button-text { display: block; }
        .loading .button-text { display: none; }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Custom Confirmation Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: var(--card-background);
            padding: 30px;
            border-radius: var(--radius);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            text-align: center;
            max-width: 400px;
            width: 90%;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .modal-overlay.active .modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        .modal-content h3 {
            color: var(--white);
            margin-top: 0;
            margin-bottom: 20px;
            font-family: 'Poppins', sans-serif;
        }
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
        }
        .modal-buttons button {
            padding: 10px 25px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .modal-buttons button.confirm-btn {
            background: linear-gradient(90deg, var(--pink), var(--blue));
            color: var(--white);
            box-shadow: 0 4px 10px rgba(0, 213, 255, 0.3);
        }
        .modal-buttons button.confirm-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 213, 255, 0.4);
        }
        .modal-buttons button.cancel-btn {
            background: var(--input-background);
            color: var(--text-light);
            border: 1px solid var(--border-light);
        }
        .modal-buttons button.cancel-btn:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.1);
        }

        /* --- Bottom Navigation Bar (reused from Home.html) --- */
        #bottomNavBar {
            position: fixed;
            left: 0;
            width: 100%;
            height: 60px;
            background: var(--header-background);
            border-top: 1px solid var(--border-light);
            box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0 10px;
            z-index: 50;
            bottom: 60px; /* Positioned above the toggle button */
            transition: bottom 0.3s ease-out; /* Smooth slide transition */
        }

        #bottomNavBar.nav-bar-hidden-full {
            bottom: -60px; /* Move it completely off-screen below */
        }

        .nav-icon-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--text-light);
            font-size: 0.75rem;
            font-weight: 600;
            transition: color 0.2s ease, transform 0.2s ease;
            flex: 1;
            max-width: 80px;
        }

        .nav-icon-item:hover {
            color: var(--white);
        }

        .nav-icon-circle {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--blue), var(--pink));
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .nav-icon-item:hover .nav-icon-circle {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px var(--blue), 0 4px 12px var(--pink);
        }

        .nav-icon-circle i {
            color: var(--white);
            font-size: 1.3rem;
            transition: transform 0.2s ease;
        }

        .nav-icon-item.active .nav-icon-circle {
            background: linear-gradient(45deg, var(--pink), var(--blue));
            box-shadow: 0 4px 12px var(--pink), 0 44px 12px var(--blue);
        }
        .nav-icon-item.active {
            color: var(--white);
        }

        /* New Toggle Button (reused from Home.html) */
        #navToggleBtn {
            position: fixed;
            bottom: 0px; /* Position at the very bottom */
            left: 50%;
            transform: translateX(-50%);
            width: 60px; /* Slightly larger button */
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--pink), var(--blue)); /* Pink to blue gradient */
            color: var(--white);
            border: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem; /* Larger icon */
            cursor: pointer;
            z-index: 60; /* Higher than nav bar */
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.3s ease;
        }

        #navToggleBtn:hover {
            transform: translateX(-50%) scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
            background: linear-gradient(45deg, var(--blue), var(--pink)); /* Reverse gradient on hover */
        }

        #navToggleBtn i {
            transition: transform 0.3s ease; /* Smooth icon rotation */
        }

        #navToggleBtn.rotated i {
            transform: rotate(180deg); /* Rotate icon when nav is hidden */
        }

        /* NEW: JCoin Request Modal Styles */
        #jcoinRequestModal.modal-overlay { /* Specificity for this modal */
            background-color: rgba(0, 0, 0, 0.6);
        }

        #jcoinRequestModal .modal-content {
            max-width: 500px;
            text-align: left;
        }
        #jcoinRequestModal .modal-content h3 {
            text-align: center;
            margin-bottom: 1.5rem;
        }
        #jcoinRequestModal .modal-content h3 i {
            /* Apply gradient to modal header icon */
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-right: 10px;
        }
        #jcoinRequestModal .modal-content .input-group {
            margin-bottom: 1rem;
        }
        #jcoinRequestModal .modal-content .input-group input[type="number"],
        #jcoinRequestModal .modal-content .input-group input[type="file"] {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid var(--border-light);
            border-radius: 15px;
            background: var(--input-background);
            color: var(--white);
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        #jcoinRequestModal .modal-content .input-group input[type="number"]:focus,
        #jcoinRequestModal .modal-content .input-group input[type="file"]:focus {
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(0, 213, 255, 0.2);
        }
        #jcoinRequestModal .modal-content .file-input-label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-light);
            font-weight: 600;
            font-size: 0.95rem;
            text-align: left;
        }
        #jcoinRequestModal .modal-content .file-input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--input-background);
            border: 1px solid var(--border-light);
            border-radius: 15px;
            padding: 0.8rem 1rem;
            cursor: pointer;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        #jcoinRequestModal .modal-content .file-input-wrapper:hover {
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(0, 213, 255, 0.2);
        }
        #jcoinRequestModal .modal-content .file-input-wrapper i {
            /* Apply gradient to file input icon */
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        #jcoinRequestModal .modal-content .file-name {
            flex-grow: 1;
            color: var(--text-light);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .gradient-text { /* Reused from Home.html for consistency */
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        #jcoinRequestModal .modal-content .receipt-preview {
            max-width: 100px;
            max-height: 100px;
            border-radius: 8px;
            object-fit: cover;
            margin-top: 10px;
            border: 1px solid var(--border-light);
            display: none;
        }
        .modal-button {
            background: var(--button-background);
            color: var(--white);
            border: none;
            border-radius: 15px;
            padding: 0.7rem 1.2rem;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: var(--button-shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex: 1; /* Make buttons take equal width */
        }
        .modal-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--blue), 0 66px 20px var(--pink);
        }
        .modal-button.cancel-button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-light);
            box-shadow: none;
        }
        .modal-button.cancel-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 1.5rem;
        }


        /* Responsive Adjustments (from Home.html / privacy_settings.html) */
        @media (max-width: 600px) {
            header .header-content-wrapper {
                padding: 0 20px;
            }
            .logo {
                font-size: 1.6rem;
            }
            header nav ul {
                display: none;
            }
            header nav ul li a {
                font-size: 1.1rem;
            }
            .user-profile-header #profileLink {
                padding: 5px;
            }
            .user-profile-header span {
                max-width: 90px;
            }
            .user-profile-header img {
                width: 30px;
                height: 30px;
            }
            .user-profile-header i {
                font-size: 25px;
            }
            #logoutButton {
                width: 25px;
                height: 25px;
                font-size: 0.8rem;
                margin-left: 8px;
            }
            #logoutButton i {
                font-size: 0.8rem;
            }
            .profile-section {
                padding: 1.5rem;
            }
            .profile-name {
                font-size: 1.8rem;
            }
            .profile-bio, .profile-location, .profile-email, .profile-info-item {
                font-size: 0.9rem;
            }
            .profile-level-icon {
                font-size: 2rem;
            }
            .profile-level-name {
                font-size: 1.2rem;
            }
            .profile-stats {
                gap: 10px;
            }
            .stat-value {
                font-size: 1.2rem;
            }
            .stat-label {
                font-size: 0.75rem;
            }
            .profile-action-button {
                padding: 0.7rem 1.2rem;
                font-size: 0.8rem;
            }
            .profile-details-section label {
                font-size: 0.85rem;
            }
            .profile-details-section input[type="text"],
            .profile-details-section input[type="url"],
            .profile-details-section textarea {
                padding: 0.7rem 0.9rem;
                font-size: 0.9rem;
            }
            .sub-section h2 {
                font-size: 1.3rem;
            }
            .sub-section .input-group label {
                font-size: 0.85rem;
            }
            .sub-section .input-group input[type="password"],
            .sub-section .input-group input[type="email"] {
                padding: 0.7rem 0.9rem;
                font-size: 0.9rem;
            }
            .sub-section button {
                padding: 0.6rem 1rem;
                font-size: 0.8rem;
            }
            .sub-section p {
                font-size: 0.8rem;
            }
            #bottomNavBar {
                height: 55px;
                padding: 0 5px;
                bottom: 55px; /* Adjust for smaller button height on mobile */
            }
            #bottomNavBar.nav-bar-hidden-full {
                bottom: -55px; /* Adjust for smaller button height on mobile */
            }
            #navToggleBtn {
                width: 55px;
                height: 55px;
                font-size: 1.5rem;
            }
            .nav-icon-circle {
                width: 40px;
                height: 40px;
            }
            .nav-icon-circle i {
                font-size: 1.2rem;
            }
            .nav-icon-item {
                font-size: 0.7rem;
            }
            body {
                padding-bottom: 110px; /* 55px (nav) + 55px (toggle) */
            }
        }
    </style>
</head>
<body class="theme-dark-mode">

    <header>
        <div class="header-content-wrapper">
            <a href="/home.html" class="logo">JCHAT</a>
            <nav>
                <ul>
                    <!-- Removed Home and Profile links from header navigation -->
                </ul>
            </nav>
            <div class="user-profile-header">
                <!-- NEW: Admin Icon Link (hidden by default) -->
                <a href="/Admin.html" id="adminIconLink" aria-label="Admin Dashboard">
                    <i class="fas fa-user-cog"></i>
                </a>
                <!-- Notification Icon with Badge -->
                <div class="notification-icon-wrapper">
                    <a href="/notifications.html" aria-label="Notifications">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notificationCount" style="display: none;">0</span>
                    </a>
                </div>
                <!-- Removed Logout Button -->
                <a href="/profile.html" id="profileLink">
                    <img id="headerProfilePic" src="" alt="Profile Picture" style="display: none;">
                    <i id="headerAvatarIcon" class="fas fa-user-circle"></i>
                    <span id="headerDisplayName">Loading...</span>
                </a>
            </div>
        </div>
    </header>

    <main>
        <div class="content-wrapper">
            <div class="profile-section">
                <div class="profile-header-area">
                    <div class="profile-pic-wrapper" id="profilePicWrapper">
                        <img id="profilePagePic" src="" alt="Profile Picture" class="profile-pic" style="display: none;">
                        <i id="profilePageAvatarIcon" class="fas fa-user-circle profile-pic-placeholder"></i>
                        <input type="file" id="profilePicUploadInput" accept="image/*" style="display: none;">
                        <label for="profilePicUploadInput" class="edit-profile-pic-overlay" id="editProfilePicOverlay">
                            <i class="fas fa-camera"></i> Edit
                        </label>
                        <div class="profile-pic-loader"></div> <!-- NEW: Loading spinner for profile pic -->
                    </div>
                    <h2 id="profileUsername" class="profile-name">Loading...</h2>
                    <p id="profileBio" class="profile-bio">No bio provided yet.</p>
                    <p id="profileLocation" class="profile-info-item" style="display: none;"><i class="fas fa-map-marker-alt"></i> <span id="locationText"></span></p>
                    <p id="profileEmail" class="profile-info-item" style="display: none;"><i class="fas fa-envelope"></i> <span id="emailText"></span></p>
                    <p id="profileSchool" class="profile-info-item" style="display: none;"><i class="fas fa-graduation-cap"></i> <span id="schoolText"></span></p>
                    <p id="profileWork" class="profile-info-item" style="display: none;"><i class="fas fa-briefcase"></i> <span id="workText"></span></p>
                    <p id="profileWebsite" class="profile-info-item" style="display: none;"><i class="fas fa-globe"></i> <a id="websiteLink" href="#" target="_blank" rel="noopener noreferrer" class="gradient-text"></a></p>
                    <p id="profileSocialLinks" class="profile-info-item" style="display: none;"><i class="fas fa-share-alt"></i> <span id="socialLinksText"></span></p>


                    <!-- NEW: Level Info Display -->
                    <div class="profile-level-info">
                        <i id="xpLevelIcon" class="fas fa-question-circle profile-level-icon"></i>
                        <span id="xpLevelName" class="profile-level-name">Loading Level...</span>
                    </div>
                    <div class="progress-bar-container" id="progressBarContainer">
                        <div id="xpProgressBarFill" class="progress-bar-fill" style="background-position: right;"></div>
                    </div>
                    <!-- End NEW: Level Info Display -->

                </div>

                <div class="profile-stats">
                    <div class="stat-item">
                        <span id="statPosts" class="stat-value">0</span>
                        <span class="stat-label">Posts</span>
                    </div>
                    <div class="stat-item">
                        <span id="statFriends" class="stat-value">0</span>
                        <span class="stat-label">Friends</span>
                    </div>
                    <div class="stat-item">
                        <span id="statFollowers" class="stat-value">0</span>
                        <span class="stat-label">Followers</span>
                    </div>
                    <div class="stat-item">
                        <span id="statFollowing" class="stat-value">0</span>
                        <span class="stat-label">Following</span>
                    </div>
                    <!-- JCoins with Exchange Rate -->
                    <div class="stat-item" id="jcoinStatItem">
                        <span id="jCoins" class="stat-value">0</span>
                        <span class="stat-label">JCoins</span>
                        <p class="jcoin-exchange-rate" id="jcoinExchangeRate" style="display: none;">
                            <span id="jcoinUSDValue">$0.00</span> USD
                        </p>
                    </div>
                    <!-- NEW: Gas (XP) Stat Item -->
                    <div class="stat-item" id="gasStatItem">
                        <span id="gasValue" class="stat-value">0</span>
                        <span class="stat-label">Gas (XP)</span>
                    </div>
                </div>

                <div class="profile-actions" id="profileActions">
                    <!-- Buttons will be dynamically added/hidden based on owner/viewer -->
                    <!-- Removed Edit Profile Button -->
                    <a href="/privacy_settings.html" id="privacySettingsButton" class="profile-action-button secondary">
                        <i class="fas fa-user-shield"></i> Privacy Settings
                    </a>
                    <!-- NEW: Wallet Link -->
                    <a href="/wallet.html" id="walletLink" class="profile-action-button secondary disabled-link">
                        <i class="fas fa-lock padlock-icon"></i> My Wallet
                    </a>
                    <p id="walletLockedMessage" class="wallet-locked-message" style="display: none;">
                        Contact admin to unlock wallet access.
                    </p>
                    <!-- NEW: Request JCoins Button -->
                    <button id="requestJCoinsButton" class="profile-action-button">
                        <i class="fas fa-coins"></i> Request JCoins
                    </button>
                    <!-- Removed Add Friend and Message buttons as requested -->
                </div>

                <!-- Inline Profile Details and Account Settings -->
                <div class="profile-details-section">
                    <label for="displayName">Display Name</label>
                    <input type="text" id="displayName" placeholder="Enter your display name">

                    <label for="bio">Bio</label>
                    <textarea id="bio" placeholder="Tell us about yourself..."></textarea>

                    <label for="locationInput">Location</label>
                    <input type="text" id="locationInput" placeholder="e.g., Lagos, Nigeria">

                    <label for="schoolInput">School/University</label>
                    <input type="text" id="schoolInput" placeholder="e.g., University of Lagos">

                    <label for="workInput">Work/Occupation</label>
                    <input type="text" id="workInput" placeholder="e.g., Software Engineer at Google">

                    <label for="interestsInput">Interests</label>
                    <textarea id="interestsInput" placeholder="e.g., Reading, Hiking, Coding, Photography (comma-separated)"></textarea>

                    <label for="websiteInput">Website/Portfolio</label>
                    <input type="url" id="websiteInput" placeholder="e.g., https://yourwebsite.com">

                    <label for="socialLinksInput">Social Media Links</label>
                    <textarea id="socialLinksInput" placeholder="e.g., LinkedIn: profile_url, Twitter: handle (comma-separated)"></textarea>

                    <button id="saveProfileChanges" class="profile-action-button">
                        <span class="button-text">Save Profile</span>
                        <div class="button-loader"></div>
                    </button>

                    <!-- Toggle for Account Settings (Email/Password) -->
                    <button id="toggleAccountSettingsButton" class="profile-action-button secondary" style="margin-top: 2rem;">
                        <i class="fas fa-cog"></i> Manage Account Settings
                    </button>

                    <div id="accountSettingsSection" style="display: none; flex-direction: column; width: 100%;">
                        <div class="sub-section">
                            <h2>Account Settings</h2>

                            <div class="input-group">
                                <label for="profileEmailInput">Email Address</label>
                                <input type="email" id="profileEmailInput" placeholder="Your email" disabled>
                            </div>

                            <form id="changeEmailForm">
                                <div class="input-group">
                                    <label for="newEmail">New Email</label>
                                    <input type="email" id="newEmail" placeholder="Enter new email">
                                </div>
                                <div class="input-group">
                                    <label for="currentPasswordForEmail">Current Password</label>
                                    <input type="password" id="currentPasswordForEmail" placeholder="Enter current password">
                                </div>
                                <button type="submit" id="updateEmailButton">
                                    <span class="button-text">Update Email</span>
                                    <div class="button-loader"></div>
                                </button>
                            </form>

                            <div class="input-group">
                                <label for="oldPassword">Old Password</label>
                                <input type="password" id="oldPassword" placeholder="Enter old password">
                            </div>
                            <div class="input-group">
                                <label for="newPassword">New Password</label>
                                <input type="password" id="newPassword" placeholder="Enter new password">
                            </div>
                            <div class="input-group">
                                <label for="confirmNewPassword">Confirm New Password</label>
                                <input type="password" id="confirmNewPassword" placeholder="Confirm new password">
                            </div>
                            <button id="changePasswordButton">
                                <span class="button-text">Change Password</span>
                                <div class="button-loader"></div>
                            </button>

                            <button id="logoutButtonAccount" class="profile-action-button secondary">
                                <i class="fas fa-sign-out-alt"></i> Log Out
                            </button>

                            <p>Need help? <a href="#">Contact Support</a></p>
                            <p>Manage your data: <a href="#">Download Data</a> | <a href="#">Delete Account</a></p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- User's posts could be displayed here if desired -->
            <div class="posts-feed-section" id="userPostsFeed" style="display: none;">
                <h3>Posts by <span id="postsFeedUsername"></span></h3>
                <p style="text-align: center; color: var(--text-light);" id="loadingUserPostsMessage">Loading posts...</p>
                <!-- User's posts will be loaded here dynamically -->
            </div>
        </div>
    </main>

    <!-- Custom Message Box (reused from Home.html) -->
    <div id="messageBox"></div>

    <!-- NEW: JCoin Request Modal -->
    <div id="jcoinRequestModal" class="modal-overlay">
        <div class="modal-content">
            <h3><i class="fas fa-coins"></i> Request JCoins</h3>
            <p style="color: var(--text-light); font-size: 0.9rem; text-align: center;">
                Enter the Naira amount you wish to purchase. You will be credited with JCoins based on the current exchange rate.
                <br>
                Amounts of <span class="gradient-text">#1000</span> and above receive a <span class="gradient-text">10% bonus</span>.
            </p>
            <div class="input-group">
                <label for="nairaAmountInput">Naira Amount (NGN):</label>
                <input type="number" id="nairaAmountInput" placeholder="e.g., 500, 1000, 5000" min="100">
                <p class="calculated-jcoins">You will get: <span id="calculatedJCoins">0 JCoins</span></p>
            </div>
            <div class="input-group">
                <label class="file-input-label" for="receiptUploadInput">Upload Payment Receipt:</label>
                <div class="file-input-wrapper">
                    <input type="file" id="receiptUploadInput" accept="image/*" style="display: none;">
                    <i class="fas fa-upload"></i>
                    <span class="file-name" id="receiptFileName">No file chosen</span>
                </div>
                <img id="receiptPreview" class="receipt-preview" style="display: none;">
            </div>
            <div class="button-group">
                <button id="cancelJCoinRequest" class="modal-button cancel-button">Cancel</button>
                <button id="submitJCoinRequestButton" class="modal-button save-button">
                    <span class="button-text">Submit Request</span>
                    <div class="button-loader"></div>
                </button>
            </div>
        </div>
    </div>


    <!-- Bottom Navigation Bar (reused from Home.html) -->
    <nav id="bottomNavBar" class="nav-bar-hidden-full">
        <a href="/home.html" class="nav-icon-item">
            <div class="nav-icon-circle"><i class="fas fa-home"></i></div>
            <span>Home</span>
        </a>
        <a href="/chat.html" class="nav-icon-item">
            <div class="nav-icon-circle"><i class="fas fa-comment-dots"></i></div>
            <span>Chat</span>
        </a>
        <a href="/find_friends.html" class="nav-icon-item">
            <div class="nav-icon-circle"><i class="fas fa-users"></i></div>
            <span>Users</span>
        </a>
        <a href="/friends.html" class="nav-icon-item">
            <div class="nav-icon-circle"><i class="fas fa-user-friends"></i></div>
            <span>Friends</span>
        </a>
        <a href="/jcoin_shop.html" class="nav-icon-item">
            <div class="nav-icon-circle"><i class="fas fa-store"></i></div>
            <span>Shop</span>
        </a>
        <a href="/settings.html" class="nav-icon-item active">
            <div class="nav-icon-circle"><i class="fas fa-cog"></i></div>
            <span>Settings</span>
        </a>
    </nav>

    <!-- Navigation Toggle Button (reused from Home.html) -->
    <button id="navToggleBtn" aria-label="Toggle Navigation">
        <i class="fas fa-chevron-up"></i>
    </button>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, updateProfile, updateEmail, reauthenticateWithCredential, EmailAuthProvider, updatePassword, signOut, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, setDoc, collection, query, where, getDocs, runTransaction, writeBatch, serverTimestamp, orderBy, addDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // --- Firebase & Canvas Environment Configuration ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyBsBinyrD9WZZXRaCvA4gxfX7BIimydDvo",
            authDomain: "jchat-1.firebaseapp.com",
            projectId: "jchat-1",
            storageBucket: "jchat-1.firebasestorage.app",
            appId: "1:328479683167:web:276c0b7e8ea44dd2d6a1ea",
            measurementId: "G-S6Z9GG0R9P"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; // Corrected: Use initialAuthToken variable

        // Cloudinary Configuration
        const cloudinaryConfig = {
            cloudName: "dxld01rcp", // Your Cloudinary Cloud Name
            uploadPreset: "Storage_preset" // Your Cloudinary Upload Preset
        };

        // Initialize Firebase services
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- DOM Elements ---
        const headerProfilePic = document.getElementById('headerProfilePic');
        const headerAvatarIcon = document.getElementById('headerAvatarIcon');
        const headerDisplayName = document.getElementById('headerDisplayName');
        // const logoutButton = document.getElementById('logoutButton'); // Header logout - REMOVED
        const notificationCountElement = document.getElementById('notificationCount');
        const messageBox = document.getElementById('messageBox');
        const headerNavLinkProfile = document.getElementById('profileLink'); // Corrected ID to match HTML
        const adminIconLink = document.getElementById('adminIconLink');

        const profilePicWrapper = document.getElementById('profilePicWrapper'); // New wrapper for owner check
        const profilePagePic = document.getElementById('profilePagePic');
        const profilePageAvatarIcon = document.getElementById('profilePageAvatarIcon');
        const profilePicUploadInput = document.getElementById('profilePicUploadInput');
        const editProfilePicOverlay = document.getElementById('editProfilePicOverlay');

        const profileUsername = document.getElementById('profileUsername'); // H2 element for username
        const profileBio = document.getElementById('profileBio');
        const profileLocation = document.getElementById('profileLocation'); // P element container
        const locationText = document.getElementById('locationText'); // Span inside profileLocation
        const profileEmail = document.getElementById('profileEmail'); // P element container
        const emailText = document.getElementById('emailText'); // Span inside profileEmail

        // NEW: User Info Display Elements
        const profileSchool = document.getElementById('profileSchool');
        const schoolText = document.getElementById('schoolText');
        const profileWork = document.getElementById('profileWork');
        const workText = document.getElementById('workText');
        const profileWebsite = document.getElementById('profileWebsite');
        const websiteLink = document.getElementById('websiteLink');
        const profileSocialLinks = document.getElementById('profileSocialLinks');
        const socialLinksText = document.getElementById('socialLinksText');


        const statPosts = document.getElementById('statPosts');
        const statFriends = document.getElementById('statFriends');
        const statFollowers = document.getElementById('statFollowers');
        const statFollowing = document.getElementById('statFollowing');
        const jCoinsSpan = document.getElementById('jCoins'); // Added for jCoins
        const jcoinExchangeRate = document.getElementById('jcoinExchangeRate'); // Added for exchange rate
        const jcoinUSDValue = document.getElementById('jcoinUSDValue'); // Added for USD value

        // XP Level Elements
        const gasValue = document.getElementById('gasValue'); // Gas (XP) value
        const xpLevelIcon = document.getElementById('xpLevelIcon');
        const xpLevelName = document.getElementById('xpLevelName');
        const progressBarContainer = document.getElementById('progressBarContainer'); // NEW: Get the container
        const xpProgressBarFill = document.getElementById('xpProgressBarFill');

        const profileActions = document.getElementById('profileActions');
        // const editProfileButton = document.getElementById('editProfileButton'); // Removed
        // const privacySettingsButton = document.getElementById('privacySettingsButton'); // Removed as it's now an <a> tag
        const walletLink = document.getElementById('walletLink'); // Wallet link
        const walletLockedMessage = document.getElementById('walletLockedMessage'); // Wallet locked message
        const requestJCoinsButton = document.getElementById('requestJCoinsButton'); // NEW: Request JCoins Button
        // Removed addFriendButton and messageButton as requested

        // Inline Edit Fields
        const displayNameInput = document.getElementById('displayName'); // Input for display name
        const bioTextarea = document.getElementById('bio');
        const locationInput = document.getElementById('locationInput'); // Input for location
        // NEW: Inputs for additional user info
        const schoolInput = document.getElementById('schoolInput');
        const workInput = document.getElementById('workInput');
        const interestsInput = document.getElementById('interestsInput');
        const websiteInput = document.getElementById('websiteInput');
        const socialLinksInput = document.getElementById('socialLinksInput');

        const saveProfileChanges = document.getElementById('saveProfileChanges'); // Renamed from saveProfileChangesButton

        // Account Settings Fields
        const profileEmailInput = document.getElementById('profileEmailInput'); // Disabled email display
        const newEmailInput = document.getElementById('newEmail');
        const currentPasswordForEmailInput = document.getElementById('currentPasswordForEmail');
        const updateEmailButton = document.getElementById('updateEmailButton');
        const oldPasswordInput = document.getElementById('oldPassword');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmNewPasswordInput = document.getElementById('confirmNewPassword');
        const changePasswordButton = document.getElementById('changePasswordButton');
        const logoutButtonAccount = document.getElementById('logoutButtonAccount'); // Logout button in account settings

        // NEW: Toggle for Account Settings Section
        const toggleAccountSettingsButton = document.getElementById('toggleAccountSettingsButton');
        const accountSettingsSection = document.getElementById('accountSettingsSection');


        const userPostsFeed = document.getElementById('userPostsFeed');
        const postsFeedUsername = document.getElementById('postsFeedUsername');
        const loadingUserPostsMessage = document.getElementById('loadingUserPostsMessage');

        // JCoin Request Modal Elements
        const jcoinRequestModal = document.getElementById('jcoinRequestModal');
        const nairaAmountInput = document.getElementById('nairaAmountInput');
        const calculatedJCoinsSpan = document.getElementById('calculatedJCoins');
        const receiptUploadInput = document.getElementById('receiptUploadInput');
        const receiptFileNameSpan = document.getElementById('receiptFileName');
        const receiptPreviewImg = document.getElementById('receiptPreview');
        const cancelJCoinRequestButton = document.getElementById('cancelJCoinRequest');
        const submitJCoinRequestButton = document.getElementById('submitJCoinRequestButton');

        // Friend Requests Section (kept for structure, but not actively used for display on this page anymore)
        const friendRequestsSection = document.getElementById('friendRequestsSection');
        const incomingRequestsList = document.getElementById('incomingRequestsList');
        const noRequestsMessage = document.getElementById('noRequestsMessage');

        // Removed: Pending Rewards Section Elements
        // const pendingRewardsSection = document.getElementById('pendingRewardsSection');
        // const pendingRewardsList = document.getElementById('pendingRewardsList');

        // --- Global State ---
        let currentUser = null; // The currently authenticated user (Firebase Auth object)
        let currentUserProfileData = null; // The current user's own private profile data (Firestore document)
        let displayedUserId = null; // The ID of the user whose profile is currently being displayed (from URL or current user)
        let displayedUserProfileData = null; // The profile data of the user currently being displayed (could be current user or another user)
        let isAuthReady = false; // Flag to indicate if auth state has been checked
        const ADMIN_UID = 'cc96gdhCRPO72NFZtleRCujHvIq2'; // Admin's User ID
        const JCOIN_EXCHANGE_RATE_PER_NAIRA = 1 / 7.5; // 1 Naira = 1/7.5 JCoins (e.g., 75 Naira = 10 JCoins)
        const JCOIN_BONUS_THRESHOLD_NAIRA = 1000; // Naira amount from which JCoin bonus applies
        const JCOIN_BONUS_PERCENTAGE = 0.10; // 10% bonus

        // --- Utility Functions ---

        /**
         * Plays a short notification sound.
         * Note: For a real application, you'd integrate Tone.js or similar for more robust audio.
         */
        function playNotificationSound() {
            // Placeholder for sound. In a real app, you'd use Tone.js or a simple Audio object.
            // if (typeof Tone !== 'undefined') {
            //     const synth = new Tone.Synth().toDestination();
            //     synth.triggerAttackRelease("C4", "8n");
            // } else {
            //     console.warn("Tone.js not loaded. Cannot play notification sound.");
            // }
        }

        /**
         * Displays a temporary message box with a given message and type.
         * @param {string} message - The message to display.
         * @param {string} type - The type of message ('success', 'error', 'info', 'loading', 'warning').
         * @param {boolean} [isPersistent=false] - If true, message stays until explicitly cleared or replaced.
         * @param {number} [durationMs=3000] - Duration in milliseconds for the message to display if not persistent.
         */
        function showMessageBox(message, type, isPersistent = false, durationMs = 3000) {
            if (messageBox.timeoutId) {
                clearTimeout(messageBox.timeoutId);
            }

            messageBox.innerHTML = `<i id="messageBoxIcon"></i><span id="messageBoxText"></span>`;
            const messageBoxIcon = document.getElementById('messageBoxIcon');
            const messageBoxText = document.getElementById('messageBoxText');

            messageBoxText.textContent = message;
            messageBox.className = 'message-box show ' + type; // Add type class for styling

            // Set icon based on type
            if (type === 'success') {
                messageBoxIcon.classList.add('fas', 'fa-check-circle');
            } else if (type === 'error') {
                messageBoxIcon.classList.add('fas', 'fa-times-circle');
            } else if (type === 'info') {
                messageBoxIcon.classList.add('fas', 'fa-info-circle');
            } else if (type === 'warning') {
                 messageBoxIcon.classList.add('fas', 'fa-exclamation-triangle');
            } else if (type === 'loading') {
                 messageBoxIcon.classList.add('fas', 'fa-spinner', 'fa-spin'); // Spinner for loading
            } else {
                messageBoxIcon.className = ''; // No specific icon
            }

            if (type === 'loading') {
                messageBox.classList.add('loading-pulse');
            } else {
                messageBox.classList.remove('loading-pulse');
            }

            messageBox.style.display = 'flex';
            messageBox.style.opacity = '1';

            if (!isPersistent) {
                messageBox.timeoutId = setTimeout(() => {
                    messageBox.style.opacity = '0';
                    messageBox.addEventListener('transitionend', function handler() {
                        messageBox.style.display = 'none';
                        messageBox.removeEventListener('transitionend', handler);
                        messageBox.classList.remove('loading-pulse');
                    }, { once: true });
                }, durationMs);
            }
        }

        /**
         * Toggles loading state for a button.
         * @param {HTMLElement} buttonElement - The button to toggle.
         * @param {boolean} isLoading - True to show loading, false to hide.
         */
        function toggleButtonLoading(buttonElement, isLoading) {
            if (!buttonElement) return;
            const loader = buttonElement.querySelector('.button-loader');
            const text = buttonElement.querySelector('.button-text');

            if (isLoading) {
                buttonElement.disabled = true;
                buttonElement.classList.add('loading'); // Add loading class for general styling
                if (loader) loader.classList.add('active');
                if (text) text.style.display = 'none';
            } else {
                buttonElement.disabled = false;
                buttonElement.classList.remove('loading');
                if (loader) loader.classList.remove('active');
                if (text) text.style.display = 'block';
            }
        }

        /**
         * Displays a custom confirmation modal.
         * @param {string} message - The message to display in the modal.
         * @returns {Promise<boolean>} Resolves with true if 'Yes' is clicked, false if 'No'.
         */
        function showCustomConfirm(message) {
            return new Promise((resolve) => {
                // Assuming you have a modal structure with IDs:
                // <div id="customConfirmModal" class="modal-overlay">
                //   <div class="modal-content">
                //     <h3 id="confirmModalMessage"></h3>
                //     <div class="modal-buttons">
                //       <button id="confirmYesBtn" class="confirm-btn">Yes</button>
                //       <button id="confirmNoBtn" class="cancel-btn">No</button>
                //     </div>
                //   </div>
                // </div>
                const customConfirmModal = document.getElementById('customConfirmModal');
                const confirmModalMessage = document.getElementById('confirmModalMessage');
                const confirmYesBtn = document.getElementById('confirmYesBtn');
                const confirmNoBtn = document.getElementById('confirmNoBtn');

                if (!customConfirmModal || !confirmModalMessage || !confirmYesBtn || !confirmNoBtn) {
                    console.error("JCHAT_ERROR: Custom confirmation modal elements not found.");
                    resolve(false); // Fallback to false if elements are missing
                    return;
                }

                confirmModalMessage.textContent = message;
                customConfirmModal.classList.add('active');

                const handleYes = () => {
                    customConfirmModal.classList.remove('active');
                    confirmYesBtn.removeEventListener('click', handleYes);
                    confirmNoBtn.removeEventListener('click', handleNo);
                    resolve(true);
                };

                const handleNo = () => {
                    customConfirmModal.classList.remove('active');
                    confirmYesBtn.removeEventListener('click', handleYes);
                    confirmNoBtn.removeEventListener('click', handleNo);
                    resolve(false);
                };

                confirmYesBtn.addEventListener('click', handleYes);
                confirmNoBtn.addEventListener('click', handleNo);
            });
        }

        /**
         * Constructs a Cloudinary URL for an image/video.
         * @param {string} urlOrPublicId - The full Cloudinary URL or the public ID of the image on Cloudinary.
         * @param {string} transformations - Optional Cloudinary transformations.
         * @returns {string|null} The full Cloudinary URL or null if urlOrPublicId is not provided.
         */
        function getCloudinaryImageUrl(urlOrPublicId, transformations = "w_auto,f_auto,q_auto") {
            if (!urlOrPublicId) return null;
            // Check if it's already a full URL (e.g., from Firebase Auth photoURL or existing Cloudinary URL)
            if (urlOrPublicId.startsWith('http://') || urlOrPublicId.startsWith('https://')) {
                // If it's a direct URL to a Cloudinary asset, we can insert transformations
                // This is a simplified approach; a more robust one would parse the URL
                if (urlOrPublicId.includes('res.cloudinary.com')) {
                    const parts = urlOrPublicId.split('/upload/');
                    if (parts.length === 2) {
                        return `${parts[0]}/upload/${transformations}/${parts[1]}`;
                    }
                }
                return urlOrPublicId; // Return as is if it's a general URL not from Cloudinary or already transformed
            }
            // Assume it's a public ID if not a full URL
            return `https://res.cloudinary.com/${cloudinaryConfig.cloudName}/image/upload/${transformations}/${urlOrPublicId}`;
        }

        /**
         * Displays the profile picture or a default icon.
         * @param {HTMLElement} imgElement - The <img> element to update.
         * @param {HTMLElement} iconElement - The <i> element to display if no image.
         * @param {string|null} profilePicId - The Cloudinary public ID or URL, or null.
         * @param {string} usernameInitial - Initial for placeholder.
         * @param {string} transformations - Cloudinary transformations for the image.
         */
        function displayProfilePicture(imgElement, iconElement, profilePicId, usernameInitial, transformations) {
            if (imgElement) { // Ensure imgElement exists
                if (profilePicId) {
                    const imageUrl = getCloudinaryImageUrl(profilePicId, transformations);
                    imgElement.src = imageUrl;
                    imgElement.style.display = 'block';
                    if (iconElement) iconElement.style.display = 'none'; // Null check for iconElement
                    imgElement.onerror = () => {
                        console.error(`JCHAT_ERROR: Failed to load profile picture: ${profilePicId}. Using placeholder.`);
                        imgElement.src = `https://placehold.co/120x120/CCCCCC/000000?text=${usernameInitial}`;
                        imgElement.style.display = 'block';
                        if (iconElement) iconElement.style.display = 'none'; // Null check for iconElement
                    };
                } else {
                    imgElement.src = '';
                    imgElement.style.display = 'none';
                    if (iconElement) iconElement.style.display = 'block'; // Null check for iconElement
                }
            }
        }

        /**
         * Resizes and compresses an image file using a canvas.
         * @param {File} file - The image file to process.
         * @param {number} maxWidth - Maximum width for the resized image.
         * @param {number} maxHeight - Maximum height for the resized image.
         * @param {number} quality - JPEG compression quality (0.0 to 1.0).
         * @returns {Promise<Blob>} A promise that resolves with the processed image as a Blob.
         */
        function resizeImage(file, maxWidth = 800, maxHeight = 800, quality = 0.8) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        // Calculate new dimensions while maintaining aspect ratio
                        if (width > maxWidth) {
                            height = height * (maxWidth / width);
                            width = maxWidth;
                        }
                        if (height > maxHeight) {
                            width = width * (maxHeight / height);
                            height = maxHeight;
                        }

                        canvas.width = width;
                        canvas.height = height;

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob((blob) => {
                            if (blob) {
                                resolve(blob);
                            } else {
                                reject(new Error('Canvas to Blob conversion failed: Resulting blob was null.'));
                            }
                        }, 'image/jpeg', quality);
                    };
                    img.onerror = (error) => {
                        console.error("JCHAT_ERROR: Image element loading error during resize:", error);
                        reject(new Error(`Image loading failed: ${error.message || 'Unknown image loading error.'}`));
                    };
                    img.src = event.target.result;
                };
                reader.onerror = (error) => {
                    console.error("JCHAT_ERROR: FileReader error during readAsDataURL:", error);
                    reject(new Error(`FileReader error: ${error.target.error ? error.target.error.message : 'Unknown error reading file.'}`));
                }
                try {
                    reader.readAsDataURL(file);
                } catch (e) {
                    console.error("JCHAT_ERROR: Error calling readAsDataURL:", e);
                    reject(new Error(`Failed to read file data: ${e.message}`));
                }
            });
        }

        /**
         * Uploads a file (image/video) to Cloudinary.
         * @param {File|Blob} file - The file object (or Blob) to upload.
         * @returns {Promise<string|null>} A promise that resolves with the full secure URL of the uploaded asset, or null on error.
         */
        async function uploadMediaToCloudinary(file) {
            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', cloudinaryConfig.uploadPreset);

                const resourceType = file.type.startsWith('image/') ? 'image' : 'video'; // Determine resource type

                const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/${resourceType}/upload`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("JCHAT_ERROR: Cloudinary upload error:", errorData);
                    throw new Error(`Cloudinary upload failed: ${errorData.error.message || response.statusText}`);
                }

                const data = await response.json();
                return data.secure_url; // Return the secure URL
            } catch (error) {
                console.error("JCHAT_ERROR: Error uploading to Cloudinary:", error);
                return null;
            }
        }

        /**
         * Updates the authorProfilePic in all posts by a given user.
         * This function is called when a user's main profile picture changes.
         * @param {string} userId - The UID of the user whose posts need updating.
         * @param {string|null} newProfilePicUrl - The new profile picture URL.
         */
        async function updatePostsWithNewProfilePic(userId, newProfilePicUrl) {
            try {
                const postsCollectionRef = collection(db, "artifacts", appId, "public", "data", "posts");
                const q = query(postsCollectionRef, where("authorId", "==", userId));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const batch = writeBatch(db);
                    querySnapshot.forEach(docSnap => {
                        const postRef = doc(db, "artifacts", appId, "public", "data", "posts", docSnap.id);
                        batch.update(postRef, { profilePhoto: newProfilePicUrl });
                    });
                    await batch.commit();
                    console.log(`JCHAT_DEBUG: Updated profile picture for ${querySnapshot.size} posts by user ${userId}.`);
                }
            } catch (error) {
                console.error("JCHAT_ERROR: Error updating posts with new profile picture:", error);
                // Not showing message box here as it's a background task after main profile update
            }
        }


        /**
         * Handles the change event for the profile picture upload input.
         * Resizes, uploads to Cloudinary, updates Firestore, and refreshes UI.
         */
        async function handleProfilePicChange(event) {
            if (!currentUser || !isAuthReady || displayedUserId !== currentUser.uid) {
                showMessageBox("You can only change your own profile picture.", 'warning');
                return;
            }

            const file = event.target.files[0];
            if (!file) {
                return; // No file selected
            }

            if (!file.type.startsWith('image/')) {
                showMessageBox("Please select an image file.", "warning");
                return;
            }
            if (file.size > 5 * 1024 * 1024) { // 5MB limit
                showMessageBox("Image size too large. Max 5MB.", "warning");
                return;
            }

            if (profilePicWrapper) profilePicWrapper.classList.add('loading'); // Show loading spinner
            showMessageBox("Uploading profile picture...", 'loading', true);

            try {
                // 1. Resize and compress image
                const resizedImageBlob = await resizeImage(file, 240, 240, 0.9); // Optimized for profile pics

                // 2. Upload to Cloudinary
                const newProfilePicUrl = await uploadMediaToCloudinary(resizedImageBlob);

                if (!newProfilePicUrl) {
                    throw new Error("Cloudinary upload failed.");
                }

                // 3. Update Firebase Auth profile
                await updateProfile(currentUser, {
                    photoURL: newProfilePicUrl
                });
                console.log("JCHAT_DEBUG: Firebase Auth photoURL updated.");

                // 4. Update Firestore private profile
                const privateProfileDocRef = doc(db, "artifacts", appId, "users", currentUser.uid, "profiles", "user_profile");
                await updateDoc(privateProfileDocRef, {
                    profilePicId: newProfilePicUrl, // Store the full URL
                    updatedAt: serverTimestamp()
                });
                console.log("JCHAT_DEBUG: Firestore private profilePicId updated.");

                // 5. Update Firestore public profile
                const publicProfileDocRef = doc(db, "artifacts", appId, "public", "data", "users", currentUser.uid);
                await updateDoc(publicProfileDocRef, {
                    profilePicId: newProfilePicUrl, // Store the full URL
                    updatedAt: serverTimestamp()
                });
                console.log("JCHAT_DEBUG: Firestore public profilePicId updated.");

                // 6. Update profile pictures in user's posts (background task)
                updatePostsWithNewProfilePic(currentUser.uid, newProfilePicUrl);

                // 7. Update UI immediately
                displayProfilePicture(profilePagePic, profilePageAvatarIcon, newProfilePicUrl, (currentUserProfileData?.username || 'U').charAt(0).toUpperCase(), "w_240,h_240,c_fill,g_face,r_max");
                displayProfilePicture(headerProfilePic, headerAvatarIcon, newProfilePicUrl, (currentUserProfileData?.username || 'U').charAt(0).toUpperCase(), "w_70,h_70,c_fill,g_face,r_max");

                showMessageBox("Profile picture updated successfully!", 'success');

                // Refresh currentUserProfileData
                const updatedProfileSnap = await getDoc(privateProfileDocRef);
                if (updatedProfileSnap.exists()) {
                    currentUserProfileData = updatedProfileSnap.data();
                    displayedUserProfileData = currentUserProfileData; // Ensure consistency
                }

            }
            catch (error) {
                console.error("JCHAT_ERROR: Error updating profile picture:", error);
                showMessageBox(`Failed to update profile picture: ${error.message}`, 'error');
            }
            finally {
                if (profilePicWrapper) profilePicWrapper.classList.remove('loading'); // Hide loading spinner
                // Clear file input to allow re-uploading the same file if needed
                event.target.value = '';
            }
        }


        /**
         * Handles user logout.
         */
        async function handleLogout() {
            if (!currentUser) return; // Only allow logout if a user is actually logged in
            try {
                await signOut(auth);
                showMessageBox("Logged out successfully! ", 'success');
                setTimeout(() => {
                    window.location.href = '/login.html'; // Redirect to login page
                }, 1000);
            } catch (error) {
                console.error("JCHAT_ERROR: Error logging out:", error);
                showMessageBox("Failed to log out. Please try again.", 'error');
            }
        }

        /**
         * Handles saving profile changes (display name, bio, location, school, work, interests, website, social links).
         */
        async function handleSaveProfileChanges() {
            if (!currentUser || !isAuthReady || displayedUserId !== currentUser.uid) {
                showMessageBox("You can only edit your own profile.", 'warning');
                return;
            }

            toggleButtonLoading(saveProfileChanges, true);
            showMessageBox("Saving profile...", 'loading', true);

            const newDisplayName = displayNameInput.value.trim();
            const newBio = bioTextarea.value.trim();
            const newLocation = locationInput.value.trim();
            const newSchool = schoolInput.value.trim(); // NEW
            const newWork = workInput.value.trim();     // NEW
            const newInterests = interestsInput.value.trim(); // NEW
            const newWebsite = websiteInput.value.trim();   // NEW
            const newSocialLinks = socialLinksInput.value.trim(); // NEW

            if (!newDisplayName) {
                showMessageBox("Display name cannot be empty.", 'error');
                toggleButtonLoading(saveProfileChanges, false);
                return;
            }

            try {
                // Update Firebase Auth display name
                if (currentUser.displayName !== newDisplayName) {
                    await updateProfile(currentUser, {
                        displayName: newDisplayName
                    });
                    console.log("JCHAT_DEBUG: Firebase Auth displayName updated.");
                }

                // Update Firestore private profile
                const privateProfileDocRef = doc(db, "artifacts", appId, "users", currentUser.uid, "profiles", "user_profile");
                await updateDoc(privateProfileDocRef, {
                    username: newDisplayName, // Update username field in Firestore
                    bio: newBio,
                    location: newLocation,
                    school: newSchool, // NEW
                    work: newWork,     // NEW
                    interests: newInterests, // NEW
                    website: newWebsite,   // NEW
                    socialLinks: newSocialLinks, // NEW
                    updatedAt: serverTimestamp()
                });
                console.log("JCHAT_DEBUG: Firestore private profile updated.");

                // Update Firestore public profile
                const publicProfileDocRef = doc(db, "artifacts", appId, "public", "data", "users", currentUser.uid);
                await updateDoc(publicProfileDocRef, {
                    username: newDisplayName,
                    bio: newBio,
                    location: newLocation,
                    school: newSchool, // NEW
                    work: newWork,     // NEW
                    interests: newInterests, // NEW
                    website: newWebsite,   // NEW
                    socialLinks: newSocialLinks, // NEW
                    updatedAt: serverTimestamp()
                });
                console.log("JCHAT_DEBUG: Firestore public profile updated.");

                // Update header UI immediately
                if (headerDisplayName) headerDisplayName.textContent = newDisplayName; // Null check
                if (profileUsername) profileUsername.textContent = newDisplayName; // Null check
                if (profileBio) profileBio.textContent = newBio || "No bio provided yet."; // Null check

                // Update display for new fields
                if (newLocation) { if (locationText) locationText.textContent = newLocation; if (profileLocation) profileLocation.style.display = 'block'; } else { if (profileLocation) profileLocation.style.display = 'none'; }
                if (newSchool) { if (schoolText) schoolText.textContent = newSchool; if (profileSchool) profileSchool.style.display = 'block'; } else { if (profileSchool) profileSchool.style.display = 'none'; }
                if (newWork) { if (workText) workText.textContent = newWork; if (profileWork) profileWork.style.display = 'block'; } else { if (profileWork) profileWork.style.display = 'none'; }
                if (newWebsite) { if (websiteLink) { websiteLink.href = newWebsite; websiteLink.textContent = newWebsite.replace(/^(https?:\/\/)?(www\.)?/, ''); } if (profileWebsite) profileWebsite.style.display = 'block'; } else { if (profileWebsite) profileWebsite.style.display = 'none'; }
                if (newSocialLinks) { if (socialLinksText) socialLinksText.textContent = newSocialLinks; if (profileSocialLinks) profileSocialLinks.style.display = 'block'; } else { if (profileSocialLinks) profileSocialLinks.style.display = 'none'; }


                showMessageBox("Profile saved successfully!", 'success');

                // Refresh currentUserProfileData
                const updatedProfileSnap = await getDoc(privateProfileDocRef);
                if (updatedProfileSnap.exists()) {
                    currentUserProfileData = updatedProfileSnap.data();
                    displayedUserProfileData = currentUserProfileData; // Ensure consistency
                }

            } catch (error) {
                console.error("JCHAT_ERROR: Error saving profile changes:", error);
                showMessageBox(`Failed to save profile: ${error.message}`, 'error');
            } finally {
                toggleButtonLoading(saveProfileChanges, false);
            }
        }

        /**
         * Handles changing user's email address.
         */
        async function handleChangeEmail(event) {
            event.preventDefault(); // Prevent form submission
            if (!currentUser || !isAuthReady) {
                showMessageBox("You must be logged in to change your email.", 'warning');
                return;
            }

            toggleButtonLoading(updateEmailButton, true);
            showMessageBox("Updating email...", 'loading', true);

            const newEmail = newEmailInput.value.trim();
            const currentPassword = currentPasswordForEmailInput.value.trim();

            if (!newEmail || !currentPassword) {
                showMessageBox("Please fill in both new email and current password.", 'error');
                toggleButtonLoading(updateEmailButton, false);
                return;
            }

            if (newEmail === currentUser.email) {
                showMessageBox("New email is the same as current email.", 'info');
                toggleButtonLoading(updateEmailButton, false);
                return;
            }

            try {
                // Reauthenticate user first
                const credential = EmailAuthProvider.credential(currentUser.email, currentPassword);
                await reauthenticateWithCredential(currentUser, credential);
                console.log("JCHAT_DEBUG: User reauthenticated successfully.");

                // Update email
                await updateEmail(currentUser, newEmail);
                console.log("JCHAT_DEBUG: Firebase Auth email updated.");

                // Update Firestore private profile
                const privateProfileDocRef = doc(db, "artifacts", appId, "users", currentUser.uid, "profiles", "user_profile");
                await updateDoc(privateProfileDocRef, {
                    email: newEmail,
                    updatedAt: serverTimestamp()
                });
                console.log("JCHAT_DEBUG: Firestore private email updated.");

                showMessageBox("Email updated successfully! Please verify your new email.", 'success');
                if (profileEmailInput) profileEmailInput.value = newEmail; // Update displayed email, null check
                if (newEmailInput) newEmailInput.value = ''; // Null check
                if (currentPasswordForEmailInput) currentPasswordForEmailInput.value = ''; // Null check

                // Refresh currentUserProfileData
                const updatedProfileSnap = await getDoc(privateProfileDocRef);
                if (updatedProfileSnap.exists()) {
                    currentUserProfileData = updatedProfileSnap.data();
                }

            } catch (error) {
                console.error("JCHAT_ERROR: Error updating email:", error);
                let errorMessage = "Failed to update email. Please check your current password.";
                if (error.code === 'auth/wrong-password') {
                    errorMessage = "Incorrect current password.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Invalid email format.";
                } else if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "This email is already in use by another account.";
                } else if (error.code === 'auth/requires-recent-login') {
                    errorMessage = "Please log out and log back in to update your email.";
                }
                showMessageBox(`${errorMessage} (${error.message})`, 'error');
            } finally {
                toggleButtonLoading(updateEmailButton, false);
            }
        }

        /**
         * Handles changing user's password.
         */
        async function handleChangePassword() {
            if (!currentUser || !isAuthReady) {
                showMessageBox("You must be logged in to change your password.", 'warning');
                return;
            }

            toggleButtonLoading(changePasswordButton, true);
            showMessageBox("Changing password...", 'loading', true);

            const oldPassword = oldPasswordInput.value.trim();
            const newPassword = newPasswordInput.value.trim();
            const confirmNewPassword = confirmNewPasswordInput.value.trim();

            if (!oldPassword || !newPassword || !confirmNewPassword) {
                showMessageBox("Please fill in all password fields.", 'error');
                toggleButtonLoading(changePasswordButton, false);
                return;
            }

            if (newPassword !== confirmNewPassword) {
                showMessageBox("New password and confirmation do not match.", 'error');
                toggleButtonLoading(changePasswordButton, false);
                return;
            }

            if (newPassword.length < 6) {
                showMessageBox("New password must be at least 6 characters long.", 'error');
                toggleButtonLoading(changePasswordButton, false);
                return;
            }

            try {
                // Reauthenticate user first
                const credential = EmailAuthProvider.credential(currentUser.email, oldPassword);
                await reauthenticateWithCredential(currentUser, credential);
                console.log("JCHAT_DEBUG: User reauthenticated successfully.");

                // Update password
                await updatePassword(currentUser, newPassword);
                console.log("JCHAT_DEBUG: Firebase Auth password updated.");

                showMessageBox("Password updated successfully!", 'success');
                if (oldPasswordInput) oldPasswordInput.value = ''; // Null check
                if (newPasswordInput) newPasswordInput.value = ''; // Null check
                if (confirmNewPasswordInput) confirmNewPasswordInput.value = ''; // Null check

            } catch (error) {
                console.error("JCHAT_ERROR: Error updating password:", error);
                let errorMessage = "Failed to update password. Please check your old password.";
                if (error.code === 'auth/wrong-password') {
                    errorMessage = "Incorrect old password.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "New password is too weak. Please choose a stronger one.";
                } else if (error.code === 'auth/requires-recent-login') {
                    errorMessage = "Please log out and log back in to update your password.";
                }
                showMessageBox(`${errorMessage} (${error.message})`, 'error');
            } finally {
                toggleButtonLoading(changePasswordButton, false);
            }
        }

        /**
         * Calculates the total cumulative Gas required to reach a specific level N.
         * Formula: Total_Gas_for_Level_N = 1500 * N * (N + 1) / 2
         * @param {number} level - The target level N.
         * @returns {number} The total cumulative Gas required to reach that level.
         */
        function getTotalGasRequiredToReachLevel(level) {
            if (level <= 0) return 0;
            return 1500 * level * (level + 1) / 2;
        }

        /**
         * Defines level names, icons, and rewards for various levels.
         * This is a client-side representation and should ideally match server-side logic.
         * @param {number} level - The current level.
         * @returns {{level: number, name: string, icon: string, jCoinReward: number, gasReward: number, otherRewards: string[]}} Level information.
         */
        function getLevelInfo(level) {
            let jCoinReward = 0;
            let gasReward = 0;
            let name = `Level ${level}`;
            let icon = "fas fa-question-circle";
            let otherRewards = []; // Array to hold other reward descriptions

            // Base JCoin and Gas rewards scale linearly
            // Starting values and increments are adjusted to provide a smoother curve up to 500
            if (level >= 1 && level <= 25) { // Tier 1: Early Explorer
                jCoinReward = 10 + (level - 1) * 5; // Start 10, +5/level
                gasReward = 5 + (level - 1) * 2;   // Start 5, +2/level
                const levelNames = [
                    "Novice", "Beginner", "Apprentice", "Explorer", "Pioneer",
                    "Communicator", "Socialite", "Networker", "Influencer", "Trendsetter",
                    "Innovator", "Creator", "Visionary", "Architect", "Maestro",
                    "Strategist", "Guardian", "Champion", "Hero", "Legend",
                    "Mythic", "Celestial", "Divine", "Transcendent", "Cosmic Being"
                ];
                const levelIcons = [
                    "fas fa-leaf", "fas fa-seedling", "fas fa-user-graduate", "fas fa-map-marker-alt", "fas fa-compass",
                    "fas fa-comments", "fas fa-users", "fas fa-share-alt", "fas fa-star", "fas fa-fire",
                    "fas fa-lightbulb", "fas fa-paint-brush", "fas fa-eye", "fas fa-building", "fas fa-music",
                    "fas fa-chess", "fas fa-shield-alt", "fas fa-trophy", "fas fa-mask", "fas fa-dragon",
                    "fas fa-meteor", "fas fa-galaxy", "fas fa-hand-sparkles", "fas fa-infinity", "fas fa-atom"
                ];
                name = levelNames[level - 1] || `Level ${level}`;
                icon = levelIcons[level - 1] || "fas fa-question-circle";

                // Specific other rewards for Tier 1
                if (level === 1) otherRewards.push("Badge: 'Newbie'");
                if (level === 3) otherRewards.push("Unlock: 1-Hour XP Boost");
                if (level === 5) otherRewards.push("Badge: 'Chat Starter'", "Unlock: Basic Profile Picture Frame");
                if (level === 8) otherRewards.push("Unlock: Common Emote Pack (Set 1)");
                if (level === 10) otherRewards.push("Title: 'Friendly Face'", "Increased Message Character Limit (+10)");
                if (level === 13) otherRewards.push("Unlock: 3-Hour XP Boost");
                if (level === 15) otherRewards.push("Badge: 'Community Contributor'", "Unlock: Basic Chat Bubble Style");
                if (level === 18) otherRewards.push("Unlock: Common Emote Pack (Set 2)");
                if (level === 20) otherRewards.push("Title: 'Early Explorer'", "Increased Message Character Limit (+15)");
                if (level === 25) otherRewards.push("Badge: 'Veteran Chatter'", "Unlock: Gradient Profile Picture Frame");

            } else if (level >= 26 && level <= 100) { // Tier 2: Active Member (Levels 26 - 100)
                jCoinReward = 120 + (level - 26) * 8; // Starts higher, increases more
                gasReward = 30 + (level - 26) * 3;
                const tierNames = ["Active Member", "Group Enthusiast", "Social Butterfly", "Community Builder"];
                const tierIcons = ["fas fa-user-check", "fas fa-users-cog", "fas fa-globe-europe", "fas fa-handshake"];
                const tierIndex = Math.floor((level - 26) / 19); // Cycle every ~19 levels for 4 names
                name = `${tierNames[tierIndex % tierNames.length]} Lv. ${level}`;
                icon = tierIcons[tierIndex % tierIcons.length];

                // Specific other rewards for Tier 2
                if (level === 30) otherRewards.push("Badge: 'Active Member'", "Unlock: Uncommon Emote Pack (Set 1)");
                if (level === 35) otherRewards.push("Increased Friend Limit (+10)");
                if (level === 40) otherRewards.push("Unlock: New Chat Bubble Style (Set 2)");
                if (level === 45) otherRewards.push("Unlock: 1-Day XP Boost");
                if (level === 50) otherRewards.push("Title: 'Centurion'", "Permanent: 1% JCoin Shop Discount", "Badge: '50-Level Achiever'");
                if (level === 55) otherRewards.push("Unlock: Uncommon Emote Pack (Set 3)");
                if (level === 60) otherRewards.push("Increased Message Character Limit (+20)");
                if (level === 65) otherRewards.push("Unlock: Basic Profile Theme (Solid Color)");
                if (level === 70) otherRewards.push("Increased Friend Limit (+15)");
                if (level === 75) otherRewards.push("Title: 'Dedicated User'", "Unlock: Rare Emote Pack (Set 1)");
                if (level === 80) otherRewards.push("Unlock: New Chat Bubble Style (Set 3)");
                if (level === 85) otherRewards.push("Unlock: 3-Day XP Boost");
                if (level === 90) otherRewards.push("Increased Group Creation Limit (+1)");
                if (level === 95) otherRewards.push("Unlock: Uncommon Profile Picture Frame");
                if (level === 100) otherRewards.push("Title: 'Master Conversationalist'", "Badge: 'Century Mark'", "Permanent: 2% JCoin Shop Discount", "Unlock: Exclusive 'Golden' Profile Picture Frame");

            } else if (level >= 101 && level <= 250) { // Tier 3: Dedicated User (Levels 101 - 250)
                jCoinReward = 750 + (level - 101) * 12;
                gasReward = 150 + (level - 101) * 5;
                const tierNames = ["Dedicated User", "JCHAT Elite", "Master Communicator", "Community Architect"];
                const tierIcons = ["fas fa-user-shield", "fas fa-gem", "fas fa-microphone-alt", "fas fa-sitemap"];
                const tierIndex = Math.floor((level - 101) / 37); // Cycle every ~37 levels for 4 names
                name = `${tierNames[tierIndex % tierNames.length]} Lv. ${level}`;
                icon = tierIcons[tierIndex % tierIcons.length];

                // Specific other rewards for Tier 3
                if (level === 110) otherRewards.push("Unlock: Animated Emote Pack (Set 1)");
                if (level === 120) otherRewards.push("Increased Media Upload Size (+5MB)");
                if (level === 125) otherRewards.push("Title: 'Rising Star'", "Unlock: Custom Chat Font (Style 1)");
                if (level === 130) otherRewards.push("Unlock: 7-Day XP Boost");
                if (level === 140) otherRewards.push("Permanent: 3% JCoin Shop Discount");
                if (level === 150) otherRewards.push("Badge: 'JCHAT Expert'", "Unlock: Premium Profile Theme (Animated 1)");
                if (level === 160) otherRewards.push("Increased Group Member Capacity (+5)");
                if (level === 170) otherRewards.push("Unlock: Animated Emote Pack (Set 2)");
                if (level === 175) otherRewards.push("Title: 'Elite Communicator'", "Unlock: Custom Chat Font (Style 2)");
                if (level === 180) otherRewards.push("Increased Message Character Limit (+25)");
                if (level === 190) otherRewards.push("Permanent: 4% JCoin Shop Discount");
                if (level === 200) otherRewards.push("Badge: 'Double Century'", "Title: 'JCHAT Champion'", "Unlock: Exclusive 'Golden' Profile Picture Frame", "Voucher: 1-Day Free Group Promotion");
                if (level === 210) otherRewards.push("Increased Media Upload Size (+10MB)");
                if (level === 220) otherRewards.push("Unlock: Premium Profile Theme (Animated 2)");
                if (level === 230) otherRewards.push("Unlock: Rare Emote Pack (Set 2)");
                if (level === 240) otherRewards.push("Priority Support Access");
                if (level === 250) otherRewards.push("Badge: 'Quarter-Millennium'", "Title: 'The Architect'", "Early Access: Next Major Feature Beta");

            } else if (level >= 251 && level <= 400) { // Tier 4: JCHAT Legend (Levels 251 - 400)
                jCoinReward = 2500 + (level - 251) * 20;
                gasReward = 500 + (level - 251) * 10;
                const tierNames = ["JCHAT Legend", "Grandmaster", "Cosmic Converser", "Eternal Speaker"];
                const tierIcons = ["fas fa-star-half-alt", "fas fa-chess-king", "fas fa-galaxy", "fas fa-infinity"];
                const tierIndex = Math.floor((level - 251) / 37); // Cycle every ~37 levels for 4 names
                name = `${tierNames[tierIndex % tierNames.length]} Lv. ${level}`;
                icon = tierIcons[tierIndex % tierIcons.length];

                // Specific other rewards for Tier 4
                if (level === 260) otherRewards.push("Permanent: 5% JCoin Shop Discount");
                if (level === 275) otherRewards.push("Title: 'Grand Strategist'", "Unlock: Legendary Emote Pack (Set 1)");
                if (level === 290) otherRewards.push("Increased Group Creation Limit (+2)");
                if (level === 300) otherRewards.push("Badge: 'Triple Century'", "Title: 'JCHAT Grandmaster'", "Voucher: 3-Day Free Group Promotion", "Unlock: Exclusive VIP Chat Room Access");
                if (level === 310) otherRewards.push("Increased Media Upload Size (+15MB)");
                if (level === 325) otherRewards.push("Title: 'Cosmic Weaver'", "Unlock: Custom Chat Font (Style 3)");
                if (level === 340) otherRewards.push("Permanent: 7% JCoin Shop Discount");
                if (level === 350) otherRewards.push("Badge: 'JCHAT Luminary'", "Unlock: Personalized Emote Slot (1 custom upload)");
                if (level === 360) otherRewards.push("Increased Group Member Capacity (+10)");
                if (level === 375) otherRewards.push("Title: 'The Eternal Flame'", "Unlock: Legendary Emote Pack (Set 2)");
                if (level === 390) otherRewards.push("Ad-Free Experience (1 Month)");
                if (level === 400) otherRewards.push("Badge: 'Quad Century'", "Title: 'The Unrivaled'", "Permanent: 10% JCoin Shop Discount", "Unlock: Unique Profile Aura (Tier 1)");

            } else if (level >= 401 && level <= 500) { // Tier 5: The Unrivaled (Levels 401 - 500)
                jCoinReward = 5000 + (level - 401) * 30;
                gasReward = 1000 + (level - 401) * 15;
                const tierNames = ["The Unrivaled", "Cosmic Creator", "JCHAT Deity", "Apex Being"];
                const tierIcons = ["fas fa-infinity", "fas fa-solar-system", "fas fa-hand-holding-heart", "fas fa-star-and-crescent"];
                const tierIndex = Math.floor((level - 401) / 25); // Cycle every 25 levels for 4 names
                name = `${tierNames[tierIndex % tierNames.length]} Lv. ${level}`;
                icon = tierIcons[tierIndex % tierIcons.length];

                // Specific other rewards for Tier 5
                if (level === 410) otherRewards.push("Ad-Free Experience (3 Months)");
                if (level === 425) otherRewards.push("Title: 'Pinnacle Performer'", "Unlock: Unique Profile Aura (Tier 2)");
                if (level === 440) otherRewards.push("Increased Media Upload Size (+20MB)");
                if (level === 450) otherRewards.push("Badge: 'Near-God'", "Unlock: Mythic Emote Pack (Set 1)");
                if (level === 460) otherRewards.push("Permanent: 12% JCoin Shop Discount");
                if (level === 475) otherRewards.push("Title: 'Cosmic Architect'", "Voucher: 7-Day Free Group Promotion");
                if (level === 480) otherRewards.push("Ad-Free Experience (6 Months)");
                if (level === 490) otherRewards.push("Unlock: Exclusive 'Cosmic' Animated Avatar Frame");
                if (level === 500) {
                    otherRewards.push(
                        "Badge: 'JCHAT Deity'",
                        "Title: 'The Absolute'",
                        "Lifetime Premium Status (Ad-Free, All Cosmetics Unlocked)",
                        "Personalized Group Creation Perk (Custom starting benefits for new groups)",
                        "Acknowledgment on JCHAT Hall of Fame (Your name/ID listed on a special page)",
                        "Exclusive Discord Role (if applicable)",
                        "Voting Rights on Future Feature Development"
                    );
                }
            } else if (level > 500) {
                // Beyond level 500, continue scaling rewards and use a generic "Master" tier
                jCoinReward = 5000 + (500 - 401) * 30 + (level - 500) * 50;
                gasReward = 1000 + (500 - 401) * 8 + (level - 500) * 15;
                name = `Master Lv. ${level}`;
                icon = "fas fa-star";
                otherRewards.push("Continued JCoin & Gas Rewards", "Exclusive Recognition (Tier 6)");
                if (level % 100 === 0) otherRewards.push("Special Milestone Bonus");
            }

            return {
                level: level,
                name: name,
                icon: icon,
                jCoinReward: jCoinReward,
                gasReward: gasReward,
                otherRewards: otherRewards
            };
        }


        /**
         * Checks if the user has leveled up and applies rewards.
         * This function is called after any update to totalGasEarned.
         * @param {string} userId - The UID of the current user.
         * @param {number} oldLevel - The user's level before the current update.
         * @param {number} newTotalGasEarned - The user's total cumulative Gas after the update.
         */
        async function checkAndApplyLevelUps(userId, oldLevel, newTotalGasEarned) {
            let currentLevel = oldLevel;
            let updated = false;
            let levelsGainedMessages = [];

            while (true) {
                const nextLevel = currentLevel + 1;
                // If it's a new user with 0 totalGasEarned, and the initial level is 1
                // The condition totalGasEarned >= gasNeededForNextLevel should only trigger if they have enough for Level 1, then Level 2, etc.
                const gasNeededForNextLevel = getTotalGasRequiredToReachLevel(nextLevel);

                // If user has not yet earned enough XP for the next level, or has reached max defined level
                if (newTotalGasEarned < gasNeededForNextLevel) {
                    break;
                }

                // If here, user has enough XP for nextLevel
                const levelInfo = getLevelInfo(nextLevel);
                currentLevel = nextLevel;
                updated = true;

                try {
                    await runTransaction(db, async (transaction) => {
                        const userProfileDocRef = doc(db, "artifacts", appId, "users", userId, "profiles", "user_profile");
                        const userProfileSnap = await transaction.get(userProfileDocRef);

                        if (!userProfileSnap.exists()) {
                            throw new Error("User profile not found during level-up transaction.");
                        }

                        const currentProfileData = userProfileSnap.data();
                        const updatedJCoins = (currentProfileData.jCoins || 0) + levelInfo.jCoinReward;
                        const updatedGas = (currentProfileData.gas || 0) + levelInfo.gasReward;
                        const updatedUnlockedBenefits = [...(currentProfileData.unlockedBenefits || [])];

                        // Add new benefits, avoiding duplicates
                        if (levelInfo.otherRewards && levelInfo.otherRewards.length > 0) {
                            levelInfo.otherRewards.forEach(benefit => {
                                if (!updatedUnlockedBenefits.includes(benefit)) {
                                    updatedUnlockedBenefits.push(benefit);
                                }
                            });
                        }

                        transaction.update(userProfileDocRef, {
                            level: currentLevel,
                            jCoins: updatedJCoins,
                            gas: updatedGas,
                            unlockedBenefits: updatedUnlockedBenefits,
                            updatedAt: serverTimestamp()
                        });

                        // Also update public profile for level and totalGasEarned
                        const publicProfileDocRef = doc(db, "artifacts", appId, "public", "data", "users", userId);
                        transaction.update(publicProfileDocRef, {
                            level: currentLevel,
                            totalGasEarned: newTotalGasEarned, // Ensure public profile also reflects totalGasEarned
                            updatedAt: serverTimestamp()
                        });
                    });

                    levelsGainedMessages.push(` You reached Level ${currentLevel}: ${levelInfo.name}! You received ${levelInfo.jCoinReward} JCoins and ${levelInfo.gasReward} Gas.`);
                    if (levelInfo.otherRewards.length > 0) {
                        levelsGainedMessages[levelsGainedMessages.length - 1] += ` Unlocked: ${levelInfo.otherRewards.join(', ')}.`;
                    }
                    console.log(`JCHAT_DEBUG: User ${userId} leveled up to ${currentLevel}.`);

                } catch (transactionError) {
                    console.error("JCHAT_ERROR: Transaction failed during level-up:", transactionError);
                    showMessageBox(`Failed to apply level-up rewards for Level ${currentLevel}: ${transactionError.message}`, 'error');
                    break; // Stop processing further levels if a transaction fails
                }
            }

            if (updated) {
                // Show all level-up messages
                levelsGainedMessages.forEach(msg => showMessageBox(msg, 'success', false, 5000));
                // Re-fetch and display the profile to update UI with new level, JCoins, Gas
                await fetchAndDisplayUserProfile(userId);
            }
        }


        /**
         * Fetches and displays the current user's profile data for the header.
         * This function runs on every page to ensure header is consistent.
         * @param {firebase.User} user - The authenticated Firebase user object.
         */
        async function fetchAndDisplayHeaderProfile(user) {
            try {
                const privateProfileDocRef = doc(db, "artifacts", appId, "users", user.uid, "profiles", "user_profile");
                const publicProfileDocRef = doc(db, "artifacts", appId, "public", "data", "users", user.uid);
                
                const privateDocSnap = await getDoc(privateProfileDocRef);

                let profileData = null;
                if (privateDocSnap.exists()) {
                    profileData = privateDocSnap.data();
                    // Fix for createdAt if it's missing or malformed (not a Timestamp)
                    if (!profileData.createdAt || typeof profileData.createdAt.toDate !== 'function') {
                        console.warn("JCHAT_WARN: Private user_profile createdAt is missing or malformed. Attempting to fix.");
                        await updateDoc(privateProfileDocRef, { createdAt: serverTimestamp() });
                        // Re-fetch to get the correct Timestamp object
                        const updatedSnap = await getDoc(privateProfileDocRef);
                        profileData.createdAt = updatedSnap.data().createdAt;
                    }
                    // Ensure 'gas' field exists, initialize if not
                    if (profileData.gas === undefined) {
                        console.log("JCHAT_DEBUG: 'gas' field missing in profile, initializing to 0.");
                        await updateDoc(privateProfileDocRef, { gas: 0 });
                        profileData.gas = 0;
                    }
                    // Ensure 'totalGasEarned' field exists, initialize if not
                    if (profileData.totalGasEarned === undefined) {
                        console.log("JCHAT_DEBUG: 'totalGasEarned' field missing in profile, initializing to 0.");
                        await updateDoc(privateProfileDocRef, { totalGasEarned: 0 });
                        profileData.totalGasEarned = 0;
                    }
                    // Ensure 'level' field exists, initialize if not
                    if (profileData.level === undefined) {
                        console.log("JCHAT_DEBUG: 'level' field missing in profile, initializing to 1.");
                        await updateDoc(privateProfileDocRef, { level: 1 });
                        profileData.level = 1;
                    }
                    if (profileData.walletUnlocked === undefined) { // NEW: Initialize walletUnlocked
                        console.log("JCHAT_DEBUG: 'walletUnlocked' field missing in profile, initializing to false.");
                        await updateDoc(privateProfileDocRef, { walletUnlocked: false });
                        profileData.walletUnlocked = false;
                    }
                    if (profileData.unlockedBenefits === undefined) { // NEW: Initialize unlockedBenefits
                        console.log("JCHAT_DEBUG: 'unlockedBenefits' field missing in profile, initializing to [].");
                        await updateDoc(privateProfileDocRef, { unlockedBenefits: [] });
                        profileData.unlockedBenefits = [];
                    }
                    // NEW: Initialize additional profile fields
                    if (profileData.school === undefined) { await updateDoc(privateProfileDocRef, { school: "" }); profileData.school = ""; }
                    if (profileData.work === undefined) { await updateDoc(privateProfileDocRef, { work: "" }); profileData.work = ""; }
                    if (profileData.interests === undefined) { await updateDoc(privateProfileDocRef, { interests: "" }); profileData.interests = ""; }
                    if (profileData.website === undefined) { await updateDoc(privateProfileDocRef, { website: "" }); profileData.website = ""; }
                    if (profileData.socialLinks === undefined) { await updateDoc(privateProfileDocRef, { socialLinks: "" }); profileData.socialLinks = ""; }


                    console.log("JCHAT_DEBUG: Fetched existing profile data for header:", profileData);
                } else {
                    // If private profile doesn't exist, create a basic one
                    profileData = {
                        username: user.displayName || `User_${user.uid.substring(0, 8)}`,
                        email: user.email || "",
                        profilePicId: user.photoURL || null,
                        bio: "",
                        location: "",
                        school: "", // NEW
                        work: "", // NEW
                        interests: "", // NEW
                        website: "", // NEW
                        socialLinks: "", // NEW
                        friendsCount: 0,
                        followersCount: 0,
                        followingCount: 0,
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp(),
                        inspirationType: "motivational",
                        visibility: {
                            displayName: true, profilePic: true, bio: false, location: false,
                            emailPublic: false, lastOnline: false, allowFriendRequests: true, allowMessages: true,
                            school: false, work: false, interests: false, website: false, socialLinks: false // NEW visibility defaults
                        },
                        totalPosts: 0,
                        jCoins: 0, // Initialize jCoins
                        gas: 0, // Initialize GAS
                        totalGasEarned: 0, // Initialize totalGasEarned
                        level: 1, // Initialize level
                        walletUnlocked: false, // NEW: Default to locked wallet
                        unlockedBenefits: [] // NEW: Initialize unlockedBenefits
                    };
                    await setDoc(privateProfileDocRef, profileData);
                    console.log("JCHAT_DEBUG: Created new profile data for header:", profileData);

                    // Also create/update public profile
                    await setDoc(publicProfileDocRef, {
                        username: profileData.username,
                        profilePicId: profileData.profilePicId,
                        bio: profileData.bio,
                        location: profileData.location,
                        school: profileData.school, // NEW
                        work: profileData.work,     // NEW
                        interests: profileData.interests, // NEW
                        website: profileData.website,   // NEW
                        socialLinks: profileData.socialLinks, // NEW
                        createdAt: profileData.createdAt,
                        updatedAt: profileData.updatedAt,
                        visibility: profileData.visibility,
                        totalPosts: profileData.totalPosts,
                        level: profileData.level, // Include level in public profile
                        totalGasEarned: profileData.totalGasEarned // Include totalGasEarned in public profile
                    }, { merge: true });
                }

                // Store current user's profile data globally
                currentUserProfileData = profileData;

                // Update header UI
                const usernameInitial = (profileData.username || "J").charAt(0).toUpperCase();
                displayProfilePicture(headerProfilePic, headerAvatarIcon, profileData?.profilePicId, usernameInitial, "w_70,h_70,c_fill,g_face,r_max");
                headerDisplayName.textContent = profileData.username || "JCHAT User";
                if (headerNavLinkProfile) headerNavLinkProfile.href = `/profile.html?userId=${user.uid}`; // Ensure header nav link is correct, null check
                if (document.getElementById('profileLink')) document.getElementById('profileLink').href = `/profile.html?userId=${user.uid}`; // Ensure header profile link is correct, null check

                // if (logoutButton) logoutButton.disabled = false; // Null check - REMOVED

                // Show Admin Icon if current user is admin
                if (adminIconLink) { // Null check
                    if (user.uid === ADMIN_UID) {
                        adminIconLink.style.display = 'block';
                    } else {
                        adminIconLink.style.display = 'none';
                    }
                }

            } catch (error) {
                console.error("JCHAT_ERROR: Error fetching or creating profile for header:", error);
                const usernameInitial = (user.displayName || "J").charAt(0).toUpperCase();
                displayProfilePicture(headerProfilePic, headerAvatarIcon, user.photoURL, usernameInitial, "w_70,h_70,c_fill,g_face,r_max");
                if (headerDisplayName) headerDisplayName.textContent = user.displayName || "JCHAT User"; // Null check
                showMessageBox(`Error loading header profile: ${error.message}`, 'error');
                // if (logoutButton) logoutButton.disabled = false; // Null check - REMOVED
            }
        }

        /**
         * Fetches and displays the notification count for the current user.
         * @param {string} userId - The UID of the current user.
         */
        async function fetchNotificationCount(userId) {
            try {
                const notificationsCollectionRef = collection(db, "artifacts", appId, "users", userId, "notifications");
                const q = query(notificationsCollectionRef, where("read", "==", false));
                const querySnapshot = await getDocs(q);
                const unreadCount = querySnapshot.size;

                if (unreadCount > 0) {
                    if (notificationCountElement) { // Null check
                        notificationCountElement.textContent = unreadCount;
                        notificationCountElement.style.display = 'flex';
                    }
                } else {
                    if (notificationCountElement) { // Null check
                        notificationCountElement.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error("JCHAT_ERROR: Error fetching notification count:", error);
                if (notificationCountElement) notificationCountElement.style.display = 'none'; // Null check
            }
        }

        // --- Profile Page Specific Functions ---

        /**
         * Shows the JCoin request modal.
         */
        function showJCoinRequestModal() {
            if (!currentUser || !currentUserProfileData || !currentUserProfileData.walletUnlocked) {
                showMessageBox("Your wallet must be unlocked by an admin to request JCoins.", 'warning');
                return;
            }
            if (jcoinRequestModal) jcoinRequestModal.classList.add('active'); // Null check
            if (nairaAmountInput) nairaAmountInput.value = ''; // Null check
            if (calculatedJCoinsSpan) calculatedJCoinsSpan.textContent = '0 JCoins'; // Null check
            if (receiptUploadInput) receiptUploadInput.value = ''; // Clear file input, null check
            if (receiptFileNameSpan) receiptFileNameSpan.textContent = 'No file chosen'; // Null check
            if (receiptPreviewImg) { // Null check
                receiptPreviewImg.style.display = 'none';
                receiptPreviewImg.src = '';
            }
        }

        /**
         * Hides the JCoin request modal.
         */
        function hideJCoinRequestModal() {
            if (jcoinRequestModal) jcoinRequestModal.classList.remove('active'); // Null check
        }

        /**
         * Calculates the JCoins based on Naira amount and bonus.
         * @param {number} nairaAmount - The Naira amount entered by the user.
         * @returns {number} The calculated JCoins.
         */
        function calculateJCoins(nairaAmount) {
            let baseJCoins = Math.floor(nairaAmount * JCOIN_EXCHANGE_RATE_PER_NAIRA);
            let bonusJCoins = 0;
            if (nairaAmount >= JCOIN_BONUS_THRESHOLD_NAIRA) {
                bonusJCoins = Math.floor(baseJCoins * JCOIN_BONUS_PERCENTAGE);
            }
            return baseJCoins + bonusJCoins;
        }

        /**
         * Submits the JCoin purchase request to Firestore.
         */
        async function submitJCoinRequest() {
            if (!currentUser || !currentUserProfileData) {
                showMessageBox("You must be logged in to submit a request.", 'error');
                return;
            }
            if (!currentUserProfileData.walletUnlocked) {
                showMessageBox("Your wallet must be unlocked by an admin to request JCoins.", 'warning');
                return;
            }

            const nairaAmount = parseInt(nairaAmountInput.value);
            const receiptFile = receiptUploadInput.files[0];

            if (isNaN(nairaAmount) || nairaAmount <= 0) {
                showMessageBox("Please enter a valid Naira amount.", 'error');
                return;
            }
            if (nairaAmount < 100) { // Minimum request amount
                showMessageBox("Minimum request amount is #100.", 'warning');
                return;
            }
            if (!receiptFile) {
                showMessageBox("Please upload a payment receipt.", 'error');
                return;
            }

            toggleButtonLoading(submitJCoinRequestButton, true);
            showMessageBox("Submitting JCoin request...", 'loading', true);

            try {
                const requestedJCoins = calculateJCoins(nairaAmount);
                const uploadedReceiptUrl = await uploadMediaToCloudinary(receiptFile); // Corrected function call

                if (!uploadedReceiptUrl) {
                    throw new Error("Failed to upload receipt image.");
                }

                const jcoinBuyRequestsCollectionRef = collection(db, "artifacts", appId, "public", "data", "jcoin_buy_requests");

                await addDoc(jcoinBuyRequestsCollectionRef, {
                    userId: currentUser.uid,
                    username: currentUserProfileData.username || `User_${currentUser.uid.substring(0, 8)}`,
                    profilePicId: currentUserProfileData.profilePicId || null,
                    requestedNairaPrice: nairaAmount,
                    requestedJCoins: requestedJCoins,
                    receiptImageUrl: uploadedReceiptUrl,
                    status: 'pending', // Always pending for admin review
                    timestamp: serverTimestamp()
                });

                showMessageBox("JCoin request submitted successfully! An admin will review it shortly.", 'success');
                hideJCoinRequestModal(); // Close modal on success
            } catch (error) {
                console.error("JCHAT_ERROR: Error submitting JCoin request:", error);
                showMessageBox(`Failed to submit request: ${error.message}`, 'error');
            } finally {
                toggleButtonLoading(submitJCoinRequestButton, false);
            }
        }

        /**
         * Fetches and displays posts by a specific user.
         * This is a simplified version for the profile page.
         * @param {string} userId - The ID of the user whose posts to fetch.
         * @param {string} username - The username to display in the section title.
         */
        async function fetchAndDisplayUserPosts(userId, username) {
            if (userPostsFeed) userPostsFeed.style.display = 'block'; // Show the posts section, null check
            if (postsFeedUsername) postsFeedUsername.textContent = username; // Null check
            if (loadingUserPostsMessage) loadingUserPostsMessage.style.display = 'block'; // Null check
            if (userPostsFeed) userPostsFeed.innerHTML = `<h3>Posts by <span id="postsFeedUsername">${username}</span></h3><p style="text-align: center; color: var(--text-light);" id="loadingUserPostsMessage">Loading posts...</p>`; // Clear and reset, null check

            try {
                const postsCollectionRef = collection(db, "artifacts", appId, "public", "data", "posts");
                const q = query(postsCollectionRef, where("authorId", "==", userId), orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    if (userPostsFeed) userPostsFeed.innerHTML += '<p style="text-align: center; color: var(--text-light);">No posts from this user yet.</p>'; // Null check
                } else {
                    querySnapshot.docs.forEach(docSnap => {
                        const post = docSnap.data();
                        const postId = docSnap.id;
                        const authorInitial = (post.username || 'J').charAt(0).toUpperCase();

                        const postElement = document.createElement('div');
                        postElement.classList.add('post-card'); // Reuse post-card style from Home.html
                        postElement.setAttribute('data-post-id', postId);
                        postElement.style.marginBottom = '20px'; // Add some spacing between posts

                        postElement.innerHTML = `
                            <div class="post-header">
                                <div class="author-pic-wrapper">
                                    ${post.profilePhoto ?
                                        `<img src="${getCloudinaryImageUrl(post.profilePhoto, 'w_80,h_80,c_fill,g_face,r_max')}" alt="Author Pic" onerror="this.onerror=null; this.src='https://placehold.co/80x80/CCCCCC/000000?text=${authorInitial}';">` :
                                        `<i class="fas fa-user-circle author-pic-placeholder"></i>`
                                    }
                                </div>
                                <div class="author-info">
                                    <span class="author-name">${post.username || 'Anonymous'}</span>
                                    <p class="post-timestamp">${post.timestamp ? new Date(post.timestamp.toDate()).toLocaleString() : 'N/A'} ${post.isEdited ? '(Edited)' : ''}</p>
                                </div>
                            </div>
                            <div class="post-content-text">
                                <p>${post.content}</p>
                            </div>
                            <div class="post-reactions-summary">
                                <span>
                                    <i class="fas fa-thumbs-up" style="color:var(--blue);"></i> <span>${post.reactions?.like || 0}</span>
                                    <i class="fas fa-heart" style="color:var(--pink);"></i> <span>${post.reactions?.love || 0}</span>
                                    <i class="fas fa-face-laugh" style="color:#ffd700;"></i> <span>${post.reactions?.haha || 0}</span>
                                </span>
                                <span>${post.commentsCount || 0} Comments</span>
                            </div>
                        `;
                        if (userPostsFeed) userPostsFeed.appendChild(postElement); // Null check
                    });
                }
            } catch (error) {
                console.error("JCHAT_ERROR: Error fetching user posts:", error);
                if (userPostsFeed) userPostsFeed.innerHTML += '<p style="text-align: center; color: var(--text-light);">Failed to load posts.</p>'; // Null check
            } finally {
                if (loadingUserPostsMessage) loadingUserPostsMessage.style.display = 'none'; // Null check
            }
        }


        /**
         * Fetches and displays incoming friend requests for the current user.
         */
        async function fetchAndDisplayIncomingFriendRequests() {
            // This function is no longer needed on the Profile page after removing friend request buttons.
            // Keeping it as a placeholder for potential future use or if friend requests are moved elsewhere.
            if (incomingRequestsList) incomingRequestsList.innerHTML = ''; // Null check
            if (noRequestsMessage) incomingRequestsList.appendChild(noRequestsMessage); // Null check
            if (noRequestsMessage) noRequestsMessage.style.display = 'block'; // Null check
            return;
        }

        /**
         * Creates an HTML list item for an incoming friend request.
         * @param {string} senderId - The UID of the sender.
         * @param {Object} requestData - The request data from Firestore.
         * @returns {HTMLElement} The created list item div element.
         */
        function createFriendRequestItem(senderId, requestData) {
            // This function is no longer directly triggered from Profile.html after removing the button.
            return document.createElement('div'); // Return dummy element
        }

        /**
         * Accepts a friend request from a given sender.
         * @param {string} senderId - The UID of the user who sent the friend request.
         * @param {HTMLElement} buttonElement - The button element that triggered the action.
         */
        async function acceptFriendRequest(senderId, buttonElement) {
            // This function is no longer directly triggered from Profile.html after removing the button.
            // It's kept here if other pages might call it.
            showMessageBox("Friend request acceptance is handled on the Friends page.", 'info');
            if (buttonElement) toggleButtonLoading(buttonElement, false);
        }

        /**
         * Rejects a friend request from a given sender.
         * @param {string} senderId - The UID of the user who sent the friend request.
         * @param {HTMLElement} buttonElement - The button element that triggered the action.
         */
        async function rejectFriendRequest(senderId, buttonElement) {
            // This function is no longer directly triggered from Profile.html after removing the button.
            // It's kept here if other pages might call it.
            showMessageBox("Friend request rejection is handled on the Friends page.", 'info');
            if (buttonElement) toggleButtonLoading(buttonElement, false);
        }

        /**
         * Removes a user from the current user's friends list.
         * @param {string} targetUserId - The UID of the user to unfriend.
         * @param {string} targetUsername - The username of the user to unfriend.
         * @param {HTMLElement} buttonElement - The button element that triggered the action.
         */
        async function unfriendUser(targetUserId, targetUsername, buttonElement) {
            // This function is no longer directly triggered from Profile.html after removing the button.
            // It's kept here if other pages might call it.
            showMessageBox("Unfriending is handled on the Friends page.", 'info');
            if (buttonElement) toggleButtonLoading(buttonElement, false);
        }


        /**
         * Fetches and displays a user's profile data.
         * Determines if it's the current user's profile or another user's.
         * @param {string} userIdToDisplay - The UID of the user whose profile should be displayed.
         */
        async function fetchAndDisplayUserProfile(userIdToDisplay) {
            // Clear previous state and show loader
            showMessageBox("Loading profile...", 'loading', true);
            if (profileUsername) profileUsername.textContent = "Loading...";
            if (profileBio) profileBio.textContent = "Loading...";
            if (profileLocation) profileLocation.style.display = 'none';
            if (profileEmail) profileEmail.style.display = 'none';
            if (profileSchool) profileSchool.style.display = 'none'; // NEW
            if (profileWork) profileWork.style.display = 'none';   // NEW
            if (profileWebsite) profileWebsite.style.display = 'none'; // NEW
            if (profileSocialLinks) profileSocialLinks.style.display = 'none'; // NEW

            if (statPosts) statPosts.textContent = "0";
            if (statFriends) statFriends.textContent = "0";
            if (statFollowers) statFollowers.textContent = "0";
            if (statFollowing) statFollowing.textContent = "0";
            if (jCoinsSpan) jCoinsSpan.textContent = "0"; // Reset jCoins
            if (jcoinExchangeRate) jcoinExchangeRate.style.display = 'none'; // Hide exchange rate by default
            if (gasValue) gasValue.textContent = "0"; // Reset Gas (XP)
            if (xpLevelIcon) xpLevelIcon.className = "fas fa-question-circle profile-level-icon"; // Reset icon
            if (xpLevelName) xpLevelName.textContent = "Loading Level..."; // Reset level name
            if (xpProgressBarFill) xpProgressBarFill.style.width = "0%"; // Reset progress bar
            if (xpProgressBarFill) xpProgressBarFill.style.backgroundPosition = "right"; // Reset gradient position


            if (profilePagePic) profilePagePic.style.display = 'none';
            if (profilePageAvatarIcon) profilePageAvatarIcon.style.display = 'block';
            
            // Hide all action buttons initially
            // if (editProfileButton) editProfileButton.style.display = 'none'; // Removed
            if (walletLink) walletLink.style.display = 'none'; // Hide wallet link
            if (walletLockedMessage) walletLockedMessage.style.display = 'none'; // Hide wallet locked message
            if (requestJCoinsButton) requestJCoinsButton.style.display = 'none'; // Hide request JCoins button
            // Removed addFriendButton and messageButton hiding here
            // Hide inline edit fields and account settings by default
            const profileDetailsSection = displayNameInput ? displayNameInput.closest('.profile-details-section') : null; // Null check for displayNameInput
            if (profileDetailsSection) {
                profileDetailsSection.style.display = 'none';
            }
            // Removed: if (pendingRewardsSection) pendingRewardsSection.style.display = 'none'; // Hide pending rewards by default
            if (accountSettingsSection) accountSettingsSection.style.display = 'none'; // NEW: Hide account settings by default
            if (toggleAccountSettingsButton) toggleAccountSettingsButton.style.display = 'none'; // NEW: Hide toggle button by default


            let profileDocRef;
            let isCurrentUserProfile = false;

            if (currentUser && userIdToDisplay === currentUser.uid) {
                // Displaying current user's profile (private data)
                profileDocRef = doc(db, "artifacts", appId, "users", userIdToDisplay, "profiles", "user_profile");
                isCurrentUserProfile = true;
                if (profilePicWrapper) profilePicWrapper.classList.add('owner'); // Null check
            } else {
                // Displaying another user's profile (public data)
                profileDocRef = doc(db, "artifacts", appId, "public", "data", "users", userIdToDisplay);
                isCurrentUserProfile = false;
                if (profilePicWrapper) profilePicWrapper.classList.remove('owner'); // Null check
            }

            try {
                const docSnap = await getDoc(profileDocRef);

                if (docSnap.exists()) {
                    // Store the fetched profile data globally for the currently displayed user
                    // If it's the current user's profile, store it in currentUserProfileData
                    if (isCurrentUserProfile) {
                        currentUserProfileData = docSnap.data();
                        displayedUserProfileData = currentUserProfileData; // Both point to the same for owner
                    } else {
                        displayedUserProfileData = docSnap.data();
                    }
                    
                    // IMPORTANT: Ensure userId is always part of displayedUserProfileData
                    displayedUserProfileData.userId = userIdToDisplay;

                    console.log(`JCHAT_DEBUG: Fetched profile data for ${userIdToDisplay}:`, displayedUserProfileData);

                    // Apply visibility settings if it's another user's profile
                    const visibility = displayedUserProfileData.visibility || {};

                    if (profileUsername) profileUsername.textContent = displayedUserProfileData.username || "JCHAT User"; // Null check
                    const usernameInitial = (displayedUserProfileData.username || "J").charAt(0).toUpperCase();

                    // Profile Picture
                    if (profilePagePic && profilePageAvatarIcon) { // Null check
                        if (displayedUserProfileData.profilePicId && (isCurrentUserProfile || visibility.profilePic)) {
                            displayProfilePicture(profilePagePic, profilePageAvatarIcon, displayedUserProfileData.profilePicId, usernameInitial, "w_240,h_240,c_fill,g_face,r_max");
                        } else {
                            profilePagePic.style.display = 'none';
                            profilePageAvatarIcon.style.display = 'block';
                        }
                    }


                    // Bio
                    if (profileBio) { // Null check
                        if (displayedUserProfileData.bio && (isCurrentUserProfile || visibility.bio)) {
                            profileBio.textContent = displayedUserProfileData.bio;
                        } else {
                            profileBio.textContent = isCurrentUserProfile ? "No bio provided yet." : "Bio not publicly available.";
                        }
                    }

                    // Location
                    if (profileLocation && locationText) { // Null check
                        if (displayedUserProfileData.location && (isCurrentUserProfile || visibility.location)) {
                            locationText.textContent = displayedUserProfileData.location;
                            profileLocation.style.display = 'block';
                        } else {
                            profileLocation.style.display = 'none';
                        }
                    }

                    // Email (only for owner or if public)
                    if (profileEmail && emailText) { // Null check
                        if (displayedUserProfileData.email && (isCurrentUserProfile || visibility.emailPublic)) {
                            emailText.textContent = displayedUserProfileData.email;
                            profileEmail.style.display = 'block';
                        } else {
                            profileEmail.style.display = 'none';
                        }
                    }

                    // NEW: Display additional user info based on visibility
                    if (profileSchool && schoolText) {
                        if (displayedUserProfileData.school && (isCurrentUserProfile || visibility.school)) {
                            schoolText.textContent = displayedUserProfileData.school;
                            profileSchool.style.display = 'block';
                        } else {
                            profileSchool.style.display = 'none';
                        }
                    }
                    if (profileWork && workText) {
                        if (displayedUserProfileData.work && (isCurrentUserProfile || visibility.work)) {
                            workText.textContent = displayedUserProfileData.work;
                            profileWork.style.display = 'block';
                        } else {
                            profileWork.style.display = 'none';
                        }
                    }
                    if (profileWebsite && websiteLink) {
                        if (displayedUserProfileData.website && (isCurrentUserProfile || visibility.website)) {
                            websiteLink.href = displayedUserProfileData.website;
                            websiteLink.textContent = displayedUserProfileData.website.replace(/^(https?:\/\/)?(www\.)?/, ''); // Display cleaner URL
                            profileWebsite.style.display = 'block';
                        } else {
                            profileWebsite.style.display = 'none';
                        }
                    }
                    if (profileSocialLinks && socialLinksText) {
                        if (displayedUserProfileData.socialLinks && (isCurrentUserProfile || visibility.socialLinks)) {
                            socialLinksText.textContent = displayedUserProfileData.socialLinks;
                            profileSocialLinks.style.display = 'block';
                        } else {
                            profileSocialLinks.style.display = 'none';
                        }
                    }


                    // Stats (always show for owner, for others based on public profile data)
                    if (statPosts) statPosts.textContent = displayedUserProfileData.totalPosts ?? 0; // Null check
                    if (statFriends) statFriends.textContent = displayedUserProfileData.friendsCount ?? 0; // Null check
                    if (statFollowers) statFollowers.textContent = displayedUserProfileData.followersCount ?? 0; // Null check
                    if (statFollowing) statFollowing.textContent = displayedUserProfileData.followingCount ?? 0; // Null check
                    
                    // JCoins (only visible to owner)
                    if (jCoinsSpan && jcoinExchangeRate && jcoinUSDValue) { // Null check
                        if (isCurrentUserProfile) {
                            jCoinsSpan.textContent = (displayedUserProfileData.jCoins ?? 0).toLocaleString();
                            const usdValue = (displayedUserProfileData.jCoins ?? 0) * JCOIN_EXCHANGE_RATE_PER_NAIRA * 0.005; // Assuming 1 JCoin = $0.005
                            jcoinUSDValue.textContent = `$${usdValue.toFixed(2)}`;
                            jcoinExchangeRate.style.display = 'flex'; // Use flex to align icon and text
                            if (jCoinsSpan.closest('.stat-item')) jCoinsSpan.closest('.stat-item').style.display = 'block'; // Ensure the entire stat item is visible
                        } else {
                            // Hide JCoins and exchange rate for other users
                            if (jCoinsSpan.closest('.stat-item')) jCoinsSpan.closest('.stat-item').style.display = 'none';
                        }
                    }
                    
                    // NEW: Display Gas (XP) and Level Progress
                    const currentGasBalance = displayedUserProfileData.gas ?? 0; // Current spendable Gas
                    const totalGasEarned = displayedUserProfileData.totalGasEarned ?? 0; // Cumulative Gas for leveling

                    // Determine current level based on totalGasEarned
                    let currentLevel = 1; // Start from Level 1
                    for (let i = 1; i <= 500; i++) { // Check up to max level 500 (or higher if you extend getLevelInfo)
                        const gasNeededForLevelI = getTotalGasRequiredToReachLevel(i);
                        if (totalGasEarned >= gasNeededForLevelI) {
                            currentLevel = i;
                        } else {
                            break; // Stop when totalGasEarned is less than what's needed for the current 'i' level
                        }
                    }
                    // Ensure level displayed is at least 1, even if totalGasEarned is 0
                    currentLevel = Math.max(1, currentLevel);

                    const levelInfo = getLevelInfo(currentLevel); // Get info for the calculated level

                    if (gasValue) gasValue.textContent = currentGasBalance.toLocaleString(); // Display current Gas balance, null check

                    // Update Level Name and Icon
                    if (xpLevelName) xpLevelName.textContent = levelInfo.name; // Null check
                    if (xpLevelIcon) xpLevelIcon.className = `${levelInfo.icon} profile-level-icon`; // Null check

                    let progressPercentage = 0;
                    const gasNeededForCurrentDisplayedLevel = getTotalGasRequiredToReachLevel(currentLevel);
                    const gasNeededForNextLevel = getTotalGasRequiredToReachLevel(currentLevel + 1);

                    if (currentLevel < 500) { // For levels up to 500, calculate progress
                        const gasEarnedInCurrentLevelSegment = totalGasEarned - gasNeededForCurrentDisplayedLevel;
                        const gasRequiredForCurrentLevelSegment = gasNeededForNextLevel - gasNeededForCurrentDisplayedLevel;
                        
                        if (gasRequiredForCurrentLevelSegment > 0) {
                            progressPercentage = Math.min(100, (gasEarnedInCurrentLevelSegment / gasRequiredForCurrentLevelSegment) * 100);
                        } else {
                            progressPercentage = 100; // Should not happen if formula is correct, but as a safeguard (e.g., if totalGasEarned is exactly at target)
                        }
                    } else {
                        progressPercentage = 100; // Maxed out for levels beyond 500
                        if (xpLevelName) xpLevelName.textContent = `MAX Level (${levelInfo.name})`;
                    }

                    // Set background-position for the gradient fill
                    // When progressPercentage is 0, background-position is right (0% of the gradient shown)
                    // When progressPercentage is 100, background-position is left (100% of the gradient shown)
                    const backgroundPosition = 100 - progressPercentage; // Invert for background-position: left to right fill
                    if (xpProgressBarFill) {
                        xpProgressBarFill.style.backgroundPosition = `${backgroundPosition}% 0`; // Set background-position
                        xpProgressBarFill.style.width = `100%`; // Ensure width is always 100%
                    }


                    // Action Buttons and Inline Edit Fields
                    if (isCurrentUserProfile) {
                        // Removed editProfileButton
                        if (walletLink) walletLink.style.display = 'inline-flex'; // Null check
                        if (requestJCoinsButton) requestJCoinsButton.style.display = 'inline-flex'; // Show Request JCoins button for owner, null check

                        // Wallet Link Logic (only for owner)
                        if (walletLink && walletLockedMessage) { // Null check
                            walletLink.style.display = 'inline-flex';
                            if (displayedUserProfileData.walletUnlocked) {
                                walletLink.classList.remove('disabled-link');
                                walletLockedMessage.style.display = 'none';
                                if (walletLink.querySelector('.padlock-icon')) { // Null check for inner icon
                                    walletLink.querySelector('.padlock-icon').classList.remove('fa-lock');
                                    walletLink.querySelector('.padlock-icon').classList.add('fa-unlock-alt');
                                }
                            } else {
                                walletLink.classList.add('disabled-link');
                                walletLockedMessage.style.display = 'block';
                                if (walletLink.querySelector('.padlock-icon')) { // Null check for inner icon
                                    walletLink.querySelector('.padlock-icon').classList.add('fa-lock');
                                    walletLink.querySelector('.padlock-icon').classList.remove('fa-unlock-alt');
                                }
                            }
                        }

                        // Show inline edit fields and account settings for owner
                        const profileDetailsSection = displayNameInput ? displayNameInput.closest('.profile-details-section') : null; // Null check
                        if (profileDetailsSection) {
                            profileDetailsSection.style.display = 'flex';
                        }
                        // Populate inline edit fields
                        if (displayNameInput) displayNameInput.value = displayedUserProfileData.username || ""; // Null check
                        if (bioTextarea) bioTextarea.value = displayedUserProfileData.bio || ""; // Null check
                        if (locationInput) locationInput.value = displayedUserProfileData.location || ""; // Null check
                        if (schoolInput) schoolInput.value = displayedUserProfileData.school || ""; // NEW
                        if (workInput) workInput.value = displayedUserProfileData.work || ""; // NEW
                        if (interestsInput) interestsInput.value = displayedUserProfileData.interests || ""; // NEW
                        if (websiteInput) websiteInput.value = displayedUserProfileData.website || ""; // NEW
                        if (socialLinksInput) socialLinksInput.value = displayedUserProfileData.socialLinks || ""; // NEW

                        if (profileEmailInput) profileEmailInput.value = displayedUserProfileData.email || ""; // Populate disabled email field, null check

                        // Show toggle button for account settings
                        if (toggleAccountSettingsButton) toggleAccountSettingsButton.style.display = 'inline-flex';


                        // Friend requests section is no longer directly on Profile.html
                        if (friendRequestsSection) friendRequestsSection.style.display = 'none'; // Hide for other users, null check

                        // Removed: Fetch and display pending rewards for the owner
                        // if (pendingRewardsSection) { // Null check
                        //     pendingRewardsSection.style.display = 'flex'; // Use flex for column layout
                        //     await fetchAndDisplayPendingRewards(currentUser.uid);
                        // }


                    } else if (currentUser) { // If logged in and viewing another user
                        // Hide all owner-specific buttons and editing sections
                        // if (editProfileButton) editProfileButton.style.display = 'none'; // Removed
                        if (walletLink) walletLink.style.display = 'none'; // Hide wallet link for others, null check
                        if (walletLockedMessage) walletLockedMessage.style.display = 'none'; // Hide message for others, null check
                        if (requestJCoinsButton) requestJCoinsButton.style.display = 'none'; // Hide request JCoins button for others, null check
                        // Hide inline edit fields and account settings
                        const profileDetailsSection = displayNameInput ? displayNameInput.closest('.profile-details-section') : null; // Null check
                        if (profileDetailsSection) {
                            profileDetailsSection.style.display = 'none';
                        }
                        if (toggleAccountSettingsButton) toggleAccountSettingsButton.style.display = 'none'; // NEW: Hide toggle button for others
                        if (accountSettingsSection) accountSettingsSection.style.display = 'none'; // NEW: Hide account settings for others

                        if (friendRequestsSection) friendRequestsSection.style.display = 'none'; // Hide for other users, null check
                        // Removed: if (pendingRewardsSection) pendingRewardsSection.style.display = 'none'; // Hide for other users, null check

                    } else { // Not logged in, viewing any profile
                        // if (editProfileButton) editProfileButton.style.display = 'none'; // Removed
                        if (walletLink) walletLink.style.display = 'none'; // Hide wallet link, null check
                        if (walletLockedMessage) walletLockedMessage.style.display = 'none'; // Hide message, null check
                        if (requestJCoinsButton) requestJCoinsButton.style.display = 'none'; // Hide request JCoins button, null check
                        // Hide inline edit fields and account settings
                        const profileDetailsSection = displayNameInput ? displayNameInput.closest('.profile-details-section') : null; // Null check
                        if (profileDetailsSection) {
                            profileDetailsSection.style.display = 'none';
                        }
                        if (toggleAccountSettingsButton) toggleAccountSettingsButton.style.display = 'none'; // NEW: Hide toggle button
                        if (accountSettingsSection) accountSettingsSection.style.display = 'none'; // NEW: Hide account settings
                        if (friendRequestsSection) friendRequestsSection.style.display = 'none'; // Hide friend requests section, null check
                        // Removed: if (pendingRewardsSection) pendingRewardsSection.style.display = 'none'; // Hide pending rewards section, null check
                        // Ensure loader is dismissed in this case too
                        if (messageBox && messageBox.classList.contains('loading-pulse')) { // Null check
                            messageBox.style.opacity = '0';
                            messageBox.addEventListener('transitionend', function handler() {
                                messageBox.style.display = 'none';
                                messageBox.removeEventListener('transitionend', handler);
                                messageBox.classList.remove('loading-pulse');
                            }, { once: true });
                        }
                    }

                    // Load user's posts (if desired on profile page)
                    // await fetchAndDisplayUserPosts(userIdToDisplay, displayedUserProfileData.username || "User");
                    if (userPostsFeed) userPostsFeed.style.display = 'none'; // Keep posts section hidden for now as it's not fully styled for this page., null check

                    showMessageBox("Profile loaded!", 'success');

                    // After displaying profile, check for level ups
                    if (isCurrentUserProfile && currentUserProfileData) {
                        await checkAndApplyLevelUps(currentUser.uid, currentUserProfileData.level, currentUserProfileData.totalGasEarned);
                    }

                } else {
                    if (profileUsername) profileUsername.textContent = "User Not Found"; // Null check
                    if (profileBio) profileBio.textContent = "This user profile does not exist or is unavailable."; // Null check
                    showMessageBox("User profile not found.", 'error');
                    // Hide inline edit fields and account settings
                    const profileDetailsSection = displayNameInput ? displayNameInput.closest('.profile-details-section') : null; // Null check
                    if (profileDetailsSection) {
                        profileDetailsSection.style.display = 'none';
                    }
                    if (toggleAccountSettingsButton) toggleAccountSettingsButton.style.display = 'none'; // NEW: Hide toggle button
                    if (accountSettingsSection) accountSettingsSection.style.display = 'none'; // NEW: Hide account settings
                    if (friendRequestsSection) friendRequestsSection.style.display = 'none'; // Hide if profile not found, null check
                    // Removed: if (pendingRewardsSection) pendingRewardsSection.style.display = 'none'; // Hide if profile not found, null check
                }
            } catch (error) {
                console.error("JCHAT_ERROR: Error fetching user profile:", error);
                if (profileUsername) profileUsername.textContent = "Error Loading Profile"; // Null check
                if (profileBio) profileBio.textContent = "An error occurred while loading this profile."; // Null check
                showMessageBox(`Failed to load profile: ${error.message}`, 'error');
                // Hide inline edit fields and account settings
                const profileDetailsSection = displayNameInput ? displayNameInput.closest('.profile-details-section') : null; // Null check
                if (profileDetailsSection) {
                    profileDetailsSection.style.display = 'none';
                }
                if (toggleAccountSettingsButton) toggleAccountSettingsButton.style.display = 'none'; // NEW: Hide toggle button
                if (accountSettingsSection) accountSettingsSection.style.display = 'none'; // NEW: Hide account settings
                if (friendRequestsSection) friendRequestsSection.style.display = 'none'; // Hide on error, null check
                // Removed: if (pendingRewardsSection) pendingRewardsSection.style.display = 'none'; // Hide on error, null check
            } finally {
                // Ensure the message box clears if it was persistent loading type
                // This ensures the loader is always dismissed.
                if (messageBox && messageBox.classList.contains('loading-pulse')) { // Null check for messageBox
                    messageBox.style.opacity = '0';
                    messageBox.addEventListener('transitionend', function handler() {
                        messageBox.style.display = 'none';
                        messageBox.removeEventListener('transitionend', handler);
                        messageBox.classList.remove('loading-pulse');
                    }, { once: true });
                }
            }
        }

        // Removed: fetchAndDisplayPendingRewards function
        // Removed: createRewardItem function
        // Removed: claimReward function


        // --- Authentication State Listener ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                isAuthReady = true; // Set auth ready flag
                console.log("JCHAT_DEBUG: User authenticated in Profile Page:", user.uid);
                
                // Fetch header profile first, as it sets currentUserProfileData
                await fetchAndDisplayHeaderProfile(user); 

                // Determine which user's profile to display
                const urlParams = new URLSearchParams(window.location.search);
                displayedUserId = urlParams.get('userId') || currentUser.uid; // Default to current user's ID

                // Only fetch and display user profile if auth is ready and currentUserProfileData is set
                // This prevents race conditions where profile data might not be available yet.
                if (isAuthReady && currentUserProfileData) {
                    await fetchAndDisplayUserProfile(displayedUserId);
                    fetchNotificationCount(user.uid); // Fetch notification count
                } else {
                    console.warn("JCHAT_WARN: Authentication not fully ready or currentUserProfileData missing. Skipping profile display for now.");
                    // Ensure loader is dismissed in this case too, as profile display might not proceed.
                    if (messageBox && messageBox.classList.contains('loading-pulse')) { // Null check
                        messageBox.style.opacity = '0';
                        messageBox.addEventListener('transitionend', function handler() {
                            messageBox.style.display = 'none';
                            messageBox.removeEventListener('transitionend', handler);
                            messageBox.classList.remove('loading-pulse');
                        }, { once: true });
                    }
                }

            } else {
                console.log("JCHAT_DEBUG: No user signed in.");
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("JCHAT_DEBUG: Signed in with custom token.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("JCHAT_DEBUG: Signed in anonymously.");
                    }
                    // onAuthStateChanged will be triggered again with the new user
                } catch (error) {
                    console.error("JCHAT_ERROR: Error during anonymous sign-in or custom token sign-in:", error);
                    if (!auth.currentUser) {
                        window.location.href = '/login.html';
                    }
                }
                isAuthReady = false;
                // if (logoutButton) logoutButton.disabled = true; // Header logout button, null check - REMOVED
                if (logoutButtonAccount) logoutButtonAccount.disabled = true; // Account settings logout button, null check
                if (headerDisplayName) headerDisplayName.textContent = "Guest"; // Null check
                if (headerProfilePic) headerProfilePic.style.display = 'none'; // Null check
                if (headerAvatarIcon) headerAvatarIcon.style.display = 'block'; // Null check
                if (adminIconLink) adminIconLink.style.display = 'none'; // Ensure admin icon is hidden, null check
                showMessageBox("Please log in to view profiles.", 'info', true);
                // Display generic message if not logged in and no specific user ID is provided
                if (profileUsername) profileUsername.textContent = "Please Log In"; // Null check
                if (profileBio) profileBio.textContent = "Log in to view your profile or search for other users."; // Null check
                if (profileActions) profileActions.innerHTML = ''; // Clear actions, null check
                // Hide inline edit fields and account settings
                const profileDetailsSection = displayNameInput ? displayNameInput.closest('.profile-details-section') : null; // Null check
                if (profileDetailsSection) {
                    profileDetailsSection.style.display = 'none';
                }
                if (userPostsFeed) userPostsFeed.style.display = 'none'; // Hide user posts, null check
                if (friendRequestsSection) friendRequestsSection.style.display = 'none'; // Hide friend requests section, null check
                // Removed: if (pendingRewardsSection) pendingRewardsSection.style.display = 'none'; // Hide pending rewards section, null check
                if (toggleAccountSettingsButton) toggleAccountSettingsButton.style.display = 'none'; // NEW: Hide toggle button
                if (accountSettingsSection) accountSettingsSection.style.display = 'none'; // NEW: Hide account settings
                // Ensure loader is dismissed in this case too
                if (messageBox && messageBox.classList.contains('loading-pulse')) { // Null check
                    messageBox.style.opacity = '0';
                    messageBox.addEventListener('transitionend', function handler() {
                        messageBox.style.display = 'none';
                        messageBox.removeEventListener('transitionend', handler);
                        messageBox.classList.remove('loading-pulse');
                    }, { once: true });
                }
            }
        });

        // --- Bottom Navigation Bar Toggle Logic (reused from Home.html) ---
        const bottomNavBar = document.getElementById('bottomNavBar');
        const navToggleBtn = document.getElementById('navToggleBtn');

        function toggleNavBarVisibility() {
            const toggleIcon = navToggleBtn.querySelector('i');
            const isHidden = bottomNavBar.classList.toggle('nav-bar-hidden-full');

            if (isHidden) {
                if (toggleIcon) toggleIcon.classList.remove('fa-chevron-down'); // Null check
                if (toggleIcon) toggleIcon.classList.add('fa-chevron-up'); // Null check
            } else {
                if (toggleIcon) toggleIcon.classList.remove('fa-chevron-up'); // Null check
                if (toggleIcon) toggleIcon.classList.add('fa-chevron-down'); // Null check
            }
        }

        if (bottomNavBar) bottomNavBar.classList.add('nav-bar-hidden-full'); // Null check
        if (navToggleBtn && navToggleBtn.querySelector('i')) { // Null check
            navToggleBtn.querySelector('i').classList.remove('fa-chevron-down');
            navToggleBtn.querySelector('i').classList.add('fa-chevron-up');
        }
        if (navToggleBtn) navToggleBtn.addEventListener('click', toggleNavBarVisibility); // Null check

        // --- Event Listeners (moved to DOMContentLoaded for safety) ---
        document.addEventListener('DOMContentLoaded', () => {
            // Apply theme on load
            const savedTheme = localStorage.getItem('jchat-theme');
            const themes = ['theme-light-mode', 'theme-dark-mode', 'theme-glass-mode', 'theme-sunset-mode'];
            if (savedTheme && themes.includes(savedTheme)) {
                document.body.classList.remove(...themes);
                document.body.classList.add(savedTheme);
            } else {
                document.body.classList.remove(...themes);
                document.body.classList.add('theme-dark-mode'); // Default
            }

            // Profile Picture Upload
            if (profilePicUploadInput) profilePicUploadInput.addEventListener('change', handleProfilePicChange); // Null check

            // Profile Edit
            if (saveProfileChanges) saveProfileChanges.addEventListener('click', handleSaveProfileChanges); // Null check

            // Account Settings Toggle
            if (toggleAccountSettingsButton) {
                toggleAccountSettingsButton.addEventListener('click', () => {
                    if (accountSettingsSection) {
                        const isHidden = accountSettingsSection.style.display === 'none';
                        accountSettingsSection.style.display = isHidden ? 'flex' : 'none'; // Use flex for column layout
                        // Change button text/icon based on state
                        toggleAccountSettingsButton.innerHTML = isHidden ?
                            '<i class="fas fa-times-circle"></i> Close Settings' :
                            '<i class="fas fa-cog"></i> Manage Account Settings';
                    }
                });
            }

            // Account Settings
            const changeEmailForm = document.getElementById('changeEmailForm'); // Get form element here
            if (changeEmailForm) changeEmailForm.addEventListener('submit', handleChangeEmail); // Null check
            if (updateEmailButton) updateEmailButton.addEventListener('click', handleChangeEmail); // Also listen to button click
            if (changePasswordButton) changePasswordButton.addEventListener('click', handleChangePassword); // Null check
            if (logoutButtonAccount) logoutButtonAccount.addEventListener('click', handleLogout); // Logout button in account settings, null check

            // JCoin Request Modal Event Listeners
            if (requestJCoinsButton) requestJCoinsButton.addEventListener('click', showJCoinRequestModal); // Null check
            if (cancelJCoinRequestButton) cancelJCoinRequestButton.addEventListener('click', hideJCoinRequestModal); // Null check
            if (submitJCoinRequestButton) submitJCoinRequestButton.addEventListener('click', submitJCoinRequest); // Null check

            // Calculate JCoins dynamically as Naira amount changes
            if (nairaAmountInput && calculatedJCoinsSpan) { // Null check
                nairaAmountInput.addEventListener('input', () => {
                    const nairaAmount = parseInt(nairaAmountInput.value);
                    if (!isNaN(nairaAmount) && nairaAmount > 0) {
                        const calculatedJCoins = calculateJCoins(nairaAmount);
                        calculatedJCoinsSpan.textContent = `${calculatedJCoins.toLocaleString()} JCoins`;
                    } else {
                        calculatedJCoinsSpan.textContent = '0 JCoins';
                    }
                });
            }


            // Handle receipt file input change
            if (receiptUploadInput && receiptFileNameSpan && receiptPreviewImg) { // Null check
                receiptUploadInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        receiptFileNameSpan.textContent = file.name;
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            receiptPreviewImg.src = e.target.result;
                            receiptPreviewImg.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    } else {
                        receiptFileNameSpan.textContent = 'No file chosen';
                        receiptPreviewImg.style.display = 'none';
                        receiptPreviewImg.src = '';
                    }
                });
            }


            // Allow clicking the custom file input wrapper to trigger the hidden input
            const fileInputWrapper = document.querySelector('.file-input-wrapper');
            if (fileInputWrapper && receiptUploadInput) { // Null check
                fileInputWrapper.addEventListener('click', () => {
                    receiptUploadInput.click();
                });
            }

            // NEW: Explicit click listener for the progress bar container
            if (progressBarContainer) { // Null check
                progressBarContainer.style.cursor = 'pointer'; // Add pointer cursor to indicate clickability
                progressBarContainer.addEventListener('click', () => {
                    window.location.href = '/levels.html'; // Navigate to levels.html
                });
            }

        });

        window.addEventListener('storage', (event) => {
            if (event.key === 'jchat-theme') {
                const newTheme = event.newValue || 'theme-dark-mode';
                const themes = ['theme-light-mode', 'theme-dark-mode', 'theme-glass-mode', 'theme-sunset-mode'];
                if (themes.includes(newTheme)) {
                    document.body.classList.remove(...themes);
                    document.body.classList.add(newTheme);
                }
            }
        });

        window.addEventListener('beforeunload', () => {
            // No specific Firestore listeners to unsubscribe from on this page currently
        });

        // Ensure header logout button is initialized outside DOMContentLoaded for immediate availability
        // if (logoutButton) logoutButton.addEventListener('click', handleLogout); // Null check - REMOVED
    </script>
</body>
</html>
